<!DOCTYPE html>
<html lang="th" x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }" :class="{ 'dark': darkMode }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Count System - ระบบนับสต๊อก</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js Collapse Plugin -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');

        * {
            font-family: 'Prompt', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Dark Mode Scrollbar */
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Smooth Transitions */
        * {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }



        /* Sidebar Glow Effect Enhancement */
        aside.glow-border {
            border-right: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 5px 0 20px rgba(59, 130, 246, 0.2),
                10px 0 40px rgba(59, 130, 246, 0.1);
        }

        .dark aside.glow-border {
            border-right: 1px solid rgba(96, 165, 250, 0.4);
            box-shadow: 5px 0 25px rgba(96, 165, 250, 0.3),
                10px 0 50px rgba(96, 165, 250, 0.15);
        }


        /* Update Menu Item Active State */
        .menu-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
            box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .dark .menu-item.active {
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            border-left: 3px solid #60a5fa;
            box-shadow: inset 0 0 15px rgba(96, 165, 250, 0.3);
        }

        /* Hover effect for menu items */
        .menu-item:hover:not(.active) {
            background: rgba(59, 130, 246, 0.05);
            border-left: 3px solid transparent;
        }

        .dark .menu-item:hover:not(.active) {
            background: rgba(96, 165, 250, 0.05);
        }

        /* Mobile menu with glow */
        .fixed.glow-border {
            animation: pulse-glow 3s ease-in-out infinite;
        }

        .glow-border-top {
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 -5px 20px rgba(59, 130, 246, 0.2),
                0 -10px 40px rgba(59, 130, 246, 0.1);
        }

        .dark .glow-border-top {
            border-top: 1px solid rgba(96, 165, 250, 0.4);
            box-shadow: 0 -5px 25px rgba(96, 165, 250, 0.3),
                0 -10px 50px rgba(96, 165, 250, 0.15);
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.5),
                    0 0 30px rgba(59, 130, 246, 0.3),
                    0 0 45px rgba(59, 130, 246, 0.1);
            }

            50% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.6),
                    0 0 40px rgba(59, 130, 246, 0.4),
                    0 0 60px rgba(59, 130, 246, 0.2);
            }
        }


        [x-cloak] {
            display: none !important;
        }

        /* Loading animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }


        .glow-border {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5),
                0 0 30px rgba(59, 130, 246, 0.3),
                0 0 45px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .dark .glow-border {
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.5),
                0 0 40px rgba(96, 165, 250, 0.3),
                0 0 60px rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.4);
        }

        /* Mobile Bottom Navigation */
        @media (max-width: 768px) {
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                z-index: 50;
            }

            .dark .bottom-nav {
                background: #1f2937;
                border-top: 1px solid #374151;
            }
        }


        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {

            /* Reduce header sizes on mobile */
            .glow-border {
                padding: 1rem;
            }

            /* Adjust table font sizes */
            table {
                font-size: 0.875rem;
            }

            /* Reduce button padding on mobile */
            button {
                padding: 0.5rem 1rem;
            }

            /* Sticky save button positioning */
            .sticky.bottom-4 {
                bottom: 5rem;
                /* Account for bottom navigation */
            }
        }

        /* Improve table scrolling on mobile */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }

        /* Ensure inputs are easily tappable on mobile */
        input[type="number"] {
            min-height: 40px;
            font-size: 16px;
            /* Prevent zoom on iOS */
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-shimmer {
            animation: shimmer 2s infinite;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Main App Container -->
    <div x-data="mainApp()" x-init="init()" class="min-h-screen flex">

        <!-- Sidebar (Desktop) -->
        <aside x-show="$store.app.isLoggedIn" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0"
            class="hidden md:flex flex-col w-64 bg-white dark:bg-gray-800 glow-border rounded-r-2xl">

            <!-- Logo Section -->
            <div class="p-4 border-b dark:border-gray-700">
                <div class="flex items-center space-x-3">
                    <div class="p-3 rounded-xl bg-blue-100 dark:bg-blue-900/30">
                        <i class="fas fa-wine-bottle text-3xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold" x-text="t('system_name')"></h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="t('inventory_management')"></p>
                    </div>
                </div>

                <div x-show="$store.app.user.currentStore" x-transition
                    class="mt-4 text-center bg-blue-50 dark:bg-blue-900/50 border border-blue-200 dark:border-blue-800 rounded-lg p-2">
                    <p class="text-xs text-blue-800 dark:text-blue-300 font-semibold">สาขาปัจจุบัน</p>
                    <p class="text-base font-bold text-blue-600 dark:text-blue-400 truncate"
                        x-text="getCurrentStoreName()"></p>
                </div>
            </div>

            <!-- Store Selector (Owner/Manager) -->
            <div class="p-4 border-b dark:border-gray-700">
                <div x-show="canSwitchStore()">
                    <label class="text-xs text-gray-600 dark:text-gray-400" x-text="t('current_store')"></label>
                    <select @change="selectStore($event.target.value)" x-model="$store.app.user.currentStore"
                        class="w-full mt-1 px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- <span x-text="t('select_store')"></span> --</option>
                        <template x-for="store in $store.app.user.stores">
                            <option :value="store.store_id" :selected="store.store_id === $store.app.user.currentStore"
                                x-text="store.name"></option>
                        </template>
                    </select>
                </div>
                <div x-show="$store.app.user.role === 'staff' && $store.app.user.currentStore">
                    <label class="text-xs text-gray-600 dark:text-gray-400">สาขาที่ดูแล</label>
                    <p class="text-base font-semibold mt-1 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-center"
                        x-text="getCurrentStoreName()"></p>
                </div>
            </div>

            <!-- Menu Items -->
            <nav class="flex-1 p-4">
                <template x-for="group in getGroupedMenuItems()" :key="group.id">
                    <div class="mb-2">
                        <!-- Menu Group Header -->
                        <button @click="toggleMenuGroup(group.id)"
                            class="menu-group-header w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-semibold">
                            <div class="flex items-center space-x-3">
                                <i :class="group.icon" class="w-5"></i>
                                <span x-text="t(group.label)"></span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-200"
                                :class="{ 'rotate-180': isMenuGroupExpanded(group.id) }"></i>
                        </button>

                        <!-- Submenu Items -->
                        <div x-show="isMenuGroupExpanded(group.id)"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 -translate-y-2"
                            x-transition:enter-end="opacity-100 translate-y-0"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 translate-y-0"
                            x-transition:leave-end="opacity-0 -translate-y-2" class="mt-1 ml-4 space-y-1">
                            <template x-for="item in group.items" :key="item.id">
                                <button @click="navigateTo(item.page)"
                                    :class="{ 'active bg-blue-50 dark:bg-blue-900/50 text-blue-600': $store.app.ui.currentPage === item.page }"
                                    class="menu-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">
                                    <i :class="item.icon" class="w-4 text-xs"></i>
                                    <span x-text="t(item.label)"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </nav>

            <!-- User Info -->
            <div class="p-4 border-t dark:border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-user-circle text-2xl"></i>
                        <div>
                            <p class="font-semibold text-sm" x-text="$store.app.user.username"></p>
                            <p class="text-xs text-gray-500 capitalize" x-text="t($store.app.user.role)"></p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button @click="toggleLanguage()" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded"
                            :title="t('switch_language')">
                            <span class="text-xs font-bold" x-text="$store.app.language === 'th' ? 'EN' : 'TH'"></span>
                        </button>
                        <button @click="toggleDarkMode()" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded">
                            <i class="fas" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
                        </button>
                    </div>
                </div>
                <button @click="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i><span x-text="t('logout')"></span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col" x-show="$store.app.isLoggedIn">

            <!-- Top Bar (Mobile) -->
            <header class="md:hidden bg-white dark:bg-gray-800 shadow-sm p-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-wine-bottle text-2xl text-purple-600"></i>
                    <div>
                        <h1 class="font-bold text-base leading-tight" x-text="t('system_name')"></h1>

                        <div x-show="$store.app.user.currentStore" x-transition
                            class="flex items-center space-x-1 text-blue-600 dark:text-blue-400">
                            <i class="fas fa-store text-xs"></i>
                            <span class="text-xs font-semibold" x-text="getCurrentStoreName()"></span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <button @click="toggleLanguage()" class="p-2">
                        <span class="text-xs font-bold" x-text="$store.app.language === 'th' ? 'EN' : 'TH'"></span>
                    </button>
                    <button @click="toggleDarkMode()" class="p-2">
                        <i class="fas" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                    <button @click="$store.app.ui.showMobileMenu = !$store.app.ui.showMobileMenu">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 p-4 md:p-6 overflow-y-auto pb-24" id="mainContent"
                @scroll.debounce.50ms="handleScroll($el)">
                <div x-html="renderCurrentPage()"></div>
            </div>

            <!-- Bottom Navigation (Mobile) -->
            <nav class="md:hidden bottom-nav glow-border-top">
                <div class="flex justify-around items-center py-2">
                    <!-- ปุ่ม 1: แดชบอร์ดสต๊อก -->
                    <button @click="navigateTo('dashboard')"
                        :class="{ 'text-blue-500': $store.app.ui.currentPage === 'dashboard' }"
                        class="flex flex-col items-center py-2 px-2">
                        <i class="fas fa-chart-pie text-xl mb-1"></i>
                        <span class="text-xs">สต๊อก</span>
                    </button>

                    <!-- ปุ่ม 2: POS Upload -->
                    <button @click="navigateTo('pdf_upload')"
                        :class="{ 'text-blue-500': $store.app.ui.currentPage === 'pdf_upload' }"
                        class="flex flex-col items-center py-2 px-2">
                        <i class="fas fa-file-pdf text-xl mb-1"></i>
                        <span class="text-xs">POS</span>
                    </button>

                    <!-- ปุ่ม 3: Mode Selector (ไม่ clickable) -->
                    <div class="flex flex-col items-center py-2 px-3 opacity-60">
                        <div class="flex items-center space-x-1">
                            <i class="fas fa-chevron-left text-xs text-gray-400"></i>
                            <i class="fas fa-grip-lines-vertical text-xl text-gray-400"></i>
                            <i class="fas fa-chevron-right text-xs text-gray-400"></i>
                        </div>
                        <span class="text-xs text-gray-400 mt-1">โหมด</span>
                    </div>

                    <!-- ปุ่ม 4: แดชบอร์ดฝากเหล้า -->
                    <button @click="navigateTo('dashboard_deposit')"
                        :class="{ 'text-blue-500': $store.app.ui.currentPage === 'dashboard_deposit' }"
                        class="flex flex-col items-center py-2 px-2">
                        <i class="fas fa-wine-bottle text-xl mb-1"></i>
                        <span class="text-xs">ฝากเหล้า</span>
                    </button>

                    <!-- ปุ่ม 5: ค้นหาประวัติ -->
                    <button @click="navigateTo('deposit_history')"
                        :class="{ 'text-blue-500': $store.app.ui.currentPage === 'deposit_history' }"
                        class="flex flex-col items-center py-2 px-2">
                        <i class="fas fa-search text-xl mb-1"></i>
                        <span class="text-xs">ค้นหา</span>
                    </button>
                </div>
            </nav>
        </main>


        <div x-show="$store.app.ui.showMobileMenu" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-4 z-50 bg-white dark:bg-gray-900 glow-border rounded-2xl p-4 flex flex-col md:hidden"
            @click.away="$store.app.ui.showMobileMenu = false">

            <div class="flex justify-between items-center pb-4 border-b dark:border-gray-700">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-wine-bottle text-2xl text-purple-600"></i>
                    <h1 class="text-lg font-bold" x-text="t('system_name')"></h1>
                </div>
                <button @click="$store.app.ui.showMobileMenu = false" class="p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="py-4 border-b dark:border-gray-700">
                <div x-show="canSwitchStore()">
                    <label class="text-xs text-gray-600 dark:text-gray-400" x-text="t('current_store')"></label>
                    <select @change="selectStore($event.target.value)" x-model="$store.app.user.currentStore"
                        class="w-full mt-1 px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                        <option value="">-- <span x-text="t('select_store')"></span> --</option>
                        <template x-for="store in $store.app.user.stores">
                            <option :value="store.store_id" :selected="store.store_id === $store.app.user.currentStore"
                                x-text="store.name"></option>
                        </template>
                    </select>
                </div>
                <div x-show="$store.app.user.role === 'staff' && $store.app.user.currentStore">
                    <label class="text-xs text-gray-600 dark:text-gray-400">สาขาที่ดูแล</label>
                    <p class="text-lg font-semibold mt-1" x-text="getCurrentStoreName()"></p>
                </div>
            </div>

            <nav class="flex-1 py-4 space-y-2 overflow-y-auto">
                <template x-for="group in getGroupedMenuItems()" :key="group.id">
                    <div>
                        <!-- Menu Group Header -->
                        <button @click="toggleMenuGroup(group.id)"
                            class="w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-left font-semibold transition-colors">
                            <div class="flex items-center space-x-4">
                                <i :class="group.icon" class="w-5 text-lg"></i>
                                <span x-text="t(group.label)"></span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-200"
                                :class="{ 'rotate-180': isMenuGroupExpanded(group.id) }"></i>
                        </button>

                        <!-- Submenu Items -->
                        <div x-show="isMenuGroupExpanded(group.id)"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 -translate-y-2"
                            x-transition:enter-end="opacity-100 translate-y-0"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 translate-y-0"
                            x-transition:leave-end="opacity-0 -translate-y-2" class="mt-1 ml-4 space-y-1">
                            <template x-for="item in group.items" :key="item.id">
                                <button @click="navigateTo(item.page)"
                                    :class="{ 'bg-blue-50 dark:bg-blue-900/50 text-blue-600': $store.app.ui.currentPage === item.page }"
                                    class="w-full flex items-center space-x-4 px-4 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-left text-sm">
                                    <i :class="item.icon" class="w-4 text-sm"></i>
                                    <span x-text="t(item.label)"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </nav>

            <div class="pt-4 border-t dark:border-gray-700">
                <div class="flex items-center space-x-3 mb-4">
                    <i class="fas fa-user-circle text-3xl"></i>
                    <div>
                        <p class="font-semibold" x-text="$store.app.user.username"></p>
                        <p class="text-xs text-gray-500 capitalize" x-text="t($store.app.user.role)"></p>
                    </div>
                </div>
                <button @click="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i><span x-text="t('logout')"></span>
                </button>
            </div>
        </div>


        <!-- Loading Modal -->

        <div x-show="$store.app.ui.loadingModal" x-cloak
            class="fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-8 max-w-md mx-4 text-center w-full">
                <div x-show="!$store.app.ui.showProgressBar" class="mb-4 flex justify-center items-center space-x-2">
                    <div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
                <h3 class="text-xl font-semibold mb-2" x-text="$store.app.ui.loadingTitle"></h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4" x-text="$store.app.ui.loadingMessage"></p>

                <div x-show="$store.app.ui.showProgressBar" class="mt-4 space-y-2">
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500"
                            :style="'width: ' + $store.app.ui.progress + '%'"></div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 flex justify-between">
                        <span x-text="$store.app.ui.progressStatus"></span>
                        <span x-text="$store.app.ui.progress + '%'"></span>
                    </div>
                </div>
            </div>
        </div>


        <!-- Login Screen -->
        <div x-show="!$store.app.isLoggedIn"
            class="flex-1 flex items-center justify-center bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
                <div class="text-center mb-6">
                    <i class="fas fa-wine-bottle text-5xl text-purple-600 mb-4"></i>
                    <h2 class="text-2xl font-bold" x-text="t('system_name')"></h2>
                    <p class="text-gray-600 dark:text-gray-400" x-text="t('sign_in_continue')"></p>
                </div>

                <form @submit.prevent="login()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2" x-text="t('username')"></label>
                        <input type="text" x-model="loginForm.username" required
                            class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                            :placeholder="t('enter_username')">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2" x-text="t('password')"></label>
                        <input type="password" x-model="loginForm.password" required
                            class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                            :placeholder="t('enter_password')">
                    </div>
                    <button type="submit" :disabled="loginForm.loading"
                        class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50">
                        <i class="fas fa-sign-in-alt mr-2" x-show="!loginForm.loading"></i>
                        <i class="fas fa-spinner fa-spin mr-2" x-show="loginForm.loading"></i>
                        <span x-text="loginForm.loading ? t('signing_in') : t('sign_in')"></span>
                    </button>
                </form>

                <!-- Language Toggle for Login Screen -->
                <div class="mt-4 text-center">
                    <button @click="toggleLanguage()" class="text-sm text-gray-600 hover:text-gray-800">
                        <i class="fas fa-globe mr-1"></i>
                        <span x-text="$store.app.language === 'th' ? 'English' : 'ภาษาไทย'"></span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Alpine.js App Logic -->
    <script>
        // Language Translations
        const translations = {
            th: {
                // System
                system_name: 'ระบบนับสต๊อก',
                inventory_management: 'จัดการสินค้าคงคลัง',
                sign_in_continue: 'เข้าสู่ระบบเพื่อดำเนินการต่อ',
                username: 'ชื่อผู้ใช้',
                password: 'รหัสผ่าน',
                enter_username: 'กรอกชื่อผู้ใช้',
                enter_password: 'กรอกรหัสผ่าน',
                sign_in: 'เข้าสู่ระบบ',
                signing_in: 'กำลังเข้าสู่ระบบ...',
                logout: 'ออกจากระบบ',
                switch_language: 'เปลี่ยนภาษา',
                manual: 'คู่มือการใช้งาน',

                // Roles
                owner: 'เจ้าของ',
                accountant: 'บัญชี',
                manager: 'ผู้จัดการ',
                staff: 'พนักงาน',

                // Store
                current_store: 'สาขาปัจจุบัน',
                select_store: 'เลือกสาขา',

                // Menu Items
                stock_system: 'ระบบนับสต็อก',
                deposit_system: 'ระบบฝากเหล้า',
                dashboard: 'แดชบอร์ด',
                products: 'สินค้า',
                manual_count: 'นับสต๊อก',
                pdf_upload: 'POS Upload',
                comparison: 'จัดการผลต่าง',
                users: 'ผู้ใช้',
                stores: 'สาขา',
                settings: 'ตั้งค่า',
                view_result: 'ดูผลลัพธ์',

                // Deposit System Menu Items
                deposit_management: 'จัดการฝาก/เบิก',
                deposit_dashboard: 'Dashboard ฝากเหล้า',
                deposit_history: 'ค้นหา/ประวัติเบิก',
                central_transfer: 'โอนคลังกลาง',
                hq_transfer: 'รับโอนจากสาขา',

                // Dashboard
                inventory_dashboard: 'แดชบอร์ดสินค้าคงคลัง',
                total_items: 'รายการทั้งหมด',
                sum_diff_qty: 'ผลรวมความต่าง (ชิ้น)',
                shrinkage_rate: 'อัตราการสูญหาย',
                top_offender: 'สินค้าที่มีปัญหามากสุด',
                top_5_by_diff: '5 อันดับความแตกต่าง',
                diff_by_category: 'ความแตกต่างตามหมวดหมู่',
                latest_discrepancies: 'ความแตกต่างล่าสุด',
                over: 'เกิน',
                short: 'ขาด',
                high: 'สูง',
                medium: 'กลาง',
                low: 'ต่ำ',
                today: 'วันนี้',
                this_week: 'สัปดาห์นี้',
                this_month: 'เดือนนี้',
                over_short_indicator: '(+ = เกิน | - = ขาด)',
                stock_accuracy_measure: 'ตัวชี้วัดความแม่นยำของสต๊อก',
                diff_short: 'ผลต่าง',
                show_label: 'แสดง',
                sort_label: 'เรียง',
                abs_diff: 'ผลต่าง (ทั้งหมด)',
                item_label: 'รายการ',
                pos_label: 'POS',
                count_label: 'นับได้',
                desc_short: 'มากไปน้อย',
                asc_short: 'น้อยไปมาก',
                direction_label: 'ทิศทาง',
                no_data_period: 'ไม่มีข้อมูลสำหรับช่วงวันที่ที่เลือก',
                showing_label: 'แสดง',
                to_label: 'ถึง',
                of_label: 'จาก',
                items_label: 'รายการ',
                previous_button: 'ก่อนหน้า',
                next_button: 'ถัดไป',

                // Products
                add_product: 'เพิ่มสินค้า',
                edit_product: 'แก้ไขสินค้า',
                delete_product: 'ลบสินค้า',
                product_code: 'รหัสสินค้า',
                product_name: 'ชื่อสินค้า',
                category: 'หมวดหมู่',
                unit: 'หน่วย',
                cost_price: 'ราคาทุน',
                selling_price: 'ราคาขาย',
                view_image: 'ดูรูป',
                upload_image: 'อัพโหลดรูป',
                search_products: 'ค้นหาสินค้า...',

                // Manual Count
                count_stock: 'นับสต๊อก',
                count_date: 'วันที่นับ',
                already_counted: 'นับแล้ว',
                not_counted: 'ยังไม่นับ',
                save_count: 'บันทึกการนับ',
                count_quantity: 'จำนวนที่นับได้',
                matched_items: 'รายการที่ตรง',
                unmatched_items: 'รายการที่ไม่ตรง',

                // PDF Upload
                upload_pdf: 'อัพโหลด PDF',
                select_date: 'เลือกวันที่',
                drop_pdf_here: 'ลากไฟล์ PDF มาวางที่นี่',
                or_click_browse: 'หรือคลิกเพื่อเลือกไฟล์',
                recent_uploads: 'การอัพโหลดล่าสุด',
                processing_ocr: 'กำลังประมวลผลไฟล์PDF...',
                add_manual_item: 'เพิ่มรายการเอง',

                // Comparison
                comparison_results: 'ผลการเปรียบเทียบ',
                pos_quantity: 'จำนวน POS',
                manual_quantity: 'จำนวนนับมือ',
                difference: 'ผลต่าง',
                status: 'สถานะ',
                explain: 'ชี้แจง',
                explanation: 'คำชี้แจง',


                // Users
                add_user: 'เพิ่มผู้ใช้',
                edit_user: 'แก้ไขผู้ใช้',
                delete_user: 'ลบผู้ใช้',
                change_password: 'เปลี่ยนรหัสผ่าน',
                select_stores: 'เลือกสาขา',
                active: 'ใช้งาน',
                inactive: 'ไม่ใช้งาน',

                // Stores  
                create_store: 'สร้างสาขา',
                store_name: 'ชื่อสาขา',
                store_code: 'รหัสสาขา',
                line_token: 'Line Token',
                manage: 'จัดการ',

                // Settings
                save_settings: 'บันทึกการตั้งค่า',
                line_notify_config: 'ตั้งค่า Line Notify',
                daily_notification_time: 'เวลาแจ้งเตือนนับสต๊อกประจำวัน',
                evening_alert_time: 'เวลาแจ้งเตือนรอบเย็น',
                auto_compare: 'เปรียบเทียบอัตโนมัติ',
                discrepancy_threshold: 'เกณฑ์ความแตกต่าง (%)',
                notification_status: 'สถานะการแจ้งเตือน',
                ready: 'พร้อมใช้งาน',
                not_ready: 'ไม่พร้อมใช้งาน',

                // Common
                save: 'บันทึก',
                cancel: 'ยกเลิก',
                confirm: 'ยืนยัน',
                delete: 'ลบ',
                edit: 'แก้ไข',
                view: 'ดู',
                search: 'ค้นหา',
                filter: 'กรอง',
                export: 'ส่งออก',
                import: 'นำเข้า',
                loading: 'กำลังโหลด...',
                no_data: 'ไม่มีข้อมูล',
                success: 'สำเร็จ',
                error: 'ผิดพลาด',
                warning: 'คำเตือน',
                info: 'ข้อมูล',
                loading: 'กำลังโหลด',
                loading_data: 'กำลังโหลดข้อมูล',
                reading_file: 'กำลังอ่านไฟล์',
                deleting: 'กำลังลบข้อมูล',
                saving: 'กำลังบันทึก',
                processing_ocr: 'กำลังประมวลผล OCR',
                please_wait: 'กรุณารอสักครู่...',
                all: 'ทั้งหมด'
            },
            en: {
                // System
                system_name: 'Stock Count System',
                inventory_management: 'Inventory Management',
                sign_in_continue: 'Sign in to continue',
                username: 'Username',
                password: 'Password',
                enter_username: 'Enter username',
                enter_password: 'Enter password',
                sign_in: 'Sign In',
                signing_in: 'Signing in...',
                logout: 'Logout',
                switch_language: 'Switch Language',
                manual: 'User Manual',

                // Roles
                owner: 'Owner',
                accountant: 'Accountant',
                manager: 'Manager',
                staff: 'Staff',

                // Store
                current_store: 'Current Store',
                select_store: 'Select Store',

                // Menu Items
                stock_system: 'Stock System',
                deposit_system: 'Deposit System',
                dashboard: 'Dashboard',
                products: 'Products',
                manual_count: 'Manual Count',
                pdf_upload: 'POS Upload',
                deposit_management: 'Deposit Management',
                deposit_dashboard: 'Deposit Dashboard',
                deposit_history: 'Deposit History',
                central_transfer: 'Central Transfer',
                comparison: 'Manage difference',
                users: 'Users',
                stores: 'Stores',
                settings: 'Settings',
                view_result: 'View Result',

                // Dashboard
                inventory_dashboard: 'Inventory Dashboard',
                total_items: 'Total Items',
                sum_diff_qty: 'Sum Diff (Qty)',
                shrinkage_rate: '% Shrinkage Rate',
                top_offender: 'Top Offender',
                top_5_by_diff: 'Top 5 by Diff',
                diff_by_category: 'Diff by Category',
                latest_discrepancies: 'Latest Discrepancies',
                over: 'over',
                short: 'short',
                high: 'high',
                medium: 'medium',
                low: 'low',
                today: 'Today',
                this_week: 'This Week',
                this_month: 'This Month',
                over_short_indicator: '(+ = Over | - = Missing)',
                stock_accuracy_measure: 'A measure of stock accuracy',
                diff_short: 'Diff',
                show_label: 'Show',
                sort_label: 'Sort',
                abs_diff: 'Abs Diff',
                item_label: 'Item',
                pos_label: 'POS',
                count_label: 'Count',
                desc_short: 'Desc',
                asc_short: 'Asc',
                direction_label: 'Direction',
                no_data_period: 'No data available for the selected period.',
                showing_label: 'Showing',
                to_label: 'to',
                of_label: 'of',
                items_label: 'items',
                previous_button: 'Previous',
                next_button: 'Next',

                // Products
                add_product: 'Add Product',
                edit_product: 'Edit Product',
                delete_product: 'Delete Product',
                product_code: 'Product Code',
                product_name: 'Product Name',
                category: 'Category',
                unit: 'Unit',
                cost_price: 'Cost Price',
                selling_price: 'Selling Price',
                view_image: 'View Image',
                upload_image: 'Upload Image',
                search_products: 'Search products...',

                // Manual Count
                count_stock: 'Count Stock',
                count_date: 'Count Date',
                already_counted: 'Already Counted',
                not_counted: 'Not Counted',
                save_count: 'Save Count',
                count_quantity: 'Count Quantity',
                matched_items: 'Matched Items',
                unmatched_items: 'Unmatched Items',

                // PDF Upload
                upload_pdf: 'Upload PDF',
                select_date: 'Select Date',
                drop_pdf_here: 'Drop PDF file here',
                or_click_browse: 'or click to browse',
                recent_uploads: 'Recent Uploads',
                processing_ocr: 'Processing OCR...',
                add_manual_item: 'Add Manual Item',

                // Comparison
                comparison_results: 'Comparison Results',
                pos_quantity: 'POS Quantity',
                manual_quantity: 'Manual Quantity',
                difference: 'Difference',
                status: 'Status',
                explain: 'Explain',
                explanation: 'Explanation',

                // Users
                add_user: 'Add User',
                edit_user: 'Edit User',
                delete_user: 'Delete User',
                change_password: 'Change Password',
                select_stores: 'Select Stores',
                active: 'Active',
                inactive: 'Inactive',

                // Stores
                create_store: 'Create Store',
                store_name: 'Store Name',
                store_code: 'Store Code',
                line_token: 'Line Token',
                manage: 'Manage',

                // Settings
                save_settings: 'Save Settings',
                line_notify_config: 'Line Notify Configuration',
                daily_notification_time: 'Daily Stock Count Notification Time',
                evening_alert_time: 'Evening Alert Time',
                auto_compare: 'Auto Compare',
                discrepancy_threshold: 'Discrepancy Threshold (%)',
                notification_status: 'Notification Status',
                ready: 'Ready',
                not_ready: 'Not Ready',

                // Common
                save: 'Save',
                cancel: 'Cancel',
                confirm: 'Confirm',
                delete: 'Delete',
                edit: 'Edit',
                view: 'View',
                search: 'Search',
                filter: 'Filter',
                export: 'Export',
                import: 'Import',
                loading: 'Loading...',
                no_data: 'No Data',
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Info',
                loading: 'Loading',
                loading_data: 'Loading Data',
                reading_file: 'Reading File',
                deleting: 'Deleting',
                saving: 'Saving',
                processing_ocr: 'Processing OCR',
                please_wait: 'Please wait...',
                all: 'All'
            }
        };


        // Global Store
        document.addEventListener('alpine:init', () => {
            Alpine.store('app', {
                isLoggedIn: false,
                language: 'th',
                webAppUrl: '', // เพิ่ม webAppUrl เพื่อเก็บ URL ของ Web App
                user: {
                    id: null,
                    username: null,
                    role: null,
                    stores: [],
                    currentStore: null,
                    sheetId: null,
                    lineToken: null,
                    isCentralStore: false
                },
                ui: {
                    currentPage: 'dashboard',
                    showMobileMenu: false,
                    loading: false,
                    loadingModal: false,
                    loadingTitle: 'กำลังโหลด',
                    loadingMessage: 'กรุณารอสักครู่...',
                    showProgressBar: false,
                    progress: 0,
                    progressStatus: ''
                }
            });

            // Alpine store for Deposit Dashboard
            Alpine.store('depositDashboard', {
                loading: false,
                storeName: '',
                selectedPeriod: 'daily', // 'daily', 'weekly', 'monthly'
                data: {
                    totalDeposits: 0,
                    inStore: 0,
                    withdrawn: 0,
                    expired: 0,
                    transferred: 0,
                    expiringSoon: 0,
                    pendingWithdrawals: 0,
                    averageDepositDays: 0,
                    totalCustomers: 0,
                    newCustomersThisMonth: 0,
                    totalValue: 0,
                    byProductType: {},
                    byCategory: {},
                    depositsByPeriod: { daily: [], weekly: [], monthly: [] },
                    withdrawalsByPeriod: { daily: [], weekly: [], monthly: [] },
                    expiringSoonList: [],
                    expiredList: []
                }
            });

            // Central Transfer Store
            Alpine.store('centralTransfer', {
                transfers: [],
                pendingTransfers: [],
                loading: false
            });
        });

        // Alpine component for Deposit Dashboard
        function depositDashboardData() {
            return {
                activeTab: 'all',

                init() {
                    // Watch for period changes and update computed data
                    this.$watch('$store.depositDashboard.selectedPeriod', () => {
                        // Data will automatically update through computed properties
                    });
                },

                get data() {
                    const storeData = Alpine.store('depositDashboard')?.data || {};
                    const period = Alpine.store('depositDashboard')?.selectedPeriod || 'daily';

                    // Calculate period-specific values
                    let periodDeposits = 0;
                    let periodWithdrawals = 0;

                    if (period === 'daily') {
                        periodDeposits = storeData.periodDepositsDaily || 0;
                        periodWithdrawals = storeData.periodWithdrawalsDaily || 0;
                    } else if (period === 'weekly') {
                        periodDeposits = storeData.periodDepositsWeekly || 0;
                        periodWithdrawals = storeData.periodWithdrawalsWeekly || 0;
                    } else if (period === 'monthly') {
                        periodDeposits = storeData.periodDepositsMonthly || 0;
                        periodWithdrawals = storeData.periodWithdrawalsMonthly || 0;
                    }

                    return {
                        ...storeData,
                        periodDeposits,
                        periodWithdrawals
                    };
                },

                refreshDashboard() {
                    const storeId = Alpine.store('app').user.currentStore;
                    if (!storeId) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาเลือกสาขา',
                            text: 'กรุณาเลือกสาขาก่อนรีเฟรชข้อมูล'
                        });
                        return;
                    }

                    // Set loading state
                    Alpine.store('depositDashboard').loading = true;

                    google.script.run
                        .withSuccessHandler((response) => {
                            if (response.success) {
                                Alpine.store('depositDashboard').storeName = response.storeName || '';
                                Alpine.store('depositDashboard').data = response.data || {};

                                Swal.fire({
                                    icon: 'success',
                                    title: 'รีเฟรชสำเร็จ',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด',
                                    text: response.message || 'ไม่สามารถโหลดข้อมูลได้'
                                });
                            }

                            Alpine.store('depositDashboard').loading = false;
                        })
                        .withFailureHandler((error) => {
                            console.error('Error refreshing dashboard:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || 'ไม่สามารถโหลดข้อมูลได้'
                            });
                            Alpine.store('depositDashboard').loading = false;
                        })
                        .getDashboardDepositData(storeId);
                }
            };
        }

        // Deposit History Component
        function depositHistoryData() {
            return {
                loading: false,
                searchQuery: '',
                filterStatus: 'all',
                allDeposits: [],

                init() {
                    console.log('Deposit History initialized');
                    this.loadAllDeposits();
                },

                async loadAllDeposits() {
                    this.loading = true;
                    const storeId = Alpine.store('app').user?.currentStore;
                    if (!storeId) {
                        console.error('No store ID found');
                        this.loading = false;
                        return;
                    }

                    console.log('Loading all deposits for store:', storeId);

                    try {
                        google.script.run
                            .withSuccessHandler((response) => {
                                console.log('Deposits loaded:', response);
                                if (response.success) {
                                    this.allDeposits = response.deposits || [];
                                } else {
                                    console.error('Failed to load deposits:', response.message);
                                    Swal.fire('Error', response.message || 'ไม่สามารถโหลดข้อมูลได้', 'error');
                                }
                                this.loading = false;
                            })
                            .withFailureHandler((error) => {
                                console.error('Error loading deposits:', error);
                                Swal.fire('Error', 'เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
                                this.loading = false;
                            })
                            .getAllDepositsWithHistory(storeId);
                    } catch (error) {
                        console.error('Exception loading deposits:', error);
                        this.loading = false;
                    }
                },

                get filteredDeposits() {
                    let filtered = this.allDeposits;

                    // Filter by status
                    if (this.filterStatus !== 'all') {
                        if (this.filterStatus === 'withdrawn') {
                            // Include both 'withdrawn' and 'fully_withdrawn'
                            filtered = filtered.filter(d => d.status === 'withdrawn' || d.status === 'fully_withdrawn');
                        } else {
                            filtered = filtered.filter(d => d.status === this.filterStatus);
                        }
                    }

                    // Filter by search query
                    if (this.searchQuery.trim()) {
                        const query = this.searchQuery.toLowerCase().trim();
                        filtered = filtered.filter(d => {
                            return (
                                (d.code && d.code.toLowerCase().includes(query)) ||
                                (d.customer_name && d.customer_name.toLowerCase().includes(query)) ||
                                (d.customer_phone && d.customer_phone.includes(query)) ||
                                (d.product_name && d.product_name.toLowerCase().includes(query))
                            );
                        });
                    }

                    return filtered;
                },

                // คำนวณจำนวนวันคงเหลือจากวันฝาก (30 วัน - จำนวนวันที่ฝากแล้ว)
                getDaysRemaining(depositDateStr) {
                    if (!depositDateStr) return null;

                    let depositDate;

                    // Parse date string (format: MM/DD/YYYY HH:mm:ss from Google Sheets)
                    if (typeof depositDateStr === 'string' && depositDateStr.includes('/')) {
                        const datePart = depositDateStr.split(' ')[0];
                        depositDate = new Date(datePart);
                    } else {
                        depositDate = new Date(depositDateStr);
                    }

                    // Check if date is valid
                    if (isNaN(depositDate.getTime())) {
                        return null;
                    }

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    depositDate.setHours(0, 0, 0, 0);

                    // คำนวณจำนวนวันที่ฝากแล้ว
                    const diffTime = today - depositDate;
                    const daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    // จำนวนวันคงเหลือ = 30 - วันที่ฝากแล้ว
                    const daysRemaining = 30 - daysPassed;
                    return daysRemaining;
                },

                // ดึงสีตามจำนวนวันคงเหลือ
                getDaysRemainingColor(days) {
                    if (days === null || days <= 0) return 'text-red-600';
                    if (days > 15) return 'text-green-600';
                    if (days >= 7) return 'text-yellow-600';
                    return 'text-red-600';
                },

                // แสดงข้อความวันคงเหลือ
                getDaysRemainingText(depositDateStr) {
                    const days = this.getDaysRemaining(depositDateStr);
                    if (days === null) return '';
                    if (days <= 0) return 'หมดอายุ';
                    return `(${days} วัน)`;
                },

                // แปลงวันที่เป็นรูปแบบไทย (DD/MM/YYYY+543)
                formatThaiDate(dateStr) {
                    if (!dateStr) return '-';

                    let date;
                    if (typeof dateStr === 'string') {
                        // Handle various date formats
                        if (dateStr.includes('GMT') || dateStr.includes('T')) {
                            date = new Date(dateStr);
                        } else if (dateStr.includes('/')) {
                            const parts = dateStr.split(' ')[0].split('/');
                            // MM/DD/YYYY format from Google Sheets
                            date = new Date(parts[2], parts[0] - 1, parts[1]);
                        } else {
                            date = new Date(dateStr);
                        }
                    } else {
                        date = new Date(dateStr);
                    }

                    if (isNaN(date.getTime())) return '-';

                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear() + 543; // แปลงเป็น พ.ศ.

                    return `${day}/${month}/${year}`;
                }
            };
        }

        // Branch Transfer Component - สำหรับสาขาปกติ
        function branchTransferData() {
            return {
                activeTab: 'expired',
                selectedItems: [],
                showTransferModal: false,
                transferNote: '',
                createdBy: '',
                photoPreview: null,
                photoBase64: null,
                submitting: false,
                loading: false,
                summary: { expired: 0, pending: 0, confirmed: 0 },
                expiredList: [],
                pendingList: [],
                confirmedList: [],

                get currentList() {
                    if (this.activeTab === 'expired') return this.expiredList;
                    if (this.activeTab === 'pending') return this.pendingList;
                    if (this.activeTab === 'confirmed') return this.confirmedList;
                    return [];
                },

                get selectedCount() {
                    return this.selectedItems.length;
                },

                get selectedDeposits() {
                    return this.expiredList.filter(item => this.selectedItems.includes(item.deposit_id));
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    const day = d.getDate().toString().padStart(2, '0');
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const year = d.getFullYear() + 543;
                    return day + '/' + month + '/' + year;
                },

                init() {
                    this.loadSummary();
                    this.loadTabData('expired');
                },

                loadSummary() {
                    const storeId = Alpine.store('app').user.currentStore;
                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result.success) {
                                this.summary = result.data;
                            }
                        })
                        .handleDepositSystemAPI({ action: 'getBranchTransferSummary', storeId: storeId });
                },

                loadTabData(tab) {
                    this.loading = true;
                    this.selectedItems = [];
                    const storeId = Alpine.store('app').user.currentStore;
                    let action = '';
                    if (tab === 'expired') action = 'getExpiredDeposits';
                    else if (tab === 'pending') action = 'getBranchPendingTransfers';
                    else if (tab === 'confirmed') action = 'getBranchConfirmedTransfers';

                    google.script.run
                        .withSuccessHandler((result) => {
                            this.loading = false;
                            if (result.success) {
                                if (tab === 'expired') this.expiredList = result.data || [];
                                else if (tab === 'pending') this.pendingList = result.data || [];
                                else if (tab === 'confirmed') this.confirmedList = result.data || [];
                            }
                        })
                        .withFailureHandler((error) => {
                            this.loading = false;
                            console.error('Load error:', error);
                        })
                        .handleDepositSystemAPI({ action: action, storeId: storeId });
                },

                switchTab(tab) {
                    this.activeTab = tab;
                    this.loadTabData(tab);
                },

                toggleSelect(depositId) {
                    const idx = this.selectedItems.indexOf(depositId);
                    if (idx > -1) {
                        this.selectedItems.splice(idx, 1);
                    } else {
                        this.selectedItems.push(depositId);
                    }
                },

                isSelected(depositId) {
                    return this.selectedItems.includes(depositId);
                },

                selectAll() {
                    if (this.selectedItems.length === this.currentList.length) {
                        this.selectedItems = [];
                    } else {
                        this.selectedItems = this.currentList.map(t => t.deposit_id);
                    }
                },

                openTransferModal() {
                    if (this.selectedItems.length === 0) {
                        Swal.fire('แจ้งเตือน', 'กรุณาเลือกรายการที่ต้องการโอน', 'warning');
                        return;
                    }
                    this.createdBy = Alpine.store('app').user.username;
                    this.showTransferModal = true;
                },

                closeTransferModal() {
                    this.showTransferModal = false;
                    this.transferNote = '';
                    this.createdBy = '';
                    this.photoPreview = null;
                    this.photoBase64 = null;
                },

                handlePhotoUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.photoPreview = e.target.result;
                        this.photoBase64 = e.target.result.split(',')[1];
                    };
                    reader.readAsDataURL(file);
                },

                submitTransfer() {
                    if (!this.createdBy.trim()) {
                        Swal.fire('แจ้งเตือน', 'กรุณาระบุชื่อผู้ส่ง', 'warning');
                        return;
                    }
                    this.submitting = true;
                    const storeId = Alpine.store('app').user.currentStore;

                    google.script.run
                        .withSuccessHandler((result) => {
                            this.submitting = false;
                            if (result.success) {
                                Swal.fire('สำเร็จ', 'ส่งคำขอโอนเรียบร้อยแล้ว', 'success');
                                this.closeTransferModal();
                                this.selectedItems = [];
                                this.loadSummary();
                                this.loadTabData(this.activeTab);
                            } else {
                                Swal.fire('ผิดพลาด', result.message, 'error');
                            }
                        })
                        .withFailureHandler((error) => {
                            this.submitting = false;
                            Swal.fire('ผิดพลาด', error.message, 'error');
                        })
                        .handleDepositSystemAPI({
                            action: 'createTransferRequest',
                            storeId: storeId,
                            depositIds: this.selectedItems,
                            note: this.transferNote,
                            createdBy: this.createdBy,
                            photo: this.photoBase64
                        });
                }
            };
        }

        // HQ Transfer Component - สำหรับคลังกลางรับของจากสาขา
        function hqTransferData() {
            return {
                activeTab: 'pending',
                showConfirmModal: false,
                showDetailModal: false,
                selectedTransfer: null,
                confirmNote: '',
                processing: false,
                loading: false,
                summary: { pending: 0, confirmed: 0 },
                pendingList: [],
                confirmedList: [],

                get currentList() {
                    if (this.activeTab === 'pending') return this.pendingList;
                    if (this.activeTab === 'confirmed') return this.confirmedList;
                    return [];
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    const day = d.getDate().toString().padStart(2, '0');
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const year = d.getFullYear() + 543;
                    return day + '/' + month + '/' + year;
                },

                init() {
                    this.loadSummary();
                    this.loadTabData('pending');
                },

                loadSummary() {
                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result.success) {
                                this.summary = result.data;
                            }
                        })
                        .handleDepositSystemAPI({ action: 'getHQTransferSummary' });
                },

                loadTabData(tab) {
                    this.loading = true;
                    let action = '';
                    if (tab === 'pending') action = 'getHQPendingTransfers';
                    else if (tab === 'confirmed') action = 'getHQConfirmedTransfers';

                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result.success) {
                                if (tab === 'pending') this.pendingList = result.data || [];
                                else if (tab === 'confirmed') this.confirmedList = result.data || [];
                            }
                            this.loading = false;
                        })
                        .withFailureHandler(() => {
                            this.loading = false;
                        })
                        .handleDepositSystemAPI({ action: action });
                },

                switchTab(tab) {
                    this.activeTab = tab;
                    this.loadTabData(tab);
                },

                openConfirmModal(transfer) {
                    this.selectedTransfer = transfer;
                    this.showConfirmModal = true;
                },

                closeConfirmModal() {
                    this.showConfirmModal = false;
                    this.selectedTransfer = null;
                    this.confirmNote = '';
                },

                openDetailModal(transfer) {
                    this.selectedTransfer = transfer;
                    this.showDetailModal = true;
                },

                closeDetailModal() {
                    this.showDetailModal = false;
                    this.selectedTransfer = null;
                },

                confirmReceive() {
                    if (!this.selectedTransfer) return;
                    this.processing = true;

                    google.script.run
                        .withSuccessHandler((result) => {
                            this.processing = false;
                            if (result.success) {
                                Swal.fire('สำเร็จ', 'รับโอนเรียบร้อยแล้ว', 'success');
                                this.closeConfirmModal();
                                this.reloadData();
                            } else {
                                Swal.fire('ผิดพลาด', result.message, 'error');
                            }
                        })
                        .withFailureHandler((error) => {
                            this.processing = false;
                            Swal.fire('ผิดพลาด', error.message, 'error');
                        })
                        .handleDepositSystemAPI({
                            action: 'confirmTransfer',
                            transferId: this.selectedTransfer.transfer_id,
                            note: this.confirmNote
                        });
                },

                rejectTransfer(transfer) {
                    Swal.fire({
                        title: 'ปฏิเสธการโอน?',
                        text: 'คุณต้องการปฏิเสธรายการนี้หรือไม่?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'ปฏิเสธ',
                        cancelButtonText: 'ยกเลิก'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            google.script.run
                                .withSuccessHandler((res) => {
                                    if (res.success) {
                                        Swal.fire('สำเร็จ', 'ปฏิเสธรายการเรียบร้อยแล้ว', 'success');
                                        this.reloadData();
                                    } else {
                                        Swal.fire('ผิดพลาด', res.message, 'error');
                                    }
                                })
                                .handleDepositSystemAPI({
                                    action: 'rejectTransfer',
                                    transferId: transfer.transfer_id
                                });
                        }
                    });
                },

                reloadData() {
                    this.loadSummary();
                    this.loadTabData(this.activeTab);
                }
            };
        }

        // Main App Function
        function mainApp() {
            return {
                getLocalDateString(date = new Date()) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },



                statusMap: {
                    pending_comparison: { text: 'รอเปรียบเทียบ', color: 'blue', icon: 'fa-hourglass-half' },
                    pending_explanation: { text: 'รอชี้แจง', color: 'yellow', icon: 'fa-pen-to-square' },
                    pending_approval: { text: 'รออนุมัติ', color: 'gray', icon: 'fa-user-clock' },
                    rejected: { text: 'ถูกปฏิเสธ', color: 'red', icon: 'fa-times-circle' },
                    completed: { text: 'เสร็จสิ้น', color: 'green', icon: 'fa-check-circle' }
                },



                stepIcons: {
                    'แจ้งเตือนนับสต็อก': 'fas fa-bell',
                    'สรุปผลต่าง': 'fas fa-balance-scale',
                    'พนักงานชี้แจง': 'fas fa-comment-dots',
                    'รอเจ้าของตัดสินใจ': 'fas fa-user-check',
                    'แจ้งผลการตัดสินใจ': 'fas fa-paper-plane',
                    'เสร็จสิ้น': 'fas fa-check-circle'
                },





                statusClasses: {
                    SUCCESS: { circle: 'bg-green-500', line: 'bg-green-500' },
                    PENDING: { circle: 'bg-yellow-500 animate-pulse', line: 'bg-gray-300 dark:bg-gray-600' },
                    SKIPPED: { circle: 'bg-gray-400', line: 'bg-gray-400' },
                    FAILED: { circle: 'bg-red-500', line: 'bg-gray-300 dark:bg-gray-600' }
                },




                isDashboardLoading: false,
                loginForm: {
                    username: '',
                    password: '',
                    loading: false
                },

                top5Mode: 'abs', // 'abs', 'over', 'short'
                discrepancySearch: '',
                discrepancySort: { key: 'difference', dir: 'desc' },
                discrepancyPageSize: 10,
                discrepancyCurrentPage: 1,

                activityHistory: {
                    loading: true,
                    filters: { dateFrom: '', dateTo: '', status: 'all' },
                    data: []
                },

                // State สำหรับ Sub Menu (เก็บสถานะการขยาย/ยุบของแต่ละ menu group)
                expandedMenus: {
                    stock: true,      // ระบบนับสต็อก (เปิดโดย default)
                    deposit: false,   // ระบบฝากเหล้า
                    settings: false,  // ตั้งค่า
                    manual: false     // คู่มือ
                },


                showAPIKeys: {
                    LINE_ACCESS_TOKEN: true,
                    GEMINI_API_KEY: true,
                    CLAUDE_API_KEY: true,
                    OPENAI_API_KEY: true,
                    IMGBB_API_KEY: true
                },

                // ตัวแปรสำหรับเก็บ settings
                masterSettings: {
                    LINE_ACCESS_TOKEN: '',
                    AI_PROVIDER: 'gemini',
                    GEMINI_API_KEY: '',
                    CLAUDE_API_KEY: '',
                    OPENAI_API_KEY: '',
                    IMGBB_API_KEY: '',
                    FOLLOW_UP_INTERVAL_HOURS: '2',
                    OWNER_GROUP_LINE_ID: ''
                },



                settingsData: {
                    group_line_id: '',
                    notify_time_daily: '08:00',
                    notify_days: 'Mon,Tue,Wed,Thu,Fri,Sat,Sun',
                    store_name: '',
                    store_code: ''
                },


                lineDashboard: {
                    loading: true,
                    // กำหนดให้วันเริ่มต้นเป็น "เมื่อวาน"
                    date: '',
                    data: []
                },

                productSearchTerm: '',
                productSort: {
                    key: 'product_name',
                    dir: 'asc'
                },


                showAddModal: false,
                showEditModal: false,
                isUploadingImage: false,
                newProduct: { // State สำหรับฟอร์มเพิ่มสินค้า
                    product_code: '',
                    product_name: '',
                    category: '',
                    unit: '',
                    cost_price: 0,
                    selling_price: 0,
                    min_stock: 0,
                    image_url: '',
                    active: true,
                    count_status: 'active'
                },
                editingProduct: {},

                isHeaderSticky: false,

                users: [],
                allStores: [], // สำหรับให้เลือกใน modal
                showAddUserModal: false,
                showEditUserModal: false,
                newUser: {
                    username: '',
                    password: '',
                    role: 'staff',
                    store_ids: [],
                    active: true
                },
                editingUser: {},

                recentUploads: [],
                ocrVerificationData: null,
                uploadStatus: {
                    uploaded: false,
                    fileName: '',
                    driveFileId: '' // เพิ่มใหม่
                },
                txtUploadDate: '',
                includeZeroQty: false,

                dashboardData: {
                    dateFrom: '',  // กำหนดเป็นค่าว่างก่อน
                    dateTo: '',    // กำหนดเป็นค่าว่างก่อน
                    stats: {
                        totalItems: 0,
                        sumDiff: 0,
                        shrinkageRate: 0,
                        topOffender: '-'
                    },
                    topDiffItems: [],
                    categoryData: [],
                    discrepancies: [],
                    // เพิ่มใหม่
                    todayStatus: {
                        manualCount: false,
                        txtUpload: false,
                        manualCountTime: '',
                        txtFileName: ''
                    }
                },
                charts: {},
                products: [],
                countData: {
                    date: '',
                    status: 'not_counted',
                    items: [],
                    matchedCount: 0,
                    unmatchedCount: 0,
                    countedBy: null, // เพิ่มใหม่
                    isEditing: false // เพิ่มใหม่
                },
                comparisonData: [],
                comparisonDate: '',
                dailySummaryData: [],
                showDetailsModal: false,
                modalData: {
                    date: '',
                    items: []
                },




                showPenaltyModal: false,
                penaltyData: { date: '', employee: '', amount: '', reason: '' },
                // Language function
                t(key) {
                    const lang = Alpine.store('app').language;
                    return translations[lang][key] || key;
                },

                toggleLanguage() {
                    const currentLang = Alpine.store('app').language;
                    const newLang = currentLang === 'th' ? 'en' : 'th';
                    Alpine.store('app').language = newLang;
                    localStorage.setItem('language', newLang);
                },




                formatDateTH(dateString) {
                    if (!dateString) return '';

                    // ตรวจสอบว่าเป็นรูปแบบไหน
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        // ถ้าปีอยู่หน้า (yyyy-mm-dd)
                        if (parts[0].length === 4) {
                            return `${parts[2].padStart(2, '0')}-${parts[1].padStart(2, '0')}-${parts[0]}`;
                        }
                        // ถ้าวันอยู่หน้า (dd-mm-yyyy) 
                        else if (parts[2].length === 4) {
                            return `${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}-${parts[2]}`;
                        }
                    }

                    return dateString;
                },

                init() {
                    // --- START: ส่วนที่แก้ไข ---
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = this.getLocalDateString(yesterday);

                    const today = this.getLocalDateString(); // บรรทัดนี้ยังคงไว้สำหรับส่วนอื่น
                    // --- END: สิ้นสุดส่วนแก้ไข ---

                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                    // --- START: แก้ไขการกำหนดค่าเริ่มต้น ---
                    // ตั้งค่าวันที่เริ่มต้นสำหรับทุกหน้าที่เกี่ยวข้องให้เป็น "เมื่อวาน"
                    this.txtUploadDate = yesterdayStr;
                    this.countData.date = yesterdayStr;
                    this.dashboardData.dateFrom = yesterdayStr;
                    this.dashboardData.dateTo = yesterdayStr;
                    this.discrepancyDashboard.filters.dateFrom = yesterdayStr;
                    this.discrepancyDashboard.filters.dateTo = yesterdayStr;
                    this.lineDashboard.date = yesterdayStr;
                    // --- END: แก้ไขการกำหนดค่าเริ่มต้น ---

                    // ส่วนของ "ประวัติการทำงาน" ยังคงใช้ช่วงเวลา 7 วันล่าสุดเหมือนเดิม
                    this.activityHistory.filters.dateFrom = this.getLocalDateString(sevenDaysAgo);
                    this.activityHistory.filters.dateTo = today;

                    // ดึง Web App URL จาก Backend
                    google.script.run
                        .withSuccessHandler(config => {
                            if (config && config.webAppUrl) {
                                Alpine.store('app').webAppUrl = config.webAppUrl;
                            }
                        })
                        .getFrontendConfig();

                    // โหลด Session และภาษา
                    const savedLang = localStorage.getItem('language') || 'th';
                    Alpine.store('app').language = savedLang;

                    const savedSession = localStorage.getItem('session');
                    if (savedSession) {
                        const session = JSON.parse(savedSession);
                        Alpine.store('app').user = session.user;
                        Alpine.store('app').isLoggedIn = true;

                        // ตรวจสอบว่าเป็น Central Store หรือไม่
                        this.checkIsCentralStore();

                        const initialPage = session.user.role === 'staff' ? 'activity_history' : 'dashboard';
                        this.navigateTo(initialPage);
                    }
                },

                async login() {
                    this.loginForm.loading = true;
                    google.script.run
                        .withSuccessHandler(result => { // สังเกตว่าข้อมูลที่ส่งกลับมาอยู่ในตัวแปร 'result'
                            if (result.success) {
                                Alpine.store('app').isLoggedIn = true;

                                let user = result.user;

                                // ถ้าผู้ใช้เป็น Staff และมีสาขาที่ได้รับมอบหมาย ให้เลืิอกสาขาแรกให้เลย
                                if (user.role === 'staff' && user.stores && user.stores.length > 0) {
                                    const firstStore = user.stores[0];
                                    user.currentStore = firstStore.store_id;
                                    user.sheetId = firstStore.sheet_id;
                                    user.lineToken = firstStore.line_token;
                                    console.log('Staff auto-selected store:', firstStore.name);
                                }

                                // --- START: แก้ไขบรรทัดนี้ ---
                                Alpine.store('app').webAppUrl = result.webAppUrl; // เปลี่ยนจาก response เป็น result
                                // --- END: แก้ไขบรรทัดนี้ ---

                                // อัปเดต user state ทั้งหมดในครั้งเดียว
                                Alpine.store('app').user = user;

                                // ตรวจสอบว่าเป็น Central Store หรือไม่
                                this.checkIsCentralStore();

                                // บันทึก Session ที่มีข้อมูลสาขาที่เลือกแล้วลง localStorage
                                localStorage.setItem('session', JSON.stringify({ user: user, timestamp: new Date().getTime() }));

                                const targetPage = user.role === 'staff' ? 'activity_history' : 'dashboard';
                                this.navigateTo(targetPage);

                            } else {
                                Swal.fire(this.t('error'), result.message, 'error');
                            }
                            this.loginForm.loading = false;
                        })
                        .withFailureHandler(error => {
                            Swal.fire(this.t('error'), error.message, 'error');
                            this.loginForm.loading = false;
                        })
                        .doLogin(this.loginForm.username, this.loginForm.password);
                },


                logout() {
                    Swal.fire({
                        title: this.t('logout') + '?',
                        text: this.t('confirm') + ' ' + this.t('logout') + '?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: this.t('confirm'),
                        cancelButtonText: this.t('cancel')
                    }).then((result) => {
                        if (result.isConfirmed) {
                            localStorage.removeItem('session');
                            Alpine.store('app').isLoggedIn = false;
                            Alpine.store('app').user = {
                                id: null,
                                username: null,
                                role: null,
                                stores: [],
                                currentStore: null
                            };
                            this.loginForm.username = '';
                            this.loginForm.password = '';
                        }
                    });
                },

                canSwitchStore() {
                    const role = Alpine.store('app').user.role;
                    return role === 'owner' || role === 'manager' || role === 'accountant';
                },



                // แก้ไข selectStore ให้รับ parameter เพิ่ม
                selectStore(storeId, targetPage = null) {
                    if (!storeId) {
                        // Reset store-specific data if "Select Store" is chosen
                        Alpine.store('app').user.currentStore = null;
                        Alpine.store('app').user.sheetId = null;
                        Alpine.store('app').user.lineToken = null;

                        // Clear settings data
                        this.settingsData = {
                            group_line_id: '',
                            notify_time_daily: '08:00',
                            notify_days: 'Mon,Tue,Wed,Thu,Fri,Sat,Sun',
                            store_name: '',
                            store_code: ''
                        };

                        this.navigateTo('dashboard');
                        return;
                    }

                    const store = Alpine.store('app').user.stores.find(s => s.store_id === storeId);
                    if (store) {
                        Alpine.store('app').user.currentStore = storeId;
                        Alpine.store('app').user.sheetId = store.sheet_id;
                        Alpine.store('app').user.lineToken = store.line_token;

                        const session = JSON.parse(localStorage.getItem('session'));
                        session.user.currentStore = storeId;
                        session.user.sheetId = store.sheet_id;
                        localStorage.setItem('session', JSON.stringify(session));

                        Toastify({
                            text: `${this.t('select_store')}: ${store.name}`,
                            duration: 2000,
                            style: { background: "#3b82f6" }
                        }).showToast();

                        // อัปเดตข้อมูลสาขาในหน้า Settings ถ้าจะไปหน้า Settings
                        if (targetPage === 'settings' || Alpine.store('app').ui.currentPage === 'settings') {
                            this.settingsData.store_name = store.name;
                            this.settingsData.store_code = store.code || store.store_code;
                        }

                        // รีเซ็ตสถานะ
                        this.dashboardData.todayStatus = {
                            manualCount: false,
                            txtUpload: false,
                            manualCountTime: '',
                            txtFileName: ''
                        };

                        // ตรวจสอบว่าเป็น Central Store หรือไม่
                        this.checkIsCentralStore();

                        // ถ้าระบุหน้าเป้าหมาย ให้ไปหน้านั้น ถ้าไม่ระบุให้ reload หน้าปัจจุบัน
                        const pageToNavigate = targetPage || Alpine.store('app').ui.currentPage;
                        this.navigateTo(pageToNavigate);
                    }
                },

                // แล้วแก้ manageStore และ storeSettings
                manageStore(storeId) {
                    this.selectStore(storeId, 'dashboard');
                },

                storeSettings(storeId) {
                    this.selectStore(storeId, 'settings');
                },

                // ตรวจสอบว่าสาขาปัจจุบันเป็น Central Store หรือไม่
                checkIsCentralStore() {
                    const storeId = Alpine.store('app').user.currentStore;
                    if (!storeId) {
                        Alpine.store('app').user.isCentralStore = false;
                        return;
                    }

                    google.script.run
                        .withSuccessHandler((result) => {
                            console.log('isCentralStore result:', result);
                            if (result.success) {
                                Alpine.store('app').user.isCentralStore = result.isCentral === true;
                            } else {
                                Alpine.store('app').user.isCentralStore = false;
                            }
                        })
                        .withFailureHandler((error) => {
                            console.error('checkIsCentralStore error:', error);
                            Alpine.store('app').user.isCentralStore = false;
                        })
                        .handleDepositSystemAPI({ action: 'isCentralStore', storeId: storeId });
                },

                loadSettings() {
                    const currentStoreId = Alpine.store('app').user.currentStore;
                    const stores = Alpine.store('app').user.stores;
                    const currentStore = stores ? stores.find(s => s.store_id === currentStoreId) : null;

                    if (!currentStore) {
                        this.settingsData = {
                            group_line_id: '',
                            notify_time_daily: '08:00',
                            notify_days: 'Mon,Tue,Wed,Thu,Fri,Sat,Sun',
                            store_name: '',
                            store_code: ''
                        };

                        // Load Master Settings for owner
                        if (Alpine.store('app').user.role === 'owner') {
                            google.script.run
                                .withSuccessHandler(response => {
                                    // เพิ่ม null check
                                    if (!response) {
                                        console.error('Master settings response is null');
                                        return;
                                    }
                                    if (response.success) {
                                        this.masterSettings = response.settings || {};
                                    }
                                })
                                .withFailureHandler(error => {
                                    console.error('Error loading master settings:', error);
                                })
                                .getMasterSettings();
                        }
                        return;
                    }

                    const sheetId = currentStore.sheet_id;
                    this.settingsData.store_name = currentStore.name;
                    this.settingsData.store_code = currentStore.code || currentStore.store_code;

                    Alpine.store('app').ui.loading = true;

                    // Load Store Settings
                    google.script.run
                        .withSuccessHandler(response => {
                            // เพิ่ม null check
                            if (!response) {
                                console.error('Store settings response is null');
                                this.settingsData = {
                                    group_line_id: '',
                                    notify_time_daily: '08:00',
                                    notify_days: 'Mon,Tue,Wed,Thu,Fri,Sat,Sun',
                                    store_name: currentStore.name,
                                    store_code: currentStore.code || currentStore.store_code
                                };
                                Alpine.store('app').ui.loading = false;
                                return;
                            }

                            if (response.success) {
                                this.settingsData = {
                                    ...response.settings,
                                    store_name: currentStore.name,
                                    store_code: currentStore.code || currentStore.store_code
                                };
                            } else {
                                console.error('Failed to load settings:', response.message);
                                this.settingsData = {
                                    group_line_id: '',
                                    notify_time_daily: '08:00',
                                    notify_days: 'Mon,Tue,Wed,Thu,Fri,Sat,Sun',
                                    store_name: currentStore.name,
                                    store_code: currentStore.code || currentStore.store_code
                                };
                            }
                            Alpine.store('app').ui.loading = false;
                        })
                        .withFailureHandler(error => {
                            console.error('Error loading settings:', error);
                            this.settingsData = {
                                group_line_id: '',
                                notify_time_daily: '08:00',
                                store_name: currentStore.name,
                                store_code: currentStore.code || currentStore.store_code
                            };
                            Alpine.store('app').ui.loading = false;
                        })
                        .getStoreSettings(sheetId);



                    // Load Master Settings (owner only)
                    if (Alpine.store('app').user.role === 'owner') {
                        google.script.run
                            .withSuccessHandler(response => {
                                if (!response) {
                                    console.error('Master settings response is null');
                                    return;
                                }
                                if (response.success) {
                                    this.masterSettings = response.settings || {};
                                }
                            })
                            .withFailureHandler(error => {
                                console.error('Error loading master settings:', error);
                            })
                            .getMasterSettings();
                    }
                },









                handleScroll(el) {
                    // กำหนดให้แถบลอยตามเมื่อ scroll ลงมาเกิน 20 pixels
                    this.isHeaderSticky = el.scrollTop > 20;
                },



                showLoadingModal(title, message, showProgress = false) {
                    Alpine.store('app').ui.loadingModal = true;
                    Alpine.store('app').ui.loadingTitle = title || this.t('loading');
                    Alpine.store('app').ui.loadingMessage = message || 'กรุณารอสักครู่...';
                    // --- START: ส่วนที่เพิ่มเข้ามา ---
                    Alpine.store('app').ui.showProgressBar = showProgress;
                    if (showProgress) {
                        Alpine.store('app').ui.progress = 0;
                        Alpine.store('app').ui.progressStatus = 'กำลังเริ่มต้น...';
                    }
                },


                hideLoadingModal() {
                    Alpine.store('app').ui.loadingModal = false;
                },



                getMenuItems() {
                    const role = Alpine.store('app').user.role;
                    const isCentral = Alpine.store('app').user.isCentralStore;

                    // เมนูโอนคลังกลาง - แสดงต่างกันตาม store type
                    const transferMenuItem = isCentral
                        ? { id: 14, page: 'central_transfer', label: 'hq_transfer', icon: 'fas fa-warehouse' }
                        : { id: 14, page: 'central_transfer', label: 'central_transfer', icon: 'fas fa-truck' };

                    const menuStructure = {
                        owner: [
                            { id: 1, page: 'dashboard', label: 'dashboard', icon: 'fas fa-chart-pie' },
                            { id: 2, page: 'products', label: 'products', icon: 'fas fa-box' },
                            { id: 6, page: 'manual_count', label: 'manual_count', icon: 'fas fa-clipboard-check' },
                            { id: 3, page: 'pdf_upload', label: 'pdf_upload', icon: 'fas fa-file-pdf' },
                            { id: 4, page: 'comparison', label: 'comparison', icon: 'fas fa-balance-scale' },
                            { id: 5, page: 'line_dashboard', label: 'Line Dashboard', icon: 'fab fa-line' },
                                                        { id: 12, page: 'dashboard_deposit', label: 'deposit_dashboard', icon: 'fas fa-chart-bar' },
                            { id: 13, page: 'deposit_history', label: 'deposit_history', icon: 'fas fa-history' },
                            transferMenuItem,
                            { id: 7, page: 'users', label: 'users', icon: 'fas fa-users' },
                            { id: 8, page: 'stores', label: 'stores', icon: 'fas fa-store' },
                            { id: 9, page: 'settings', label: 'settings', icon: 'fas fa-cog' },
                            { id: 10, page: 'manual', label: 'manual', icon: 'fas fa-book' }
                        ],
                        accountant: [
                            { id: 1, page: 'dashboard', label: 'dashboard', icon: 'fas fa-chart-pie' },
                            { id: 2, page: 'products', label: 'products', icon: 'fas fa-box' },
                            { id: 6, page: 'manual_count', label: 'manual_count', icon: 'fas fa-clipboard-check' },
                            { id: 3, page: 'pdf_upload', label: 'pdf_upload', icon: 'fas fa-file-pdf' },
                            { id: 4, page: 'comparison', label: 'comparison', icon: 'fas fa-balance-scale' },
                            { id: 5, page: 'line_dashboard', label: 'Line Dashboard', icon: 'fab fa-line' },
                            { id: 9, page: 'settings', label: 'settings', icon: 'fas fa-cog' },
                            { id: 10, page: 'manual', label: 'manual', icon: 'fas fa-book' }
                        ],
                        manager: [
                            { id: 1, page: 'dashboard', label: 'dashboard', icon: 'fas fa-chart-pie' },
                            { id: 2, page: 'products', label: 'products', icon: 'fas fa-box' },
                            { id: 6, page: 'manual_count', label: 'manual_count', icon: 'fas fa-clipboard-check' },
                            { id: 4, page: 'comparison', label: 'comparison', icon: 'fas fa-balance-scale' },
                            { id: 5, page: 'line_dashboard', label: 'Line Dashboard', icon: 'fab fa-line' },
                                                        { id: 12, page: 'dashboard_deposit', label: 'deposit_dashboard', icon: 'fas fa-chart-bar' },
                            { id: 13, page: 'deposit_history', label: 'deposit_history', icon: 'fas fa-history' },
                            transferMenuItem,
                            { id: 7, page: 'users', label: 'users', icon: 'fas fa-users' },
                            { id: 8, page: 'stores', label: 'stores', icon: 'fas fa-store' },
                            { id: 9, page: 'settings', label: 'settings', icon: 'fas fa-cog' },
                            { id: 10, page: 'manual', label: 'manual', icon: 'fas fa-book' }
                        ],
                        staff: [
                            { id: 1, page: 'manual_count', label: 'manual_count', icon: 'fas fa-clipboard-check' },
                                                        { id: 2, page: 'activity_history', label: 'ประวัติการทำงาน', icon: 'fas fa-history' },
                            { id: 3, page: 'users', label: 'change_password', icon: 'fas fa-key' },
                            { id: 4, page: 'manual', label: 'manual', icon: 'fas fa-book' }
                        ]
                    };
                    return menuStructure[role] || [];
                },

                getMobileMenuItems() {
                    const items = this.getMenuItems();
                    return items.slice(0, 5);
                },

                // ฟังก์ชันใหม่: จัดกลุ่มเมนูเป็น 4 หมวดหลัก
                getGroupedMenuItems() {
                    const role = Alpine.store('app').user.role;
                    const flatItems = this.getMenuItems(); // ใช้ function เดิม

                    // กำหนด mapping ระหว่าง page กับ group
                    const pageGroupMap = {
                        dashboard: 'stock',
                        products: 'stock',
                        manual_count: 'stock',
                        pdf_upload: 'stock',
                        comparison: 'stock',
                        line_dashboard: 'stock',
                        deposit: 'deposit',
                        deposit_management: 'deposit',
                        dashboard_deposit: 'deposit',
                        deposit_history: 'deposit',
                        central_transfer: 'deposit',
                        users: 'settings',
                        stores: 'settings',
                        settings: 'settings',
                        change_password: 'settings',
                        activity_history: 'stock', // staff's activity history อยู่ใน stock system
                        manual: 'manual'
                    };

                    // สร้าง groups
                    const groups = [
                        {
                            id: 'stock',
                            label: 'stock_system',
                            icon: 'fas fa-box',
                            items: []
                        },
                        {
                            id: 'deposit',
                            label: 'deposit_system',
                            icon: 'fas fa-wine-glass-alt',
                            items: []
                        },
                        {
                            id: 'settings',
                            label: 'settings',
                            icon: 'fas fa-cog',
                            items: []
                        },
                        {
                            id: 'manual',
                            label: 'manual',
                            icon: 'fas fa-book',
                            items: []
                        }
                    ];

                    // กระจายเมนูเข้า groups
                    flatItems.forEach(item => {
                        const groupId = pageGroupMap[item.page];
                        const group = groups.find(g => g.id === groupId);
                        if (group) {
                            group.items.push(item);
                        }
                    });

                    // กรองเฉพาะ groups ที่มี items
                    return groups.filter(group => group.items.length > 0);
                },

                // Toggle การแสดง/ซ่อน submenu
                toggleMenuGroup(groupId) {
                    this.expandedMenus[groupId] = !this.expandedMenus[groupId];
                },

                // ตรวจสอบว่า menu group ถูกขยายหรือไม่
                isMenuGroupExpanded(groupId) {
                    return this.expandedMenus[groupId] || false;
                },

                loadActivityHistory() {
                    this.activityHistory.loading = true;
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) { this.activityHistory.loading = false; return; }
                    this.showLoadingModal('กำลังโหลด', 'กำลังดึงข้อมูลประวัติการทำงาน...');
                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) { this.activityHistory.data = response.data; }
                            else { Swal.fire('Error', response.message, 'error'); }
                            this.activityHistory.loading = false;
                            this.hideLoadingModal();
                        })
                        .withFailureHandler(error => {
                            Swal.fire('Error', error.message, 'error');
                            this.activityHistory.loading = false;
                            this.hideLoadingModal();
                        })
                        .getStaffActivityHistory(sheetId, this.activityHistory.filters.dateFrom, this.activityHistory.filters.dateTo);
                },

                // --- START: Deposit System Load Functions ---
                loadDashboardDeposit() {
                    const storeId = Alpine.store('app').user.currentStore;
                    if (!storeId) return;

                    Alpine.store('depositDashboard').loading = true;

                    // Get store name from stores list
                    const stores = Alpine.store('app').user.stores || [];
                    const currentStore = stores.find(s => s.store_id === storeId);
                    const storeName = currentStore?.name || storeId;

                    google.script.run
                        .withSuccessHandler((response) => {
                            if (response.success) {
                                Alpine.store('depositDashboard').storeName = response.storeName || storeName;
                                Alpine.store('depositDashboard').data = response.data || {
                                    totalDeposits: 0,
                                    inStore: 0,
                                    withdrawn: 0,
                                    expired: 0,
                                    transferred: 0,
                                    expiringSoon: 0,
                                    pendingWithdrawals: 0,
                                    averageDepositDays: 0,
                                    totalCustomers: 0,
                                    newCustomersThisMonth: 0,
                                    totalValue: 0,
                                    byProductType: {},
                                    byCategory: {},
                                    depositsByPeriod: { daily: [], weekly: [], monthly: [] },
                                    withdrawalsByPeriod: { daily: [], weekly: [], monthly: [] },
                                    expiringSoonList: [],
                                    expiredList: []
                                };

                                // Dispatch event for chart initialization
                                window.dispatchEvent(new CustomEvent('deposit-dashboard-updated'));
                            } else {
                                console.error('Failed to load dashboard:', response.message);
                                Swal.fire('Error', response.message || 'ไม่สามารถโหลดข้อมูลได้', 'error');
                            }

                            Alpine.store('depositDashboard').loading = false;
                        })
                        .withFailureHandler((error) => {
                            console.error('Error loading dashboard:', error);
                            Swal.fire('Error', 'เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
                            Alpine.store('depositDashboard').loading = false;
                        })
                        .getDashboardDepositData(storeId);
                },

                loadDepositHistory() {
                    // Component จะโหลดข้อมูลเองผ่าน depositHistoryData.init()
                    console.log('Deposit history page loaded');
                },

                loadCentralTransfer() {
                    const storeId = Alpine.store('app').user.currentStore;
                    if (!storeId) return;

                    const isCentral = Alpine.store('app').user.isCentralStore;
                    Alpine.store('centralTransfer').loading = true;

                    if (isCentral) {
                        // HQ: โหลดรายการที่รอรับจากสาขาอื่น
                        console.log('Loading pending transfers for HQ:', storeId);
                        google.script.run
                            .withSuccessHandler((result) => {
                                console.log('Pending transfers result:', result);
                                if (result.success) {
                                    Alpine.store('centralTransfer').pendingTransfers = result.data || [];
                                }
                                Alpine.store('centralTransfer').loading = false;
                            })
                            .withFailureHandler((error) => {
                                console.error('Load pending transfers error:', error);
                                Alpine.store('centralTransfer').loading = false;
                            })
                            .handleDepositSystemAPI({ action: 'getPendingTransfers', storeId: storeId });
                    } else {
                        // สาขาปกติ: โหลดรายการที่หมดอายุ พร้อมโอน
                        console.log('Loading expired deposits for branch:', storeId);
                        google.script.run
                            .withSuccessHandler((result) => {
                                console.log('Expired deposits result:', result);
                                if (result.success) {
                                    Alpine.store('centralTransfer').transfers = result.data || [];
                                }
                                Alpine.store('centralTransfer').loading = false;
                            })
                            .withFailureHandler((error) => {
                                console.error('Load expired deposits error:', error);
                                Alpine.store('centralTransfer').loading = false;
                            })
                            .handleDepositSystemAPI({ action: 'getExpiredDeposits', storeId: storeId });
                    }
                },
                // --- END: Deposit System Load Functions ---

                openExplanationPage(date) {
                    const storeId = Alpine.store('app').user.currentStore;
                    const webAppUrl = Alpine.store('app').webAppUrl;
                    if (!storeId || !webAppUrl) {
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถสร้างลิงก์ได้', 'error');
                        return;
                    }
                    const url = `${webAppUrl}?page=explanation&store=${storeId}&date=${date}`;
                    window.open(url, '_blank');
                },



                get filteredActivityHistory() {
                    const { status } = this.activityHistory.filters;
                    if (!this.activityHistory.data) { return []; }
                    if (status === 'all') { return this.activityHistory.data; }
                    return this.activityHistory.data.filter(item => item.status === status);
                },


                navigateTo(page) {
                    // --- START: เพิ่มการป้องกัน Staff เข้าหน้า Dashboard ---
                    if (Alpine.store('app').user.role === 'staff' && page === 'dashboard') {
                        // ถ้า Staff พยายามจะเข้าหน้า dashboard ให้ redirect ไปหน้า activity_history แทน
                        console.warn("Staff access to dashboard is restricted. Redirecting to activity history.");
                        page = 'activity_history';
                    }
                    // --- END: เพิ่มการป้องกัน ---

                    if (page === 'manual') {
                        const webAppUrl = Alpine.store('app').webAppUrl;
                        window.open(`${webAppUrl}?page=manual`, '_blank');
                        return;
                    }

                    // --- START: Handle external deposit page ---
                    if (page === 'deposit') {
                        const webAppUrl = Alpine.store('app').webAppUrl;
                        const storeId = Alpine.store('app').user.currentStore;
                        if (!storeId) {
                            Swal.fire({ icon: 'info', title: this.t('select_store'), text: 'กรุณาเลือกสาขาก่อนเข้าใช้งานหน้านี้' });
                            return;
                        }
                        window.open(`${webAppUrl}?page=deposit&store=${storeId}`, '_blank');
                        return;
                    }
                    // --- END: Handle external deposit page ---

                    const pagesNeedStore = ['dashboard', 'products', 'manual_count', 'pdf_upload', 'comparison', 'settings', 'activity_history', 'dashboard_deposit', 'deposit_history', 'central_transfer'];
                    if (pagesNeedStore.includes(page) && !Alpine.store('app').user.currentStore) {
                        Swal.fire({ icon: 'info', title: this.t('select_store'), text: 'กรุณาเลือกสาขาก่อนเข้าใช้งานหน้านี้' });
                        return;
                    }
                    Alpine.store('app').ui.currentPage = page;
                    Alpine.store('app').ui.showMobileMenu = false;

                    switch (page) {
                        case 'dashboard': this.loadDashboardData(); break;
                        case 'products': this.loadProducts(); break;
                        case 'manual_count': this.checkCountStatus(); break;
                        case 'line_dashboard': this.loadLineDashboard(); break;
                        case 'txt_upload': this.checkUploadStatus(this.txtUploadDate); this.loadRecentUploads(); break;
                        case 'users': if (Alpine.store('app').user.role === 'owner') { this.loadUsersAndStores(); } break;
                        case 'comparison': this.loadDiscrepancyDashboard(); break;
                        case 'settings': this.loadSettings(); break;
                        case 'activity_history': this.loadActivityHistory(); break;
                        case 'dashboard_deposit': this.loadDashboardDeposit(); break;
                        case 'deposit_history': this.loadDepositHistory(); break;
                        case 'central_transfer': this.loadCentralTransfer(); break;
                    }
                },



                async loadUsersAndStores() {
                    Alpine.store('app').ui.loading = true;
                    // โหลด Users
                    google.script.run.withSuccessHandler(response => {
                        if (response.success) this.users = response.users;
                    }).getUsers();

                    // --- START: ส่วนที่แก้ไข ---
                    // โหลด Stores ทั้งหมดสำหรับ Dropdown
                    google.script.run.withSuccessHandler(response => {
                        if (response.success) {
                            this.allStores = response.stores; // response.stores จะมี id, name มาแล้ว
                        }
                    }).getAllStores(); // <--- แก้จาก getStoreData() เป็น getAllStores()
                    // --- END: ส่วนที่แก้ไข ---

                    Alpine.store('app').ui.loading = false;
                },

                openEditUserModal(user) {
                    this.editingUser = JSON.parse(JSON.stringify(user));
                    this.showEditUserModal = true;
                },

                saveUser(isNew = false) {
                    const userData = isNew ? this.newUser : this.editingUser;
                    const backendFunction = isNew ? 'addUser' : 'updateUser';

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                Swal.fire(this.t('success'), '', 'success');
                                this.showAddUserModal = false;
                                this.showEditUserModal = false;
                                this.loadUsersAndStores(); // โหลดข้อมูลใหม่
                            } else { Swal.fire(this.t('error'), response.message, 'error'); }
                        })
                    [backendFunction](userData);
                },

                confirmDeleteUser(userId) {
                    Swal.fire({
                        title: 'ยืนยันการลบ?',
                        text: "ผู้ใช้นี้จะถูกปิดการใช้งาน",
                        icon: 'warning',
                        showCancelButton: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            google.script.run.withSuccessHandler(response => {
                                if (response.success) this.loadUsersAndStores();
                            }).deleteUser(userId);
                        }
                    });
                },

                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('darkMode', this.darkMode);
                },

                getCurrentStoreName() {
                    const storeId = Alpine.store('app').user.currentStore;
                    if (!storeId) return this.t('no_data');
                    const store = Alpine.store('app').user.stores.find(s => s.store_id === storeId);
                    return store ? store.name : this.t('no_data');
                },

                // Dashboard Functions
                async loadDashboardData() {
                    if (this.isDashboardLoading) {
                        console.log('[Dashboard] Blocked: A request is already in progress.');
                        return;
                    }
                    this.isDashboardLoading = true;

                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) {
                        this.isDashboardLoading = false;
                        return;
                    }

                    console.log('[Dashboard] Starting to load all data...');
                    this.showLoadingModal(this.t('loading'), 'กำลังโหลดข้อมูลแดชบอร์ด...');
                    const today = this.getLocalDateString();

                    // สร้าง Promise สำหรับทุก request ที่ต้องการ
                    const mainDataPromise = new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .getDashboardData(sheetId, this.dashboardData.dateFrom, this.dashboardData.dateTo);
                    });

                    const countStatusPromise = new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .getManualCountForm(sheetId, today);
                    });

                    const uploadStatusPromise = new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .getUploadStatusForDate(sheetId, today);
                    });

                    try {
                        // รอให้ทุก request ทำงานเสร็จ
                        const [mainData, countStatus, uploadStatus] = await Promise.all([
                            mainDataPromise,
                            countStatusPromise,
                            uploadStatusPromise
                        ]);

                        console.log('[Dashboard] All data received successfully.');

                        // อัปเดตสถานะวันนี้
                        if (countStatus.success) {
                            this.dashboardData.todayStatus.manualCount = countStatus.hasExisting || false;
                            this.dashboardData.todayStatus.manualCountTime = countStatus.hasExisting ? new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';
                        }
                        if (uploadStatus.success) {
                            this.dashboardData.todayStatus.txtUpload = uploadStatus.uploaded || false;
                            this.dashboardData.todayStatus.txtFileName = uploadStatus.fileName || '';
                        }

                        // อัปเดตข้อมูลหลักของแดชบอร์ด
                        if (mainData.success) {
                            this.dashboardData = {
                                ...this.dashboardData,
                                stats: mainData.stats || { totalItems: 0, sumDiff: 0, shrinkageRate: 0, topOffender: '-' },
                                topDiffItems: mainData.topDiffItems || [],
                                categoryData: mainData.categoryData || [],
                                discrepancies: mainData.discrepancies || [],
                            };
                            this.$nextTick(() => { this.renderCharts(); });
                        } else {
                            Swal.fire(this.t('error'), mainData.message, 'error');
                        }

                    } catch (error) {
                        console.error('[Dashboard] Failed to load data:', error);
                        Swal.fire(this.t('error'), error.message, 'error');
                    } finally {
                        // ไม่ว่าจะสำเร็จหรือล้มเหลว ให้คืนค่าสถานะและปิด Modal เสมอ
                        this.hideLoadingModal();
                        this.isDashboardLoading = false;
                    }
                },





                setDateRange(range) {
                    const today = new Date();
                    const todayStr = this.getLocalDateString(today);

                    switch (range) {
                        case 'today':
                            this.dashboardData.dateFrom = todayStr;
                            this.dashboardData.dateTo = todayStr;
                            break;
                        case 'week':
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - 7);
                            this.dashboardData.dateFrom = weekStart.toISOString().split('T')[0];
                            this.dashboardData.dateTo = todayStr;
                            break;
                        case 'month':
                            const monthStart = new Date(today);
                            monthStart.setMonth(today.getMonth() - 1);
                            this.dashboardData.dateFrom = monthStart.toISOString().split('T')[0];
                            this.dashboardData.dateTo = todayStr;
                            break;
                    }
                    this.loadDashboardData();
                },





                renderCharts() {
                    // ทำลายกราฟเก่า (ถ้ามี)
                    if (this.charts.topDiff) this.charts.topDiff.destroy();
                    if (this.charts.category) this.charts.category.destroy();

                    const isDarkMode = this.darkMode;
                    const tickColor = isDarkMode ? '#a1a1aa' : '#475569';
                    const gridColor = isDarkMode ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.06)';

                    // --- กราฟแท่ง Top 5 (แนวนอน) ---
                    const topDiffCtx = document.getElementById('topDiffChartNew')?.getContext('2d');
                    if (topDiffCtx && this.dashboardData.topDiffItems) {
                        let itemsToShow = [];
                        if (this.top5Mode === 'over') {
                            itemsToShow = this.dashboardData.topDiffItems.filter(d => d.value > 0).slice(0, 5);
                        } else if (this.top5Mode === 'short') {
                            itemsToShow = this.dashboardData.topDiffItems.filter(d => d.value < 0).slice(0, 5);
                        } else { // 'abs'
                            itemsToShow = [...this.dashboardData.topDiffItems].sort((a, b) => Math.abs(b.value) - Math.abs(a.value)).slice(0, 5);
                        }

                        const labels = itemsToShow.map(d => d.name);
                        const values = itemsToShow.map(d => this.top5Mode === 'abs' ? Math.abs(d.value) : d.value);

                        const palette = ['#ef4444', '#3b82f6', '#f97316', '#8b5cf6', '#a855f7'];
                        const colors = itemsToShow.map((d, index) => palette[index % palette.length]);

                        this.charts.topDiff = new Chart(topDiffCtx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Difference',
                                    data: values,
                                    backgroundColor: colors,
                                    borderColor: colors,
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    borderSkipped: false
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { ticks: { color: tickColor }, grid: { display: false } },
                                    x: { ticks: { color: tickColor }, grid: { color: gridColor } }
                                }
                            }
                        });
                    }

                    // --- กราฟโดนัท Category ---
                    const categoryCtx = document.getElementById('categoryChartNew')?.getContext('2d');
                    if (categoryCtx && this.dashboardData.categoryData) {
                        const categoryLabels = this.dashboardData.categoryData.map(d => d.category);
                        const categoryValues = this.dashboardData.categoryData.map(d => d.value);
                        const categoryColors = this.dashboardData.categoryData.map(d => d.color);

                        this.charts.category = new Chart(categoryCtx, {
                            type: 'doughnut',
                            data: {
                                labels: categoryLabels,
                                datasets: [{
                                    data: categoryValues,
                                    backgroundColor: categoryColors,
                                    borderColor: isDarkMode ? '#171717' : '#ffffff',
                                    borderWidth: 4,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: { color: tickColor, usePointStyle: true, pointStyle: 'circle' }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                const label = context.label || '';
                                                const value = context.raw || 0;
                                                const total = context.dataset.data.reduce((sum, data) => sum + data, 0);
                                                const percentage = total > 0 ? (value / total) * 100 : 0;

                                                return `${label}: ${value.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${percentage.toFixed(2)}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                },



                async exportDashboard(format) {
                    // --- 1. ตรวจสอบเงื่อนไขก่อนสร้างไฟล์ ---
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) {
                        Swal.fire('ผิดพลาด', 'กรุณาเลือกสาขาก่อน', 'warning');
                        return;
                    }

                    const dateFrom = this.dashboardData.dateFrom;
                    const dateTo = this.dashboardData.dateTo;
                    if (dateFrom !== dateTo) {
                        Swal.fire('ผิดพลาด', 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุดเป็นวันเดียวกัน', 'warning');
                        return;
                    }

                    this.showLoadingModal('กำลังเตรียมไฟล์', `กำลังสร้างไฟล์ ${format.toUpperCase()}...`);

                    // --- 2. เรียกใช้ Backend ---
                    google.script.run
                        .withSuccessHandler(response => {
                            this.hideLoadingModal();
                            if (response.success) {
                                Swal.fire({
                                    title: 'สร้างไฟล์สำเร็จ!',
                                    text: `ไฟล์ ${format.toUpperCase()} ของคุณพร้อมแล้ว`,
                                    icon: 'success',
                                    confirmButtonText: 'ดาวน์โหลดเลย!'
                                }).then(() => {
                                    // --- 3. เปิด URL ของไฟล์เพื่อให้ผู้ใช้ดาวน์โหลด ---
                                    window.open(response.fileUrl, '_blank');
                                });
                            } else {
                                // แสดง Error ที่ส่งมาจาก Backend (เช่น "ไม่พบข้อมูล")
                                Swal.fire('ผิดพลาด', response.message, 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            this.hideLoadingModal();
                            Swal.fire('เกิดข้อผิดพลาดร้ายแรง', error.message, 'error');
                        })
                        .exportDailyChecklist(sheetId, dateFrom, format);
                },

                // Products Functions
                async loadProducts() {
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) return;

                    this.showLoadingModal(this.t('loading'), this.t('loading_data'));

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                this.products = response.products;
                            } else {
                                Swal.fire(this.t('error'), response.message, 'error');
                            }
                            this.hideLoadingModal();
                        })
                        .withFailureHandler(error => {
                            Swal.fire(this.t('error'), error.message, 'error');
                            this.hideLoadingModal();
                        })
                        .getProducts(sheetId);
                },


                openEditModal(product) {
                    this.editingProduct = JSON.parse(JSON.stringify(product)); // Clone object to avoid reactivity issues
                    this.showEditModal = true;
                },

                // ฟังก์ชันสำหรับบันทึก (ใช้ทั้งเพิ่มและแก้ไข)
                saveProduct(isNew = false) {
                    const productData = isNew ? this.newProduct : this.editingProduct;
                    const backendFunction = isNew ? 'addProduct' : 'updateProduct';

                    if (!productData.product_code || !productData.product_name) {
                        Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกรหัสและชื่อสินค้า', 'warning');
                        return;
                    }

                    this.showLoadingModal(this.t('saving'), 'กำลังบันทึกข้อมูลสินค้า...');

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                Swal.fire(this.t('success'), '', 'success');
                                this.showAddModal = false;
                                this.showEditModal = false;
                                this.loadProducts(); // โหลดข้อมูลใหม่หลังจากบันทึก
                            } else {
                                Swal.fire(this.t('error'), response.message, 'error');
                            }
                            this.hideLoadingModal();
                        })
                        .withFailureHandler(error => {
                            Swal.fire(this.t('error'), error.message, 'error');
                            this.hideLoadingModal();
                        })
                    [backendFunction](Alpine.store('app').user.sheetId, productData);
                },


                get productStats() {
                    if (!this.products || this.products.length === 0) {
                        return { total: 0, active: 0, inactive: 0, excluded: 0 };
                    }
                    return {
                        total: this.products.length,
                        active: this.products.filter(p => p.active).length,
                        inactive: this.products.filter(p => !p.active).length,
                        excluded: this.products.filter(p => p.count_status === 'excluded').length
                    };
                },

                // ฟังก์ชันสำหรับ Toggle Active
                toggleActive(productCode, isActive) {
                    google.script.run
                        .withSuccessHandler(response => {
                            if (!response.success) {
                                Swal.fire(this.t('error'), response.message, 'error');
                                this.loadProducts(); // โหลดซ้ำเพื่อคืนค่า Toggle
                            }
                        })
                        .toggleProductStatus(Alpine.store('app').user.sheetId, productCode, isActive);
                },


                uploadImageToImgBB(event, productModel) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.isUploadingImage = true;

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const base64Image = reader.result;

                        // เรียกใช้ฟังก์ชันฝั่ง Backend แทนการ fetch เอง
                        google.script.run
                            .withSuccessHandler(response => {
                                if (response.success) {
                                    if (productModel === 'new') {
                                        this.newProduct.image_url = response.url;
                                    } else {
                                        this.editingProduct.image_url = response.url;
                                    }
                                    Toastify({ text: 'อัปโหลดรูปสำเร็จ', style: { background: "linear-gradient(to right, #00b09b, #96c93d)" } }).showToast();
                                } else {
                                    Swal.fire('อัปโหลดล้มเหลว', response.message, 'error');
                                }
                                this.isUploadingImage = false;
                            })
                            .withFailureHandler(error => {
                                Swal.fire('ผิดพลาด', error.message, 'error');
                                this.isUploadingImage = false;
                            })
                            .uploadImageToImgbbBackend(base64Image);
                    };

                    reader.onerror = error => {
                        Swal.fire('ผิดพลาด', 'ไม่สามารถอ่านไฟล์รูปภาพได้', 'error');
                        this.isUploadingImage = false;
                    };
                },



                addProduct() {
                    Swal.fire({
                        title: this.t('add_product'),
                        html: `
                            <input id="product_code" class="swal2-input" placeholder="${this.t('product_code')}">
                            <input id="product_name" class="swal2-input" placeholder="${this.t('product_name')}">
                            <input id="category" class="swal2-input" placeholder="${this.t('category')}">
                            <input id="unit" class="swal2-input" placeholder="${this.t('unit')}">
                            <input id="cost_price" type="number" step="0.01" class="swal2-input" placeholder="${this.t('cost_price')}">
                            <input id="selling_price" type="number" step="0.01" class="swal2-input" placeholder="${this.t('selling_price')}">
                        `,
                        confirmButtonText: this.t('save'),
                        showCancelButton: true,
                        cancelButtonText: this.t('cancel'),
                        preConfirm: () => {
                            return {
                                product_code: document.getElementById('product_code').value,
                                product_name: document.getElementById('product_name').value,
                                category: document.getElementById('category').value,
                                unit: document.getElementById('unit').value,
                                cost_price: parseFloat(document.getElementById('cost_price').value) || 0,
                                selling_price: parseFloat(document.getElementById('selling_price').value) || 0
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Alpine.store('app').ui.loading = true;
                            google.script.run
                                .withSuccessHandler(response => {
                                    Alpine.store('app').ui.loading = false;
                                    if (response.success) {
                                        Swal.fire(this.t('success'), this.t('add_product') + ' ' + this.t('success'), 'success');
                                        this.loadProducts(); // โหลดรายการสินค้าใหม่
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    Alpine.store('app').ui.loading = false;
                                    Swal.fire(this.t('error'), error.message, 'error');
                                })
                                .addProduct(Alpine.store('app').user.sheetId, result.value);
                        }
                    });
                },


                editProduct(productCode) {
                    const product = this.products.find(p => p.product_code === productCode);
                    if (!product) return;

                    Swal.fire({
                        title: this.t('edit_product'),
                        html: `
                            <input id="product_code" class="swal2-input" value="${product.product_code}" readonly>
                            <input id="product_name" class="swal2-input" value="${product.product_name}">
                            <input id="category" class="swal2-input" value="${product.category}">
                            <input id="unit" class="swal2-input" value="${product.unit}">
                            <input id="cost_price" type="number" step="0.01" class="swal2-input" value="${product.cost_price}">
                            <input id="selling_price" type="number" step="0.01" class="swal2-input" value="${product.selling_price}">
                        `,
                        confirmButtonText: this.t('save'),
                        showCancelButton: true,
                        cancelButtonText: this.t('cancel'),
                        preConfirm: () => {
                            return {
                                product_name: document.getElementById('product_name').value,
                                category: document.getElementById('category').value,
                                unit: document.getElementById('unit').value,
                                cost_price: parseFloat(document.getElementById('cost_price').value) || 0,
                                selling_price: parseFloat(document.getElementById('selling_price').value) || 0
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Alpine.store('app').ui.loading = true;
                            google.script.run
                                .withSuccessHandler(response => {
                                    Alpine.store('app').ui.loading = false;
                                    if (response.success) {
                                        Swal.fire(this.t('success'), this.t('edit_product') + ' ' + this.t('success'), 'success');
                                        this.loadProducts(); // โหลดรายการสินค้าใหม่
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    Alpine.store('app').ui.loading = false;
                                    Swal.fire(this.t('error'), error.message, 'error');
                                })
                                .updateProduct(Alpine.store('app').user.sheetId, productCode, result.value);
                        }
                    });
                },


                deleteProduct(productCode) {
                    Swal.fire({
                        title: this.t('delete_product'),
                        text: `${this.t('confirm')} ${this.t('delete')} ${productCode}?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: this.t('delete'),
                        cancelButtonText: this.t('cancel')
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.showLoadingModal(this.t('deleting'), 'กำลังลบสินค้า...');

                            google.script.run
                                .withSuccessHandler(response => {
                                    this.hideLoadingModal();
                                    if (response.success) {
                                        Swal.fire(this.t('success'), this.t('delete_product') + ' ' + this.t('success'), 'success');
                                        this.loadProducts();
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    this.hideLoadingModal();
                                    Swal.fire(this.t('error'), error.message, 'error');
                                })
                                .deleteProduct(Alpine.store('app').user.sheetId, productCode);
                        }
                    });
                },


                viewProductImage(productCode) {
                    Swal.fire({
                        title: this.t('view_image'),
                        html: `<img src="https://placehold.co/100x100/e2e8f0/64748b?text=No+Image" alt="${productCode}" class="w-full">`,
                        confirmButtonText: this.t('cancel')
                    });
                },





                checkCountStatus() {
                    const selectedDate = this.countData.date;
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) return;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                this.countData = {
                                    date: selectedDate,
                                    status: response.hasExisting ? 'counted' : 'not_counted',
                                    items: [],
                                    matchedCount: response.matchedCount || 0,
                                    unmatchedCount: response.unmatchedCount || 0,
                                    countedBy: response.countedBy || null, // เพิ่มบรรทัดนี้
                                    isEditing: false // เพิ่มบรรทัดนี้
                                };
                            } else {
                                Swal.fire('Error', 'Could not check count status.', 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            console.error("Failed to check count status:", error);
                        })
                        .getManualCountForm(sheetId, selectedDate);
                },


                startCounting() {
                    this.showLoadingModal(this.t('loading'), 'กำลังโหลดรายการสินค้า...');
                    const selectedDate = this.countData.date;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                const grouped = response.products.reduce((acc, product) => {
                                    const category = product.category || 'Uncategorized';
                                    if (!acc[category]) {
                                        acc[category] = {
                                            category: category,
                                            products: [],
                                            collapsed: false  // *** เพิ่มบรรทัดนี้ ***
                                        };
                                    }
                                    const existingQty = response.existingCounts[product.product_code];
                                    product.quantity = existingQty !== undefined ? existingQty : null;
                                    acc[category].products.push(product);
                                    return acc;
                                }, {});

                                this.countData.items = Object.values(grouped);
                                this.countData.status = 'counting';
                            } else {
                                Swal.fire(this.t('error'), response.message, 'error');
                            }
                            this.hideLoadingModal();
                        })
                        .withFailureHandler(error => {
                            Swal.fire(this.t('error'), error.message, 'error');
                            this.hideLoadingModal();
                        })
                        .getManualCountForm(Alpine.store('app').user.sheetId, selectedDate);
                },


                get countProgress() {
                    if (!this.countData || !this.countData.items) return { total: 0, counted: 0, uncounted: 0 };

                    let total = 0;
                    let counted = 0;

                    this.countData.items.forEach(category => {
                        category.products.forEach(product => {
                            total++;
                            if (product.quantity !== null && product.quantity !== '') {
                                counted++;
                            }
                        });
                    });

                    return {
                        total: total,
                        counted: counted,
                        uncounted: total - counted
                    };
                },




                saveCount() {
                    // ตรวจสอบช่องว่างก่อนบันทึก
                    const uncountedItems = [];
                    this.countData.items.forEach(category => {
                        category.products.forEach(product => {
                            if (product.quantity === null || product.quantity === '') {
                                uncountedItems.push({
                                    code: product.product_code,
                                    name: product.product_name,
                                    category: category.category
                                });
                            }
                        });
                    });

                    if (uncountedItems.length > 0) {
                        // สร้างรายการ HTML ของสินค้าที่ยังไม่นับ
                        let itemsList = '<div class="text-left max-h-60 overflow-y-auto">';
                        itemsList += '<p class="font-semibold mb-2">รายการที่ยังไม่ได้นับ:</p>';
                        itemsList += '<ul class="list-disc list-inside space-y-1">';
                        uncountedItems.forEach(item => {
                            itemsList += `<li class="text-sm"><span class="font-mono">${item.code}</span> - ${item.name} <span class="text-gray-500">(${item.category})</span></li>`;
                        });
                        itemsList += '</ul></div>';

                        Swal.fire({
                            title: 'พบรายการที่ยังไม่ได้นับ',
                            html: `
                <p class="mb-4">มีสินค้า <span class="text-red-600 font-bold">${uncountedItems.length}</span> รายการที่ยังไม่ได้กรอกจำนวนนับ</p>
                ${itemsList}
                <p class="mt-4 text-sm text-gray-600">กรุณากรอกจำนวนให้ครบทุกรายการ (หากไม่มีสินค้าให้ใส่ 0)</p>
            `,
                            icon: 'warning',
                            confirmButtonText: 'ตกลง',
                            confirmButtonColor: '#3085d6',
                            width: '600px'
                        });
                        return; // หยุดการทำงานของฟังก์ชันทันที
                    }

                    // ถ้าผ่านการตรวจสอบแล้ว ให้ทำงานส่วนที่เหลือ (เหมือนเดิม)
                    Swal.fire({
                        title: this.t('save_count'),
                        text: `${this.t('confirm')} บันทึกการนับสต๊อก ${this.countProgress.total} รายการ?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: this.t('save'),
                        cancelButtonText: this.t('cancel')
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.showLoadingModal(this.t('saving'), 'กำลังบันทึกการนับสต๊อก...');

                            const countsToSubmit = [];
                            this.countData.items.forEach(category => {
                                category.products.forEach(product => {
                                    // ไม่จำเป็นต้องเช็คอีกครั้ง แต่มีไว้ก็ไม่เสียหาย
                                    if (product.quantity !== null && product.quantity !== '') {
                                        countsToSubmit.push({
                                            product_code: product.product_code,
                                            product_name: product.product_name,
                                            quantity: parseFloat(product.quantity)
                                        });
                                    }
                                });
                            });

                            google.script.run
                                .withSuccessHandler(response => {
                                    this.hideLoadingModal();
                                    if (response.success) {
                                        this.countData.status = 'counted';
                                        Swal.fire(this.t('success'), this.t('save_count') + ' ' + this.t('success'), 'success');

                                        // เพิ่มการอัพเดทสถานะในแดชบอร์ด
                                        if (Alpine.store('app').ui.currentPage === 'manual_count') {
                                            this.dashboardData.todayStatus.manualCount = true;
                                            this.dashboardData.todayStatus.manualCountTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                                        }
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    this.hideLoadingModal();
                                    Swal.fire(this.t('error'), error.message, 'error');
                                })
                                .submitManualCount(
                                    Alpine.store('app').user.sheetId,
                                    this.countData.date,
                                    countsToSubmit,
                                    Alpine.store('app').user.username
                                );
                        }
                    });
                },

                // TXT Upload Functions

                checkUploadStatus(date) {
                    const checkDate = date || this.txtUploadDate;
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) return;

                    google.script.run
                        .withSuccessHandler(response => {
                            console.log('Upload status response:', response); // Debug log

                            if (response.success) {
                                // ดึง drive_file_id จาก file_url ถ้ามี
                                let driveId = '';
                                if (response.file_url) {
                                    const match = response.file_url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                                    if (match && match[1]) {
                                        driveId = match[1];
                                    }
                                } else if (response.driveFileId) {
                                    driveId = response.driveFileId;
                                }

                                // แก้ไข fileName ถ้าเป็น "view?usp=drivesdk"
                                let fileName = response.fileName;
                                if (fileName === 'view?usp=drivesdk' || fileName && fileName.includes('view?')) {
                                    const storeName = this.getCurrentStoreName();
                                    const dateParts = checkDate.split('-');
                                    fileName = `${storeName}_${dateParts[2]}${dateParts[1]}${dateParts[0]}.txt`;
                                }

                                this.uploadStatus = {
                                    uploaded: response.uploaded,
                                    fileName: fileName || '',
                                    driveFileId: driveId
                                };
                            }
                        })
                        .withFailureHandler(error => {
                            console.error("Error checking upload status:", error);
                        })
                        .getUploadStatusForDate(sheetId, checkDate);
                },





                loadDailySummary() {
                    this.showLoadingModal('กำลังโหลด', 'กำลังสรุปข้อมูลผลต่างรายวัน...');
                    const sheetId = Alpine.store('app').user.sheetId;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                this.dailySummaryData = response.summary;
                            } else {
                                Swal.fire('ผิดพลาด', response.message, 'error');
                            }
                            this.hideLoadingModal();
                        })
                        .withFailureHandler(error => {
                            Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                            this.hideLoadingModal();
                        })
                        .getDailyComparisonSummary(sheetId);
                },






                openDetailsModal(date) {
                    // เปลี่ยนโครงสร้าง modalData เพื่อรองรับการจัดกลุ่ม
                    this.modalData = {
                        date: date,
                        pendingExplanation: [],
                        pendingApproval: [],
                        rejected: [],
                        approved: []
                    };
                    const formattedDate = new Date(date).toLocaleDateString('th-TH');
                    this.showLoadingModal('กำลังโหลด', `กำลังดึงรายละเอียดของวันที่ ${formattedDate}...`);

                    google.script.run
                        .withSuccessHandler(response => {
                            this.hideLoadingModal();
                            if (response.success) {
                                // วนลูปเพื่อจัดกลุ่มข้อมูลตามสถานะ
                                response.details.forEach(item => {
                                    if (item.approval_status === 'rejected') {
                                        this.modalData.rejected.push(item);
                                    } else if (item.approval_status === 'approved') {
                                        this.modalData.approved.push(item);
                                    } else if (item.explanation) { // มีคำชี้แจงแล้ว = รออนุมัติ
                                        this.modalData.pendingApproval.push(item);
                                    } else { // ยังไม่มีคำชี้แจง = รอชี้แจง
                                        this.modalData.pendingExplanation.push(item);
                                    }
                                });
                                this.showDetailsModal = true;
                            } else {
                                Swal.fire('ผิดพลาด', response.message, 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            this.hideLoadingModal();
                            Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                        })
                        .getDiscrepancyDetailsForDate(Alpine.store('app').user.sheetId, date);
                },

                closeDetailsModal() {
                    this.showDetailsModal = false;
                    this.modalData = { date: '', items: [] };
                },

                approveOrReject(date, status) {
                    const title = status === 'approved' ? 'ยืนยันการยอมรับ' : 'ยืนยันการปฏิเสธ';
                    const text = `คุณต้องการ${status === 'approved' ? 'ยอมรับ' : 'ปฏิเสธ'}คำชี้แจงทั้งหมดของวันที่ ${date} ใช่หรือไม่?`;

                    Swal.fire({
                        title: title,
                        text: text,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'ยืนยัน',
                        cancelButtonText: 'ยกเลิก',
                        input: status === 'rejected' ? 'textarea' : null, // เพิ่มช่องใส่เหตุผลกรณีปฏิเสธ
                        inputPlaceholder: 'กรุณาระบุเหตุผลที่ปฏิเสธ (ถ้ามี)...'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const ownerName = Alpine.store('app').user.username;
                            const notes = result.value || ''; // รับค่าจาก input
                            this.showLoadingModal('กำลังบันทึก', 'กำลังอัปเดตสถานะ...');

                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.success) {
                                        Swal.fire('สำเร็จ!', 'อัปเดตสถานะเรียบร้อยแล้ว', 'success');
                                        this.loadDailySummary(); // โหลดข้อมูลใหม่
                                    } else {
                                        Swal.fire('ผิดพลาด', response.message, 'error');
                                    }
                                    this.hideLoadingModal();
                                })
                                .withFailureHandler(error => {
                                    Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                                    this.hideLoadingModal();
                                })
                                .updateApprovalStatus(Alpine.store('app').user.sheetId, date, status, ownerName, notes);
                        }
                    });
                },











                explainDiscrepancy(compId) {
                    Swal.fire({
                        title: this.t('explanation'),
                        input: 'textarea',
                        inputPlaceholder: this.t('explanation'),
                        showCancelButton: true,
                        confirmButtonText: this.t('save'),
                        cancelButtonText: this.t('cancel')
                    }).then((result) => {
                        if (result.isConfirmed && result.value) {
                            Alpine.store('app').ui.loading = true;
                            google.script.run
                                .withSuccessHandler(response => {
                                    Alpine.store('app').ui.loading = false;
                                    if (response.success) {
                                        Swal.fire(this.t('success'), '', 'success');
                                        this.loadComparisonData(); // โหลดข้อมูลใหม่
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    Alpine.store('app').ui.loading = false;
                                    Swal.fire(this.t('error'), error.message, 'error');
                                })
                                .submitExplanation(
                                    Alpine.store('app').user.sheetId,
                                    compId,
                                    result.value,
                                    Alpine.store('app').user.username
                                );
                        }
                    });
                },


                // User Functions
                addUser() {
                    Swal.fire({
                        title: this.t('add_user'),
                        html: `
                            <input id="username" class="swal2-input" placeholder="${this.t('username')}">
                            <input id="password" type="password" class="swal2-input" placeholder="${this.t('password')}">
                            <select id="role" class="swal2-select">
                                <option value="staff">${this.t('staff')}</option>
                                <option value="manager">${this.t('manager')}</option>
                                <option value="owner">${this.t('owner')}</option>
                            </select>
                        `,
                        confirmButtonText: this.t('save'),
                        showCancelButton: true,
                        cancelButtonText: this.t('cancel'),
                        preConfirm: () => {
                            return {
                                username: document.getElementById('username').value,
                                password: document.getElementById('password').value,
                                role: document.getElementById('role').value
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed && result.value.username && result.value.password) {
                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.success) {
                                        Swal.fire(this.t('success'), '', 'success');
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .addUser(result.value); // ส่งข้อมูล User ใหม่ไป Backend
                        }
                    });
                },




                createStore() {
                    Swal.fire({
                        title: this.t('create_store'),
                        html: `
            <div class="space-y-3">
                <input id="store_name" class="swal2-input" placeholder="${this.t('store_name')}" required>
                <input id="store_code" class="swal2-input" placeholder="${this.t('store_code')}" maxlength="10" required>
                <input id="group_line_id" class="swal2-input" placeholder="Group Line ID">
                <small class="text-gray-500">กรอก Group Line ID เพื่อรับการแจ้งเตือน</small>
            </div>
        `,
                        confirmButtonText: this.t('create_store'),
                        showCancelButton: true,
                        cancelButtonText: this.t('cancel'),
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        preConfirm: () => {
                            const store_name = document.getElementById('store_name').value;
                            const store_code = document.getElementById('store_code').value;
                            const group_line_id = document.getElementById('group_line_id').value;

                            if (!store_name || !store_code) {
                                Swal.showValidationMessage('กรุณากรอกชื่อสาขาและรหัสสาขา');
                                return false;
                            }

                            // Validate store code (letters and numbers only)
                            if (!/^[A-Za-z0-9]+$/.test(store_code)) {
                                Swal.showValidationMessage('รหัสสาขาต้องเป็นตัวอักษรและตัวเลขเท่านั้น');
                                return false;
                            }

                            return {
                                store_name: store_name,
                                store_code: store_code.toUpperCase(),
                                group_line_id: group_line_id
                            }
                        },
                        showLoaderOnConfirm: true,
                        allowOutsideClick: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // แสดง loading
                            Alpine.store('app').ui.loading = true;
                            Swal.fire({
                                title: 'กำลังสร้างสาขา...',
                                text: 'กรุณารอสักครู่',
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                willOpen: () => {
                                    Swal.showLoading();
                                }
                            });

                            // เรียก backend function
                            google.script.run
                                .withSuccessHandler(response => {
                                    Alpine.store('app').ui.loading = false;
                                    Swal.close();

                                    if (response.success) {
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'สำเร็จ!',
                                            html: `
                                <p>สาขา <strong>${result.value.store_name}</strong> ถูกสร้างเรียบร้อยแล้ว</p>
                                <p class="mt-2">รหัสสาขา: <strong>${result.value.store_code}</strong></p>
                                ${result.value.group_line_id ? `<p>Group Line ID: <strong>${result.value.group_line_id}</strong></p>` : ''}
                                <p class="mt-3"><a href="${response.sheet_url}" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์ Spreadsheet</a></p>
                            `,
                                            confirmButtonText: 'ตกลง'
                                        }).then(() => {
                                            // Reload stores list
                                            this.loadStores();
                                        });
                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'เกิดข้อผิดพลาด',
                                            text: response.message || 'ไม่สามารถสร้างสาขาได้',
                                            confirmButtonText: 'ตกลง'
                                        });
                                    }
                                })
                                .withFailureHandler(error => {
                                    Alpine.store('app').ui.loading = false;
                                    Swal.close();

                                    Swal.fire({
                                        icon: 'error',
                                        title: 'เกิดข้อผิดพลาด',
                                        text: error.toString(),
                                        confirmButtonText: 'ตกลง'
                                    });
                                })
                                .createNewStore(
                                    result.value.store_name,
                                    result.value.store_code,
                                    result.value.group_line_id,
                                    Alpine.store('app').user.username // ส่ง username เป็น managerId
                                );
                        }
                    });
                },



                loadStores() {
                    // ส่ง id และ role ของ user ปัจจุบันไปให้ backend
                    const userId = Alpine.store('app').user.id;
                    const userRole = Alpine.store('app').user.role;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                // Update stores list
                                Alpine.store('app').user.stores = response.stores;

                                // Refresh UI if on stores page
                                if (Alpine.store('app').ui.currentPage === 'stores') {
                                    this.navigateTo('stores');
                                }
                            } else {
                                console.error('Failed to load stores:', response.message);
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('Error loading stores:', error);
                        })
                        .getUserStores(userId, userRole); // ส่ง 2 arguments
                },


                // เพิ่มฟังก์ชัน saveMasterSettings
                saveMasterSettings() {
                    Alpine.store('app').ui.loading = true;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ',
                                    text: 'บันทึกการตั้งค่าระบบหลักเรียบร้อย'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ผิดพลาด',
                                    text: response.message
                                });
                            }
                            Alpine.store('app').ui.loading = false;
                        })
                        .withFailureHandler(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'ผิดพลาด',
                                text: error.message
                            });
                            Alpine.store('app').ui.loading = false;
                        })
                        .updateMasterSettings(this.masterSettings);
                },

                // แก้ไขฟังก์ชัน saveStoreSettings
                // แก้ไขฟังก์ชัน saveStoreSettings
                saveStoreSettings() {
                    const sheetId = Alpine.store('app').user.sheetId; // <-- แก้ไขบรรทัดนี้
                    if (!sheetId) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาเลือกสาขา',
                            text: 'กรุณาเลือกสาขาก่อนบันทึกการตั้งค่า'
                        });
                        return;
                    }

                    Alpine.store('app').ui.loading = true;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ',
                                    text: 'บันทึกการตั้งค่าสาขาเรียบร้อย'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ผิดพลาด',
                                    text: response.message
                                });
                            }
                            Alpine.store('app').ui.loading = false;
                        })
                        .withFailureHandler(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'ผิดพลาด',
                                text: error.message
                            });
                            Alpine.store('app').ui.loading = false;
                        })
                        .updateStoreSettingsBackend(sheetId, this.settingsData);
                },

                toggleNotifyDay(dayKey) {
                    // แปลง notify_days string เป็น array
                    const currentDays = this.settingsData.notify_days ? this.settingsData.notify_days.split(',').map(d => d.trim()) : [];

                    // Toggle: ถ้ามีแล้วให้เอาออก, ถ้ายังไม่มีให้เพิ่มเข้าไป
                    const index = currentDays.indexOf(dayKey);
                    if (index > -1) {
                        currentDays.splice(index, 1);
                    } else {
                        currentDays.push(dayKey);
                    }

                    // แปลงกลับเป็น string และ sort ตามลำดับวัน
                    const dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    const sortedDays = currentDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));
                    this.settingsData.notify_days = sortedDays.join(',');
                },

                // Multi-LINE OA Configuration Functions
                loadLineOAConfig() {
                    const currentStoreId = Alpine.store('app').user.currentStore;
                    if (!currentStoreId) {
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                this.lineOAConfig = response.config;
                            } else {
                                console.error('Failed to load LINE OA config:', response.message);
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('Error loading LINE OA config:', error);
                        })
                        .handleDepositSystemAPI({
                            action: 'getStoreLineOAConfig',
                            data: { storeId: currentStoreId }
                        });
                },

                saveLineOAConfig() {
                    const currentStoreId = Alpine.store('app').user.currentStore;
                    if (!currentStoreId) {
                        Swal.fire({
                            icon: 'error',
                            title: 'ข้อผิดพลาด',
                            text: 'กรุณาเลือกสาขาก่อน'
                        });
                        return;
                    }

                    // Validate required fields
                    if (!this.lineOAConfig.line_token) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณากรอกข้อมูล',
                            text: 'กรุณากรอก LINE Access Token'
                        });
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ',
                                    text: 'บันทึกการตั้งค่า LINE OA เรียบร้อย'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ข้อผิดพลาด',
                                    text: response.message || 'ไม่สามารถบันทึกการตั้งค่าได้'
                                });
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('Error saving LINE OA config:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'ข้อผิดพลาด',
                                text: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล'
                            });
                        })
                        .handleDepositSystemAPI({
                            action: 'updateStoreLineOAConfig',
                            data: {
                                storeId: currentStoreId,
                                config: this.lineOAConfig
                            }
                        });
                },

                // Receipt Configuration Functions
                loadReceiptConfig() {
                    let currentStoreId = Alpine.store('app').user.currentStore;

                    // Fix: If currentStore doesn't match any store_id in stores array, use the first store
                    const stores = Alpine.store('app').user.stores;
                    if (stores && stores.length > 0) {
                        const storeExists = stores.find(s => s.store_id === currentStoreId);
                        if (!storeExists) {
                            console.warn('⚠️  loadReceiptConfig: currentStore ID not found, using first store');
                            currentStoreId = stores[0].store_id;
                            Alpine.store('app').user.currentStore = currentStoreId;
                        }
                    }

                    if (!currentStoreId) {
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(response => {
                            if (!response) {
                                console.warn('No response from getStoreReceiptConfig - using default values');
                                return;
                            }
                            if (response.success) {
                                // Merge with existing config to preserve defaults
                                this.receiptConfig = Object.assign({}, this.receiptConfig, response.config);
                            } else {
                                console.error('Failed to load receipt config:', response.message);
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('Error loading receipt config:', error);
                        })
                        .handleDepositSystemAPI({
                            action: 'getStoreReceiptConfig',
                            data: { storeId: currentStoreId }
                        });
                },

                saveReceiptConfig() {
                    let currentStoreId = Alpine.store('app').user.currentStore;
                    console.log('🔍 saveReceiptConfig - currentStoreId:', currentStoreId);
                    console.log('🔍 Full user object:', Alpine.store('app').user);
                    console.log('🔍 Stores array:', Alpine.store('app').user.stores);

                    // Fix: If currentStore doesn't match any store_id in stores array, use the first store
                    const stores = Alpine.store('app').user.stores;
                    if (stores && stores.length > 0) {
                        const storeExists = stores.find(s => s.store_id === currentStoreId);
                        if (!storeExists) {
                            console.warn('⚠️  currentStore ID not found in stores array, using first store');
                            currentStoreId = stores[0].store_id;
                            Alpine.store('app').user.currentStore = currentStoreId;
                            console.log('✅ Updated currentStoreId to:', currentStoreId);
                        }
                    }

                    if (!currentStoreId) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาเลือกสาขา',
                            text: 'กรุณาเลือกสาขาก่อนบันทึกการตั้งค่า'
                        });
                        return;
                    }

                    Swal.fire({
                        title: 'กำลังบันทึก...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    google.script.run
                        .withSuccessHandler(response => {
                            if (!response) {
                                console.error('No response from updateStoreReceiptConfig');
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ผิดพลาด',
                                    text: 'ไม่ได้รับการตอบกลับจากเซิร์ฟเวอร์'
                                });
                                return;
                            }

                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ',
                                    text: 'บันทึกการตั้งค่าใบเสร็จเรียบร้อย'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ผิดพลาด',
                                    text: response.message || 'ไม่สามารถบันทึกได้'
                                });
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('Save receipt config error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'ผิดพลาด',
                                text: error.message || 'เกิดข้อผิดพลาดในการบันทึก'
                            });
                        })
                        .handleDepositSystemAPI({
                            action: 'updateStoreReceiptConfig',
                            data: {
                                storeId: currentStoreId,
                                config: this.receiptConfig
                            }
                        });
                },

                previewCustomerReceipt() {
                    // Create mock deposit data for preview
                    const mockDeposit = {
                        depositCode: 'DEP-PREVIEW-001',
                        customerName: 'คุณทดสอบ ระบบ',
                        customerPhone: '081-234-5678',
                        productName: 'Johnnie Walker Black Label',
                        quantity: 1,
                        depositDate: new Date().toISOString(),
                        expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        notes: 'ตัวอย่างการพิมพ์ใบเสร็จลูกค้า'
                    };

                    const currentStore = Alpine.store('app').user.stores.find(s => s.store_id === Alpine.store('app').user.currentStore);
                    const storeName = currentStore?.store_name || 'ชื่อร้าน';
                    const html = this.generateCustomerReceiptHTML(mockDeposit, storeName);

                    const printWindow = window.open('', '_blank', 'width=400,height=600');
                    if (printWindow) {
                        printWindow.document.write(html);
                        printWindow.document.close();
                    }
                },

                previewBottleLabel() {
                    // Create mock deposit data for preview
                    const mockDeposit = {
                        depositCode: 'DEP-PREVIEW-001',
                        productName: 'Johnnie Walker Black Label',
                        expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    };

                    const html = this.generateBottleLabelHTML(mockDeposit);

                    const printWindow = window.open('', '_blank', 'width=400,height=300');
                    if (printWindow) {
                        printWindow.document.write(html);
                        printWindow.document.close();
                    }
                },

                generateCustomerReceiptHTML(deposit, storeName) {
                    const headerText = this.receiptConfig.receipt_header_text || 'ใบรับฝาก';
                    const depositDate = new Date(deposit.depositDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
                    const expiryDate = new Date(deposit.expiryDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });

                    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page {
            size: 50mm 40mm;
            margin: 0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            width: 50mm;
            height: 40mm;
            padding: 2mm;
            font-family: 'Sarabun', Arial, sans-serif;
            font-size: 7pt;
            line-height: 1.3;
        }
        .header {
            text-align: center;
            font-size: 9pt;
            font-weight: bold;
            border-bottom: 0.3mm dashed #000;
            padding-bottom: 1mm;
            margin-bottom: 1mm;
        }
        .code {
            text-align: center;
            font-size: 12pt;
            font-weight: bold;
            letter-spacing: 0.5mm;
            margin: 1mm 0;
        }
        .info {
            font-size: 7pt;
        }
        .row {
            display: flex;
            justify-content: space-between;
            margin: 0.5mm 0;
        }
        .row .label {
            color: #333;
        }
        .row .value {
            font-weight: bold;
            text-align: right;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .dates {
            display: flex;
            justify-content: space-between;
            font-size: 6.5pt;
            border-top: 0.3mm dashed #000;
            padding-top: 1mm;
            margin-top: 1mm;
        }
        .date-item {
            text-align: center;
        }
        .date-label {
            color: #555;
            font-size: 6pt;
        }
        .date-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">${headerText}</div>
    <div class="code">${deposit.depositCode}</div>
    <div class="info">
        <div class="row">
            <span class="label">ชื่อ</span>
            <span class="value">${deposit.customerName}</span>
        </div>
        <div class="row">
            <span class="label">สินค้า</span>
            <span class="value">${deposit.productName}</span>
        </div>
        <div class="row">
            <span class="label">จำนวน</span>
            <span class="value">${deposit.quantity} ขวด</span>
        </div>
    </div>
    <div class="dates">
        <div class="date-item">
            <div class="date-label">วันฝาก</div>
            <div class="date-value">${depositDate}</div>
        </div>
        <div class="date-item">
            <div class="date-label">หมดอายุ</div>
            <div class="date-value">${expiryDate}</div>
        </div>
    </div>
</body>
</html>
                    `;
                },

                generateBottleLabelHTML(deposit) {
                    const expiryDate = new Date(deposit.expiryDate).toLocaleDateString('th-TH', {
                        year: '2-digit',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    const quantity = deposit.quantity || 1;

                    // Generate multiple labels based on quantity
                    let labelsHTML = '';
                    for (let i = 0; i < quantity; i++) {
                        labelsHTML += `
    <div class="label-page">
        <div class="code">${deposit.depositCode}</div>
        <div class="product">${deposit.productName}</div>
        <div class="bottle-num">${i + 1}/${quantity}</div>
        <div class="expiry-box">EXP: ${expiryDate}</div>
    </div>`;
                    }

                    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page {
            size: 50mm 40mm;
            margin: 0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Sarabun', Arial, sans-serif;
        }
        .label-page {
            width: 50mm;
            height: 40mm;
            padding: 2mm;
            page-break-after: always;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .label-page:last-child {
            page-break-after: auto;
        }
        .code {
            font-size: 14pt;
            font-weight: bold;
            letter-spacing: 0.5mm;
            margin-bottom: 2mm;
        }
        .product {
            font-size: 8pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2mm;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bottle-num {
            font-size: 10pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 2mm;
        }
        .expiry-box {
            background: #000;
            color: #fff;
            padding: 1.5mm 4mm;
            border-radius: 1mm;
            font-size: 8pt;
            font-weight: bold;
        }
    </style>
</head>
<body>
    ${labelsHTML}
</body>
</html>
                    `;
                },

                uploadQRCode(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (!file.type.startsWith('image/')) {
                        Swal.fire({
                            icon: 'error',
                            title: 'ผิดพลาด',
                            text: 'กรุณาเลือกไฟล์รูปภาพเท่านั้น'
                        });
                        return;
                    }

                    this.isUploadingQR = true;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Image = e.target.result.split(',')[1];

                        // Upload to ImgBB
                        const formData = new FormData();
                        formData.append('image', base64Image);
                        formData.append('key', this.masterSettings.IMGBB_API_KEY);

                        fetch('https://api.imgbb.com/1/upload', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    this.receiptConfig.qr_code_image_url = data.data.url;
                                    Toastify({
                                        text: "อัปโหลด QR Code สำเร็จ",
                                        duration: 3000,
                                        style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                                    }).showToast();
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'ผิดพลาด',
                                        text: 'ไม่สามารถอัปโหลดรูปภาพได้'
                                    });
                                }
                                this.isUploadingQR = false;
                            })
                            .catch(error => {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ผิดพลาด',
                                    text: error.message
                                });
                                this.isUploadingQR = false;
                            });
                    };
                    reader.readAsDataURL(file);
                },

                uploadLogo(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (!file.type.startsWith('image/')) {
                        Swal.fire({
                            icon: 'error',
                            title: 'ผิดพลาด',
                            text: 'กรุณาเลือกไฟล์รูปภาพเท่านั้น'
                        });
                        return;
                    }

                    this.isUploadingLogo = true;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Image = e.target.result.split(',')[1];

                        // Upload to ImgBB
                        const formData = new FormData();
                        formData.append('image', base64Image);
                        formData.append('key', this.masterSettings.IMGBB_API_KEY);

                        fetch('https://api.imgbb.com/1/upload', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    this.receiptConfig.receipt_logo_url = data.data.url;
                                    Toastify({
                                        text: "อัปโหลดโลโก้สำเร็จ",
                                        duration: 3000,
                                        style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                                    }).showToast();
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'ผิดพลาด',
                                        text: 'ไม่สามารถอัปโหลดรูปภาพได้'
                                    });
                                }
                                this.isUploadingLogo = false;
                            })
                            .catch(error => {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ผิดพลาด',
                                    text: error.message
                                });
                                this.isUploadingLogo = false;
                            });
                    };
                    reader.readAsDataURL(file);
                },

                viewImage(imageUrl) {
                    Swal.fire({
                        imageUrl: imageUrl,
                        imageAlt: 'Image Preview',
                        showCloseButton: true,
                        showConfirmButton: false,
                        width: 600
                    });
                },

                renderCurrentPage() {
                    const page = Alpine.store('app').ui.currentPage;
                    const pages = {
                        dashboard: this.renderDashboard(),
                        products: this.renderProducts(),
                        manual_count: this.renderManualCount(),
                        pdf_upload: this.renderPDFUpload(),
                        comparison: this.renderComparison(),
                        line_dashboard: this.renderLineDashboard(),
                        users: this.renderUsers(),
                        stores: this.renderStores(),
                        settings: this.renderSettings(),
                        activity_history: this.renderActivityHistory(),
                        dashboard_deposit: this.renderDashboardDeposit(),
                        deposit_history: this.renderDepositHistory(),
                        central_transfer: this.renderCentralTransfer(),
                    };
                    return pages[page] || `<div>Page not found: ${page}</div>`;
                },






                async loadCategories() {
                    if (!this.$store.app.user.currentStore) {
                        this.showCategoryMessage('error', 'กรุณาเลือกสาขาก่อน');
                        return;
                    }

                    try {
                        this.showCategoryMessage('info', 'กำลังโหลดหมวดหมู่...');

                        const sheetId = this.$store.app.user.sheetId; // [!code ++]

                        const result = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getCurrentCategoriesForUI(sheetId);
                        });

                        if (result.success) {
                            this.categoryData.categories = result.categories;
                            this.categoryData.jsonText = result.json;
                            this.categoryData.message = '';
                        } else {
                            this.showCategoryMessage('error', result.message);
                        }
                    } catch (error) {
                        this.showCategoryMessage('error', `เกิดข้อผิดพลาด: ${error.message}`);
                    }
                },

                async saveCategories() {
                    if (!this.$store.app.user.currentStore) {
                        this.showCategoryMessage('error', 'กรุณาเลือกสาขาก่อน');
                        return;
                    }

                    try {
                        // Validate JSON first
                        const categories = JSON.parse(this.categoryData.jsonText);

                        if (!Array.isArray(categories)) {
                            this.showCategoryMessage('error', 'รูปแบบไม่ถูกต้อง: ต้องเป็น Array');
                            return;
                        }

                        if (categories.length === 0) {
                            this.showCategoryMessage('error', 'ต้องมีหมวดหมู่อย่างน้อย 1 หมวด');
                            return;
                        }

                        // Check for non-MAT categories
                        const nonMatCategories = categories.filter(c => !c.startsWith('MAT-'));
                        if (nonMatCategories.length > 0) {
                            const proceed = confirm(`พบหมวดหมู่ที่ไม่ขึ้นต้นด้วย "MAT-": ${nonMatCategories.join(', ')}\n\nต้องการบันทึกต่อไปหรือไม่?`);
                            if (!proceed) return;
                        }

                        this.showCategoryMessage('info', 'กำลังบันทึก...');

                        const sheetId = this.$store.app.user.currentStore.sheetId;

                        const result = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .saveCategoriesFromUI(sheetId, this.categoryData.jsonText);
                        });

                        if (result.success) {
                            this.showCategoryMessage('success', `✅ ${result.message}`);
                            await this.loadCategories();
                        } else {
                            this.showCategoryMessage('error', `❌ ${result.message}`);
                        }
                    } catch (error) {
                        this.showCategoryMessage('error', `JSON ไม่ถูกต้อง: ${error.message}`);
                    }
                },



                async resetCategoriesToDefault() {
                    if (!confirm('รีเซ็ตเป็นค่าเริ่มต้น? การตั้งค่าปัจจุบันจะถูกลบ')) {
                        return;
                    }

                    try {
                        this.showCategoryMessage('info', 'กำลังรีเซ็ต...');

                        const result = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .getDefaultCategoriesForUI();
                        });

                        if (result.success) {
                            this.categoryData.jsonText = JSON.stringify(result.categories, null, 2);
                            this.showCategoryMessage('success', '✅ รีเซ็ตเรียบร้อย คลิก "บันทึก" เพื่อยืนยัน');
                        }
                    } catch (error) {
                        this.showCategoryMessage('error', `เกิดข้อผิดพลาด: ${error.message}`);
                    }
                },

                validateCategories() {
                    try {
                        const categories = JSON.parse(this.categoryData.jsonText);

                        if (!Array.isArray(categories)) {
                            this.showCategoryMessage('error', '❌ รูปแบบไม่ถูกต้อง: ต้องเป็น Array');
                            return;
                        }

                        if (categories.length === 0) {
                            this.showCategoryMessage('error', '❌ Array ว่างเปล่า');
                            return;
                        }

                        const issues = [];
                        const nonMatCategories = categories.filter(c => !c.startsWith('MAT-'));
                        if (nonMatCategories.length > 0) {
                            issues.push(`⚠️ ${nonMatCategories.length} หมวดไม่ขึ้นต้นด้วย "MAT-"`);
                        }

                        const duplicates = categories.filter((c, i) => categories.indexOf(c) !== i);
                        if (duplicates.length > 0) {
                            issues.push(`⚠️ มีหมวดซ้ำ: ${[...new Set(duplicates)].join(', ')}`);
                        }

                        if (issues.length > 0) {
                            this.showCategoryMessage('warning', issues.join('<br>'));
                        } else {
                            this.showCategoryMessage('success', `✅ รูปแบบถูกต้อง! มี ${categories.length} หมวด`);
                        }

                    } catch (error) {
                        this.showCategoryMessage('error', `❌ JSON ไม่ถูกต้อง: ${error.message}`);
                    }
                },

                exportCategories() {
                    const jsonText = this.categoryData.jsonText;

                    // Copy to clipboard
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(jsonText).then(() => {
                            this.showCategoryMessage('success', '✅ คัดลอกไปยัง Clipboard แล้ว!');
                        }).catch(() => {
                            this.showCategoryMessage('info', `คัดลอกข้อมูลด้านล่าง:\n\n${jsonText}`);
                        });
                    } else {
                        // Fallback
                        prompt('คัดลอกข้อมูลด้านล่าง:', jsonText);
                    }
                },

                importCategories() {
                    const jsonText = prompt('วาง JSON ของหมวดหมู่ที่ต้องการนำเข้า:');

                    if (!jsonText) return;

                    try {
                        const categories = JSON.parse(jsonText);

                        if (!Array.isArray(categories)) {
                            this.showCategoryMessage('error', 'รูปแบบไม่ถูกต้อง: ต้องเป็น Array');
                            return;
                        }

                        this.categoryData.jsonText = JSON.stringify(categories, null, 2);
                        this.categoryData.categories = categories;
                        this.showCategoryMessage('success', '✅ นำเข้าเรียบร้อย คลิก "บันทึก" เพื่อยืนยัน');

                    } catch (error) {
                        this.showCategoryMessage('error', `JSON ไม่ถูกต้อง: ${error.message}`);
                    }
                },

                showCategoryMessage(type, message) {
                    this.categoryData.messageType = type;
                    this.categoryData.message = message;

                    // Auto hide success/info messages
                    if (type === 'success' || type === 'info') {
                        setTimeout(() => {
                            this.categoryData.message = '';
                        }, 5000);
                    }
                },










                renderActivityHistory() {
                    return `
        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center space-x-4">
                    <div class="bg-purple-100 dark:bg-purple-900/30 p-4 rounded-xl"><i class="fas fa-history text-4xl text-purple-600 dark:text-purple-400"></i></div>
                    <div><h2 class="text-3xl font-bold mb-1">ประวัติการทำงาน</h2><p class="text-gray-600 dark:text-gray-400">ติดตามสถานะการนับสต็อกและชี้แจงผลต่างรายวัน</p></div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label class="text-xs text-gray-500 dark:text-gray-400">จากวันที่</label><input type="date" x-model="activityHistory.filters.dateFrom" @change="loadActivityHistory()" class="w-full mt-1 p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="text-xs text-gray-500 dark:text-gray-400">ถึงวันที่</label><input type="date" x-model="activityHistory.filters.dateTo" @change="loadActivityHistory()" class="w-full mt-1 p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="text-xs text-gray-500 dark:text-gray-400">กรองตามสถานะ</label><select x-model="activityHistory.filters.status" class="w-full mt-1 p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"><option value="all">ทุกสถานะ</option><option value="pending_explanation">รอชี้แจง</option><option value="pending_approval">รออนุมัติ</option><option value="rejected">ถูกปฏิเสธ</option><option value="completed">เสร็จสิ้น</option></select></div>
                </div>
            </div>
            <div x-show="activityHistory.loading" class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-2 text-gray-500">กำลังโหลดข้อมูล...</p></div>
            <div x-show="!activityHistory.loading" class="space-y-3">
                <template x-if="filteredActivityHistory.length === 0"><div class="text-center text-gray-500 py-12 bg-white dark:bg-gray-800 rounded-lg shadow"><i class="fas fa-inbox text-5xl mb-4"></i><p>ไม่พบข้อมูลตามเงื่อนไขที่เลือก</p></div></template>
                <template x-for="item in filteredActivityHistory" :key="item.date">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col md:flex-row items-center justify-between gap-4 hover:shadow-md transition-shadow">
                        <div class="flex-1 w-full md:w-auto">
                            <p class="font-bold text-lg" x-text="new Date(item.date).toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })"></p>
                            <div class="flex items-center space-x-4 text-sm mt-2">
                                <span class="flex items-center" :class="item.hasManualCount ? 'text-green-600' : 'text-gray-400'"><i class="fas fa-clipboard-check text-base mr-2"></i> นับสต็อก</span>
                                <span class="flex items-center" :class="item.hasPdfUpload ? 'text-blue-600' : 'text-gray-400'"><i class="fas fa-file-pdf text-base mr-2"></i> อัปโหลด PDF</span>
                            </div>
                        </div>
                        <div class="flex-shrink-0 flex flex-col items-center mx-4 my-2 md:my-0">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full" :class="'bg-' + (statusMap[item.status]?.color || 'gray') + '-100 text-' + (statusMap[item.status]?.color || 'gray') + '-800 dark:bg-opacity-20 dark:text-' + (statusMap[item.status]?.color || 'gray') + '-300'"><i :class="'fas ' + (statusMap[item.status]?.icon || 'fa-question-circle') + ' mr-1.5'"></i><span x-text="statusMap[item.status]?.text || 'ไม่ทราบสถานะ'"></span></span>
                            
                            <div x-show="item.totalDiscrepancies > 0" class="flex items-center gap-3 text-xs mt-2">
                                <span class="flex items-center text-gray-500 dark:text-gray-400" title="จำนวนผลต่างทั้งหมด">
                                    <i class="fas fa-file-alt mr-1"></i>
                                    <span x-text="item.totalDiscrepancies"></span>
                                </span>
                                <span x-show="item.pendingApprovalCount > 0" class="flex items-center text-yellow-600 dark:text-yellow-400" title="จำนวนรายการที่รออนุมัติ">
                                    <i class="fas fa-hourglass-half mr-1"></i>
                                    <span x-text="item.pendingApprovalCount"></span>
                                </span>
                                <span x-show="item.rejectedCount > 0" class="flex items-center text-red-600 dark:text-red-400" title="จำนวนรายการที่ถูกปฏิเสธ">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    <span x-text="item.rejectedCount"></span>
                                </span>
                            </div>
                            </div>
                        <div class="flex-shrink-0 w-full md:w-auto">
                            <button @click="openExplanationPage(item.date)" class="w-full bg-blue-500 text-white px-5 py-2.5 rounded-lg hover:bg-blue-600 font-semibold transition-colors flex items-center justify-center"><i class="fas fa-search mr-2"></i>ดูรายละเอียด</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    `;
                },


                get sortedAndFilteredDiscrepancies() {
                    if (!this.dashboardData || !this.dashboardData.discrepancies) return { items: [], total: 0, t: this.t };

                    // [!code --] const data = [...this.dashboardData.discrepancies]
                    const data = this.dashboardData.discrepancies.map(item => ({ ...item, t: this.t }))
                        .filter(item => {
                            if (this.discrepancySearch.trim() === '') return true;
                            const term = this.discrepancySearch.toLowerCase();
                            return (item.product_name || '').toLowerCase().includes(term) ||
                                (item.product_code || '').toLowerCase().includes(term);
                        })
                        .sort((a, b) => {
                            const key = this.discrepancySort.key;
                            const dir = this.discrepancySort.dir === 'asc' ? 1 : -1;

                            let valA = a[key];
                            let valB = b[key];

                            if (key === 'difference') {
                                valA = Math.abs(valA);
                                valB = Math.abs(valB);
                            }

                            if (valA < valB) return -1 * dir;
                            if (valA > valB) return 1 * dir;
                            return 0;
                        });

                    const total = data.length;
                    const start = (this.discrepancyCurrentPage - 1) * this.discrepancyPageSize;
                    const end = start + this.discrepancyPageSize;
                    const items = data.slice(start, end);

                    return { items, total, t: this.t };
                },

                changeDiscrepancyPage(direction) {
                    if (direction === 'next') {
                        const totalPages = Math.ceil(this.sortedAndFilteredDiscrepancies.total / this.discrepancyPageSize);
                        if (this.discrepancyCurrentPage < totalPages) {
                            this.discrepancyCurrentPage++;
                        }
                    } else if (direction === 'prev' && this.discrepancyCurrentPage > 1) {
                        this.discrepancyCurrentPage--;
                    }
                },


                renderDashboard() {
                    return `
        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8 mb-6">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-xl">
                            <i class="fas fa-chart-pie text-4xl text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">${this.t('inventory_dashboard')}</h2>
                            <p class="text-gray-600 dark:text-gray-400">${this.t('stores')}: ${this.getCurrentStoreName()}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl px-4 py-2">
                        <div class="relative group">
                            <i class="fas fa-clipboard-check text-xl" :class="dashboardData.todayStatus.manualCount ? 'text-green-500' : 'text-gray-400'"></i>
                        </div>
                        <div class="relative group">
                            <i class="fas fa-file-alt text-xl" :class="dashboardData.todayStatus.txtUpload ? 'text-blue-500' : 'text-gray-400'"></i>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 ml-2">
                            <div>วันนี้</div>
                            <div class="font-medium" x-text="new Date().toLocaleDateString('th-TH', {day: 'numeric', month: 'short'})"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 -mt-6 mb-6">
                <div></div>
                <div class="flex flex-wrap items-center gap-2">
                    <input type="date" x-model="dashboardData.dateFrom" @change="loadDashboardData()" class="px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm">
                    <span class="text-gray-500">-</span>
                    <input type="date" x-model="dashboardData.dateTo" @change="loadDashboardData()" class="px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm">
                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1 ml-2">
                        <button @click="setDateRange('today')" class="px-3 py-1 text-sm rounded-md hover:bg-white dark:hover:bg-gray-600">${this.t('today')}</button>
                        <button @click="setDateRange('week')" class="px-3 py-1 text-sm rounded-md hover:bg-white dark:hover:bg-gray-600">${this.t('this_week')}</button>
                        <button @click="setDateRange('month')" class="px-3 py-1 text-sm rounded-md hover:bg-white dark:hover:bg-gray-600">${this.t('this_month')}</button>
                    </div>
                    <div class="flex gap-2 ml-2">
                        <button @click="exportDashboard('pdf')" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm"><i class="fas fa-file-pdf mr-1"></i>PDF</button>
                        <button @click="exportDashboard('excel')" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"><i class="fas fa-file-excel mr-1"></i>Excel</button>
                    </div>
                </div>
            </div>

            ${this.renderDashboardBody()}
        </div>
    `;
                },



                renderDashboardBody() {
                    return `
        <div class="space-y-6">
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 shadow-softLight dark:shadow-soft">
                    <div class="text-sm text-slate-500 dark:text-slate-400">${this.t('total_items')}</div>
                    <div class="text-2xl font-semibold mt-1 tracking-tight" x-text="dashboardData.stats.totalItems || '0'"></div>
                </div>
                <div class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 shadow-softLight dark:shadow-soft">
                    <div class="text-sm text-slate-500 dark:text-slate-400">${this.t('sum_diff_qty')}</div>
                    <div class="text-2xl font-semibold mt-1 tracking-tight" x-text="(dashboardData.stats.sumDiff || 0).toFixed(2)"></div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">${this.t('over_short_indicator')}</div>
                </div>
                <div class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 shadow-softLight dark:shadow-soft">
                    <div class="text-sm text-slate-500 dark:text-slate-400">${this.t('shrinkage_rate')}</div>
                    <div class="text-2xl font-semibold mt-1 tracking-tight" x-text="(dashboardData.stats.shrinkageRate || 0).toFixed(2) + '%'"></div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">${this.t('stock_accuracy_measure')}</div>
                </div>
                <div class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 shadow-softLight dark:shadow-soft">
                    <div class="text-sm text-slate-500 dark:text-slate-400">${this.t('top_offender')}</div>
                    <div class="text-2xl font-semibold mt-1 tracking-tight truncate" x-text="dashboardData.stats.topOffender !== 'None' ? dashboardData.stats.topOffender : t('no_data')" :title="dashboardData.stats.topOffender"></div>
                    <div class="text-xs mt-2" 
                         :class="dashboardData.topDiffItems.length > 0 && dashboardData.topDiffItems[0].value >= 0 ? 'text-green-500' : 'text-red-500'"
                         x-text="dashboardData.topDiffItems.length > 0 ? t('difference') + ': ' + dashboardData.topDiffItems[0].value.toFixed(2) : ''">
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 col-span-1 lg:col-span-2 shadow-softLight dark:shadow-soft">
                    <div class="flex items-center justify-between gap-4">
                        <h3 class="font-medium tracking-tight">${this.t('top_5_by_diff')}</h3>
                        <div class="flex items-center gap-1 p-1 rounded-lg border border-slate-200 bg-slate-100/70 dark:border-white/10 dark:bg-white/5">
                            <button @click="top5Mode = 'abs'; renderCharts()" :class="top5Mode === 'abs' ? 'border-indigo-500/60 bg-white dark:bg-indigo-500/15 text-indigo-600 dark:text-indigo-300' : 'border-transparent text-slate-600 hover:bg-white/50 dark:text-slate-300 dark:hover:bg-white/5'" class="px-3 py-1.5 text-xs rounded-md border transition-colors">${this.t('diff_short')}</button>
                            <button @click="top5Mode = 'over'; renderCharts()" :class="top5Mode === 'over' ? 'border-indigo-500/60 bg-white dark:bg-indigo-500/15 text-indigo-600 dark:text-indigo-300' : 'border-transparent text-slate-600 hover:bg-white/50 dark:text-slate-300 dark:hover:bg-white/5'" class="px-3 py-1.5 text-xs rounded-md border transition-colors">+ ${this.t('over')}</button>
                            <button @click="top5Mode = 'short'; renderCharts()" :class="top5Mode === 'short' ? 'border-indigo-500/60 bg-white dark:bg-indigo-500/15 text-indigo-600 dark:text-indigo-300' : 'border-transparent text-slate-600 hover:bg-white/50 dark:text-slate-300 dark:hover:bg-white/5'" class="px-3 py-1.5 text-xs rounded-md border transition-colors">- ${this.t('short')}</button>
                        </div>
                    </div>
                    <div class="mt-4 h-72">
                        <canvas id="topDiffChartNew"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 shadow-softLight dark:shadow-soft">
                    <h3 class="font-medium tracking-tight">${this.t('diff_by_category')}</h3>
                    <div class="mt-4 h-72">
                        <canvas id="categoryChartNew"></canvas>
                    </div>
                </div>
            </section>

            <section class="bg-white dark:bg-neutral-900 p-4 rounded-xl border border-slate-200 dark:border-white/10 shadow-softLight dark:shadow-soft">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h3 class="font-medium tracking-tight">${this.t('latest_discrepancies')}</h3>
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        <label class="text-sm text-slate-500 dark:text-slate-400 hidden md:block">${this.t('show_label')}</label>
                        <select x-model.number="discrepancyPageSize" @change="discrepancyCurrentPage = 1" class="bg-white text-slate-700 px-3 py-2 rounded-lg border border-slate-300 dark:bg-neutral-800 dark:text-slate-200 dark:border-white/10 transition-colors">
                            <option value="10">10</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                        </select>
                        <label class="text-sm text-slate-500 dark:text-slate-400 hidden md:block">${this.t('sort_label')}</label>
                        <select x-model="discrepancySort.key" @change="discrepancyCurrentPage = 1" class="bg-white text-slate-700 px-3 py-2 rounded-lg border border-slate-300 dark:bg-neutral-800 dark:text-slate-200 dark:border-white/10 transition-colors">
                            <option value="difference">${this.t('abs_diff')}</option>
                            <option value="product_name">${this.t('item_label')}</option>
                            <option value="pos_quantity">${this.t('pos_label')}</option>
                            <option value="manual_quantity">${this.t('count_label')}</option>
                        </select>
                        <select x-model="discrepancySort.dir" @change="discrepancyCurrentPage = 1" class="bg-white text-slate-700 px-3 py-2 rounded-lg border border-slate-300 dark:bg-neutral-800 dark:text-slate-200 dark:border-white/10 transition-colors">
                            <option value="desc">${this.t('desc_short')}</option>
                            <option value="asc">${this.t('asc_short')}</option>
                        </select>
                        <div class="relative">
                            <i class="fas fa-search w-4 h-4 absolute left-3 top-2.5 text-slate-400 pointer-events-none"></i>
                            <input x-model.debounce.300ms="discrepancySearch" @input="discrepancyCurrentPage = 1" :placeholder="t('search_products')" class="bg-white text-slate-700 pl-9 pr-3 py-2 rounded-lg border border-slate-300 dark:bg-neutral-800 dark:text-slate-200 dark:border-white/10 transition-colors" />
                        </div>
                    </div>
                </div>
                <div class="mt-4 overflow-auto">
                    <table class="w-full text-left border-separate" style="border-spacing:0 8px;">
                        <thead class="text-sm text-slate-500 dark:text-slate-400">
                            <tr>
                                <th class="px-3 py-2">${this.t('item_label')}</th>
                                <th class="px-3 py-2">${this.t('pos_label')}</th>
                                <th class="px-3 py-2">${this.t('count_label')}</th>
                                <th class="px-3 py-2">${this.t('difference')}</th>
                                <th class="px-3 py-2">${this.t('direction_label')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="sortedAndFilteredDiscrepancies.items.length === 0">
                                <tr><td colspan="5" class="px-3 py-10 text-center text-slate-500 dark:text-slate-400" x-text="t('no_data_period')"></td></tr>
                            </template>
                            <template x-for="item in sortedAndFilteredDiscrepancies.items" :key="item.comp_id">
                                <tr class="bg-white hover:bg-slate-50/50 dark:bg-white/5 dark:hover:bg-white/10 transition-colors">
                                    <td class="px-3 py-3 rounded-l-lg">
                                        <div class="font-medium" x-text="item.product_name || '-'"></div>
                                        <div class="text-xs text-slate-500" x-text="item.product_code || '-'"></div>
                                    </td>
                                    <td class="px-3 py-3" x-text="(item.pos_quantity || 0).toFixed(2)"></td>
                                    <td class="px-3 py-3" x-text="(item.manual_quantity || 0).toFixed(2)"></td>
                                    <td class="px-3 py-3 font-medium" :class="item.difference >= 0 ? 'text-green-500' : 'text-red-500'" x-text="(item.difference >= 0 ? '+' : '') + (item.difference || 0).toFixed(2)"></td>
                                    <td class="px-3 py-3 rounded-r-lg">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs border"
                                              :class="item.difference >= 0 ? 'bg-green-500/10 text-green-600 border-green-400/30' : 'bg-red-500/10 text-red-600 border-red-400/30'">
                                            <span x-text="item.difference >= 0 ? t('over') : t('short')"></span>
                                        </span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex items-center justify-between text-sm">
                    <div class="text-slate-600 dark:text-slate-400">
                        <span x-text="t('showing_label')"></span> 
                        <span x-text="sortedAndFilteredDiscrepancies.items.length > 0 ? (discrepancyCurrentPage - 1) * discrepancyPageSize + 1 : 0"></span> 
                        <span x-text="t('to_label')"></span> 
                        <span x-text="Math.min(discrepancyCurrentPage * discrepancyPageSize, sortedAndFilteredDiscrepancies.total)"></span> 
                        <span x-text="t('of_label')"></span> 
                        <span x-text="sortedAndFilteredDiscrepancies.total"></span> 
                        <span x-text="t('items_label')"></span>
                    </div>
                    <div class="inline-flex gap-2">
                        <button @click="changeDiscrepancyPage('prev')" :disabled="discrepancyCurrentPage === 1" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 dark:border-white/10 dark:bg-neutral-800 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" x-text="t('previous_button')"></button>
                        <button @click="changeDiscrepancyPage('next')" :disabled="discrepancyCurrentPage * discrepancyPageSize >= sortedAndFilteredDiscrepancies.total" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 dark:border-white/10 dark:bg-neutral-800 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" x-text="t('next_button')"></button>
                    </div>
                </div>
            </section>
        </div>
    `;
                },



                sortProducts(key) {
                    if (this.productSort.key === key) {
                        // ถ้าคลิกที่คอลัมน์เดิม ให้สลับทิศทาง
                        this.productSort.dir = this.productSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        // ถ้าคลิกคอลัมน์ใหม่ ให้เรียงจากน้อยไปมากเสมอ
                        this.productSort.key = key;
                        this.productSort.dir = 'asc';
                    }
                },


                get sortedAndFilteredProducts() {
                    if (!this.products) return [];

                    return [...this.products]
                        .filter(p => {
                            // ส่วนของการค้นหา (Search)
                            if (this.productSearchTerm.trim() === '') return true;
                            const term = this.productSearchTerm.toLowerCase();
                            return p.product_code.toLowerCase().includes(term) ||
                                p.product_name.toLowerCase().includes(term) ||
                                p.category.toLowerCase().includes(term);
                        })
                        .sort((a, b) => {
                            // ส่วนของการเรียงข้อมูล (Sort)
                            const key = this.productSort.key;
                            const dir = this.productSort.dir === 'asc' ? 1 : -1;

                            if (a[key] < b[key]) return -1 * dir;
                            if (a[key] > b[key]) return 1 * dir;
                            return 0;
                        });
                },


                get productsByCategory() {
                    const grouped = {};
                    this.sortedAndFilteredProducts.forEach(product => {
                        const category = product.category || 'ไม่มีหมวดหมู่';
                        if (!grouped[category]) {
                            grouped[category] = [];
                        }
                        grouped[category].push(product);
                    });
                    return grouped;
                },

                renderProductsHeader() {
                    return `
        <div class="glow-border bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl md:text-2xl font-bold mb-4">จัดการสินค้า</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 md:p-4 rounded-lg">
                    <p class="text-xs md:text-sm text-gray-600 dark:text-gray-400">สินค้าทั้งหมด</p>
                    <p class="text-xl md:text-2xl font-bold text-blue-600" x-text="productStats.total"></p>
                </div>
                <div class="bg-green-50 dark:bg-green-900/20 p-3 md:p-4 rounded-lg">
                    <p class="text-xs md:text-sm text-gray-600 dark:text-gray-400">เปิดใช้งาน</p>
                    <p class="text-xl md:text-2xl font-bold text-green-600" x-text="productStats.active"></p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 p-3 md:p-4 rounded-lg">
                    <p class="text-xs md:text-sm text-gray-600 dark:text-gray-400">ปิดใช้งาน</p>
                    <p class="text-xl md:text-2xl font-bold text-gray-600" x-text="productStats.inactive"></p>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 md:p-4 rounded-lg">
                    <p class="text-xs md:text-sm text-gray-600 dark:text-gray-400">ยกเว้นการนับ</p>
                    <p class="text-xl md:text-2xl font-bold text-yellow-600" x-text="productStats.excluded"></p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" x-model.debounce.300ms="productSearchTerm" placeholder="ค้นหาสินค้า (รหัส, ชื่อ, หมวดหมู่)..." class="flex-grow p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                <button @click="showAddModal = true" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 w-full md:w-auto whitespace-nowrap">
                    <i class="fas fa-plus mr-2"></i>เพิ่มสินค้า
                </button>
            </div>
        </div>
    `;
                },



                renderProductsTable() {
                    return `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
            <!-- Desktop Table View -->
            <div class="md:block hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">สถานะขาย</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">รหัสสินค้า</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">ชื่อสินค้า</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">หมวดหมู่</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">สถานะการนับ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="product in sortedAndFilteredProducts" :key="product.product_id">
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                                          :class="product.active ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'">
                                        <span x-text="product.active ? 'ใช้งาน' : 'ปิด'"></span>
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm font-mono" x-text="product.product_code"></td>
                                <td class="px-4 py-3 text-sm font-medium" x-text="product.product_name"></td>
                                <td class="px-4 py-3 text-sm" x-text="product.category"></td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                                          :class="{
                                            'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300': product.count_status === 'active' || !product.count_status,
                                            'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300': product.count_status === 'excluded'
                                          }"
                                          x-text="product.count_status === 'excluded' ? 'ยกเว้น' : 'นับปกติ'">
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button @click="openEditModal(product)" 
                                            class="inline-flex items-center px-3 py-1.5 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-xs rounded-lg transition-colors">
                                        <i class="fas fa-edit mr-1"></i> แก้ไข
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View with Category Grouping -->
            <div class="md:hidden" x-data="{ collapsedCategories: {} }">
                <template x-for="(categoryGroup, categoryName) in productsByCategory" :key="categoryName">
                    <div class="border-b dark:border-gray-700">
                        <!-- Category Header -->
                        <button @click="collapsedCategories[categoryName] = !collapsedCategories[categoryName]"
                                class="w-full flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-folder text-blue-500"></i>
                                <span class="font-medium text-sm" x-text="categoryName"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500" x-text="categoryGroup.length + ' รายการ'"></span>
                                <i class="fas text-xs transition-transform duration-200"
                                   :class="collapsedCategories[categoryName] ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                            </div>
                        </button>
                        
                        <!-- Products in Category -->
                        <div x-show="!collapsedCategories[categoryName]" class="divide-y divide-gray-100 dark:divide-gray-700/50">
                            <template x-for="product in categoryGroup" :key="product.product_id">
                                <div class="px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2">
                                                <span class="font-medium text-sm truncate" x-text="product.product_name"></span>
                                                <span class="flex-shrink-0 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium"
                                                      :class="product.active ? 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300'">
                                                    <span x-text="product.active ? 'ใช้งาน' : 'ปิดใช้งาน'"></span>
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-2 mt-0.5">
                                                <span class="text-xs text-gray-500 font-mono" x-text="product.product_code"></span>
                                                <span class="text-xs text-gray-400">•</span>
                                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs"
                                                      :class="{
                                                        'bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300': product.count_status === 'active' || !product.count_status,
                                                        'bg-yellow-50 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-300': product.count_status === 'excluded'
                                                      }"
                                                      x-text="product.count_status === 'excluded' ? 'ยกเว้น' : 'นับปกติ'">
                                                </span>
                                            </div>
                                        </div>
                                        <button @click="openEditModal(product)" 
                                                class="flex-shrink-0 p-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                            <i class="fas fa-edit text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    `;
                },



                renderProducts() {
                    return `
        <!-- Add Product Modal - แก้ไขให้ปุ่มไม่ถูกบัง -->
        <div x-show="showAddModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" @keydown.escape.window="showAddModal = false" x-cloak>
            <div @click.away="showAddModal = false" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[85vh] flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b dark:border-gray-700 flex-shrink-0">
                    <h3 class="text-lg font-semibold">เพิ่มสินค้าใหม่</h3>
                </div>
                
                <!-- Content - จำกัดความสูง -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1" style="max-height: calc(85vh - 140px);">
                    <div class="flex items-center gap-4">
                        <img :src="newProduct.image_url || 'https://placehold.co/100x100/e2e8f0/64748b?text=No+Image'" class="w-24 h-24 rounded-lg object-cover">
                        <div>
                            <label class="block text-sm font-medium mb-1">รูปสินค้า</label>
                            <input type="file" @change="uploadImageToImgBB($event, 'new')" class="text-sm">
                            <div x-show="isUploadingImage" class="text-sm text-blue-500 mt-1"><i class="fas fa-spinner fa-spin mr-1"></i>กำลังอัปโหลด...</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">รหัสสินค้า</label><input type="text" x-model="newProduct.product_code" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="กรอกรหัสสินค้า"></div>
                        <div><label class="block text-sm font-medium">ชื่อสินค้า</label><input type="text" x-model="newProduct.product_name" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="กรอกชื่อสินค้า"></div>
                        <div><label class="block text-sm font-medium">หมวดหมู่</label><input type="text" x-model="newProduct.category" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="กรอกหมวดหมู่"></div>
                        <div><label class="block text-sm font-medium">หน่วย</label><input type="text" x-model="newProduct.unit" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="เช่น ชิ้น, กิโล"></div>
                        <div><label class="block text-sm font-medium">ราคาทุน</label><input type="number" step="0.01" x-model.number="newProduct.cost_price" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">ราคาขาย</label><input type="number" step="0.01" x-model.number="newProduct.selling_price" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">สต็อกขั้นต่ำ</label><input type="number" x-model.number="newProduct.min_stock" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">สถานะการขาย</label><select x-model="newProduct.active" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option :value="true">เปิดใช้งาน (Active)</option><option :value="false">ปิดใช้งาน (Inactive)</option></select></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium">สถานะการนับ</label><select x-model="newProduct.count_status" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option value="active">นับสต็อก (Active)</option><option value="excluded">ยกเว้นการนับ (Excluded)</option></select></div>
                    </div>
                </div>
                
                <!-- Footer - ติดด้านล่าง -->
                <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2 flex-shrink-0 bg-white dark:bg-gray-800">
                    <button @click="showAddModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">ยกเลิก</button>
                    <button @click="saveProduct(true)" class="px-4 py-2 bg-blue-500 text-white rounded-lg">บันทึก</button>
                </div>
            </div>
        </div>

        <!-- Edit Product Modal - แก้ไขให้ปุ่มไม่ถูกบัง -->
        <div x-show="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" @keydown.escape.window="showEditModal = false" x-cloak>
            <div @click.away="showEditModal = false" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[85vh] flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b dark:border-gray-700 flex-shrink-0">
                    <h3 class="text-lg font-semibold">แก้ไขสินค้า</h3>
                </div>
                
                <!-- Content - จำกัดความสูง -->
                <div class="p-6 space-y-4 overflow-y-auto flex-1" style="max-height: calc(85vh - 140px);">
                    <div class="flex items-center gap-4">
                        <img :src="editingProduct.image_url || 'https://placehold.co/100x100/e2e8f0/64748b?text=No+Image'" class="w-24 h-24 rounded-lg object-cover">
                        <div>
                            <label class="block text-sm font-medium mb-1">เปลี่ยนรูปสินค้า</label>
                            <input type="file" @change="uploadImageToImgBB($event, 'edit')" class="text-sm">
                            <div x-show="isUploadingImage" class="text-sm text-blue-500 mt-1"><i class="fas fa-spinner fa-spin mr-1"></i>กำลังอัปโหลด...</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">รหัสสินค้า</label><input type="text" x-model="editingProduct.product_code" readonly class="w-full mt-1 p-2 border rounded bg-gray-100 dark:bg-gray-700"></div>
                        <div><label class="block text-sm font-medium">ชื่อสินค้า</label><input type="text" x-model="editingProduct.product_name" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">หมวดหมู่</label><input type="text" x-model="editingProduct.category" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">หน่วย</label><input type="text" x-model="editingProduct.unit" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">ราคาทุน</label><input type="number" step="0.01" x-model.number="editingProduct.cost_price" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">ราคาขาย</label><input type="number" step="0.01" x-model.number="editingProduct.selling_price" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                        <div><label class="block text-sm font-medium">สถานะการขาย (Active/Inactive)</label><select x-model="editingProduct.active" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option :value="true">เปิดใช้งาน (Active)</option><option :value="false">ปิดใช้งาน (Inactive)</option></select></div>
                        <div><label class="block text-sm font-medium">สถานะการนับ</label><select x-model="editingProduct.count_status" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option value="active">นับสต็อก (Active)</option><option value="excluded">ยกเว้นการนับ (Excluded)</option></select></div>
                    </div>
                </div>
                
                <!-- Footer - ติดด้านล่าง -->
                <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2 flex-shrink-0 bg-white dark:bg-gray-800">
                    <button @click="showEditModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">ยกเลิก</button>
                    <button @click="saveProduct(false)" class="px-4 py-2 bg-blue-500 text-white rounded-lg">บันทึก</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="space-y-4 max-w-full overflow-x-hidden">
            ${this.renderProductsHeader()}
            ${this.renderProductsTable()}
        </div>
    `;
                },





                renderManualCount() {
                    return `
        <div class="space-y-6">
            <div class="glow-border bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold">${this.t('count_stock')}</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">เลือกวันที่และเริ่มนับสต็อก</p>
                    </div>
                    <div class="w-full md:w-auto">
                        <input type="date" x-model="countData.date" @change="checkCountStatus()" 
                               class="w-full md:w-auto p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                    </div>
                </div>
            </div>

            <div x-show="countData.status === 'not_counted'" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
                <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400 mb-4">ยังไม่มีข้อมูลการนับสต็อกสำหรับวันที่นี้</p>
                <button @click="startCounting()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                    <i class="fas fa-play mr-2"></i>เริ่มนับสต็อก
                </button>
            </div>

            <div x-show="countData.status === 'counted'" class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>${this.t('already_counted')}</span>
                        </h3>
                        <div x-show="countData.countedBy" class="text-sm text-gray-500">
                            โดย: <span class="font-medium" x-text="countData.countedBy"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 md:gap-4">
                        <div class="bg-green-50 dark:bg-green-900 p-3 rounded">
                            <p class="text-xs text-gray-600">${this.t('matched_items')}</p>
                            <p class="text-xl font-bold text-green-600" x-text="countData.matchedCount"></p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900 p-3 rounded">
                            <p class="text-xs text-gray-600">${this.t('unmatched_items')}</p>
                            <p class="text-xl font-bold text-red-600" x-text="countData.unmatchedCount"></p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2"
                         x-show="$store.app.user.role === 'owner' || $store.app.user.role === 'manager'">
                         <button @click="startEditingCount()" class="bg-yellow-500 text-white px-5 py-2.5 rounded-lg hover:bg-yellow-600 font-semibold">
                            <i class="fas fa-edit mr-2"></i>แก้ไขการนับ
                         </button>
                    </div>
                </div>
            </div>

            <div x-show="countData.status === 'counting' || countData.status === 'editing'" class="space-y-4">
                <div class="sticky top-4 z-10 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border dark:border-gray-700">
                     <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="w-full" x-show="!countData.isEditing">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-bold">กำลังนับสต็อก...</h3>
                                    <p class="text-sm text-gray-500">นับแล้ว <span x-text="countProgress.counted" class="font-bold text-blue-600"></span> จาก <span x-text="countProgress.total" class="font-bold"></span> รายการ</p>
                                </div>
                                <div class="w-1/2 bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                    <div class="bg-blue-600 h-2.5 rounded-full" :style="'width: ' + (countProgress.total > 0 ? (countProgress.counted / countProgress.total * 100) : 0) + '%'"></div>
                                </div>
                            </div>
                        </div>
                        <div x-show="countData.isEditing" class="font-bold text-lg text-yellow-600">
                            <i class="fas fa-edit"></i> โหมดแก้ไขการนับ
                        </div>
                        <button @click="countData.isEditing ? saveEditedCount() : saveCount()" class="w-full md:w-auto bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 whitespace-nowrap">
                            <i class="fas fa-save mr-2"></i><span x-text="countData.isEditing ? 'บันทึกการแก้ไข' : '${this.t('save_count')}'"></span>
                        </button>
                     </div>
                </div>
                
                <div class="space-y-4">
                    <template x-for="category in countData.items" :key="category.category">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                            <button @click="category.collapsed = !category.collapsed" 
                                    class="w-full p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <h3 class="font-semibold text-lg" x-text="category.category"></h3>
                                <i class="fas transition-transform" :class="category.collapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                            </button>
                            
                            <div x-show="!category.collapsed" class="divide-y dark:divide-gray-700">
                                <div x-show="countData.isEditing" class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 p-2 bg-gray-50 dark:bg-gray-700">
                                    <div class="col-span-5">สินค้า</div>
                                    <div class="col-span-2 text-center">POS</div>
                                    <div class="col-span-2 text-center">นับเดิม</div>
                                    <div class="col-span-3 text-center">นับใหม่</div>
                                </div>
                                <template x-for="product in category.products" :key="product.product_code">
                                    <div>
                                        <div x-show="!countData.isEditing" class="p-3 md:p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                            <div class="grid grid-cols-3 gap-4 items-center">
                                                <div class="col-span-2">
                                                    <p class="font-medium" x-text="product.product_name"></p>
                                                    <p class="text-sm text-gray-500 font-mono" x-text="product.product_code"></p>
                                                </div>
                                                <div>
                                                    <input type="number" inputmode="decimal" x-model.number="product.quantity"
                                                           class="w-full text-center text-lg font-bold p-2 border-2 rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500"
                                                           placeholder="0">
                                                </div>
                                            </div>
                                        </div>
                                        <div x-show="countData.isEditing" class="grid grid-cols-12 gap-2 items-center p-2 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                            <div class="col-span-5">
                                                <p class="font-medium text-sm" x-text="product.product_name"></p>
                                                <p class="text-xs text-gray-500 font-mono" x-text="product.product_code"></p>
                                            </div>
                                            <div class="col-span-2 text-center font-medium text-blue-600" x-text="product.pos_quantity !== null ? product.pos_quantity : '-'"></div>
                                            <div class="col-span-2 text-center text-gray-500" x-text="product.manual_quantity !== null ? product.manual_quantity : '-'"></div>
                                            <div class="col-span-3">
                                                <input type="number" inputmode="decimal" x-model.number="product.new_quantity"
                                                       class="w-full text-center text-md font-bold p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                                       :class="{'border-yellow-500 ring-2 ring-yellow-200': product.new_quantity != product.manual_quantity}">
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    `;
                },




                loadRecentUploads() {
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) return;

                    google.script.run
                        .withSuccessHandler(response => {
                            console.log('Recent uploads response:', response); // Debug log

                            if (response.success) {
                                // แปลงข้อมูลให้ถูกต้อง
                                this.recentUploads = response.uploads.map(upload => {
                                    // ดึง drive_file_id จาก file_url
                                    let driveId = '';
                                    if (upload.file_url) {
                                        const match = upload.file_url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                                        if (match && match[1]) {
                                            driveId = match[1];
                                        }
                                    }

                                    // แก้ไข file_name ถ้าเป็น "view?usp=drivesdk"
                                    let fileName = upload.file_name;
                                    if (fileName === 'view?usp=drivesdk' || fileName.includes('view?')) {
                                        // สร้างชื่อไฟล์จากวันที่
                                        const storeName = this.getCurrentStoreName();
                                        const dateParts = upload.ocr_date.split('-');
                                        if (dateParts.length === 3) {
                                            fileName = `${storeName}_${dateParts[0]}${dateParts[1]}${dateParts[2]}.txt`;
                                        } else {
                                            fileName = `OCR_${upload.ocr_date}.txt`;
                                        }
                                    }

                                    // แก้ไข ocr_date ให้เป็นรูปแบบ yyyy-mm-dd
                                    let formattedDate = upload.ocr_date;
                                    const parts = upload.ocr_date.split('-');
                                    if (parts.length === 3 && parts[0].length <= 2) {
                                        // ถ้าเป็น dd-mm-yyyy แปลงเป็น yyyy-mm-dd
                                        formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                                    }

                                    return {
                                        ...upload,
                                        drive_file_id: driveId,
                                        file_name: fileName,
                                        ocr_date: formattedDate
                                    };
                                });
                            } else {
                                console.error("Failed to load recent uploads:", response.message);
                            }
                        })
                        .withFailureHandler(error => {
                            console.error("Error loading recent uploads:", error);
                        })
                        .getRecentUploads(sheetId);
                },






                uploadFile(event) {
                    // ตรวจสอบสิทธิ์การอัพโหลด - เฉพาะ Owner และ Accountant เท่านั้น
                    const role = Alpine.store('app').user.role;
                    if (role !== 'owner' && role !== 'accountant') {
                        Swal.fire('ไม่มีสิทธิ์', 'คุณไม่มีสิทธิ์อัพโหลดไฟล์ กรุณาติดต่อผู้ดูแลระบบ', 'error');
                        return;
                    }

                    if (this.uploadStatus.uploaded) {
                        Swal.fire('ผิดพลาด', 'วันที่เลือกได้อัพโหลดไฟล์ไปแล้ว ไม่สามารถอัพโหลดซ้ำได้', 'warning');
                        return;
                    }
                    const file = event.target.files ? event.target.files[0] : event.dataTransfer.files[0];
                    const fileInput = document.getElementById('txtInput');

                    if (!file || file.type !== 'text/plain') {
                        Swal.fire(this.t('error'), 'กรุณาเลือกไฟล์ TXT เท่านั้น', 'error');
                        if (fileInput) fileInput.value = null;
                        return;
                    }

                    Swal.fire({
                        title: 'ยืนยันการอัปโหลด?',
                        html: `คุณต้องการอัปโหลดไฟล์: <br><strong class="font-mono text-blue-600">${file.name}</strong>`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'ใช่, อัปโหลดเลย',
                        cancelButtonText: 'ยกเลิก'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const reader = new FileReader();
                            // อ่านไฟล์เป็น ArrayBuffer เพื่อรองรับหลาย encoding
                            reader.readAsArrayBuffer(file);

                            reader.onload = () => {
                                let fileContent;
                                try {
                                    // ลองแปลงด้วย windows-874 (Thai encoding) ก่อน
                                    const decoder = new TextDecoder('windows-874');
                                    fileContent = decoder.decode(reader.result);

                                    // ตรวจสอบว่าภาษาไทยแสดงผลถูกต้องหรือไม่
                                    // ถ้ามีตัวอักษรที่เป็น replacement character (�) มาก อาจต้องลอง UTF-8
                                    const replacementCount = (fileContent.match(/�/g) || []).length;
                                    if (replacementCount > 10) {
                                        // ลอง UTF-8 แทน
                                        const utf8Decoder = new TextDecoder('utf-8');
                                        fileContent = utf8Decoder.decode(reader.result);
                                    }
                                } catch (error) {
                                    // ถ้า windows-874 ไม่ได้ ลอง UTF-8
                                    try {
                                        const utf8Decoder = new TextDecoder('utf-8');
                                        fileContent = utf8Decoder.decode(reader.result);
                                    } catch (e) {
                                        Swal.fire(this.t('error'), 'ไม่สามารถอ่านไฟล์ได้ กรุณาตรวจสอบรูปแบบไฟล์', 'error');
                                        if (fileInput) fileInput.value = null;
                                        return;
                                    }
                                }

                                const storeName = this.getCurrentStoreName();
                                const dateParts = this.txtUploadDate.split('-');
                                const formattedDate = `${dateParts[0]}${dateParts[1]}${dateParts[2]}`;
                                const newFileName = `${storeName}_${formattedDate}.txt`;

                                this.processTXTWithProgress(fileContent, newFileName, this.txtUploadDate, this.includeZeroQty);
                            };

                            reader.onerror = (error) => {
                                Swal.fire(this.t('error'), 'Error reading file.', 'error');
                            };
                        } else {
                            if (fileInput) fileInput.value = null;
                        }
                    });
                },



                addManualOcrItem() {
                    // เพิ่มแถวว่างๆ ต่อท้ายตาราง
                    this.ocrVerificationData.results.push({
                        product_code: '',
                        product_name: '',
                        quantity: null,
                        unit: '',
                        category: '',
                        status: 'manual',
                        is_new: true
                    });

                    // Scroll ลงไปแถวล่างสุดอัตโนมัติ
                    this.$nextTick(() => {
                        const tableContainer = document.querySelector('.overflow-x-auto');
                        if (tableContainer) {
                            tableContainer.scrollTo({
                                top: tableContainer.scrollHeight,
                                behavior: 'smooth'
                            });

                            // Focus ที่ input แรกของแถวใหม่
                            const inputs = tableContainer.querySelectorAll('input[type="text"]');
                            if (inputs.length > 0) {
                                const lastRowInputs = Array.from(inputs).slice(-5);
                                if (lastRowInputs[0]) {
                                    setTimeout(() => lastRowInputs[0].focus(), 300);
                                }
                            }
                        }
                    });

                    // แสดงข้อความแจ้งเตือน
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    Toast.fire({
                        icon: 'info',
                        title: 'เพิ่มแถวใหม่แล้ว กรุณากรอกข้อมูล'
                    });
                },


                updateProductInfo(item) {
                    if (!item.product_code || item.product_code.trim() === '') {
                        return;
                    }

                    // ค้นหาสินค้าจาก Products list
                    const product = this.products.find(p =>
                        p.product_code &&
                        p.product_code.toLowerCase() === item.product_code.toLowerCase()
                    );

                    if (product) {
                        // ✅ เจอสินค้าในระบบ - อัพเดทข้อมูลอัตโนมัติ
                        item.product_name = product.product_name || '';
                        item.unit = product.unit || '';
                        item.category = product.category || '';
                        item.status = 'verified';
                        item.is_new = false;

                        // แสดงการแจ้งเตือนว่าเจอสินค้า
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true
                        });

                        Toast.fire({
                            icon: 'success',
                            title: `✓ เจอสินค้า: ${product.product_name}`
                        });
                    } else {
                        // ❌ ไม่เจอสินค้าในระบบ
                        item.status = 'manual';
                        item.is_new = true;
                    }
                },





                removeOcrItem(item) {
                    // หา index ที่แท้จริงใน array ต้นฉบับ
                    const actualIndex = this.ocrVerificationData.results.indexOf(item);

                    if (actualIndex === -1) {
                        return; // ไม่พบ item ใน array
                    }

                    const itemName = item.product_name || 'รายการนี้';

                    Swal.fire({
                        title: 'ยืนยันการลบ?',
                        text: `ต้องการลบรายการ "${itemName}" หรือไม่?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'ใช่, ลบเลย',
                        cancelButtonText: 'ยกเลิก'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.ocrVerificationData.results.splice(actualIndex, 1);

                            Swal.fire({
                                icon: 'success',
                                title: 'ลบแล้ว',
                                text: 'รายการถูกลบเรียบร้อยแล้ว',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        }
                    });
                },


                showWarningDetails(item) {
                    if (!item.warnings || item.warnings.length === 0) return;

                    let warningHtml = '<div class="text-left space-y-3">';
                    warningHtml += `<p class="font-bold text-gray-800 dark:text-gray-200 mb-3">รหัสสินค้า: <span class="text-blue-600">${item.product_code}</span></p>`;
                    warningHtml += '<div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg">';
                    warningHtml += '<p class="text-sm font-semibold text-yellow-800 dark:text-yellow-400 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>ข้อมูลที่ไม่สอดคล้องกัน:</p>';
                    warningHtml += '<ul class="space-y-2 text-sm">';

                    item.warnings.forEach(warning => {
                        let fieldName = '';
                        if (warning.field === 'product_name') fieldName = 'ชื่อสินค้า';
                        else if (warning.field === 'category') fieldName = 'หมวดหมู่';
                        else if (warning.field === 'unit') fieldName = 'หน่วย';

                        warningHtml += `
            <li class="border-l-4 border-yellow-400 pl-3">
                <div class="font-medium text-gray-700 dark:text-gray-300">${fieldName}:</div>
                <div class="text-red-600 dark:text-red-400">📄 ไฟล์: "${warning.fileValue}"</div>
                <div class="text-green-600 dark:text-green-400">✓ Master: "${warning.masterValue}"</div>
            </li>
        `;
                    });

                    warningHtml += '</ul>';
                    warningHtml += '</div>';
                    warningHtml += '<p class="text-xs text-gray-500 dark:text-gray-400 mt-3"><i class="fas fa-info-circle mr-1"></i>ระบบจะใช้ข้อมูลจาก Master (สีเขียว) โดยอัตโนมัติ</p>';
                    warningHtml += '</div>';

                    Swal.fire({
                        title: '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>รายละเอียดความไม่สอดคล้อง',
                        html: warningHtml,
                        icon: 'warning',
                        confirmButtonText: 'เข้าใจแล้ว',
                        width: '600px',
                        customClass: {
                            popup: 'text-left'
                        }
                    });
                },


                validateOcrData() {
                    const invalidItems = [];

                    this.ocrVerificationData.results.forEach((item, index) => {
                        const errors = [];

                        if (!item.product_code || item.product_code.trim() === '') {
                            errors.push('ไม่มีรหัสสินค้า');
                        }
                        if (!item.product_name || item.product_name.trim() === '') {
                            errors.push('ไม่มีชื่อสินค้า');
                        }
                        // อนุญาตให้ quantity เป็นค่าใดก็ได้ (รวมติดลบ) แต่ต้องเป็นตัวเลข
                        if (item.quantity === null || item.quantity === undefined || item.quantity === '') {
                            errors.push('จำนวนต้องระบุเป็นตัวเลข');
                        } else if (isNaN(Number(item.quantity))) {
                            errors.push('จำนวนต้องเป็นตัวเลข');
                        }
                        if (!item.unit || item.unit.trim() === '') {
                            errors.push('ไม่มีหน่วย');
                        }

                        if (errors.length > 0) {
                            invalidItems.push({
                                index: index + 1,
                                product_code: item.product_code || '(ไม่มีรหัส)',
                                errors: errors
                            });
                        }
                    });

                    return {
                        isValid: invalidItems.length === 0,
                        invalidItems: invalidItems
                    };
                },



                saveVerifiedOcr() {
                    // 🔍 ตรวจสอบข้อมูลก่อนบันทึก
                    const validation = this.validateOcrData();

                    if (!validation.isValid) {
                        let errorHtml = '<div class="text-left">';
                        errorHtml += '<p class="font-bold mb-2 text-red-600">พบข้อมูลที่ไม่ถูกต้อง:</p>';
                        errorHtml += '<ul class="list-disc pl-5 space-y-1">';

                        validation.invalidItems.forEach(item => {
                            errorHtml += `<li class="mb-1">`;
                            errorHtml += `<strong>แถวที่ ${item.index}</strong> (${item.product_code}): `;
                            errorHtml += `<span class="text-red-600">${item.errors.join(', ')}</span>`;
                            errorHtml += `</li>`;
                        });

                        errorHtml += '</ul></div>';

                        Swal.fire({
                            icon: 'error',
                            title: 'ข้อมูลไม่ครบถ้วน',
                            html: errorHtml,
                            confirmButtonText: 'ตกลง',
                            width: '600px'
                        });
                        return;
                    }

                    // ✅ ข้อมูลถูกต้อง - ดำเนินการบันทึกต่อ
                    Swal.fire({
                        title: this.t('confirm'),
                        text: `ยืนยันการบันทึก ${this.ocrVerificationData.results.length} รายการ?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'ยืนยัน',
                        cancelButtonText: 'ยกเลิก'
                    }).then(result => {
                        if (result.isConfirmed) {
                            this.showLoadingModal(this.t('saving'), 'กำลังบันทึกข้อมูล POS...');

                            // ✅ สร้าง verifiedData ที่รวม zeroQtyProducts
                            const verifiedData = {
                                ocr_id: this.ocrVerificationData.ocr_id || null,  // สำหรับกรณี edit
                                ocr_date: this.ocrVerificationData.ocr_date,
                                file_url: this.ocrVerificationData.file_url,
                                file_id: this.ocrVerificationData.file_id,
                                file_name: this.ocrVerificationData.file_name,
                                results: this.ocrVerificationData.results,                    // ✅ สินค้า qty > 0
                                zeroQtyProducts: this.ocrVerificationData.zeroQtyProducts,    // ✅ สินค้า qty = 0
                                includeZeroQty: true,
                                stats: {
                                    totalItems: this.ocrVerificationData.results.length,
                                    verifiedItems: this.ocrVerificationData.results.filter(r => r.status === 'verified').length,
                                    unmatchedItems: this.ocrVerificationData.results.filter(r => r.status === 'unmatched').length,
                                    zeroQtyItems: this.ocrVerificationData.zeroQtyProducts?.length || 0,
                                    processTime: 0
                                }
                            };

                            console.log('Saving verified data:', verifiedData);

                            google.script.run
                                .withSuccessHandler(response => {
                                    this.hideLoadingModal();
                                    if (response.success) {
                                        Swal.fire({
                                            icon: 'success',
                                            title: this.t('success'),
                                            text: 'บันทึกข้อมูล POS สำเร็จ',
                                            timer: 2000,
                                            showConfirmButton: false
                                        });
                                        this.ocrVerificationData = null;
                                        this.loadRecentUploads();
                                    } else {
                                        Swal.fire(this.t('error'), response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    this.hideLoadingModal();
                                    console.error('Save error:', error);
                                    Swal.fire(this.t('error'), error.message, 'error');
                                })
                                .saveVerifiedOcrData(
                                    Alpine.store('app').user.sheetId,
                                    verifiedData,
                                    Alpine.store('app').user.username
                                );
                        }
                    });
                },




                editOcrBatch(ocrId) {
                    this.showLoadingModal(this.t('loading'), 'กำลังโหลดข้อมูล OCR...');

                    google.script.run
                        .withSuccessHandler(response => {
                            this.hideLoadingModal();
                            if (response.success) {
                                this.ocrVerificationData = response.data;
                            } else {
                                Swal.fire(this.t('error'), response.message, 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            this.hideLoadingModal();
                            Swal.fire(this.t('error'), error.message, 'error');
                        })
                        .getOcrBatchForEditing(Alpine.store('app').user.sheetId, ocrId);
                },






                // เพิ่มฟังก์ชันนี้หลัง formatDateTH
                formatDateForFileName(dateString) {
                    if (!dateString) return '';
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        // แปลงจาก yyyy-mm-dd เป็น ddmmyyyy
                        return `${parts[2]}${parts[1]}${parts[0]}`;
                    }
                    return dateString.replace(/-/g, '');
                },


                handleDrop(event) {
                    if (this.uploadStatus.uploaded) {
                        Swal.fire('อัปโหลดไปแล้ว', 'วันที่เลือกได้อัปโหลดไฟล์ไปแล้ว ไม่สามารถอัปโหลดซ้ำได้', 'warning');
                        return;
                    }
                    // สร้าง event object จำลองเพื่อส่งไปให้ฟังก์ชัน uploadFile
                    const simulatedEvent = {
                        target: {
                            files: event.dataTransfer.files
                        }
                    };
                    // เรียกใช้ฟังก์ชัน uploadFile ที่มีอยู่แล้ว
                    this.uploadFile(simulatedEvent);
                },


                get filteredOcrResults() {
                    if (!this.ocrVerificationData || !this.ocrVerificationData.results) {
                        return [];
                    }
                    // ถ้าติ๊ก checkbox ให้แสดงทั้งหมด
                    if (this.includeZeroQty) {
                        return this.ocrVerificationData.results;
                    }
                    // ถ้าไม่ได้ติ๊ก ให้กรองเอารายการที่ quantity ไม่ใช่ 0
                    // แต่ยังคงแสดงแถวใหม่ที่เพิ่มด้วยตนเอง (is_new = true หรือ quantity = null)
                    return this.ocrVerificationData.results.filter(item =>
                        item.quantity !== 0 || item.is_new === true || item.quantity === null
                    );
                },



                renderPDFUpload() {
                    return `
        <!-- ส่วนที่ 1: แสดงเมื่อยังไม่มี ocrVerificationData -->
        <div x-show="!ocrVerificationData" class="space-y-6"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100">
            
            <!-- Header Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-4 md:p-8">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 dark:bg-blue-900/30 p-3 md:p-4 rounded-xl">
                            <i class="fas fa-file-alt text-3xl md:text-4xl text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-1 text-gray-900 dark:text-white">อัปโหลดไฟล์ POS</h2>
                            <p class="text-sm md:text-base text-gray-600 dark:text-gray-400">อัปโหลดไฟล์จากระบบ POS เพื่อนำเข้าข้อมูลสต๊อกอัตโนมัติ</p>
                        </div>
                    </div>
                    <div class="w-full md:w-auto">
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg px-4 py-2">
                            <div class="text-xs md:text-sm text-gray-600 dark:text-gray-400">ร้าน</div>
                            <div class="text-base md:text-lg font-semibold text-gray-900 dark:text-white" x-text="getCurrentStoreName()"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Date Selection Card -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex items-center space-x-2 w-full md:w-auto">
                        <i class="fas fa-calendar-alt text-gray-400"></i>
                        <label class="text-sm font-medium whitespace-nowrap">${this.t('select_date')}:</label>
                        <input type="date" x-model="txtUploadDate"
                            @change="checkUploadStatus($event.target.value)"
                            class="p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 md:w-48 w-full">
                    </div>
                    
                    <div x-show="uploadStatus.uploaded" class="flex items-center text-green-600 dark:text-green-400">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span class="text-sm">วันนี้อัปโหลดไฟล์ไปแล้ว</span>
                    </div>
                </div>
            </div>

            <!-- Upload Drag & Drop Area -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-4 md:p-8">

                <!-- สำหรับ Owner และ Accountant - สามารถอัพโหลดได้ -->
                <div x-show="$store.app.user.role === 'owner' || $store.app.user.role === 'accountant'">
                    <div @drop.prevent="handleDrop($event)" @dragover.prevent @dragenter.prevent
                        class="border-3 border-dashed border-blue-300 dark:border-blue-700 rounded-2xl p-8 md:p-16 text-center
                                hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all cursor-pointer"
                        :class="{'opacity-50 cursor-not-allowed': uploadStatus.uploaded}"
                        @click="!uploadStatus.uploaded && document.getElementById('txtInput').click()">

                        <template x-if="!uploadStatus.uploaded">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-cloud-upload-alt text-5xl md:text-7xl text-blue-500 dark:text-blue-400 mb-4"></i>
                                <p class="text-lg md:text-xl font-semibold mb-2 text-gray-700 dark:text-gray-300">วางไฟล์ TXT ที่นี่</p>
                                <p class="text-sm md:text-base text-gray-500 dark:text-gray-400">หรือคลิกเพื่อเลือกไฟล์</p>
                                <input type="file" accept="text/plain,.txt" class="hidden" id="txtInput" @change="uploadFile($event)">
                            </div>
                        </template>

                        <template x-if="uploadStatus.uploaded">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-check-circle text-5xl md:text-6xl text-green-500 mb-4"></i>
                                <p class="text-lg font-semibold text-green-600">วันที่ท่านเลือก อัปโหลดไฟล์ไปแล้ว</p>
                                <p class="text-sm text-gray-600"><i class="fas fa-file-alt mr-2 text-blue-500"></i><span x-text="uploadStatus.fileName"></span></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- สำหรับ Manager และ Staff - ดูได้อย่างเดียว -->
                <div x-show="$store.app.user.role === 'manager' || $store.app.user.role === 'staff'"
                    class="border-3 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl p-8 md:p-16 text-center bg-gray-50 dark:bg-gray-700/50">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-eye text-5xl md:text-7xl text-gray-400 dark:text-gray-500 mb-4"></i>
                        <p class="text-lg md:text-xl font-semibold mb-2 text-gray-600 dark:text-gray-400">คุณสามารถดูข้อมูลได้อย่างเดียว</p>
                        <p class="text-sm md:text-base text-gray-500 dark:text-gray-500">ไม่มีสิทธิ์อัพโหลดไฟล์ - กรุณาติดต่อผู้ดูแลระบบ</p>
                    </div>
                </div>
            </div>

            <!-- Recent Uploads Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-4 md:p-8">
                <div class="flex items-center space-x-3 mb-6">
                    <i class="fas fa-history text-2xl text-blue-600 dark:text-blue-400"></i>
                    <h3 class="text-xl font-bold">${this.t('recent_uploads')}</h3>
                </div>

                <!-- Desktop Table -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="p-3 text-left">วันที่</th>
                                <th class="p-3 text-left">ชื่อไฟล์</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Items</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-if="recentUploads.length === 0">
                                <tr><td colspan="5" class="text-center p-8 text-gray-500">ไม่มีข้อมูล</td></tr>
                            </template>
                            <template x-for="upload in recentUploads" :key="upload.ocr_id">
                                <tr>
                                    <td class="p-3" x-text="formatDateTH(upload.ocr_date)"></td>
                                    <td class="p-3" x-text="upload.file_name"></td>
                                    <td class="p-3">
                                        <span class="px-2 py-1 text-xs rounded-full" 
                                              :class="upload.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                              x-text="upload.status"></span>
                                    </td>
                                    <td class="p-3" x-text="upload.total_items"></td>
                                    <td class="p-3 text-center">
                                        <button @click="editOcrBatch(upload.ocr_id)" class="text-blue-600 hover:underline">แก้ไข</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div class="md:hidden space-y-3">
                    <template x-if="recentUploads.length === 0">
                        <p class="text-center p-4 text-gray-500">ไม่มีข้อมูล</p>
                    </template>
                    <template x-for="upload in recentUploads" :key="upload.ocr_id">
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            <div class="flex justify-between items-center text-sm">
                                <span x-text="formatDateTH(upload.ocr_date)"></span>
                                <span class="px-2 py-1 text-xs rounded-full" 
                                      :class="upload.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                      x-text="upload.status"></span>
                            </div>
                            <p class="text-xs text-gray-500 truncate mt-1" x-text="upload.file_name"></p>
                            <div class="flex justify-between items-center mt-2 text-xs">
                                <span>Items: <strong x-text="upload.total_items"></strong></span>
                                <button @click="editOcrBatch(upload.ocr_id)" class="text-blue-600 font-semibold">แก้ไข</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- ส่วนที่ 2: แสดงเมื่อมี ocrVerificationData (ตรวจสอบข้อมูล OCR) -->
        <template x-if="ocrVerificationData">
            <div class="space-y-6"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100">
                
                <!-- Header Card -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="bg-purple-100 dark:bg-purple-900/30 p-4 rounded-xl">
                                <i class="fas fa-search text-4xl text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold mb-1">ตรวจสอบข้อมูลPOS</h2>
                                <p class="text-gray-600 dark:text-gray-400">ไฟล์: <strong x-text="ocrVerificationData.file_name"></strong></p>
                            </div>
                        </div>
                        <button @click="ocrVerificationData = null" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-semibold">
                            <i class="fas fa-times mr-2"></i> ยกเลิก
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600" x-text="ocrVerificationData.results.length || 0"></div>
                            <div class="text-sm">รายการทั้งหมด</div>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600" x-text="ocrVerificationData.results.filter(r => r.status === 'verified').length"></div>
                            <div class="text-sm">ตรงกับรายการสินค้าที่มีอยู่</div>
                        </div>
                        <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600" x-text="ocrVerificationData.results.filter(r => r.status === 'unmatched').length"></div>
                            <div class="text-sm">ไม่ตรงตรงกับรายการสินค้าที่มีอยู่</div>
                        </div>
                    </div>

                    <!-- ✅ ตารางที่แก้ไขแล้ว - แก้ไขได้ทุกช่อง -->
                    <div class="overflow-x-auto rounded-lg border dark:border-gray-700">
                        <table class="w-full text-sm min-w-full">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-3 text-left">รหัสสินค้า</th>
                                    <th class="p-3 text-left">ชื่อสินค้า</th>
                                    <th class="p-3 text-right">จำนวน</th>
                                    <th class="p-3 text-left">หน่วย</th>
                                    <th class="p-3 text-left">หมวดหมู่</th>
                                    <th class="p-3 text-center">สถานะ</th>
                                    <th class="p-3 text-center">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                
                                <!-- ✅ แถวที่แก้ไขแล้ว -->
                                <template x-for="(item, index) in filteredOcrResults" :key="index">
                                    <tr :class="{
                                        'bg-red-50 dark:bg-red-900/20': item.status === 'unmatched',
                                        'bg-yellow-50 dark:bg-yellow-900/20': item.status === 'manual' || item.hasWarning
                                    }">
                                        <!-- รหัสสินค้า - แก้ไขได้ + Auto-search -->
                                        <td class="p-1">
                                            <input type="text"
                                                   x-model="item.product_code"
                                                   @input="updateProductInfo(item)"
                                                   class="w-full bg-transparent border rounded p-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all"
                                                   placeholder="รหัสสินค้า">
                                        </td>

                                        <!-- ชื่อสินค้า - แก้ไขได้เสมอ + แสดง warning icon -->
                                        <td class="p-1">
                                            <div class="flex items-center gap-2">
                                                <input type="text"
                                                       x-model="item.product_name"
                                                       class="flex-1 bg-transparent border rounded p-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all"
                                                       placeholder="ชื่อสินค้า">
                                                <i x-show="item.hasWarning"
                                                   @click="showWarningDetails(item)"
                                                   class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 cursor-pointer hover:text-yellow-800 transition-colors"
                                                   title="คลิกเพื่อดูรายละเอียด"></i>
                                            </div>
                                        </td>
                                        
                                        <!-- จำนวน - แก้ไขได้เสมอ -->
                                        <td class="p-1">
                                            <input type="number" 
                                                   step="0.01" 
                                                   x-model.number="item.quantity" 
                                                   class="w-24 bg-transparent border rounded p-2 dark:bg-gray-700 text-right focus:ring-2 focus:ring-blue-500 transition-all"
                                                   placeholder="0.00">
                                        </td>
                                        
                                        <!-- หน่วย - แก้ไขได้เสมอ -->
                                        <td class="p-1">
                                            <input type="text" 
                                                   x-model="item.unit" 
                                                   class="w-full bg-transparent border rounded p-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all"
                                                   placeholder="หน่วย">
                                        </td>
                                        
                                        <!-- หมวดหมู่ - แก้ไขได้เสมอ -->
                                        <td class="p-1">
                                            <input type="text" 
                                                   x-model="item.category" 
                                                   class="w-full bg-transparent border rounded p-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all"
                                                   placeholder="หมวดหมู่">
                                        </td>
                                        
                                        <!-- สถานะ - แสดงอย่างเดียว -->
                                        <td class="p-2 text-center">
                                            <span class="px-2 py-1 text-xs rounded-full inline-flex items-center" 
                                                  :class="{
                                                      'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': item.status === 'verified', 
                                                      'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': item.status === 'unmatched', 
                                                      'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400': item.status === 'manual'
                                                  }">
                                                <i class="fas mr-1" 
                                                   :class="{
                                                       'fa-check-circle': item.status === 'verified',
                                                       'fa-exclamation-circle': item.status === 'unmatched',
                                                       'fa-edit': item.status === 'manual'
                                                   }"></i>
                                                <span x-text="item.status"></span>
                                            </span>
                                        </td>
                                        
                                        <!-- ปุ่มลบ -->
                                        <td class="p-2 text-center">
                                            <button @click="removeOcrItem(item)"
                                                    class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-all"
                                                    title="ลบรายการนี้">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- ปุ่มด้านล่าง -->
                    <div class="mt-6 flex justify-between">
                        <button @click="addManualOcrItem()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i> ${this.t('add_manual_item')}
                        </button>
                        <div class="space-x-2">
                            <button @click="ocrVerificationData = null" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                ${this.t('cancel')}
                            </button>
                            <button @click="saveVerifiedOcr()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-save mr-2"></i> ${this.t('save')}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    `;
                },










                renderComparison() {
                    this.$nextTick(() => {
                        this.loadDiscrepancyDashboard();
                    });

                    return `
    <!-- Details Modal - ปรับลำดับรอชี้แจงให้ถูกต้อง -->
    <div x-show="showDetailsModal" @keydown.escape.window="closeDetailsModal()" 
         class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" x-cloak>
        <div @click.away="closeDetailsModal()" 
             class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <!-- Header - Fixed position -->
            <div class="flex-none p-4 border-b dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 rounded-t-lg">
                <h3 class="text-lg font-semibold">
                    รายละเอียดผลต่าง วันที่ 
                    <span x-text="new Date(modalData.date).toLocaleDateString('th-TH')"></span>
                </h3>
                <button @click="closeDetailsModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <!-- Content - Scrollable -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                
                <!-- รอชี้แจง - ย้ายมาแสดงก่อน -->
                <div x-show="modalData.pendingExplanation && modalData.pendingExplanation.length > 0">
                    <h4 class="text-md font-semibold mb-2 pb-2 border-b dark:border-gray-600 flex items-center gap-2 text-blue-600 dark:text-blue-400">
                        <i class="fas fa-comment-dots"></i> รอชี้แจง
                    </h4>
                    <p class="text-xs text-gray-500 mb-2">รายการเหล่านี้ยังไม่ได้ถูกชี้แจงโดยพนักงาน</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[400px]">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left whitespace-nowrap">สินค้า</th>
                                    <th class="px-3 py-2 text-center whitespace-nowrap w-24">ผลต่าง</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y dark:divide-gray-600">
                                <template x-for="item in modalData.pendingExplanation">
                                    <tr>
                                        <td class="px-3 py-3">
                                            <div class="font-medium" x-text="item.product_name"></div>
                                            <div class="text-xs text-gray-500" x-text="item.product_code"></div>
                                        </td>
                                        <td class="px-3 py-3 text-center font-bold whitespace-nowrap" 
                                            :class="item.difference >= 0 ? 'text-green-600' : 'text-red-600'" 
                                            x-text="(item.difference > 0 ? '+' : '') + item.difference"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- รออนุมัติ -->
                <div x-show="modalData.pendingApproval && modalData.pendingApproval.length > 0">
                    <h4 class="text-md font-semibold mb-2 pb-2 border-b dark:border-gray-600 flex items-center gap-2 text-yellow-600 dark:text-yellow-400">
                        <i class="fas fa-hourglass-half"></i> รออนุมัติ
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[500px]">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left whitespace-nowrap">สินค้า</th>
                                    <th class="px-3 py-2 text-center whitespace-nowrap w-24">ผลต่าง</th>
                                    <th class="px-3 py-2 text-left">คำชี้แจง</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y dark:divide-gray-600">
                                <template x-for="item in modalData.pendingApproval">
                                    <tr>
                                        <td class="px-3 py-3">
                                            <div class="font-medium" x-text="item.product_name"></div>
                                            <div class="text-xs text-gray-500" x-text="item.product_code"></div>
                                        </td>
                                        <td class="px-3 py-3 text-center font-bold whitespace-nowrap" 
                                            :class="item.difference >= 0 ? 'text-green-600' : 'text-red-600'" 
                                            x-text="(item.difference > 0 ? '+' : '') + item.difference"></td>
                                        <td class="px-3 py-3 text-gray-600 dark:text-gray-400">
                                            <span x-text="item.explanation || '-'"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ปฏิเสธ -->
                <div x-show="modalData.rejected && modalData.rejected.length > 0">
                    <h4 class="text-md font-semibold mb-2 pb-2 border-b dark:border-gray-600 flex items-center gap-2 text-red-600 dark:text-red-400">
                        <i class="fas fa-times-circle"></i> ปฏิเสธ (รอแก้ไข)
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[500px]">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left whitespace-nowrap">สินค้า</th>
                                    <th class="px-3 py-2 text-center whitespace-nowrap w-24">ผลต่าง</th>
                                    <th class="px-3 py-2 text-left">เหตุผลที่ปฏิเสธ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y dark:divide-gray-600">
                                <template x-for="item in modalData.rejected">
                                    <tr>
                                        <td class="px-3 py-3">
                                            <div class="font-medium" x-text="item.product_name"></div>
                                            <div class="text-xs text-gray-500" x-text="item.product_code"></div>
                                        </td>
                                        <td class="px-3 py-3 text-center font-bold whitespace-nowrap" 
                                            :class="item.difference >= 0 ? 'text-green-600' : 'text-red-600'" 
                                            x-text="(item.difference > 0 ? '+' : '') + item.difference"></td>
                                        <td class="px-3 py-3 text-gray-600 dark:text-gray-400">
                                            <span x-text="item.owner_notes || '-'"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- อนุมัติแล้ว -->
                <div x-show="modalData.approved && modalData.approved.length > 0">
                    <h4 class="text-md font-semibold mb-2 pb-2 border-b dark:border-gray-600 flex items-center gap-2 text-green-600 dark:text-green-400">
                        <i class="fas fa-check-circle"></i> อนุมัติแล้ว
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[500px]">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left whitespace-nowrap">สินค้า</th>
                                    <th class="px-3 py-2 text-center whitespace-nowrap w-24">ผลต่าง</th>
                                    <th class="px-3 py-2 text-left">คำชี้แจง</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y dark:divide-gray-600">
                                <template x-for="item in modalData.approved">
                                    <tr>
                                        <td class="px-3 py-3">
                                            <div class="font-medium" x-text="item.product_name"></div>
                                            <div class="text-xs text-gray-500" x-text="item.product_code"></div>
                                        </td>
                                        <td class="px-3 py-3 text-center font-bold whitespace-nowrap" 
                                            :class="item.difference >= 0 ? 'text-green-600' : 'text-red-600'" 
                                            x-text="(item.difference > 0 ? '+' : '') + item.difference"></td>
                                        <td class="px-3 py-3 text-gray-600 dark:text-gray-400">
                                            <span x-text="item.explanation || '-'"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="(!modalData.pendingApproval || modalData.pendingApproval.length === 0) && (!modalData.rejected || modalData.rejected.length === 0) && (!modalData.approved || modalData.approved.length === 0) && (!modalData.pendingExplanation || modalData.pendingExplanation.length === 0)" 
                     class="text-center text-gray-500 py-8">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>ไม่พบรายการผลต่างสำหรับวันนี้</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Partial Approval Modal - แก้ไขปุ่มไม่ให้ถูกบัง -->
    <div x-show="discrepancyDashboard.showPartialApprovalModal" 
         @keydown.escape.window="closePartialApprovalModal()"
         class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-start p-4 overflow-y-auto" x-cloak>
        <div @click.away="closePartialApprovalModal()" 
             class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl my-8">
            
            <!-- Header -->
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-800 rounded-t-lg sticky top-0 z-10">
                <div class="flex-1 min-w-0">
                    <h3 class="text-lg font-semibold">อนุมัติบางรายการ</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        วันที่: <span x-text="new Date(discrepancyDashboard.partialApprovalDate).toLocaleDateString('th-TH')"></span>
                    </p>
                </div>
                <button @click="closePartialApprovalModal()" 
                        class="flex-none text-gray-400 hover:text-gray-600 text-2xl ml-4">&times;</button>
            </div>
            
            <!-- Content -->
            <div class="p-4 md:p-6">
                
                <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg gap-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" 
                               @change="selectAllPartialItems($event.target.checked, 'approve')"
                               class="rounded">
                        <span class="font-medium">เลือกทั้งหมด</span>
                    </label>
                    <span class="text-sm text-gray-600 dark:text-gray-400">
                        เลือกแล้ว: <strong x-text="discrepancyDashboard.partialApprovalItems.filter(i => i.selected).length"></strong> 
                        / <span x-text="discrepancyDashboard.partialApprovalItems.length"></span>
                    </span>
                </div>

                <div class="space-y-2 mb-6 max-h-[35vh] overflow-y-auto pr-2">
                    <template x-for="item in discrepancyDashboard.partialApprovalItems" :key="item.comp_id">
                        <div class="border dark:border-gray-600 rounded-lg p-3 md:p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                             :class="{ 'bg-blue-50 dark:bg-blue-900/20 border-blue-300': item.selected }">
                            <label class="flex items-start space-x-3 cursor-pointer">
                                <input type="checkbox" 
                                       :checked="item.selected"
                                       @change="togglePartialItem(item.comp_id, 'approve')"
                                       class="mt-1 rounded flex-none">
                                <div class="flex-1">
                                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                        <div class="flex-1">
                                            <div class="font-medium" x-text="item.product_name"></div>
                                            <div class="text-xs text-gray-500" x-text="item.product_code"></div>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm">
                                            <span class="text-gray-600 dark:text-gray-400">
                                                POS: <strong x-text="item.pos_quantity"></strong>
                                            </span>
                                            <span class="text-gray-600 dark:text-gray-400">
                                                นับได้: <strong x-text="item.manual_quantity"></strong>
                                            </span>
                                            <span class="font-bold" 
                                                  :class="item.difference >= 0 ? 'text-green-600' : 'text-red-600'"
                                                  x-text="'ผลต่าง: ' + (item.difference > 0 ? '+' : '') + item.difference"></span>
                                        </div>
                                    </div>
                                    <div x-show="item.explanation" class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium">คำชี้แจง: </span>
                                        <span x-text="item.explanation"></span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </template>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <label class="block text-sm font-medium mb-2">
                        <i class="fas fa-comment text-blue-600 mr-1"></i>
                        เหตุผลในการอนุมัติเฉพาะบางรายการ (บังคับ)
                    </label>
                    <textarea x-model="discrepancyDashboard.partialApprovalReason"
                              placeholder="ระบุเหตุผลว่าทำไมอนุมัติเฉพาะรายการที่เลือก..."
                              class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                              rows="3"></textarea>
                </div>
            </div>
            
            <!-- Footer - พื้นที่ปลอดภัยสำหรับปุ่ม -->
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 flex flex-col sm:flex-row justify-end gap-2 rounded-b-lg border-t dark:border-gray-600 sticky bottom-0">
                <button @click="closePartialApprovalModal()" 
                        class="px-6 py-2.5 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 w-full sm:w-auto">
                    ยกเลิก
                </button>
                <button @click="submitPartialApproval()" 
                        class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 w-full sm:w-auto">
                    <i class="fas fa-check mr-2"></i>
                    อนุมัติรายการที่เลือก
                </button>
            </div>
        </div>
    </div>

    <!-- Partial Reject Modal - แก้ไขปุ่มไม่ให้ถูกบัง -->
    <div x-show="discrepancyDashboard.showPartialRejectModal" 
         @keydown.escape.window="closePartialRejectModal()"
         class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-start p-4 overflow-y-auto" x-cloak>
        <div @click.away="closePartialRejectModal()" 
             class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl my-8">
            
            <!-- Header -->
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-red-50 to-orange-50 dark:from-gray-700 dark:to-gray-800 rounded-t-lg sticky top-0 z-10">
                <div class="flex-1 min-w-0">
                    <h3 class="text-lg font-semibold">ปฏิเสธบางรายการ</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        วันที่: <span x-text="new Date(discrepancyDashboard.partialRejectDate).toLocaleDateString('th-TH')"></span>
                    </p>
                </div>
                <button @click="closePartialRejectModal()" 
                        class="flex-none text-gray-400 hover:text-gray-600 text-2xl ml-4">&times;</button>
            </div>
            
            <!-- Content -->
            <div class="p-4 md:p-6">
                
                <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg gap-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" 
                               @change="selectAllPartialItems($event.target.checked, 'reject')"
                               class="rounded">
                        <span class="font-medium">เลือกทั้งหมด</span>
                    </label>
                    <span class="text-sm text-gray-600 dark:text-gray-400">
                        เลือกแล้ว: <strong x-text="discrepancyDashboard.partialRejectItems.filter(i => i.selected).length"></strong> 
                        / <span x-text="discrepancyDashboard.partialRejectItems.length"></span>
                    </span>
                </div>

                <div class="space-y-2 mb-6 max-h-[35vh] overflow-y-auto pr-2">
                    <template x-for="item in discrepancyDashboard.partialRejectItems" :key="item.comp_id">
                        <div class="border dark:border-gray-600 rounded-lg p-3 md:p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                             :class="{ 'bg-red-50 dark:bg-red-900/20 border-red-300': item.selected }">
                            <label class="flex items-start space-x-3 cursor-pointer">
                                <input type="checkbox" 
                                       :checked="item.selected"
                                       @change="togglePartialItem(item.comp_id, 'reject')"
                                       class="mt-1 rounded flex-none">
                                <div class="flex-1">
                                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                        <div class="flex-1">
                                            <div class="font-medium" x-text="item.product_name"></div>
                                            <div class="text-xs text-gray-500" x-text="item.product_code"></div>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm">
                                            <span class="text-gray-600 dark:text-gray-400">
                                                POS: <strong x-text="item.pos_quantity"></strong>
                                            </span>
                                            <span class="text-gray-600 dark:text-gray-400">
                                                นับได้: <strong x-text="item.manual_quantity"></strong>
                                            </span>
                                            <span class="font-bold" 
                                                  :class="item.difference >= 0 ? 'text-green-600' : 'text-red-600'"
                                                  x-text="'ผลต่าง: ' + (item.difference > 0 ? '+' : '') + item.difference"></span>
                                        </div>
                                    </div>
                                    <div x-show="item.explanation" class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                        <span class="font-medium">คำชี้แจง: </span>
                                        <span x-text="item.explanation"></span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </template>
                </div>

                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                    <label class="block text-sm font-medium mb-2">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-1"></i>
                        เหตุผลในการปฏิเสธ (บังคับ)
                    </label>
                    <textarea x-model="discrepancyDashboard.partialRejectReason"
                              placeholder="ระบุเหตุผลที่ปฏิเสธรายการที่เลือก..."
                              class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                              rows="3"></textarea>
                </div>
            </div>
            
            <!-- Footer - พื้นที่ปลอดภัยสำหรับปุ่ม -->
            <div class="p-4 bg-gray-50 dark:bg-gray-700/50 flex flex-col sm:flex-row justify-end gap-2 rounded-b-lg border-t dark:border-gray-600 sticky bottom-0">
                <button @click="closePartialRejectModal()" 
                        class="px-6 py-2.5 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 w-full sm:w-auto">
                    ยกเลิก
                </button>
                <button @click="submitPartialReject()" 
                        class="px-6 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 w-full sm:w-auto">
                    <i class="fas fa-times mr-2"></i>
                    ปฏิเสธรายการที่เลือก
                </button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Content -->
    <div class="space-y-6">
        <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
            <h2 class="text-3xl font-bold">แดชบอร์ดจัดการผลต่าง</h2>
            <p class="text-gray-600 dark:text-gray-400">สรุปภาพรวมผลต่าง, ติดตามแนวโน้ม, และจัดการคำชี้แจงสำหรับเจ้าของร้าน</p>
        </div>

        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label class="text-xs text-gray-500">จากวันที่</label>
                    <input type="date" x-model="discrepancyDashboard.filters.dateFrom" 
                           @change="loadDiscrepancyDashboard()" 
                           class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="text-xs text-gray-500">ถึงวันที่</label>
                    <input type="date" x-model="discrepancyDashboard.filters.dateTo" 
                           @change="loadDiscrepancyDashboard()" 
                           class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="col-span-1 lg:col-span-2 flex gap-2">
                    <button @click="exportDiscrepancyReport('excel')" 
                            class="flex-1 bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 disabled:opacity-50" 
                            :disabled="discrepancyDashboard.loading">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                    <button @click="exportDiscrepancyReport('pdf')" 
                            class="flex-1 bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 disabled:opacity-50" 
                            :disabled="discrepancyDashboard.loading">
                        <i class="fas fa-file-pdf mr-2"></i>Export PDF
                    </button>
                </div>
            </div>
        </div>

        <div x-show="discrepancyDashboard.loading" class="text-center p-10">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-600 dark:text-gray-400">กำลังโหลดข้อมูลแดชบอร์ด...</p>
        </div>

        <div x-show="!discrepancyDashboard.loading" class="space-y-6">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <p class="text-sm text-gray-500 dark:text-gray-400">มูลค่าของขาด (บาท)</p>
                    <p class="text-3xl font-bold text-red-500" 
                       x-text="(discrepancyDashboard.data.kpis?.shrinkageValue || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <p class="text-sm text-gray-500 dark:text-gray-400">มูลค่าของเกิน (บาท)</p>
                    <p class="text-3xl font-bold text-green-500" 
                       x-text="(discrepancyDashboard.data.kpis?.overageValue || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <p class="text-sm text-gray-500 dark:text-gray-400">รายการรออนุมัติ</p>
                    <p class="text-3xl font-bold text-yellow-500" 
                       x-text="discrepancyDashboard.data.kpis?.pendingApprovalCount || 0"></p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <p class="text-sm text-gray-500 dark:text-gray-400">ความแม่นยำสต๊อก</p>
                    <p class="text-3xl font-bold text-blue-500" 
                       x-text="(discrepancyDashboard.data.kpis?.accuracyRate || 0).toFixed(2) + '%'"></p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <h3 class="font-semibold mb-4">แนวโน้มผลต่าง (มูลค่า)</h3>
                    <div class="h-64">
                        <canvas id="discrepancyTrendChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
    <h3 class="font-semibold mb-4">5 หมวดหมู่ที่ผลต่างสูงสุด (มูลค่า)</h3>
    <div class="space-y-4">
        <template x-if="top5CategoriesByDiscrepancy.length === 0">
            <div class="flex items-center justify-center h-56 text-gray-500">
                ไม่มีข้อมูล
            </div>
        </template>
        <template x-for="(category, index) in top5CategoriesByDiscrepancy" :key="index">
            <div>
                <div class="flex justify-between items-center text-sm mb-1">
                    <span class="text-gray-800 dark:text-gray-200" x-text="category.category"></span>
                    <span class="font-medium text-gray-900 dark:text-gray-100" x-text="category.value.toLocaleString('th-TH', { minimumFractionDigits: 2 }) + ' ฿'"></span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" :style="'width: ' + category.percentage + '%'"></div>
                </div>
            </div>
        </template>
    </div>
</div>
            </div>

            <!-- Data Table - ส่วนที่หายไป -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
                <div class="p-4 flex flex-col md:flex-row justify-between items-center gap-4 border-b dark:border-gray-700">
                    <div x-show="discrepancyDashboard.selectedRows.length > 0" class="w-full md:w-auto">
                        <span x-text="'เลือก ' + discrepancyDashboard.selectedRows.length + ' วัน'" 
                              class="font-semibold text-blue-600"></span>
                        <button @click="approveSelected()" 
                                class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                            <i class="fas fa-check-double mr-1"></i>
                            อนุมัติทั้งหมดที่เลือก
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="p-3 w-10">
                                    <input type="checkbox" @change="toggleAllSelection($event)" class="rounded">
                                </th>
                                <th class="p-3 text-left cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" 
                                    @click="sortBy('date')">
                                    วันที่ <i class="fas fa-sort text-gray-400"></i>
                                </th>
                                <th class="p-3 text-left">สถานะการส่งข้อมูล</th>
                                <th class="p-3 text-left">สรุปผล (รายการ)</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-if="filteredAndSortedTableData.length === 0">
                                <tr>
                                    <td colspan="5" class="text-center py-10 text-gray-500">
                                        ไม่พบข้อมูลตามเงื่อนไขที่เลือก
                                    </td>
                                </tr>
                            </template>
                            <template x-for="row in filteredAndSortedTableData" :key="row.id">
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                    <td class="p-3">
                                        <input type="checkbox" :value="row.id" 
                                               x-model="discrepancyDashboard.selectedRows" class="rounded">
                                    </td>
                                    <td class="p-3 font-semibold whitespace-nowrap" 
                                        x-text="new Date(row.date).toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' })"></td>
                                    <td class="p-3">
                                        <div class="flex items-center space-x-3 text-lg">
                                            <i class="fas fa-clipboard-check" title="Manual Count"
                                               :class="row.hasManualCount ? 'text-green-500' : 'text-gray-300 dark:text-gray-600'"></i>
                                            <i class="fas fa-file-pdf" title="PDF Upload"
                                               :class="row.hasPdfUpload ? 'text-blue-500' : 'text-gray-300 dark:text-gray-600'"></i>
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        <template x-if="row.isComplete">
                                            <div class="flex items-center gap-3 text-xs">
                                                <div class="flex items-center" title="ผลต่างรวม">
                                                    <i class="fas fa-file-alt text-gray-400 mr-1.5"></i>
                                                    <span class="font-bold text-gray-700 dark:text-gray-200" x-text="row.summaryCounts.total"></span>
                                                </div>
                                                <div class="flex items-center" title="ชี้แจงแล้ว">
                                                    <i class="fas fa-comment-dots text-blue-400 mr-1.5"></i>
                                                    <span class="font-bold text-blue-600 dark:text-blue-400" x-text="row.summaryCounts.explained"></span>
                                                </div>
                                                <div class="flex items-center" title="รออนุมัติ">
                                                    <i class="fas fa-hourglass-half text-yellow-500 mr-1.5"></i>
                                                    <span class="font-bold text-yellow-600 dark:text-yellow-400" x-text="row.summaryCounts.pending"></span>
                                                </div>
                                                <div class="flex items-center" title="ปฏิเสธ">
                                                    <i class="fas fa-times-circle text-red-400 mr-1.5"></i>
                                                    <span class="font-bold text-red-600 dark:text-red-400" x-text="row.summaryCounts.rejected"></span>
                                                </div>
                                            </div>
                                        </template>
                                        <template x-if="!row.isComplete">
                                            <span class="text-xs italic text-gray-500" x-text="row.summaryCounts.displayText || 'ไม่มีข้อมูล'"></span>
                                        </template>
                                    </td>
                                    <td class="p-3 text-center">
                                        <template x-if="row.isComplete">
                                            <div class="flex items-center justify-center gap-2">
                                                <button @click="openDetailsModal(row.date)"
                                                        class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200 dark:bg-blue-900/50 dark:text-blue-300">
                                                    <i class="fas fa-eye mr-1"></i> ดูรายละเอียด
                                                </button>
                                                <button @click="openPartialApprovalModal(row.date)"
                                                        class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                                                    <i class="fas fa-check-circle mr-1"></i> อนุมัติ
                                                </button>
                                                <button @click="openPartialRejectModal(row.date)"
                                                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                                                    <i class="fas fa-times-circle mr-1"></i> ปฏิเสธ
                                                </button>
                                            </div>
                                        </template>
                                        <template x-if="!row.isComplete">
                                            <span class="text-gray-400">-</span>
                                        </template>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    `;
                },



                renderDiscrepancyCharts() {
                    // ทำลายกราฟเก่า
                    if (this.discrepancyDashboard.charts.trend) {
                        this.discrepancyDashboard.charts.trend.destroy();
                    }
                    if (this.discrepancyDashboard.charts.category) {
                        this.discrepancyDashboard.charts.category.destroy();
                        this.discrepancyDashboard.charts.category = null;
                    }

                    const isDarkMode = this.darkMode;
                    const tickColor = isDarkMode ? '#a1a1aa' : '#475569';
                    const gridColor = isDarkMode ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.06)';

                    // กราฟแนวโน้ม
                    const trendCtx = document.getElementById('discrepancyTrendChart')?.getContext('2d');
                    if (trendCtx && this.discrepancyDashboard.data.trendChartData?.length > 0) {
                        this.discrepancyDashboard.charts.trend = new Chart(trendCtx, {
                            type: 'bar',
                            data: {
                                // --- ✅ แก้ไขส่วนนี้ ---
                                labels: this.discrepancyDashboard.data.trendChartData.map(d => {
                                    const parts = d.date.split('-'); // แปลง "2025-10-01" เป็น ["2025", "10", "01"]
                                    return `${parts[2]}-${parts[1]}-${parts[0]}`; // จัดเรียงใหม่เป็น "01-10-2025"
                                }),
                                // --- จบส่วนที่แก้ไข ---
                                datasets: [
                                    {
                                        label: 'มูลค่าของขาด',
                                        data: this.discrepancyDashboard.data.trendChartData.map(d => d.shrinkage),
                                        backgroundColor: '#ef4444',
                                        borderRadius: 4
                                    },
                                    {
                                        label: 'มูลค่าของเกิน',
                                        data: this.discrepancyDashboard.data.trendChartData.map(d => d.overage),
                                        backgroundColor: '#22c55e',
                                        borderRadius: 4
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: tickColor,
                                            font: { size: 12 }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { color: tickColor },
                                        grid: { color: gridColor }
                                    },
                                    y: {
                                        ticks: {
                                            color: tickColor,
                                            callback: function (value) {
                                                return value.toLocaleString('th-TH');
                                            }
                                        },
                                        grid: { color: gridColor }
                                    }
                                }
                            }
                        });
                    }
                },


                get top5CategoriesByDiscrepancy() {
                    if (!this.discrepancyDashboard.data.categoryChartData || this.discrepancyDashboard.data.categoryChartData.length === 0) {
                        return [];
                    }

                    const sortedData = [...this.discrepancyDashboard.data.categoryChartData]
                        // เพิ่ม: กรองข้อมูลที่ไม่สมบูรณ์ออกก่อน
                        .filter(item => item && typeof item.value !== 'undefined' && item.category)
                        .sort((a, b) => Math.abs(b.value) - Math.abs(a.value))
                        .slice(0, 5);

                    if (sortedData.length === 0) {
                        return [];
                    }

                    const maxValue = Math.abs(sortedData[0].value);

                    return sortedData.map(item => ({
                        // เพิ่ม: ป้องกันกรณี category เป็นค่าว่าง
                        category: item.category || 'ไม่ระบุหมวดหมู่',
                        value: Math.abs(item.value),
                        percentage: maxValue > 0 ? (Math.abs(item.value) / maxValue) * 100 : 0
                    }));
                },


                discrepancyDashboard: {
                    loading: true,
                    filters: {
                        dateFrom: '',
                        dateTo: '',
                        status: 'all',
                        showAll: true
                    },
                    sort: { column: 'date', direction: 'desc' },
                    data: {},
                    charts: {},
                    expandedDate: null,
                    selectedRows: [],
                    // แก้ไข/เพิ่มส่วนนี้
                    showPartialApprovalModal: false,
                    partialApprovalDate: null,
                    partialApprovalItems: [],
                    partialApprovalReason: '',
                    showPartialRejectModal: false,
                    partialRejectDate: null,
                    partialRejectItems: [],
                    partialRejectReason: ''
                },







                openPartialApprovalModal(date) {
                    this.discrepancyDashboard.partialApprovalDate = date;
                    this.discrepancyDashboard.partialApprovalReason = '';
                    this.showLoadingModal('กำลังโหลด', 'กำลังดึงรายการที่รออนุมัติ...');

                    const sheetId = Alpine.store('app').user.sheetId;

                    google.script.run
                        .withSuccessHandler(response => {
                            this.hideLoadingModal();
                            if (response.success) {
                                if (response.details.length === 0) {
                                    Swal.fire({
                                        icon: 'info',
                                        title: 'ไม่พบรายการ',
                                        text: 'ไม่พบรายการที่รอการอนุมัติในวันนี้',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                    return;
                                }

                                this.discrepancyDashboard.partialApprovalItems = response.details.map(item => ({
                                    ...item,
                                    selected: false
                                }));
                                this.discrepancyDashboard.showPartialApprovalModal = true;
                            } else {
                                Swal.fire('ผิดพลาด', response.message, 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            this.hideLoadingModal();
                            Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                        })
                        // เรียกใช้ฟังก์ชันใหม่ที่กรองข้อมูลแล้ว
                        .getPendingDiscrepancyDetailsForDate(sheetId, date);
                },

                openPartialRejectModal(date) {
                    this.discrepancyDashboard.partialRejectDate = date;
                    this.discrepancyDashboard.partialRejectReason = '';
                    this.showLoadingModal('กำลังโหลด', 'กำลังดึงรายการที่รอปฏิเสธ...');

                    const sheetId = Alpine.store('app').user.sheetId;

                    google.script.run
                        .withSuccessHandler(response => {
                            this.hideLoadingModal();
                            if (response.success) {
                                // ตรวจสอบว่ามีรายการที่รอการอนุมัติหรือไม่
                                if (response.details.length === 0) {
                                    Swal.fire({
                                        icon: 'info',
                                        title: 'ไม่พบรายการ',
                                        text: 'ไม่พบรายการที่รอการตัดสินใจในวันนี้',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                    return; // ไม่ต้องเปิด Modal
                                }

                                this.discrepancyDashboard.partialRejectItems = response.details.map(item => ({
                                    ...item,
                                    selected: false
                                }));
                                this.discrepancyDashboard.showPartialRejectModal = true;
                            } else {
                                Swal.fire('ผิดพลาด', response.message, 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            this.hideLoadingModal();
                            Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                        })
                        // *** แก้ไขตรงนี้: ให้เรียกใช้ฟังก์ชันใหม่ที่กรองข้อมูลแล้ว ***
                        .getPendingDiscrepancyDetailsForDate(sheetId, date);
                },

                closePartialApprovalModal() {
                    this.discrepancyDashboard.showPartialApprovalModal = false;
                    this.discrepancyDashboard.partialApprovalDate = null;
                    this.discrepancyDashboard.partialApprovalItems = [];
                    this.discrepancyDashboard.partialApprovalReason = '';
                },

                closePartialRejectModal() {
                    this.discrepancyDashboard.showPartialRejectModal = false;
                    this.discrepancyDashboard.partialRejectDate = null;
                    this.discrepancyDashboard.partialRejectItems = [];
                    this.discrepancyDashboard.partialRejectReason = '';
                },









                togglePartialItem(compId, type) { // <--- เพิ่ม type
                    const items = type === 'approve' ? this.discrepancyDashboard.partialApprovalItems : this.discrepancyDashboard.partialRejectItems;
                    const item = items.find(i => i.comp_id === compId);
                    if (item) {
                        item.selected = !item.selected;
                    }
                },

                selectAllPartialItems(selectAll, type) { // <--- เพิ่ม type
                    const items = type === 'approve' ? this.discrepancyDashboard.partialApprovalItems : this.discrepancyDashboard.partialRejectItems;
                    items.forEach(item => {
                        item.selected = selectAll;
                    });
                },


                // แก้ไขฟังก์ชันนี้
                submitPartialApproval() {
                    const selectedItems = this.discrepancyDashboard.partialApprovalItems.filter(item => item.selected);

                    if (selectedItems.length === 0) {
                        Swal.fire('กรุณาเลือกรายการ', 'กรุณาเลือกอย่างน้อย 1 รายการที่ต้องการอนุมัติ', 'warning');
                        return;
                    }

                    if (!this.discrepancyDashboard.partialApprovalReason.trim()) {
                        Swal.fire('กรุณาใส่เหตุผล', 'กรุณาระบุเหตุผลในการอนุมัติบางรายการ', 'warning');
                        return;
                    }

                    Swal.fire({
                        title: 'ยืนยันการอนุมัติบางรายการ?',
                        html: `
            <p>คุณต้องการอนุมัติ <strong>${selectedItems.length}</strong> รายการ</p>
            <p>จากทั้งหมด <strong>${this.discrepancyDashboard.partialApprovalItems.length}</strong> รายการ</p>
            <p class="text-sm mt-2 text-gray-600">วันที่: ${new Date(this.discrepancyDashboard.partialApprovalDate).toLocaleDateString('th-TH')}</p>
        `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'อนุมัติ',
                        cancelButtonText: 'ยกเลิก'
                    }).then(result => {
                        if (result.isConfirmed) {
                            this.showLoadingModal('กำลังบันทึก', 'กำลังอนุมัติรายการที่เลือก...');

                            const sheetId = Alpine.store('app').user.sheetId;
                            const ownerName = Alpine.store('app').user.username;
                            const compIds = selectedItems.map(item => item.comp_id);

                            google.script.run
                                .withSuccessHandler(response => {
                                    this.hideLoadingModal();
                                    if (response.success) {
                                        Swal.fire('สำเร็จ!', 'อนุมัติรายการที่เลือกเรียบร้อยแล้ว', 'success');
                                        this.closePartialApprovalModal();
                                        this.loadDiscrepancyDashboard();
                                    } else {
                                        Swal.fire('ผิดพลาด', response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    this.hideLoadingModal();
                                    Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                                })
                                .approvePartialItems(
                                    sheetId,
                                    this.discrepancyDashboard.partialApprovalDate,
                                    compIds,
                                    ownerName,
                                    this.discrepancyDashboard.partialApprovalReason
                                );
                        }
                    });
                },

                // เพิ่มฟังก์ชันนี้
                submitPartialReject() {
                    const selectedItems = this.discrepancyDashboard.partialRejectItems.filter(item => item.selected);

                    if (selectedItems.length === 0) {
                        Swal.fire('กรุณาเลือกรายการ', 'กรุณาเลือกอย่างน้อย 1 รายการที่ต้องการปฏิเสธ', 'warning');
                        return;
                    }

                    if (!this.discrepancyDashboard.partialRejectReason.trim()) {
                        Swal.fire('กรุณาใส่เหตุผล', 'กรุณาระบุเหตุผลในการปฏิเสธรายการที่เลือก', 'warning');
                        return;
                    }

                    Swal.fire({
                        title: 'ยืนยันการปฏิเสธบางรายการ?',
                        html: `
            <p>คุณต้องการปฏิเสธ <strong>${selectedItems.length}</strong> รายการ</p>
            <p class="text-sm mt-2 text-gray-600">วันที่: ${new Date(this.discrepancyDashboard.partialRejectDate).toLocaleDateString('th-TH')}</p>
        `,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ยืนยันการปฏิเสธ',
                        cancelButtonText: 'ยกเลิก'
                    }).then(result => {
                        if (result.isConfirmed) {
                            this.showLoadingModal('กำลังบันทึก', 'กำลังปฏิเสธรายการที่เลือก...');

                            const sheetId = Alpine.store('app').user.sheetId;
                            const ownerName = Alpine.store('app').user.username;
                            const compIds = selectedItems.map(item => item.comp_id);

                            google.script.run
                                .withSuccessHandler(response => {
                                    this.hideLoadingModal();
                                    if (response.success) {
                                        Swal.fire('สำเร็จ!', 'ปฏิเสธรายการที่เลือกเรียบร้อยแล้ว', 'success');
                                        this.closePartialRejectModal();
                                        this.loadDiscrepancyDashboard();
                                    } else {
                                        Swal.fire('ผิดพลาด', response.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    this.hideLoadingModal();
                                    Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                                })
                                .rejectPartialItems( // <--- เรียกฟังก์ชันใหม่
                                    sheetId,
                                    this.discrepancyDashboard.partialRejectDate,
                                    compIds,
                                    ownerName,
                                    this.discrepancyDashboard.partialRejectReason
                                );
                        }
                    });
                },



                get filteredAndSortedTableData() {
                    // ป้องกัน error กรณีที่ข้อมูลยังโหลดไม่เสร็จ
                    if (!this.discrepancyDashboard.data.tableData) {
                        return [];
                    }

                    const sort = this.discrepancyDashboard.sort;

                    // *** START: ส่วนที่แก้ไข ***
                    // นำตรรกะการกรองตามสถานะ (statusMatch) ออกทั้งหมด
                    const processedData = this.discrepancyDashboard.data.tableData.filter(row => {
                        // เงื่อนไขเดียวที่เหลืออยู่คือการแสดงเฉพาะวันที่มีผลต่าง (isComplete และ summaryCounts.total > 0)
                        // หรือวันที่ยังดำเนินการไม่เสร็จ (isComplete === false)
                        const showMatch = row.isComplete ? row.summaryCounts.total > 0 : true;
                        return showMatch;
                    });
                    // *** END: ส่วนที่แก้ไข ***

                    // ส่วนของการเรียงลำดับ (Sorting)
                    processedData.sort((a, b) => {
                        const valA = a[sort.column];
                        const valB = b[sort.column];
                        const direction = sort.direction === 'asc' ? 1 : -1;

                        if (sort.column === 'financialImpact') {
                            return (valA - valB) * direction;
                        }

                        if (valA < valB) return -1 * direction;
                        if (valA > valB) return 1 * direction;
                        return 0;
                    });

                    return processedData;
                },

                // เพิ่ม: ฟังก์ชันสำหรับเปลี่ยนการเรียงข้อมูล
                sortBy(column) {
                    if (this.discrepancyDashboard.sort.column === column) {
                        this.discrepancyDashboard.sort.direction = this.discrepancyDashboard.sort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.discrepancyDashboard.sort.column = column;
                        this.discrepancyDashboard.sort.direction = 'desc';
                    }
                },

                // เพิ่มฟังก์ชันใหม่สำหรับจัดการแดชบอร์ด
                loadDiscrepancyDashboard() {
                    this.discrepancyDashboard.loading = true;
                    const sheetId = Alpine.store('app').user.sheetId;
                    if (!sheetId) return;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                this.discrepancyDashboard.data = response.data;
                                this.$nextTick(() => this.renderDiscrepancyCharts());
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                            this.discrepancyDashboard.loading = false;
                        })
                        .withFailureHandler(err => {
                            Swal.fire('Error', err.message, 'error');
                            this.discrepancyDashboard.loading = false;
                        })
                        .getDiscrepancyDashboardData(sheetId, this.discrepancyDashboard.filters.dateFrom, this.discrepancyDashboard.filters.dateTo);
                },


                toggleRow(date) {
                    this.discrepancyDashboard.expandedDate = this.discrepancyDashboard.expandedDate === date ? null : date;
                },

                // ฟังก์ชันจัดการ Bulk Actions
                toggleAllSelection(event) {
                    if (event.target.checked) {
                        this.discrepancyDashboard.selectedRows = this.filteredAndSortedTableData.map(r => r.id);
                    } else {
                        this.discrepancyDashboard.selectedRows = [];
                    }
                },


                // แก้ไขฟังก์ชันนี้
                approveSelected() {
                    const selected = this.discrepancyDashboard.selectedRows;
                    if (selected.length === 0) return;

                    Swal.fire({
                        title: `ยืนยันการอนุมัติ ${selected.length} วัน?`,
                        text: "ทุกรายการที่ 'รอตรวจสอบ' ในวันที่เลือกจะถูกอนุมัติทั้งหมด",
                        icon: 'question',
                        input: 'textarea', // <--- เพิ่ม input
                        inputPlaceholder: 'กรุณาระบุเหตุผลในการอนุมัติทั้งหมด (จำเป็น)...', // <--- เพิ่ม placeholder
                        showCancelButton: true,
                        confirmButtonText: 'ยืนยันการอนุมัติ',
                        cancelButtonText: 'ยกเลิก',
                        preConfirm: (reason) => { // <--- เพิ่ม preConfirm
                            if (!reason) {
                                Swal.showValidationMessage('กรุณาระบุเหตุผล')
                            }
                            return reason
                        }
                    }).then(result => {
                        if (result.isConfirmed) {
                            const reason = result.value; // <--- รับค่าเหตุผล
                            this.showLoadingModal('กำลังดำเนินการ...');
                            google.script.run
                                .withSuccessHandler(res => {
                                    this.hideLoadingModal();
                                    if (res.success) {
                                        this.discrepancyDashboard.selectedRows = [];
                                        this.loadDiscrepancyDashboard(); // โหลดข้อมูลใหม่
                                        Swal.fire('สำเร็จ!', 'รายการที่เลือกถูกอนุมัติแล้ว', 'success');
                                    } else {
                                        Swal.fire('ผิดพลาด', res.message, 'error');
                                    }
                                })
                                .withFailureHandler(error => {
                                    this.hideLoadingModal();
                                    Swal.fire('ผิดพลาดร้ายแรง', error.message, 'error');
                                })
                                .approveMultipleDays(Alpine.store('app').user.sheetId, selected, Alpine.store('app').user.username, reason); // <--- ส่ง reason ไปด้วย
                        }
                    });
                },












                exportDiscrepancyReport(format) {
                    const sheetId = Alpine.store('app').user.sheetId;
                    // ใช้ filtered data ในการ export (ถ้ามี client-side filter)
                    const dataToExport = this.discrepancyDashboard.data.tableData;

                    this.showLoadingModal('Exporting...', `Creating ${format.toUpperCase()} file.`);

                    google.script.run
                        .withSuccessHandler(response => {
                            this.hideLoadingModal();
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Export Successful!',
                                    html: `<a href="${response.fileUrl}" target="_blank" class="text-blue-600 underline">Click here to download your file</a>`
                                });
                            } else {
                                Swal.fire('Export Failed', response.message, 'error');
                            }
                        })
                        .withFailureHandler(err => {
                            this.hideLoadingModal();
                            Swal.fire('Error', err.message, 'error');
                        })
                        .exportDiscrepancyReport(sheetId, dataToExport, format, this.discrepancyDashboard.filters.dateFrom, this.discrepancyDashboard.filters.dateTo);
                },





                renderUsers() {
                    const role = Alpine.store('app').user.role;

                    // สำหรับพนักงาน (Staff)
                    if (role === 'staff') {
                        return `
            <div class="space-y-6 max-w-md mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 dark:bg-indigo-900/30 p-4 rounded-xl">
                            <i class="fas fa-key text-4xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">${this.t('change_password')}</h2>
                            <p class="text-gray-600 dark:text-gray-400">เปลี่ยนรหัสผ่านของคุณ</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-4">
                    <div><label class="block text-sm font-medium">Current Password</label><input type="password" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="block text-sm font-medium">New Password</label><input type="password" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="block text-sm font-medium">Confirm Password</label><input type="password" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg">${this.t('save')}</button>
                </div>
            </div>
        `;
                    }

                    // สำหรับเจ้าของ (Owner)
                    return `
        <div x-show="showAddUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div @click.away="showAddUserModal = false" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-lg font-semibold p-4 border-b dark:border-gray-700">เพิ่มผู้ใช้ใหม่</h3>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <div><label class="block text-sm">ชื่อผู้ใช้</label><input type="text" x-model="newUser.username" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="block text-sm">รหัสผ่าน</label><input type="password" x-model="newUser.password" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="block text-sm">บทบาท</label>
                        <select x-model="newUser.role" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option value="accountant">Accountant</option><option value="manager">Manager</option><option value="staff">Staff</option></select>
                    </div>
                    <div><label class="block text-sm">สาขาที่ดูแล (เลือกได้หลายสาขา)</label>
                        <div class="mt-2 max-h-40 overflow-y-auto border rounded-lg p-2 dark:border-gray-600">
                            <template x-for="store in allStores">
                                <label class="flex items-center p-1"><input type="checkbox" :value="store.id" x-model="newUser.store_ids" class="mr-2 rounded"> <span x-text="store.name"></span></label>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2">
                    <button @click="showAddUserModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">ยกเลิก</button>
                    <button @click="saveUser(true)" class="px-4 py-2 bg-blue-500 text-white rounded-lg">บันทึก</button>
                </div>
            </div>
        </div>

        <div x-show="showEditUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div @click.away="showEditUserModal = false" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-lg font-semibold p-4 border-b dark:border-gray-700">แก้ไขผู้ใช้</h3>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <div><label class="block text-sm">ชื่อผู้ใช้</label><input type="text" x-model="editingUser.username" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label class="block text-sm">บทบาท</label>
                        <select x-model="editingUser.role" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option value="accountant">Accountant</option><option value="manager">Manager</option><option value="staff">Staff</option></select>
                    </div>
                    <div><label class="block text-sm">สาขาที่ดูแล (เลือกได้หลายสาขา)</label>
                        <div class="mt-2 max-h-40 overflow-y-auto border rounded-lg p-2 dark:border-gray-600">
                            <template x-for="store in allStores">
                                <label class="flex items-center p-1"><input type="checkbox" :value="store.id" x-model="editingUser.store_ids" class="mr-2 rounded"> <span x-text="store.name"></span></label>
                            </template>
                        </div>
                    </div>
                    <div><label class="block text-sm">สถานะ</label>
                        <select x-model="editingUser.active" class="w-full mt-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option :value="true">Active</option><option :value="false">Inactive</option></select>
                    </div>
                </div>
                <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-2">
                    <button @click="showEditUserModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">ยกเลิก</button>
                    <button @click="saveUser(false)" class="px-4 py-2 bg-blue-500 text-white rounded-lg">บันทึก</button>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 dark:bg-indigo-900/30 p-4 rounded-xl">
                            <i class="fas fa-users text-4xl text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">${this.t('users')}</h2>
                            <p class="text-gray-600 dark:text-gray-400">จัดการผู้ใช้งานและสิทธิ์การเข้าถึง</p>
                        </div>
                    </div>
                    <button @click="showAddUserModal = true" class="hidden md:block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-all font-semibold">
                        <i class="fas fa-user-plus mr-2"></i>${this.t('add_user')}
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center md:hidden">
                <div></div>
                <button @click="showAddUserModal = true" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 w-full">
                    <i class="fas fa-user-plus mr-2"></i>${this.t('add_user')}
                </button>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm min-w-[640px]">
                        <thead class="bg-gray-50 dark:bg-gray-700 whitespace-nowrap"><tr>
                            <th class="p-3 text-left">Username</th>
                            <th class="p-3 text-left">Role</th>
                            <th class="p-3 text-left">Assigned Stores</th>
                            <th class="p-3 text-center">Status</th>
                            <th class="p-3 text-center">Actions</th>
                        </tr></thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-if="!users || users.length === 0">
                                <tr><td colspan="5" class="text-center p-8 text-gray-500">ไม่มีข้อมูลผู้ใช้</td></tr>
                            </template>
                            <template x-for="user in users" :key="user.user_id">
                                <tr class="whitespace-nowrap">
                                    <td class="p-3" x-text="user.username"></td>
                                    <td class="p-3 capitalize" x-text="user.role"></td>
                                    <td class="p-3">
                                        <span x-text="user.store_ids.map(id => (allStores.find(s => s.id === id) || {}).name || id).join(', ')"></span>
                                    </td>
                                    <td class="p-3 text-center">
                                        <span class="px-2 py-1 text-xs rounded-full" :class="user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" x-text="user.active ? 'Active' : 'Inactive'"></span>
                                    </td>
                                    <td class="p-3 text-center">
                                        <button @click="openEditUserModal(user)" class="text-blue-600 hover:text-blue-800 p-2">แก้ไข</button>
                                        <button @click="confirmDeleteUser(user.user_id)" class="text-red-600 hover:text-red-800 p-2">ลบ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
                },






                renderStores() {
                    return `
        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="bg-pink-100 dark:bg-pink-900/30 p-4 rounded-xl">
                            <i class="fas fa-store text-4xl text-pink-600 dark:text-pink-400"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">${this.t('stores')}</h2>
                            <p class="text-gray-600 dark:text-gray-400">จัดการสาขาและข้อมูลร้านค้า</p>
                        </div>
                    </div>
                    <button @click="createStore()" class="hidden md:block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-all font-semibold">
                        <i class="fas fa-plus mr-2"></i>${this.t('create_store')}
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center md:hidden">
                <div></div>
                <button @click="createStore()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 w-full">
                    <i class="fas fa-plus mr-2"></i>${this.t('create_store')}
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <template x-for="store in $store.app.user.stores" :key="store.store_id">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg shadow-gray-200/50 dark:shadow-none p-6 flex flex-col hover:shadow-xl transition-shadow">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold" x-text="store.name"></h3>
                                <span class="px-2 py-1 text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 rounded-full">${this.t('active')}</span>
                            </div>
                            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                                <p><i class="fas fa-barcode mr-2 text-gray-400"></i><span class="font-mono" x-text="store.code"></span></p>
                                <p><i class="fas fa-user-shield mr-2 text-gray-400"></i>Owner: <span x-text="$store.app.user.username"></span></p>
                            </div>
                        </div>
                        <div class="mt-6 flex space-x-2">
                            <button @click="manageStore(store.store_id)" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">${this.t('manage')}</button>
                            <button @click="storeSettings(store.store_id)" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">${this.t('settings')}</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    `;
                },




                renderSettings() {
                    const isOwner = Alpine.store('app').user.role === 'owner';

                    return `
        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center space-x-4">
                    <div class="bg-gray-200 dark:bg-gray-700 p-4 rounded-xl">
                        <i class="fas fa-cog text-4xl text-gray-600 dark:text-gray-400"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">${this.t('settings')}</h2>
                        <p class="text-gray-600 dark:text-gray-400">ตั้งค่าระบบและการแจ้งเตือน</p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-green-600 flex items-center">
                    <i class="fas fa-store mr-2"></i>ตั้งค่าสาขา
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 pb-4 border-b dark:border-gray-700">
                    <div>
                        <label class="block text-sm font-medium mb-1">ชื่อสาขา</label>
                        <input type="text" x-model="settingsData.store_name"
                               class="w-full px-3 py-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600"
                               readonly disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">รหัสสาขา</label>
                        <input type="text" x-model="settingsData.store_code"
                               class="w-full px-3 py-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600"
                               readonly disabled>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Group Line ID (สำหรับพนักงาน)</label>
                        <input type="text" x-model="settingsData.group_line_id"
                               class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                               placeholder="กรอก Group Line ID ของสาขา">
                        <p class="text-xs text-gray-500 mt-1">ID ของกลุ่ม Line พนักงานที่ต้องการรับการแจ้งเตือนประจำวัน</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">เวลาแจ้งเตือนนับสต๊อกประจำวัน</label>
                        <input type="time" x-model="settingsData.notify_time_daily"
                               class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">วันที่ต้องการแจ้งเตือน</label>
                        <div class="grid grid-cols-7 gap-2">
                            <template x-data="{ days: [
                                {key: 'Mon', label: 'จ.'},
                                {key: 'Tue', label: 'อ.'},
                                {key: 'Wed', label: 'พ.'},
                                {key: 'Thu', label: 'พฤ.'},
                                {key: 'Fri', label: 'ศ.'},
                                {key: 'Sat', label: 'ส.'},
                                {key: 'Sun', label: 'อา.'}
                            ] }" x-for="day in days" :key="day.key">
                                <button
                                    type="button"
                                    @click="toggleNotifyDay(day.key)"
                                    :class="(settingsData.notify_days || '').split(',').includes(day.key) ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                    class="px-3 py-2 rounded-lg font-medium text-sm hover:opacity-80 transition-all">
                                    <span x-text="day.label"></span>
                                </button>
                            </template>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">เลือกวันที่ต้องการให้ระบบแจ้งเตือนนับสต๊อก (สามารถเลือกได้หลายวัน)</p>
                    </div>
                </div>

                <div class="mt-6">
                    <button @click="saveStoreSettings()"
                            class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50"
                            :disabled="!$store.app.user.currentStore">
                        <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่าสาขา
                    </button>
                    <span x-show="!$store.app.user.currentStore" class="text-red-500 text-sm ml-2">
                        กรุณาเลือกสาขาก่อน
                    </span>
                </div>
            </div>

            <!-- Multi-LINE OA Configuration Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" x-data="{
                lineOAConfig: {
                    line_token: '',
                    line_channel_secret: '',
                    staff_group_id: '',
                    bar_group_id: '',
                    central_group_id: ''
                }
            }" x-init="loadLineOAConfig()">
                <h3 class="text-lg font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fa-brands fa-line mr-2"></i>ตั้งค่า LINE Official Account
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    ตั้งค่า LINE OA สำหรับระบบฝากเหล้า (แยกต่างหากจากการตั้งค่าใบเสร็จ)
                </p>

                <div class="space-y-6">
                    <!-- LINE Access Token & Secret -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-green-600 flex items-center">
                            <i class="fas fa-key mr-2"></i>LINE API Credentials
                        </h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    LINE Channel Access Token <span class="text-red-500">*</span>
                                </label>
                                <input type="password" x-model="lineOAConfig.line_token"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 font-mono text-sm"
                                       placeholder="jvLHMLy/rv6AaKcyZUDl...">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ดูได้จาก LINE Developers Console → Messaging API tab
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">LINE Channel Secret</label>
                                <input type="password" x-model="lineOAConfig.line_channel_secret"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 font-mono text-sm"
                                       placeholder="a1b2c3d4e5f6g7h8i9j0...">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ดูได้จาก LINE Developers Console → Basic Settings tab
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- LINE Group IDs -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-purple-600 flex items-center">
                            <i class="fas fa-users mr-2"></i>LINE Group IDs สำหรับแจ้งเตือน
                        </h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    Staff Group ID
                                </label>
                                <input type="text" x-model="lineOAConfig.staff_group_id"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 font-mono text-sm"
                                       placeholder="C1234567890abcdef...">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Group สำหรับรับแจ้งเตือนคำขอฝากเหล้า (Staff รับเหล้า)
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    Bar Group ID
                                </label>
                                <input type="text" x-model="lineOAConfig.bar_group_id"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 font-mono text-sm"
                                       placeholder="C5678901234abcdef...">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Group สำหรับรับแจ้งเตือนคำขอเบิกเหล้า (Bar ยืนยันฝาก/เบิก)
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    Central Group ID <span class="text-gray-400">(Optional)</span>
                                </label>
                                <input type="text" x-model="lineOAConfig.central_group_id"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 font-mono text-sm"
                                       placeholder="C9012345678abcdef...">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Group สำหรับคลังกลาง (กรณีมีการโอนระหว่างสาขา)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Help Guide -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <h5 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2 flex items-center">
                            <i class="fas fa-question-circle mr-2"></i>วิธีหา Group ID
                        </h5>
                        <ol class="text-xs text-blue-600 dark:text-blue-400 space-y-1 ml-4 list-decimal">
                            <li>เพิ่ม LINE OA เข้า Group ที่ต้องการ</li>
                            <li>ส่งข้อความอะไรก็ได้ในกลุ่ม</li>
                            <li>ดู Webhook logs ใน Apps Script หรือใช้ LINE Group ID Finder</li>
                            <li>Copy Group ID (รูปแบบ: C1234567890abcdef...)</li>
                        </ol>
                        <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">
                            <i class="fas fa-book mr-1"></i>
                            อ่านคู่มือเพิ่มเติมใน <strong>LINE_OA_SETUP_GUIDE.md</strong>
                        </p>
                    </div>
                </div>

                <div class="mt-6">
                    <button @click="saveLineOAConfig()"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50"
                            :disabled="!$store.app.user.currentStore">
                        <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่า LINE OA
                    </button>
                    <span x-show="!$store.app.user.currentStore" class="text-red-500 text-sm ml-2">
                        กรุณาเลือกสาขาก่อน
                    </span>
                </div>
            </div>

            <!-- Store Receipt Configuration Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" x-data="{
                receiptConfig: {
                    line_id: '',
                    line_add_friend_url: '',
                    qr_code_image_url: '',
                    store_address: '',
                    store_phone: '',
                    receipt_logo_url: '',
                    receipt_header_text: 'ใบรับฝากเหล้า',
                    receipt_footer_line1: 'กรุณาเก็บใบรับนี้ไว้เป็นหลักฐาน',
                    receipt_footer_line2: 'แสดงใบรับหรือรหัสเมื่อต้องการเบิก'
                },
                isUploadingQR: false,
                isUploadingLogo: false
            }" x-init="loadReceiptConfig()">
                <h3 class="text-lg font-semibold mb-4 text-purple-600 flex items-center">
                    <i class="fas fa-receipt mr-2"></i>ตั้งค่าใบเสร็จรับฝากเหล้า
                </h3>

                <div class="space-y-6">
                    <!-- LINE OA Info Section -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-green-600 flex items-center">
                            <i class="fa-brands fa-line mr-2"></i>ข้อมูล LINE Official Account
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">LINE ID</label>
                                <input type="text" x-model="receiptConfig.line_id"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="@yourlineid">
                                <p class="text-xs text-gray-500 mt-1">เช่น @abc123</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">LINE Add Friend URL</label>
                                <input type="text" x-model="receiptConfig.line_add_friend_url"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="https://line.me/R/ti/p/@...">
                                <p class="text-xs text-gray-500 mt-1">URL สำหรับเพิ่มเพื่อน</p>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Section -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-blue-600 flex items-center">
                            <i class="fas fa-qrcode mr-2"></i>QR Code สำหรับเพิ่มเพื่อน LINE
                        </h4>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-shrink-0">
                                <div class="w-40 h-40 border-2 border-dashed rounded-lg flex items-center justify-center bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                    <template x-if="receiptConfig.qr_code_image_url">
                                        <img :src="receiptConfig.qr_code_image_url" alt="QR Code" class="w-full h-full object-contain p-2">
                                    </template>
                                    <template x-if="!receiptConfig.qr_code_image_url">
                                        <i class="fas fa-image text-4xl text-gray-400"></i>
                                    </template>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-2">อัปโหลด QR Code</label>
                                <input type="file" accept="image/*" id="qrCodeInput"
                                       @change="uploadQRCode($event)"
                                       class="hidden">
                                <div class="space-y-2">
                                    <button @click="$('#qrCodeInput').click()"
                                            :disabled="isUploadingQR"
                                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50 transition-colors">
                                        <i class="fas" :class="isUploadingQR ? 'fa-spinner fa-spin' : 'fa-upload'" class="mr-2"></i>
                                        <span x-text="isUploadingQR ? 'กำลังอัปโหลด...' : 'เลือกรูปภาพ'"></span>
                                    </button>
                                    <template x-if="receiptConfig.qr_code_image_url">
                                        <button @click="viewImage(receiptConfig.qr_code_image_url)"
                                                class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors ml-2">
                                            <i class="fas fa-eye mr-2"></i>ดูรูปเต็ม
                                        </button>
                                    </template>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">อัปโหลดรูป QR Code สำหรับให้ลูกค้า Add Friend LINE OA</p>
                            </div>
                        </div>
                    </div>

                    <!-- Store Info Section -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-orange-600 flex items-center">
                            <i class="fas fa-store mr-2"></i>ข้อมูลสาขา (สำหรับพิมพ์ใบเสร็จ)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">ที่อยู่สาขา</label>
                                <textarea x-model="receiptConfig.store_address"
                                          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                          rows="2"
                                          placeholder="123/45 ถนนสุขุมวิท แขวง/เขต จังหวัด 10110"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">เบอร์โทรศัพท์</label>
                                <input type="text" x-model="receiptConfig.store_phone"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="02-123-4567">
                            </div>
                        </div>
                    </div>

                    <!-- Logo Section -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-pink-600 flex items-center">
                            <i class="fas fa-image mr-2"></i>โลโก้ร้าน (ทางเลือก)
                        </h4>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-shrink-0">
                                <div class="w-40 h-40 border-2 border-dashed rounded-lg flex items-center justify-center bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                    <template x-if="receiptConfig.receipt_logo_url">
                                        <img :src="receiptConfig.receipt_logo_url" alt="Logo" class="w-full h-full object-contain p-2">
                                    </template>
                                    <template x-if="!receiptConfig.receipt_logo_url">
                                        <i class="fas fa-image text-4xl text-gray-400"></i>
                                    </template>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-2">อัปโหลดโลโก้</label>
                                <input type="file" accept="image/*" id="logoInput"
                                       @change="uploadLogo($event)"
                                       class="hidden">
                                <div class="space-y-2">
                                    <button @click="$('#logoInput').click()"
                                            :disabled="isUploadingLogo"
                                            class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 disabled:opacity-50 transition-colors">
                                        <i class="fas" :class="isUploadingLogo ? 'fa-spinner fa-spin' : 'fa-upload'" class="mr-2"></i>
                                        <span x-text="isUploadingLogo ? 'กำลังอัปโหลด...' : 'เลือกรูปภาพ'"></span>
                                    </button>
                                    <template x-if="receiptConfig.receipt_logo_url">
                                        <button @click="viewImage(receiptConfig.receipt_logo_url)"
                                                class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors ml-2">
                                            <i class="fas fa-eye mr-2"></i>ดูรูปเต็ม
                                        </button>
                                    </template>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">อัปโหลดโลโก้ร้านสำหรับแสดงบนใบเสร็จ (ไม่บังคับ)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Print Settings Section -->
                    <div class="p-4 border rounded-lg dark:border-gray-700">
                        <h4 class="text-md font-semibold mb-4 text-indigo-600 flex items-center">
                            <i class="fas fa-print mr-2"></i>ตั้งค่าการพิมพ์
                        </h4>

                        <!-- Receipt Text Settings -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">หัวข้อใบเสร็จ</label>
                                <input type="text" x-model="receiptConfig.receipt_header_text"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="ใบรับฝากเหล้า">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">ข้อความท้ายใบเสร็จ (บรรทัดที่ 1)</label>
                                <input type="text" x-model="receiptConfig.receipt_footer_line1"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="กรุณาเก็บใบรับนี้ไว้เป็นหลักฐาน">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">ข้อความท้ายใบเสร็จ (บรรทัดที่ 2)</label>
                                <input type="text" x-model="receiptConfig.receipt_footer_line2"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="แสดงใบรับหรือรหัสเมื่อต้องการเบิก">
                            </div>
                        </div>

                        <!-- Preview Buttons -->
                        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    กระดาษ 58mm • พิมพ์ 1 ใบ • ป้ายแปะตามจำนวนขวด
                                </p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="previewCustomerReceipt()"
                                        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors text-sm">
                                    <i class="fas fa-eye mr-1"></i>ดูตัวอย่างใบรับ
                                </button>
                                <button @click="previewBottleLabel()"
                                        class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors text-sm">
                                    <i class="fas fa-eye mr-1"></i>ดูตัวอย่างป้ายขวด
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="mt-6">
                    <button @click="saveReceiptConfig()"
                            class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50"
                            :disabled="!$store.app.user.currentStore">
                        <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่าใบเสร็จ
                    </button>
                    <span x-show="!$store.app.user.currentStore" class="text-red-500 text-sm ml-2">
                        กรุณาเลือกสาขาก่อน
                    </span>
                </div>
            </div>

            ${isOwner ? `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-6">

                <h3 class="text-lg font-semibold text-blue-600 flex items-center border-b dark:border-gray-700 pb-4">
                    <i class="fas fa-server mr-2"></i>ตั้งค่าระบบหลัก (Master Settings)
                </h3>

                <div class="p-4 border rounded-lg dark:border-gray-700">
                    <h4 class="text-md font-semibold mb-4 text-green-600 flex items-center">
                        <i class="fa-brands fa-line mr-2"></i>ตั้งค่าระบบ Line
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Line Access Token</label>
                            <input type="password"
                                   x-model="masterSettings.LINE_ACCESS_TOKEN"
                                   class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                   placeholder="กรอก Line Access Token สำหรับส่งแจ้งเตือน">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Owner Group Line ID</label>
                            <input type="text" x-model="masterSettings.OWNER_GROUP_LINE_ID"
                                   class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                   placeholder="กรอก ID กลุ่มไลน์ของเจ้าของร้าน">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">สำหรับรับการแจ้งเตือนสรุปและคำชี้แจงจากพนักงาน</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">ความถี่ในการแจ้งเตือนซ้ำ (ชั่วโมง)</label>
                            <select x-model="masterSettings.FOLLOW_UP_INTERVAL_HOURS" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                                <option value="0">ปิด</option>
                                <option value="1">ทุก 1 ชั่วโมง</option>
                                <option value="2">ทุก 2 ชั่วโมง</option>
                                <option value="3">ทุก 3 ชั่วโมง</option>
                                <option value="5">ทุก 5 ชั่วโมง</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button @click="saveMasterSettings()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่าระบบหลัก
                    </button>
                </div>
            </div>
            ` : ''}
        </div>
    `;
                },

                // --- START: Deposit System Render Functions ---
                renderDashboardDeposit() {
                    const dashboardData = Alpine.store('depositDashboard');
                    const data = dashboardData?.data || {};
                    const loading = dashboardData?.loading || false;
                    const storeName = dashboardData?.storeName || '';

                    if (loading) {
                        return `
        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center space-x-4">
                    <div class="bg-purple-100 dark:bg-purple-900 p-4 rounded-xl">
                        <i class="fas fa-chart-bar text-4xl text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">Dashboard ฝากเหล้า</h2>
                        <p class="text-gray-600 dark:text-gray-400">${storeName}</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-center py-20">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-6xl text-purple-500 mb-4"></i>
                    <p class="text-gray-600 dark:text-gray-400">กำลังโหลดข้อมูล...</p>
                </div>
            </div>
        </div>
    `;
                    }

                    return `
        <div class="space-y-4 md:space-y-6" x-data="depositDashboardData()">
            <!-- Header with Time Info -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-4 md:p-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-chart-bar text-purple-600 mr-2 md:mr-3"></i>
                            Dashboard ฝากเหล้า
                        </h1>
                        <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-1">
                            ${storeName} • อัพเดทล่าสุด: ${new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} น.
                        </p>
                    </div>
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <button @click="window.open('deposit.html', '_blank')"
                                class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white px-3 md:px-4 py-2 rounded-lg transition-all text-sm">
                            <i class="fas fa-plus-circle mr-1 sm:mr-2"></i>
                            <span class="hidden sm:inline">จัดการฝาก/เบิก</span>
                            <span class="sm:hidden">จัดการ</span>
                        </button>
                        <button @click="refreshDashboard()"
                                class="flex-1 sm:flex-none bg-purple-600 hover:bg-purple-700 text-white px-3 md:px-4 py-2 rounded-lg transition-all text-sm">
                            <i class="fas fa-sync-alt mr-1 sm:mr-2"></i>
                            <span>รีเฟรช</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Alerts Banner -->
            <div x-show="(data.expiringSoon > 0 || data.pendingWithdrawals > 0 || data.expired > 0 || data.readyToTransfer > 0)"
                 class="bg-gradient-to-r from-orange-100 via-amber-100 to-yellow-100 dark:from-orange-900/30 dark:via-amber-900/30 dark:to-yellow-900/30 rounded-xl shadow-lg p-4 md:p-5 border-2 border-orange-200 dark:border-orange-800">
                <div class="flex items-start space-x-3 md:space-x-4">
                    <div class="bg-orange-200 dark:bg-orange-800/50 p-2 md:p-3 rounded-lg flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-lg md:text-2xl text-orange-600 dark:text-orange-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-sm md:text-lg mb-2 text-orange-800 dark:text-orange-300">⚠️ แจ้งเตือนที่ต้องดำเนินการ</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 md:gap-3 text-xs md:text-sm">
                            <div x-show="data.expiringSoon > 0" class="bg-white dark:bg-gray-800/50 rounded-lg p-2 md:p-3 border border-orange-200 dark:border-orange-700">
                                <div class="font-bold text-lg md:text-2xl text-orange-700 dark:text-orange-400" x-text="data.expiringSoon || 0"></div>
                                <div class="text-gray-700 dark:text-gray-300">ใกล้หมดอายุภายใน 7 วัน</div>
                            </div>
                            <div x-show="data.pendingWithdrawals > 0" class="bg-white dark:bg-gray-800/50 rounded-lg p-2 md:p-3 border border-orange-200 dark:border-orange-700">
                                <div class="font-bold text-lg md:text-2xl text-orange-700 dark:text-orange-400" x-text="data.pendingWithdrawals || 0"></div>
                                <div class="text-gray-700 dark:text-gray-300">คำขอเบิกรออนุมัติ</div>
                            </div>
                            <div x-show="data.expired > 0" class="bg-white dark:bg-gray-800/50 rounded-lg p-2 md:p-3 border border-red-200 dark:border-red-700">
                                <div class="font-bold text-lg md:text-2xl text-red-700 dark:text-red-400" x-text="data.expired || 0"></div>
                                <div class="text-gray-700 dark:text-gray-300">หมดอายุแล้ว</div>
                            </div>
                            <div x-show="data.readyToTransfer > 0" class="bg-white dark:bg-gray-800/50 rounded-lg p-2 md:p-3 border border-green-200 dark:border-green-700">
                                <div class="font-bold text-lg md:text-2xl text-green-700 dark:text-green-400" x-text="data.readyToTransfer || 0"></div>
                                <div class="text-gray-700 dark:text-gray-300">พร้อมโอนคลังกลาง</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats with Sub-info -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                <!-- Total Deposits -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-5 hover:shadow-xl transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="bg-blue-100 dark:bg-blue-900 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-wine-bottle text-xl md:text-2xl text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">${data.totalDeposits || 0}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">ขวด</div>
                        </div>
                    </div>
                    <h4 class="font-semibold text-sm md:text-base text-gray-900 dark:text-white mb-2">ฝากทั้งหมด</h4>
                    <div class="text-xs text-blue-600 dark:text-blue-400 font-medium">
                        <i class="fas fa-info-circle mr-1"></i>รายการทั้งหมดในระบบ
                    </div>
                </div>

                <!-- In Store -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-5 hover:shadow-xl transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="bg-green-100 dark:bg-green-900 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-store text-xl md:text-2xl text-green-600 dark:text-green-400"></i>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">${data.inStore || 0}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">ขวด</div>
                        </div>
                    </div>
                    <h4 class="font-semibold text-sm md:text-base text-gray-900 dark:text-white mb-2">ในร้าน</h4>
                    <div class="space-y-1 text-xs text-gray-600 dark:text-gray-400">
                        <div class="flex justify-between">
                            <span>ใกล้หมดอายุ</span>
                            <span class="font-medium text-orange-600" x-text="(data.expiringSoon || 0) + ' ขวด'"></span>
                        </div>
                    </div>
                </div>

                <!-- Withdrawn -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-5 hover:shadow-xl transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="bg-purple-100 dark:bg-purple-900 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-box-open text-xl md:text-2xl text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">${data.withdrawn || 0}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">ขวด</div>
                        </div>
                    </div>
                    <h4 class="font-semibold text-sm md:text-base text-gray-900 dark:text-white mb-2">เบิกแล้ว</h4>
                    <div class="text-xs text-purple-600 dark:text-purple-400 font-medium">
                        <i class="fas fa-check-circle mr-1"></i>เบิกเสร็จสมบูรณ์
                    </div>
                </div>

                <!-- Problems -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-5 hover:shadow-xl transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="bg-orange-100 dark:bg-orange-900 p-2 md:p-3 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-xl md:text-2xl text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl md:text-3xl font-bold text-orange-600">${(data.expired || 0) + (data.transferred || 0)}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">รายการ</div>
                        </div>
                    </div>
                    <h4 class="font-semibold text-sm md:text-base text-gray-900 dark:text-white mb-2">ปัญหา</h4>
                    <div class="space-y-1 text-xs text-gray-600 dark:text-gray-400">
                        <div class="flex justify-between">
                            <span>หมดอายุ</span>
                            <span class="font-medium text-red-600" x-text="(data.expired || 0) + ' ขวด'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>คลังกลาง</span>
                            <span class="font-medium text-gray-600" x-text="(data.transferred || 0) + ' ขวด'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Period Selector Tabs -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                <div class="flex items-center justify-between flex-wrap gap-2">
                    <h3 class="text-base md:text-lg font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>ดูข้อมูลตามช่วงเวลา
                    </h3>
                    <div class="flex space-x-1 text-xs">
                        <button @click="$store.depositDashboard.selectedPeriod = 'daily'"
                                :class="$store.depositDashboard.selectedPeriod === 'daily' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="px-3 md:px-4 py-2 rounded-lg font-medium transition-colors">
                            รายวัน
                        </button>
                        <button @click="$store.depositDashboard.selectedPeriod = 'weekly'"
                                :class="$store.depositDashboard.selectedPeriod === 'weekly' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="px-3 md:px-4 py-2 rounded-lg font-medium transition-colors">
                            รายสัปดาห์
                        </button>
                        <button @click="$store.depositDashboard.selectedPeriod = 'monthly'"
                                :class="$store.depositDashboard.selectedPeriod === 'monthly' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                class="px-3 md:px-4 py-2 rounded-lg font-medium transition-colors">
                            รายเดือน
                        </button>
                    </div>
                </div>
            </div>

            <!-- Deposits Section -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-base md:text-lg font-bold text-blue-600 dark:text-blue-400">
                        <i class="fas fa-arrow-down mr-2"></i>ฝากเข้า
                        <span class="text-sm font-normal text-gray-500 ml-2" x-text="$store.depositDashboard.selectedPeriod === 'daily' ? '(วันนี้)' : ($store.depositDashboard.selectedPeriod === 'weekly' ? '(สัปดาห์นี้)' : '(เดือนนี้)')"></span>
                    </h3>
                    <div class="text-right">
                        <div class="text-2xl md:text-3xl font-bold text-blue-600" x-text="(data.periodDeposits || 0) + ' ขวด'"></div>
                    </div>
                </div>

                <!-- Deposits by Category -->
                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">แยกตามหมวดหมู่</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2" x-show="data.depositsByCategory && Object.keys(data.depositsByCategory).length > 0">
                        <template x-for="(count, category) in (data.depositsByCategory || {})" :key="category">
                            <div class="bg-white dark:bg-gray-800 p-2 rounded text-center">
                                <div class="text-lg font-bold text-blue-600" x-text="count"></div>
                                <div class="text-xs text-gray-500 truncate" x-text="category"></div>
                            </div>
                        </template>
                    </div>
                    <div x-show="!data.depositsByCategory || Object.keys(data.depositsByCategory || {}).length === 0" class="text-sm text-gray-500 text-center py-2">
                        ไม่มีข้อมูล
                    </div>
                </div>

                <!-- Deposits List -->
                <div x-data="{ showAllDeposits: false }">
                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">รายการฝากล่าสุด</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto" x-show="(data.recentDeposits || []).length > 0">
                        <template x-for="(item, index) in (showAllDeposits ? (data.recentDeposits || []) : (data.recentDeposits || []).slice(0, 5))" :key="item.id || index">
                            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-sm">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900 dark:text-white truncate" x-text="item.customer"></div>
                                    <div class="text-xs text-gray-500" x-text="item.product + ' • ' + item.category"></div>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="font-bold text-blue-600" x-text="item.quantity + ' ขวด'"></div>
                                    <div class="text-xs text-gray-500" x-text="item.date"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="(data.recentDeposits || []).length === 0" class="text-sm text-gray-500 text-center py-4">
                        ไม่มีรายการฝากในช่วงนี้
                    </div>
                    <button x-show="(data.recentDeposits || []).length > 5"
                            @click="showAllDeposits = !showAllDeposits"
                            class="w-full mt-2 text-blue-600 dark:text-blue-400 text-sm hover:underline">
                        <span x-show="!showAllDeposits">แสดงทั้งหมด (<span x-text="(data.recentDeposits || []).length"></span> รายการ)</span>
                        <span x-show="showAllDeposits">ซ่อน</span>
                    </button>
                </div>
            </div>

            <!-- Withdrawals Section -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-base md:text-lg font-bold text-purple-600 dark:text-purple-400">
                        <i class="fas fa-arrow-up mr-2"></i>เบิกออก
                        <span class="text-sm font-normal text-gray-500 ml-2" x-text="$store.depositDashboard.selectedPeriod === 'daily' ? '(วันนี้)' : ($store.depositDashboard.selectedPeriod === 'weekly' ? '(สัปดาห์นี้)' : '(เดือนนี้)')"></span>
                    </h3>
                    <div class="text-right">
                        <div class="text-2xl md:text-3xl font-bold text-purple-600" x-text="(data.periodWithdrawals || 0) + ' ขวด'"></div>
                    </div>
                </div>

                <!-- Withdrawals List -->
                <div x-data="{ showAllWithdrawals: false }">
                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">รายการเบิกล่าสุด</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto" x-show="(data.recentWithdrawals || []).length > 0">
                        <template x-for="(item, index) in (showAllWithdrawals ? (data.recentWithdrawals || []) : (data.recentWithdrawals || []).slice(0, 5))" :key="item.id || index">
                            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-sm">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900 dark:text-white truncate" x-text="item.customer"></div>
                                    <div class="text-xs text-gray-500" x-text="item.product + ' • ' + item.code"></div>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="font-bold text-purple-600" x-text="item.quantity + ' ขวด'"></div>
                                    <div class="text-xs text-gray-500" x-text="item.date"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="(data.recentWithdrawals || []).length === 0" class="text-sm text-gray-500 text-center py-4">
                        ไม่มีรายการเบิกในช่วงนี้
                    </div>
                    <button x-show="(data.recentWithdrawals || []).length > 5"
                            @click="showAllWithdrawals = !showAllWithdrawals"
                            class="w-full mt-2 text-purple-600 dark:text-purple-400 text-sm hover:underline">
                        <span x-show="!showAllWithdrawals">แสดงทั้งหมด (<span x-text="(data.recentWithdrawals || []).length"></span> รายการ)</span>
                        <span x-show="showAllWithdrawals">ซ่อน</span>
                    </button>
                </div>
            </div>

            <!-- Expiring Soon Table (≤ 7 days) -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6" x-show="($store.depositDashboard.data.expiringSoonList || []).length > 0">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
                    <h3 class="text-base md:text-lg font-bold text-orange-600 dark:text-orange-400">
                        <i class="fas fa-exclamation-triangle mr-2"></i>ใกล้หมดอายุ (≤ 7 วัน) - ต้องดำเนินการด่วน
                    </h3>
                </div>

                <!-- Desktop: Table View -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-orange-50 dark:bg-orange-900/20 border-b-2 border-orange-200 dark:border-orange-800">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold">รหัส</th>
                                <th class="px-4 py-3 text-left font-semibold">ลูกค้า</th>
                                <th class="px-4 py-3 text-left font-semibold">สินค้า</th>
                                <th class="px-4 py-3 text-center font-semibold">จำนวน</th>
                                <th class="px-4 py-3 text-left font-semibold">หมดอายุ</th>
                                <th class="px-4 py-3 text-center font-semibold">เหลือ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-for="item in ($store.depositDashboard.data.expiringSoonList || [])" :key="item.id">
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <td class="px-4 py-3 font-mono text-xs" x-text="item.code"></td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium" x-text="item.customer"></div>
                                        <div class="text-xs text-gray-500" x-text="item.phone"></div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium" x-text="item.product"></div>
                                        <div class="text-xs text-gray-500" x-text="item.category"></div>
                                    </td>
                                    <td class="px-4 py-3 text-center font-semibold" x-text="item.quantity"></td>
                                    <td class="px-4 py-3 text-xs" x-text="item.expiryDate"></td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs font-bold"
                                              :class="{
                                                  'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300': item.daysRemaining <= 3,
                                                  'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300': item.daysRemaining > 3 && item.daysRemaining <= 7
                                              }"
                                              x-text="item.daysRemaining + ' วัน'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile: Card View -->
                <div class="md:hidden space-y-3">
                    <template x-for="item in ($store.depositDashboard.data.expiringSoonList || [])" :key="item.id">
                        <div class="bg-orange-50 dark:bg-orange-900/10 border border-orange-200 dark:border-orange-800 rounded-lg p-3">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-sm text-gray-900 dark:text-white truncate" x-text="item.product"></div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400" x-text="item.category"></div>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-bold flex-shrink-0 ml-2"
                                      :class="{
                                          'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300': item.daysRemaining <= 3,
                                          'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300': item.daysRemaining > 3 && item.daysRemaining <= 7
                                      }"
                                      x-text="item.daysRemaining + ' วัน'"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-gray-500">ลูกค้า:</span>
                                    <span class="font-medium text-gray-900 dark:text-white" x-text="item.customer"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">จำนวน:</span>
                                    <span class="font-semibold text-gray-900 dark:text-white" x-text="item.quantity + ' ขวด'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Expired List Table (> 30 days) -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6" x-show="($store.depositDashboard.data.expiredList || []).length > 0">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
                    <h3 class="text-base md:text-lg font-bold text-red-600 dark:text-red-400">
                        <i class="fas fa-exclamation-circle mr-2"></i>รายการหมดอายุ (> 30 วัน)
                    </h3>
                </div>

                <!-- Desktop: Table View -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-red-50 dark:bg-red-900/20 border-b-2 border-red-200 dark:border-red-800">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold">รหัส</th>
                                <th class="px-4 py-3 text-left font-semibold">ลูกค้า</th>
                                <th class="px-4 py-3 text-left font-semibold">สินค้า</th>
                                <th class="px-4 py-3 text-center font-semibold">จำนวน</th>
                                <th class="px-4 py-3 text-center font-semibold">เกินมา</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-for="item in ($store.depositDashboard.data.expiredList || []).slice(0, 5)" :key="item.id">
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <td class="px-4 py-3 font-mono text-xs" x-text="item.code"></td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium" x-text="item.customer"></div>
                                        <div class="text-xs text-gray-500" x-text="item.phone"></div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium" x-text="item.product"></div>
                                        <div class="text-xs text-gray-500" x-text="item.category"></div>
                                    </td>
                                    <td class="px-4 py-3 text-center font-semibold" x-text="item.quantity"></td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 px-2 py-1 rounded-full text-xs font-bold" x-text="'+' + item.daysExpired + ' วัน'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile: Card View -->
                <div class="md:hidden space-y-3">
                    <template x-for="item in ($store.depositDashboard.data.expiredList || []).slice(0, 5)" :key="item.id">
                        <div class="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded-lg p-3">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-sm text-gray-900 dark:text-white truncate" x-text="item.product"></div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400" x-text="item.category"></div>
                                </div>
                                <span class="bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 px-2 py-1 rounded-full text-xs font-bold flex-shrink-0 ml-2" x-text="'+' + item.daysExpired + ' วัน'"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-gray-500">ลูกค้า:</span>
                                    <span class="font-medium text-gray-900 dark:text-white" x-text="item.customer"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">จำนวน:</span>
                                    <span class="font-semibold text-gray-900 dark:text-white" x-text="item.quantity + ' ขวด'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Transferred to Central Section -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-base md:text-lg font-bold text-gray-600 dark:text-gray-400">
                        <i class="fas fa-truck mr-2"></i>โอนคลังกลาง
                    </h3>
                    <div class="text-right">
                        <div class="text-2xl md:text-3xl font-bold text-gray-600" x-text="(data.transferred || 0) + ' ขวด'"></div>
                    </div>
                </div>

                <!-- Transferred List -->
                <div x-data="{ showAllTransferred: false }">
                    <div class="space-y-2 max-h-64 overflow-y-auto" x-show="(data.transferredList || []).length > 0">
                        <template x-for="(item, index) in (showAllTransferred ? (data.transferredList || []) : (data.transferredList || []).slice(0, 5))" :key="item.id || index">
                            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-sm">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900 dark:text-white truncate" x-text="item.customer"></div>
                                    <div class="text-xs text-gray-500" x-text="item.product + ' • ' + item.code"></div>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="font-bold text-gray-600" x-text="item.quantity + ' ขวด'"></div>
                                    <div class="text-xs text-gray-500" x-text="item.date"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="(data.transferredList || []).length === 0" class="text-sm text-gray-500 text-center py-4">
                        ไม่มีรายการโอนคลังกลาง
                    </div>
                    <button x-show="(data.transferredList || []).length > 5"
                            @click="showAllTransferred = !showAllTransferred"
                            class="w-full mt-2 text-gray-600 dark:text-gray-400 text-sm hover:underline">
                        <span x-show="!showAllTransferred">แสดงทั้งหมด (<span x-text="(data.transferredList || []).length"></span> รายการ)</span>
                        <span x-show="showAllTransferred">ซ่อน</span>
                    </button>
                </div>
            </div>
        </div>
    `;
                },

                renderDepositHistory() {
                    return `
        <div x-data="depositHistoryData()" class="space-y-4 md:space-y-6">
            <!-- Mobile: Compact Header with Search -->
            <div class="md:hidden bg-white dark:bg-gray-800 rounded-xl glow-border p-4">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-blue-100 dark:bg-blue-900 p-2 rounded-lg">
                        <i class="fas fa-search text-xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">ค้นหาประวัติ</h2>
                </div>
                <div class="relative">
                    <input type="text" x-model="searchQuery"
                           placeholder="ค้นหาชื่อ, เบอร์โทร, รหัส..."
                           class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                </div>
            </div>

            <!-- Desktop: Original Header -->
            <div class="hidden md:block bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center space-x-4">
                    <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-xl">
                        <i class="fas fa-search text-4xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">ค้นหาประวัติ</h2>
                    </div>
                </div>
            </div>

            <!-- Desktop: Search Section -->
            <div class="hidden md:block bg-white dark:bg-gray-800 rounded-2xl glow-border p-6">
                <div class="relative">
                    <input type="text" x-model="searchQuery"
                           placeholder="ค้นหาชื่อ, เบอร์โทร, รหัส..."
                           class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="bg-white dark:bg-gray-800 rounded-lg shadow p-12 text-center">
                <i class="fas fa-spinner fa-spin text-6xl text-blue-500 mb-4"></i>
                <p class="text-lg text-gray-600 dark:text-gray-400">กำลังโหลดข้อมูล...</p>
            </div>

            <!-- Filters and Tabs -->
            <div x-show="!loading" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <div class="flex items-center gap-2 overflow-x-auto pb-2 -mb-2">
                    <button @click="filterStatus = 'all'"
                            :class="filterStatus === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="px-3 md:px-4 py-2 rounded-lg font-medium transition whitespace-nowrap text-sm md:text-base flex-shrink-0">
                        ทั้งหมด
                    </button>
                    <button @click="filterStatus = 'in_store'"
                            :class="filterStatus === 'in_store' ? 'bg-green-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="px-3 md:px-4 py-2 rounded-lg font-medium transition whitespace-nowrap text-sm md:text-base flex-shrink-0">
                        <i class="fas fa-box md:mr-2"></i>
                        <span class="hidden sm:inline">ในร้าน</span>
                    </button>
                    <button @click="filterStatus = 'withdrawn'"
                            :class="filterStatus === 'withdrawn' ? 'bg-orange-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="px-3 md:px-4 py-2 rounded-lg font-medium transition whitespace-nowrap text-sm md:text-base flex-shrink-0">
                        <i class="fas fa-wine-bottle md:mr-2"></i>
                        <span class="hidden sm:inline">เบิกแล้ว</span>
                    </button>
                    <button @click="filterStatus = 'expired'"
                            :class="filterStatus === 'expired' ? 'bg-red-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="px-3 md:px-4 py-2 rounded-lg font-medium transition whitespace-nowrap text-sm md:text-base flex-shrink-0">
                        <i class="fas fa-exclamation-triangle md:mr-2"></i>
                        <span class="hidden sm:inline">หมดอายุ</span>
                    </button>
                    <button @click="filterStatus = 'transferred'"
                            :class="filterStatus === 'transferred' ? 'bg-purple-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="px-3 md:px-4 py-2 rounded-lg font-medium transition whitespace-nowrap text-sm md:text-base flex-shrink-0">
                        <i class="fas fa-exchange-alt md:mr-2"></i>
                        <span class="hidden sm:inline">โอนคลังกลาง</span>
                    </button>
                </div>
            </div>

            <!-- Deposits List -->
            <div x-show="!loading" class="space-y-4">
                <template x-for="deposit in filteredDeposits" :key="deposit.id">
                    <div x-data="{ expanded: false }" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition">
                        <div class="p-4 md:p-5">
                            <!-- Desktop Layout (md and up) -->
                            <div class="hidden md:block">
                                <!-- Header with Badge, Code and Percent -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <!-- Status Badge -->
                                        <span :class="{
                                            'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300': deposit.status === 'in_store',
                                            'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300': deposit.status === 'withdrawn' || deposit.status === 'fully_withdrawn',
                                            'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300': deposit.status === 'expired',
                                            'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300': deposit.status === 'transferred'
                                        }" class="px-2 py-1 rounded-full text-xs font-semibold whitespace-nowrap">
                                            <span x-show="deposit.status === 'in_store'">ในร้าน</span>
                                            <span x-show="deposit.status === 'withdrawn' || deposit.status === 'fully_withdrawn'">เบิกแล้ว</span>
                                            <span x-show="deposit.status === 'expired'">หมดอายุ</span>
                                            <span x-show="deposit.status === 'transferred'">โอนคลังกลาง</span>
                                        </span>
                                        <span class="text-lg font-bold text-gray-900 dark:text-white" x-text="deposit.code"></span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-2xl font-bold" :class="{
                                            'text-green-600': deposit.remaining_percent >= 50,
                                            'text-yellow-600': deposit.remaining_percent >= 20 && deposit.remaining_percent < 50,
                                            'text-red-600': deposit.remaining_percent < 20
                                        }" x-text="deposit.remaining_percent + '%'"></span>
                                        <span class="text-xs text-gray-500 ml-1">เหลือ</span>
                                    </div>
                                </div>

                                <!-- Info Grid - Desktop -->
                                <div class="grid grid-cols-5 gap-4 text-sm">
                                    <div>
                                        <div class="text-gray-500 dark:text-gray-400 text-xs">ลูกค้า</div>
                                        <div class="font-semibold text-gray-900 dark:text-white" x-text="deposit.customer_name"></div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 dark:text-gray-400 text-xs">สินค้า</div>
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="deposit.product_name"></div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 dark:text-gray-400 text-xs">จำนวน</div>
                                        <div class="font-medium text-gray-900 dark:text-white">
                                            <span x-text="deposit.remaining_qty"></span> / <span x-text="deposit.quantity"></span> ขวด
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 dark:text-gray-400 text-xs">วันฝาก</div>
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="formatThaiDate(deposit.deposit_date)"></div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500 dark:text-gray-400 text-xs">หมดอายุ</div>
                                        <div class="font-medium text-gray-900 dark:text-white">
                                            <span x-text="formatThaiDate(deposit.expiry_date)"></span>
                                            <template x-if="deposit.status === 'in_store'">
                                                <span :class="getDaysRemainingColor(getDaysRemaining(deposit.deposit_date))"
                                                      class="ml-1 font-bold text-xs"
                                                      x-text="getDaysRemainingText(deposit.deposit_date)"></span>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Date Row (for non in_store) -->
                                <div x-show="deposit.status !== 'in_store' && deposit.status_date" class="mt-2 text-xs text-gray-500">
                                    <span x-show="deposit.status === 'withdrawn' || deposit.status === 'fully_withdrawn'">วันที่เบิก: </span>
                                    <span x-show="deposit.status === 'expired'">วันที่หมดอายุ: </span>
                                    <span x-show="deposit.status === 'transferred'">วันที่โอน: </span>
                                    <span class="font-medium" x-text="formatThaiDate(deposit.status_date)"></span>
                                </div>

                                <!-- Expand Button -->
                                <button @click="expanded = !expanded" class="w-full mt-3 text-blue-600 dark:text-blue-400 text-xs flex items-center justify-center hover:underline">
                                    <span x-show="!expanded">แสดงเพิ่มเติม</span>
                                    <span x-show="expanded">ซ่อน</span>
                                    <i class="fas ml-1" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </button>
                            </div>

                            <!-- Mobile Layout -->
                            <div class="md:hidden">
                                <!-- Header with Badge -->
                                <div class="flex items-center justify-between mb-2 cursor-pointer" @click="expanded = !expanded">
                                    <div class="flex items-center gap-2 min-w-0">
                                        <!-- Status Badge -->
                                        <span :class="{
                                            'bg-green-100 text-green-800': deposit.status === 'in_store',
                                            'bg-orange-100 text-orange-800': deposit.status === 'withdrawn' || deposit.status === 'fully_withdrawn',
                                            'bg-red-100 text-red-800': deposit.status === 'expired',
                                            'bg-purple-100 text-purple-800': deposit.status === 'transferred'
                                        }" class="px-2 py-0.5 rounded-full text-xs font-semibold whitespace-nowrap flex-shrink-0">
                                            <span x-show="deposit.status === 'in_store'">ในร้าน</span>
                                            <span x-show="deposit.status === 'withdrawn' || deposit.status === 'fully_withdrawn'">เบิกแล้ว</span>
                                            <span x-show="deposit.status === 'expired'">หมดอายุ</span>
                                            <span x-show="deposit.status === 'transferred'">โอนคลังกลาง</span>
                                        </span>
                                        <span class="font-bold text-gray-900 dark:text-white truncate" x-text="deposit.code"></span>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-2">
                                        <div class="text-xl font-bold" :class="{
                                            'text-green-600': deposit.remaining_percent >= 50,
                                            'text-yellow-600': deposit.remaining_percent >= 20 && deposit.remaining_percent < 50,
                                            'text-red-600': deposit.remaining_percent < 20
                                        }" x-text="deposit.remaining_percent + '%'"></div>
                                        <div class="text-xs text-gray-500">เหลือ</div>
                                    </div>
                                </div>

                                <!-- Compact Info -->
                                <div class="space-y-2 text-sm cursor-pointer" @click="expanded = !expanded">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">ลูกค้า</span>
                                        <span class="font-semibold text-gray-900 dark:text-white" x-text="deposit.customer_name"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">สินค้า</span>
                                        <span class="font-medium text-gray-900 dark:text-white" x-text="deposit.product_name"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">จำนวน</span>
                                        <span class="font-medium"><span x-text="deposit.remaining_qty"></span>/<span x-text="deposit.quantity"></span> ขวด</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500">หมดอายุ</span>
                                        <span class="font-medium">
                                            <span x-text="formatThaiDate(deposit.expiry_date)"></span>
                                            <template x-if="deposit.status === 'in_store'">
                                                <span :class="getDaysRemainingColor(getDaysRemaining(deposit.deposit_date))"
                                                      class="ml-1 font-bold text-xs"
                                                      x-text="getDaysRemainingText(deposit.deposit_date)"></span>
                                            </template>
                                        </span>
                                    </div>
                                    <!-- Status Date (mobile) -->
                                    <div x-show="deposit.status !== 'in_store' && deposit.status_date" class="flex justify-between">
                                        <span class="text-gray-500">
                                            <span x-show="deposit.status === 'withdrawn' || deposit.status === 'fully_withdrawn'">วันที่เบิก</span>
                                            <span x-show="deposit.status === 'expired'">วันที่หมดอายุ</span>
                                            <span x-show="deposit.status === 'transferred'">วันที่โอน</span>
                                        </span>
                                        <span class="font-medium" x-text="formatThaiDate(deposit.status_date)"></span>
                                    </div>
                                </div>

                                <button @click="expanded = !expanded" class="w-full mt-3 text-blue-600 dark:text-blue-400 text-xs flex items-center justify-center">
                                    <span x-show="!expanded">แสดงเพิ่มเติม</span>
                                    <span x-show="expanded">ซ่อน</span>
                                    <i class="fas ml-1" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </button>
                            </div>

                            <!-- Expanded Content (shared) -->
                            <div x-show="expanded" x-collapse class="space-y-3 text-sm border-t dark:border-gray-700 pt-4 mt-3">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                    <div class="p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                        <div class="text-gray-500 mb-1">เบอร์โทร</div>
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="deposit.customer_phone || '-'"></div>
                                    </div>
                                    <div class="p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                        <div class="text-gray-500 mb-1">วันฝาก</div>
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="formatThaiDate(deposit.deposit_date)"></div>
                                    </div>
                                    <div class="p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                        <div class="text-gray-500 mb-1">ประเภท</div>
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="deposit.category || '-'"></div>
                                    </div>
                                    <div x-show="deposit.table_number" class="p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                                        <div class="text-gray-500 mb-1">โต๊ะ</div>
                                        <div class="font-medium text-gray-900 dark:text-white" x-text="deposit.table_number"></div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div x-show="deposit.notes" class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-xs">
                                    <div class="text-gray-600 mb-1">หมายเหตุ</div>
                                    <div class="text-gray-900 dark:text-white" x-text="deposit.notes"></div>
                                </div>

                                <!-- Photo Button -->
                                <div x-show="deposit.photo_url" class="flex justify-center">
                                    <button @click="window.open(deposit.photo_url, '_blank')"
                                            class="px-4 py-2 bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 rounded-lg flex items-center">
                                        <i class="fas fa-image text-blue-600 mr-2"></i>
                                        <span class="text-blue-600 text-sm">ดูรูปภาพ</span>
                                    </button>
                                </div>

                                <!-- Withdrawal History -->
                                <div x-show="deposit.withdrawals && deposit.withdrawals.length > 0" class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                                    <div class="flex items-center text-orange-700 dark:text-orange-300 font-semibold mb-2 text-xs">
                                        <i class="fas fa-history mr-2"></i>ประวัติการเบิก (<span x-text="deposit.withdrawals.length"></span> ครั้ง)
                                    </div>
                                    <div class="space-y-2 max-h-32 overflow-y-auto">
                                        <template x-for="(withdrawal, index) in deposit.withdrawals" :key="index">
                                            <div class="text-xs bg-white dark:bg-gray-800 p-2 rounded border-l-2 border-orange-500">
                                                <div class="flex justify-between mb-1">
                                                    <span class="font-semibold text-orange-700">ครั้งที่ <span x-text="index + 1"></span></span>
                                                    <span class="text-gray-600" x-text="formatThaiDate(withdrawal.date)"></span>
                                                </div>
                                                <div class="text-gray-700">จำนวน: <span class="font-semibold" x-text="withdrawal.quantity"></span> ขวด</div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <div x-show="filteredDeposits.length === 0" class="bg-white dark:bg-gray-800 rounded-lg shadow p-12 text-center">
                    <i class="fas fa-inbox text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <p class="text-lg text-gray-500 dark:text-gray-400">ไม่พบข้อมูล</p>
                </div>
            </div>
        </div>
    `;
                },

                renderCentralTransfer() {
                    const isCentral = Alpine.store('app').user.isCentralStore;
                    if (isCentral) {
                        return this.renderHQTransferPage();
                    } else {
                        return this.renderBranchTransferPage();
                    }
                },

                // หน้าสำหรับสาขาปกติ - แสดงรายการหมดอายุพร้อมโอน
                renderBranchTransferPage() {
                    return `
        <div class="space-y-6" x-data="branchTransferData()" x-init="init()">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 dark:bg-green-900 p-4 rounded-xl">
                            <i class="fas fa-truck text-4xl text-green-600 dark:text-green-400"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">โอนคลังกลาง</h2>
                            <p class="text-gray-600 dark:text-gray-400">รายการฝากที่หมดอายุ พร้อมส่งโอนไปคลังกลาง</p>
                        </div>
                    </div>
                    <button x-show="selectedCount > 0" @click="openTransferModal()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                        <i class="fas fa-paper-plane"></i>
                        <span>ส่งโอน (<span x-text="selectedCount"></span> รายการ)</span>
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-3 gap-4">
                <div @click="switchTab('expired')" class="bg-white dark:bg-gray-800 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all" :class="activeTab === 'expired' ? 'ring-2 ring-red-500' : ''">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">หมดอายุ</p>
                            <p class="text-2xl font-bold text-red-600" x-text="summary.expired || 0"></p>
                        </div>
                        <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                            <i class="fas fa-clock text-red-500"></i>
                        </div>
                    </div>
                </div>
                <div @click="switchTab('pending')" class="bg-white dark:bg-gray-800 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all" :class="activeTab === 'pending' ? 'ring-2 ring-yellow-500' : ''">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">รอคลังรับ</p>
                            <p class="text-2xl font-bold text-yellow-600" x-text="summary.pending || 0"></p>
                        </div>
                        <div class="bg-yellow-100 dark:bg-yellow-900/30 p-3 rounded-full">
                            <i class="fas fa-hourglass-half text-yellow-500"></i>
                        </div>
                    </div>
                </div>
                <div @click="switchTab('confirmed')" class="bg-white dark:bg-gray-800 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all" :class="activeTab === 'confirmed' ? 'ring-2 ring-green-500' : ''">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">รับแล้ว</p>
                            <p class="text-2xl font-bold text-green-600" x-text="summary.confirmed || 0"></p>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                            <i class="fas fa-check-circle text-green-500"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <template x-if="loading">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                        <p class="mt-2 text-gray-600">กำลังโหลดข้อมูล...</p>
                    </div>
                </template>
                <template x-if="!loading && currentList.length === 0">
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-500">ไม่มีรายการ</h3>
                    </div>
                </template>
                <template x-if="!loading && currentList.length > 0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th x-show="activeTab === 'expired'" class="px-3 py-2 text-center w-10">
                                        <input type="checkbox" @click="selectAll()" :checked="selectedItems.length === currentList.length && currentList.length > 0" class="w-4 h-4">
                                    </th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 whitespace-nowrap">รหัส</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 whitespace-nowrap">ลูกค้า</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 whitespace-nowrap">รายการ</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 whitespace-nowrap">หมดอายุ</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 whitespace-nowrap">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                <template x-for="item in currentList" :key="item.deposit_id">
                                    <tr :class="isSelected(item.deposit_id) ? 'bg-blue-50 dark:bg-blue-900/20' : ''">
                                        <td x-show="activeTab === 'expired'" class="px-3 py-2 text-center">
                                            <input type="checkbox" :checked="isSelected(item.deposit_id)" @click="toggleSelect(item.deposit_id)" class="w-4 h-4">
                                        </td>
                                        <td class="px-3 py-2 text-xs font-mono whitespace-nowrap" x-text="item.deposit_code"></td>
                                        <td class="px-3 py-2 whitespace-nowrap" x-text="item.customer_name"></td>
                                        <td class="px-3 py-2 whitespace-nowrap" x-text="item.item_name + ' x' + item.quantity"></td>
                                        <td class="px-3 py-2 whitespace-nowrap" x-text="formatDate(item.expiry_date)"></td>
                                        <td class="px-3 py-2 text-center">
                                            <span x-show="activeTab === 'expired'" class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">หมดอายุ</span>
                                            <span x-show="activeTab === 'pending'" class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">รอรับ</span>
                                            <span x-show="activeTab === 'confirmed'" class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">รับแล้ว</span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>

            <!-- Transfer Modal -->
            <div x-show="showTransferModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" x-cloak>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg mx-4 p-6 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-paper-plane text-blue-500 mr-2"></i>นำส่งคลังกลาง</h3>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">รายการที่เลือก (<span x-text="selectedCount"></span> รายการ)</label>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 max-h-32 overflow-y-auto text-sm">
                            <template x-for="dep in selectedDeposits" :key="dep.deposit_id">
                                <div class="py-2 border-b border-gray-200 dark:border-gray-600 last:border-0">
                                    <div><span class="font-mono text-blue-600" x-text="dep.deposit_code"></span> - <span x-text="dep.item_name"></span></div>
                                    <div class="text-gray-500 text-xs mt-1">└─ คงเหลือ: <span x-text="dep.quantity"></span> ขวด</div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ผู้นำส่ง</label>
                        <input type="text" x-model="createdBy" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 dark:bg-gray-600 dark:border-gray-600 cursor-not-allowed">
                    </div>

                    <!-- TODO: Photo upload -->

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">หมายเหตุ (ถ้ามี)</label>
                        <textarea x-model="transferNote" rows="2" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="ระบุหมายเหตุ..."></textarea>
                    </div>

                    <div class="flex space-x-3">
                        <button @click="closeTransferModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">ยกเลิก</button>
                        <button @click="submitTransfer()" :disabled="submitting || !createdBy" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-show="!submitting">ยืนยันส่งโอน</span>
                            <span x-show="submitting"><i class="fas fa-spinner fa-spin"></i> กำลังส่ง...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
                },

                // หน้าสำหรับ HQ - รับของจากสาขาอื่น
                renderHQTransferPage() {
                    return `
        <div class="space-y-6" x-data="hqTransferData()" x-init="init()">
            <div class="bg-white dark:bg-gray-800 rounded-2xl glow-border p-8">
                <div class="flex items-center space-x-4">
                    <div class="bg-purple-100 dark:bg-purple-900 p-4 rounded-xl">
                        <i class="fas fa-warehouse text-4xl text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-1 text-gray-900 dark:text-white">รับโอนจากสาขา</h2>
                        <p class="text-gray-600 dark:text-gray-400">รายการที่รอรับจากสาขาอื่น</p>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 gap-4">
                <div @click="switchTab('pending')" class="cursor-pointer bg-white dark:bg-gray-800 rounded-lg shadow p-4 border-2 transition-all" :class="activeTab === 'pending' ? 'border-yellow-500' : 'border-transparent hover:border-gray-300'">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">รอรับ</p>
                            <p class="text-2xl font-bold text-yellow-600" x-text="summary.pending"></p>
                        </div>
                        <i class="fas fa-clock text-3xl text-yellow-500"></i>
                    </div>
                </div>
                <div @click="switchTab('confirmed')" class="cursor-pointer bg-white dark:bg-gray-800 rounded-lg shadow p-4 border-2 transition-all" :class="activeTab === 'confirmed' ? 'border-green-500' : 'border-transparent hover:border-gray-300'">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">รับแล้ว</p>
                            <p class="text-2xl font-bold text-green-600" x-text="summary.confirmed"></p>
                        </div>
                        <i class="fas fa-check-circle text-3xl text-green-500"></i>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-2 border-b border-gray-200 dark:border-gray-700">
                <button @click="switchTab('pending')" class="px-4 py-2 font-medium transition-colors" :class="activeTab === 'pending' ? 'text-yellow-600 border-b-2 border-yellow-600' : 'text-gray-500 hover:text-gray-700'">
                    <i class="fas fa-clock mr-2"></i>รอรับ
                </button>
                <button @click="switchTab('confirmed')" class="px-4 py-2 font-medium transition-colors" :class="activeTab === 'confirmed' ? 'text-green-600 border-b-2 border-green-600' : 'text-gray-500 hover:text-gray-700'">
                    <i class="fas fa-check-circle mr-2"></i>รับแล้ว
                </button>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 overflow-hidden">
                <template x-if="loading">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-purple-500"></i>
                        <p class="mt-2 text-gray-600">กำลังโหลดข้อมูล...</p>
                    </div>
                </template>
                <template x-if="!loading && currentList.length === 0">
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2" x-text="activeTab === 'pending' ? 'ไม่มีรายการรอรับ' : 'ไม่มีรายการที่รับแล้ว'"></h3>
                        <p class="text-gray-600 dark:text-gray-400" x-text="activeTab === 'pending' ? 'ยังไม่มีรายการที่รอรับจากสาขาอื่นในขณะนี้' : 'ยังไม่มีรายการที่รับแล้ว'"></p>
                    </div>
                </template>
                <template x-if="!loading && currentList.length > 0">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">รหัสโอน</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">จากสาขา</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">รายการ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap">วันที่ส่ง</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase whitespace-nowrap" x-show="activeTab === 'confirmed'">วันที่รับ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" x-show="activeTab === 'pending'">จัดการ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase whitespace-nowrap" x-show="activeTab === 'confirmed'">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <template x-for="item in currentList" :key="item.transfer_id">
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-mono whitespace-nowrap" x-text="item.transfer_code"></td>
                                        <td class="px-4 py-3 text-sm whitespace-nowrap" x-text="item.from_store_name"></td>
                                        <td class="px-4 py-3 text-sm whitespace-nowrap">
                                            <span x-text="item.items_count + ' รายการ'"></span>
                                            <span class="text-gray-500">(<span x-text="item.total_quantity"></span> ขวด)</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm whitespace-nowrap" x-text="formatDate(item.transfer_date)"></td>
                                        <td class="px-4 py-3 text-sm whitespace-nowrap" x-show="activeTab === 'confirmed'" x-text="formatDate(item.confirmed_date)"></td>
                                        <td class="px-4 py-3 text-center whitespace-nowrap" x-show="activeTab === 'pending'">
                                            <button @click="openDetailModal(item)" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 mr-1">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button @click="openConfirmModal(item)" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 mr-1">
                                                <i class="fas fa-check"></i> รับ
                                            </button>
                                            <button @click="rejectTransfer(item)" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                        <td class="px-4 py-3 text-center whitespace-nowrap" x-show="activeTab === 'confirmed'">
                                            <button @click="openDetailModal(item)" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 mr-1">
                                                <i class="fas fa-eye"></i> ดู
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>

            <!-- Confirm Modal -->
            <div x-show="showConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" x-cloak>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
                    <h3 class="text-xl font-bold mb-4">ยืนยันรับโอน</h3>
                    <p class="mb-4 text-gray-600 dark:text-gray-400">รับโอนจาก: <span class="font-bold" x-text="selectedTransfer?.from_store_name"></span></p>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">หมายเหตุ (ถ้ามี)</label>
                        <textarea x-model="confirmNote" rows="3" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="ระบุหมายเหตุ..."></textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button @click="closeConfirmModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">ยกเลิก</button>
                        <button @click="confirmReceive()" :disabled="processing" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                            <span x-show="!processing">ยืนยันรับ</span>
                            <span x-show="processing"><i class="fas fa-spinner fa-spin"></i> กำลังดำเนินการ...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Detail Modal -->
            <div x-show="showDetailModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" x-cloak>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4 p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">รายละเอียดการโอน</h3>
                        <button @click="closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- Transfer Info -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">รหัสโอน:</span>
                                <span class="font-mono font-bold ml-2" x-text="selectedTransfer?.transfer_code"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">จากสาขา:</span>
                                <span class="font-bold ml-2" x-text="selectedTransfer?.from_store_name"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">วันที่ส่ง:</span>
                                <span class="ml-2" x-text="formatDate(selectedTransfer?.transfer_date)"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">จำนวน:</span>
                                <span class="ml-2" x-text="(selectedTransfer?.items_count || 0) + ' รายการ (' + (selectedTransfer?.total_quantity || 0) + ' ขวด)'"></span>
                            </div>
                        </div>
                        <template x-if="selectedTransfer?.notes">
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <span class="text-gray-500">หมายเหตุ:</span>
                                <span class="ml-2" x-text="selectedTransfer?.notes"></span>
                            </div>
                        </template>
                    </div>

                    <!-- Photo -->
                    <template x-if="selectedTransfer?.photo_url">
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-500 mb-2">รูปถ่าย</h4>
                            <img :src="selectedTransfer?.photo_url" class="max-w-full h-auto rounded-lg border max-h-64 object-contain" alt="Transfer Photo">
                        </div>
                    </template>

                    <!-- Deposits List -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">รายการของฝาก</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">รหัส</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ชื่อลูกค้า</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">สินค้า</th>
                                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">จำนวน</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <template x-for="dep in (selectedTransfer?.deposits || [])" :key="dep.deposit_id">
                                        <tr>
                                            <td class="px-3 py-2 font-mono" x-text="dep.deposit_code"></td>
                                            <td class="px-3 py-2" x-text="dep.customer_name"></td>
                                            <td class="px-3 py-2" x-text="dep.product_name"></td>
                                            <td class="px-3 py-2 text-center" x-text="dep.quantity"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Footer Buttons -->
                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <button @click="closeDetailModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">ปิด</button>
                        <template x-if="activeTab === 'pending'">
                            <button @click="closeDetailModal(); openConfirmModal(selectedTransfer)" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>รับโอน
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    `;
                },
                // --- END: Deposit System Render Functions ---




                loadLineDashboard() {
                    this.lineDashboard.loading = true;
                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                this.lineDashboard.data = response.data;
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                            this.lineDashboard.loading = false;
                        })
                        .withFailureHandler(error => {
                            Swal.fire('Error', error.message, 'error');
                            this.lineDashboard.loading = false;
                        })
                        .getLineDashboardData(this.lineDashboard.date);
                },

                resendNotification(storeId, date, eventType) {
                    Swal.fire({
                        title: 'ยืนยันการส่งซ้ำ?',
                        text: `คุณต้องการส่งแจ้งเตือน ${eventType} สำหรับสาขานี้อีกครั้งหรือไม่?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'ใช่, ส่งเลย',
                        cancelButtonText: 'ยกเลิก'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.showLoadingModal('กำลังส่ง...', 'กำลังส่งการแจ้งเตือนอีกครั้ง');
                            google.script.run
                                .withSuccessHandler(response => {
                                    this.hideLoadingModal();
                                    if (response.success) {
                                        Toastify({ text: response.message, duration: 3000, style: { background: "#10B981" } }).showToast();
                                    } else {
                                        Swal.fire('Error', response.message, 'error');
                                    }
                                })
                                .resendNotification(storeId, date, eventType);
                        }
                    });
                },



                renderLineDashboard() {
                    return `
    <div class="space-y-6">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 dark:from-green-600 dark:to-green-700 p-6 rounded-xl shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fa-brands fa-line text-3xl text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">LINE Notification Dashboard</h2>
                        <p class="text-green-100 text-sm">ติดตามสถานะการแจ้งเตือนของแต่ละสาขา</p>
                    </div>
                </div>
                
                <!-- Date Picker -->
                <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-4 py-2.5 rounded-lg shadow-md">
                    <i class="fas fa-calendar-alt text-green-600 dark:text-green-400"></i>
                    <input 
                        type="date" 
                        x-model="lineDashboard.date" 
                        @change="loadLineDashboard()"
                        class="bg-transparent border-none focus:outline-none text-gray-800 dark:text-gray-200 font-medium cursor-pointer"
                    />
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="lineDashboard.loading" class="flex flex-col items-center justify-center py-16">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-green-200 dark:border-green-800 border-t-green-500 dark:border-t-green-400 rounded-full animate-spin"></div>
            </div>
            <p class="mt-4 text-gray-600 dark:text-gray-400 font-medium">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Empty State -->
        <template x-if="!lineDashboard.loading && lineDashboard.data.length === 0">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-12 text-center">
                <div class="inline-block p-4 bg-gray-100 dark:bg-gray-700 rounded-full mb-4">
                    <i class="fas fa-inbox text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">ไม่พบข้อมูล</h3>
                <p class="text-gray-500 dark:text-gray-400">ไม่มีข้อมูลสำหรับวันที่เลือก</p>
            </div>
        </template>

        <!-- Dashboard Content -->
        <div x-show="!lineDashboard.loading && lineDashboard.data.length > 0" class="space-y-6">
            <template x-for="branch in lineDashboard.data" :key="branch.storeId">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300">
                    
                    <!-- Store Header -->
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-600">
                        <div class="flex items-center justify-between flex-wrap gap-3">
                            <div class="flex items-center gap-3">
                                <div class="bg-white dark:bg-gray-600 p-2 rounded-lg shadow-sm">
                                    <i class="fas fa-store text-lg text-gray-700 dark:text-gray-300"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100" x-text="branch.storeName"></h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        <span x-text="'Store ID: ' + branch.storeId"></span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Overall Status Badge -->
                            <div class="flex items-center gap-2">
                                <span 
                                    class="px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm"
                                    :class="{
                                        'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300': branch.overallStatus === 'COMPLETED',
                                        'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300': branch.overallStatus === 'PENDING' || branch.overallStatus === 'WAITING_APPROVAL',
                                        'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': branch.overallStatus === 'FAILED',
                                        'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': branch.overallStatus === 'NOT_STARTED'
                                    }"
                                >
                                    <i class="fas" 
                                       :class="{
                                           'fa-check-circle': branch.overallStatus === 'COMPLETED',
                                           'fa-clock': branch.overallStatus === 'PENDING' || branch.overallStatus === 'WAITING_APPROVAL',
                                           'fa-exclamation-circle': branch.overallStatus === 'FAILED',
                                           'fa-minus-circle': branch.overallStatus === 'NOT_STARTED'
                                       }"
                                    ></i>
                                    <span x-text="branch.overallStatus"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ Progress Bar Section (เพิ่มใหม่) -->
                    <div class="px-6 pt-4 pb-2 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
                        <div class="mb-4">
                            <!-- Progress Header -->
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                    <i class="fas fa-tasks mr-1.5 text-green-600 dark:text-green-400"></i>
                                    ความคืบหน้า
                                </span>
                                <span 
                                    class="text-sm font-bold"
                                    :class="{
                                        'text-green-600 dark:text-green-400': Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) === 100,
                                        'text-yellow-600 dark:text-yellow-400': Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) > 0 && Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) < 100,
                                        'text-gray-500 dark:text-gray-400': Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) === 0
                                    }"
                                    x-text="Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) + '%'"
                                ></span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="relative w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner">
                                <div 
                                    class="h-full rounded-full transition-all duration-700 ease-out relative"
                                    :class="{
                                        'bg-gradient-to-r from-green-500 to-green-600': Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) === 100,
                                        'bg-gradient-to-r from-yellow-500 to-yellow-600': Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) > 0 && Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) < 100,
                                        'bg-gray-400': Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) === 0
                                    }"
                                    :style="'width: ' + Math.round((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) + '%'"
                                >
                                    <!-- Animated Shine Effect -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-shimmer"></div>
                                </div>
                            </div>
                            
                            <!-- Progress Details -->
                            <div class="flex items-center justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <span class="flex items-center gap-1">
                                    <span class="font-semibold text-gray-700 dark:text-gray-300" x-text="branch.timeline.filter(s => s.status === 'COMPLETED').length"></span>
                                    <span>/</span>
                                    <span class="text-gray-700 dark:text-gray-300" x-text="branch.timeline.length"></span>
                                    <span>ขั้นตอนเสร็จสิ้น</span>
                                </span>
                                <span 
                                    x-show="branch.timeline.filter(s => s.status === 'PENDING').length > 0" 
                                    class="text-yellow-600 dark:text-yellow-400 flex items-center gap-1 font-medium"
                                >
                                    <i class="fas fa-clock"></i>
                                    <span x-text="branch.timeline.filter(s => s.status === 'PENDING').length + ' รอดำเนินการ'"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Container -->
                    <div class="p-6">
                        
                        <!-- Desktop Timeline (Hidden on Mobile) -->
                        <div class="hidden md:block">
                            <div class="relative">
                                <!-- Progress Background Line -->
                                <div class="absolute top-8 left-0 right-0 h-1 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                                
                                <!-- Active Progress Line -->
                                <div 
                                    class="absolute top-8 left-0 h-1 rounded-full transition-all duration-500 ease-in-out"
                                    :class="{
                                        'bg-green-500 dark:bg-green-400': branch.overallStatus === 'COMPLETED',
                                        'bg-yellow-500 dark:bg-yellow-400': branch.overallStatus === 'PENDING' || branch.overallStatus === 'WAITING_APPROVAL',
                                        'bg-red-500 dark:bg-red-400': branch.overallStatus === 'FAILED'
                                    }"
                                    :style="'width: ' + ((branch.timeline.filter(s => s.status === 'COMPLETED').length / branch.timeline.length) * 100) + '%'"
                                ></div>
                                
                                <!-- Steps -->
                                <div class="relative flex justify-between items-start">
                                    <template x-for="(step, index) in branch.timeline" :key="step.id">
                                        <div class="flex flex-col items-center" style="flex: 1">
                                            <!-- Step Circle -->
                                            <div class="relative z-10 group">
                                                <div 
                                                    class="w-16 h-16 rounded-full flex items-center justify-center text-white shadow-lg transition-all duration-300 group-hover:scale-110 cursor-pointer"
                                                    :class="{
                                                        'bg-green-500 dark:bg-green-600 ring-4 ring-green-100 dark:ring-green-900': step.status === 'COMPLETED',
                                                        'bg-yellow-500 dark:bg-yellow-600 ring-4 ring-yellow-100 dark:ring-yellow-900 animate-pulse': step.status === 'PENDING',
                                                        'bg-red-500 dark:bg-red-600 ring-4 ring-red-100 dark:ring-red-900': step.status === 'FAILED',
                                                        'bg-gray-300 dark:bg-gray-600': step.status === 'NOT_STARTED'
                                                    }"
                                                >
                                                    <i class="text-xl" :class="stepIcons[step.name] || 'fa-question'"></i>
                                                </div>
                                                
                                                <!-- Status Badge (On Hover) -->
                                                <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
                                                    <div class="bg-gray-900 dark:bg-gray-700 text-white text-xs px-3 py-1 rounded-full shadow-lg">
                                                        <span x-text="step.status"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Step Label -->
                                            <div class="mt-4 text-center max-w-[120px]">
                                                <p 
                                                    class="text-sm font-semibold leading-tight mb-1"
                                                    :class="{
                                                        'text-gray-900 dark:text-gray-100': step.status === 'COMPLETED' || step.status === 'PENDING',
                                                        'text-gray-500 dark:text-gray-400': step.status === 'NOT_STARTED'
                                                    }"
                                                    x-text="step.name"
                                                ></p>
                                                
                                                <!-- Timestamp -->
                                                <p 
                                                    x-show="step.timestamp"
                                                    class="text-xs text-gray-500 dark:text-gray-400"
                                                    x-text="step.timestamp"
                                                ></p>
                                            </div>
                                            
                                            <!-- Resend Button -->
                                            <div x-show="step.status === 'PENDING' && step.eventType === 'DAILY_REMINDER'" class="mt-2">
                                                <button 
                                                    @click="resendNotification(branch.storeId, lineDashboard.date, step.eventType)"
                                                    class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium rounded-full shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-1.5"
                                                    title="ส่งซ้ำ"
                                                >
                                                    <i class="fas fa-redo-alt"></i>
                                                    <span>ส่งซ้ำ</span>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Timeline (Visible on Mobile) -->
                        <div class="block md:hidden space-y-4">
                            <template x-for="(step, index) in branch.timeline" :key="step.id">
                                <div class="relative">
                                    <!-- Connector Line (Not for last item) -->
                                    <div 
                                        x-show="index < branch.timeline.length - 1"
                                        class="absolute left-8 top-16 bottom-0 w-0.5 -mb-4"
                                        :class="{
                                            'bg-green-500 dark:bg-green-400': step.status === 'COMPLETED',
                                            'bg-yellow-500 dark:bg-yellow-400': step.status === 'PENDING',
                                            'bg-red-500 dark:bg-red-400': step.status === 'FAILED',
                                            'bg-gray-300 dark:bg-gray-600': step.status === 'NOT_STARTED'
                                        }"
                                    ></div>
                                    
                                    <!-- Step Card -->
                                    <div class="flex items-start gap-4">
                                        <!-- Circle Icon -->
                                        <div class="relative z-10 flex-shrink-0">
                                            <div 
                                                class="w-16 h-16 rounded-full flex items-center justify-center text-white shadow-lg"
                                                :class="{
                                                    'bg-green-500 dark:bg-green-600 ring-4 ring-green-100 dark:ring-green-900': step.status === 'COMPLETED',
                                                    'bg-yellow-500 dark:bg-yellow-600 ring-4 ring-yellow-100 dark:ring-yellow-900 animate-pulse': step.status === 'PENDING',
                                                    'bg-red-500 dark:bg-red-600 ring-4 ring-red-100 dark:ring-red-900': step.status === 'FAILED',
                                                    'bg-gray-300 dark:bg-gray-600': step.status === 'NOT_STARTED'
                                                }"
                                            >
                                                <i class="text-xl" :class="stepIcons[step.name] || 'fa-question'"></i>
                                            </div>
                                        </div>
                                        
                                        <!-- Step Info Card -->
                                        <div class="flex-1 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 shadow-sm">
                                            <div class="flex items-start justify-between gap-2 mb-2">
                                                <h4 class="font-semibold text-gray-900 dark:text-gray-100" x-text="step.name"></h4>
                                                <span 
                                                    class="px-2 py-1 rounded-full text-xs font-bold uppercase"
                                                    :class="{
                                                        'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300': step.status === 'COMPLETED',
                                                        'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300': step.status === 'PENDING',
                                                        'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': step.status === 'FAILED',
                                                        'bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300': step.status === 'NOT_STARTED'
                                                    }"
                                                    x-text="step.status"
                                                ></span>
                                            </div>
                                            
                                            <p x-show="step.timestamp" class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                                                <i class="fas fa-clock mr-1"></i>
                                                <span x-text="step.timestamp"></span>
                                            </p>
                                            
                                            <!-- Resend Button -->
                                            <div x-show="step.status === 'PENDING' && step.eventType !== 'COMPLETED' && step.eventType !== 'WAITING_APPROVAL'">
                                                <button 
                                                    @click="resendNotification(branch.storeId, lineDashboard.date, step.eventType)"
                                                    class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium rounded-lg shadow hover:shadow-md transition-all duration-200 flex items-center gap-1.5"
                                                >
                                                    <i class="fas fa-redo-alt"></i>
                                                    <span>ส่งการแจ้งเตือนซ้ำ</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    `;
                },



                startEditingCount() {
                    this.showLoadingModal('กำลังโหลด', 'กำลังเตรียมข้อมูลสำหรับแก้ไข...');
                    const selectedDate = this.countData.date;

                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.success) {
                                console.log("Data received from server:", JSON.stringify(response.data, null, 2));

                                const grouped = {
                                    mismatched: { category: 'รายการที่ไม่ตรง', products: [], collapsed: false },
                                    matched: { category: 'รายการที่ตรง', products: [], collapsed: true }
                                };

                                // --- START: เพิ่ม Log การตรวจสอบแบบละเอียด ---
                                console.log(`Processing ${response.data.length} items for grouping...`);

                                response.data.forEach((item, index) => {
                                    const diffValue = item.difference;
                                    const diff = parseFloat(diffValue);

                                    console.log(`Item #${index + 1}: ${item.product_code}, Raw Difference: '${diffValue}', Parsed Diff: ${diff}`);

                                    if (isNaN(diff)) {
                                        console.error(`--> ERROR: Difference for ${item.product_code} is NaN (Not a Number)! Skipping.`);
                                        return; // ข้าม item นี้ไปถ้าค่า difference ไม่ใช่ตัวเลข
                                    }

                                    if (Math.abs(diff) < 0.01) {
                                        console.log(`--> Sorting '${item.product_code}' into 'Matched'`);
                                        grouped.matched.products.push(item);
                                    } else {
                                        console.log(`--> Sorting '${item.product_code}' into 'Mismatched'`);
                                        grouped.mismatched.products.push(item);
                                    }
                                });

                                console.log(`Grouping complete. Mismatched: ${grouped.mismatched.products.length}, Matched: ${grouped.matched.products.length}`);
                                // --- END: เพิ่ม Log ---

                                this.countData.items = [grouped.mismatched, grouped.matched];
                                this.countData.status = 'editing';
                                this.countData.isEditing = true;
                            } else {
                                Swal.fire(this.t('error'), response.message, 'error');
                            }
                            this.hideLoadingModal();
                        })
                        .withFailureHandler(error => {
                            Swal.fire(this.t('error'), error.message, 'error');
                            this.hideLoadingModal();
                        })
                        .getCountDataForEdit(Alpine.store('app').user.sheetId, selectedDate);
                },



                saveEditedCount() {
                    const updatedItems = [];
                    let stillMismatchedCount = 0;

                    this.countData.items.forEach(category => {
                        category.products.forEach(product => {
                            // เช็คว่ามีการเปลี่ยนแปลงค่าหรือไม่
                            if (product.new_quantity !== product.manual_quantity) {
                                updatedItems.push({
                                    product_code: product.product_code,
                                    product_name: product.product_name,
                                    new_quantity: parseFloat(product.new_quantity) || 0
                                });
                            }
                            // เช็คผลต่างใหม่
                            const newDifference = (parseFloat(product.new_quantity) || 0) - (product.pos_quantity || 0);
                            if (Math.abs(newDifference) >= 0.01) {
                                stillMismatchedCount++;
                            }
                        });
                    });

                    if (updatedItems.length === 0) {
                        Swal.fire('ไม่มีการเปลี่ยนแปลง', 'คุณยังไม่ได้แก้ไขจำนวนนับใดๆ', 'info');
                        return;
                    }

                    const confirmAction = () => {
                        this.showLoadingModal(this.t('saving'), 'กำลังอัปเดตข้อมูลและส่งแจ้งเตือน...');
                        google.script.run
                            .withSuccessHandler(response => {
                                this.hideLoadingModal();
                                if (response.success) {
                                    Swal.fire(this.t('success'), 'แก้ไขข้อมูลเรียบร้อย', 'success');
                                    this.countData.isEditing = false;
                                    this.checkCountStatus(); // กลับไปหน้าสรุป
                                } else {
                                    Swal.fire(this.t('error'), response.message, 'error');
                                }
                            })
                            .withFailureHandler(error => {
                                this.hideLoadingModal();
                                Swal.fire(this.t('error'), error.message, 'error');
                            })
                            .updateStockCountAndComparison(
                                Alpine.store('app').user.sheetId,
                                this.countData.date,
                                updatedItems,
                                Alpine.store('app').user.username
                            );
                    };

                    if (stillMismatchedCount > 0) {
                        Swal.fire({
                            title: 'ยืนยันการบันทึก?',
                            html: `พบว่ามี <strong class="text-red-600">${stillMismatchedCount}</strong> รายการที่ยังคงมีผลต่าง คุณต้องการบันทึกการแก้ไขนี้หรือไม่?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'ยืนยัน',
                            cancelButtonText: 'ยกเลิก'
                        }).then(result => {
                            if (result.isConfirmed) {
                                confirmAction();
                            }
                        });
                    } else {
                        confirmAction();
                    }
                },






                async processTXTWithProgress(fileContent, fileName, uploadDate, includeZeroQty) {
                    // 1. เริ่มแสดง Modal พร้อม Progress Bar
                    this.showLoadingModal('กำลังประมวลผลไฟล์ TXT', 'กำลังเตรียมข้อมูล...', true);

                    // 2. จำลองความคืบหน้า
                    const totalDuration = 10000; // 10 วินาที (TXT ประมวลผลเร็วกว่า PDF)
                    const intervalTime = 500;
                    let elapsedTime = 0;

                    const progressInterval = setInterval(() => {
                        elapsedTime += intervalTime;
                        const progress = Math.min(90, Math.round((elapsedTime / totalDuration) * 100));
                        Alpine.store('app').ui.progress = progress;

                        if (progress < 20) {
                            Alpine.store('app').ui.progressStatus = 'กำลังอัปโหลดไฟล์ขึ้นเซิร์ฟเวอร์...';
                        } else if (progress < 60) {
                            Alpine.store('app').ui.progressStatus = 'กำลังอ่านและแปลงข้อมูล...';
                        } else {
                            Alpine.store('app').ui.progressStatus = 'กำลังตรวจสอบและจัดรูปแบบข้อมูล...';
                        }
                    }, intervalTime);

                    // 3. เรียกใช้ Backend เพื่อประมวลผลไฟล์ TXT
                    try {
                        const response = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .uploadAndProcessTXT(
                                    Alpine.store('app').user.sheetId,
                                    fileContent,
                                    fileName,
                                    uploadDate,
                                    true
                                );
                        });

                        // 4. เมื่อ Backend ทำงานเสร็จ
                        clearInterval(progressInterval);
                        Alpine.store('app').ui.progress = 100;
                        Alpine.store('app').ui.progressStatus = 'ประมวลผลสำเร็จ!';

                        if (response.success) {
                            this.ocrVerificationData = {
                                ocr_date: response.ocr_date,
                                file_url: response.file_url,
                                file_id: response.file_id,
                                file_name: response.file_name,
                                results: response.results,
                                zeroQtyProducts: response.zeroQtyProducts,
                                stats: response.stats,
                                includeZeroQty: includeZeroQty
                            };

                            this.uploadStatus = {
                                uploaded: true,
                                fileName: fileName,
                                driveFileId: response.file_id || ''
                            };

                            const today = this.getLocalDateString();
                            if (this.txtUploadDate === today) {
                                this.dashboardData.todayStatus.txtUpload = true;
                                this.dashboardData.todayStatus.txtFileName = fileName;
                            }

                            const totalForDisplay = this.ocrVerificationData.results.length;
                            const verifiedForDisplay = this.ocrVerificationData.results.filter(r => r.status === 'verified').length;
                            const unmatchedForDisplay = this.ocrVerificationData.results.filter(r => r.status === 'unmatched').length;

                            this.hideLoadingModal();
                            Swal.fire({
                                icon: 'success',
                                title: this.t('success'),
                                html: `
                    <p>พบสินค้า ${totalForDisplay} รายการ</p>
                    <p class="text-green-600">✓ ตรงกัน: ${verifiedForDisplay} รายการ</p>
                    <p class="text-red-600">✗ ไม่ตรงกัน: ${unmatchedForDisplay} รายการ</p>
                    <p class="text-blue-600 mt-2">📁 ไฟล์ได้ถูกบันทึกใน Google Drive แล้ว</p>
                `,
                                confirmButtonText: 'ตกลง'
                            });

                        } else {
                            this.hideLoadingModal();
                            Swal.fire(this.t('error'), response.message, 'error');
                        }
                    } catch (error) {
                        clearInterval(progressInterval);
                        this.hideLoadingModal();
                        Swal.fire(this.t('error'), error.message, 'error');
                    }
                }




            }
        }


    </script>
</body>

</html>