<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มขอฝากเหล้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">

    <div id="app" class="max-w-md mx-auto p-4">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-t-3xl p-6 -mx-4 -mt-4 mb-6">
            <div class="text-center">
                <i class="fas fa-wine-glass-alt text-4xl mb-3"></i>
                <h1 class="text-2xl font-bold">ฟอร์มขอฝากเหล้า</h1>
                <p class="text-sm opacity-90 mt-1">กรอกข้อมูลเพื่อขอฝากเหล้าที่ร้าน</p>
            </div>
        </div>

        <!-- Form -->
        <div class="bg-white rounded-2xl shadow-xl p-6 space-y-5">

            <!-- Customer Name -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-user text-purple-600 mr-2"></i>ชื่อ-นามสกุล *
                </label>
                <input type="text"
                       id="customerName"
                       placeholder="กรอกชื่อของคุณ"
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
            </div>

            <!-- Phone Number -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-phone text-purple-600 mr-2"></i>เบอร์โทรศัพท์ *
                </label>
                <input type="tel"
                       id="customerPhone"
                       placeholder="0xx-xxx-xxxx"
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                <p class="text-xs text-gray-500 mt-1">สำหรับติดต่อกลับเมื่อเหล้าใกล้หมดอายุ</p>
            </div>

            <!-- Alcohol Type -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-wine-bottle text-purple-600 mr-2"></i>ประเภทเหล้า *
                </label>
                <select id="alcoholType"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                    <option value="">เลือกประเภทเหล้า</option>
                    <option value="Whisky">Whisky (วิสกี้)</option>
                    <option value="Vodka">Vodka (วอดก้า)</option>
                    <option value="Rum">Rum (รัม)</option>
                    <option value="Gin">Gin (จิน)</option>
                    <option value="Tequila">Tequila (เตกีล่า)</option>
                    <option value="Brandy">Brandy (บรั่นดี)</option>
                    <option value="Wine">Wine (ไวน์)</option>
                    <option value="Beer">Beer (เบียร์)</option>
                    <option value="Other">อื่นๆ</option>
                </select>
            </div>

            <!-- Quantity -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-list-ol text-purple-600 mr-2"></i>จำนวนขวด *
                </label>
                <input type="number"
                       id="quantity"
                       min="1"
                       value="1"
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
            </div>

            <!-- Table Number -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-chair text-purple-600 mr-2"></i>เลขโต๊ะ
                </label>
                <input type="text"
                       id="tableNumber"
                       placeholder="เลขโต๊ะของคุณ (ถ้ามี)"
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-sticky-note text-purple-600 mr-2"></i>หมายเหตุ
                </label>
                <textarea id="notes"
                          rows="3"
                          placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition resize-none"></textarea>
            </div>

            <!-- Info Box -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-600 text-xl mt-0.5"></i>
                    <div class="text-sm text-blue-800">
                        <p class="font-semibold mb-1">ข้อมูลที่ควรทราบ:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>เหล้าที่ฝากสามารถเก็บได้ <strong>30 วัน</strong></li>
                            <li>สมาชิก VIP เก็บได้ถึง <strong>90 วัน</strong></li>
                            <li>ระบบจะแจ้งเตือนก่อนหมดอายุ 3 วัน</li>
                            <li>หากหมดอายุจะโอนไปคลังกลาง</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button onclick="submitForm()"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all transform hover:scale-105">
                <i class="fas fa-paper-plane mr-2"></i>ส่งคำขอฝาก
            </button>

            <!-- Close Button -->
            <button onclick="closeLiff()"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition">
                <i class="fas fa-times mr-2"></i>ปิด
            </button>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-sm text-gray-500">
            <p>Powered by <strong class="text-purple-600">ระบบฝากเหล้า</strong></p>
        </div>
    </div>

    <script>
        let liffId = 'YOUR_LIFF_ID'; // TODO: Replace with actual LIFF ID
        let userId = null;
        let displayName = null;

        // Initialize LIFF
        window.onload = async function() {
            try {
                await liff.init({ liffId: liffId });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // Get user profile
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;

                // Pre-fill name if available
                if (displayName) {
                    document.getElementById('customerName').value = displayName;
                }

                console.log('LIFF initialized:', { userId, displayName });
            } catch (error) {
                console.error('LIFF init error:', error);
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อ LINE ได้', 'error');
            }
        };

        async function submitForm() {
            // Get form values
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const alcoholType = document.getElementById('alcoholType').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const tableNumber = document.getElementById('tableNumber').value.trim();
            const notes = document.getElementById('notes').value.trim();

            // Validation
            if (!customerName) {
                Swal.fire('Error', 'กรุณากรอกชื่อ-นามสกุล', 'error');
                return;
            }

            if (!customerPhone) {
                Swal.fire('Error', 'กรุณากรอกเบอร์โทรศัพท์', 'error');
                return;
            }

            // Validate phone format (basic)
            const phoneRegex = /^0\d{8,9}$/;
            if (!phoneRegex.test(customerPhone.replace(/-/g, ''))) {
                Swal.fire('Error', 'รูปแบบเบอร์โทรไม่ถูกต้อง', 'error');
                return;
            }

            if (!alcoholType) {
                Swal.fire('Error', 'กรุณาเลือกประเภทเหล้า', 'error');
                return;
            }

            if (!quantity || quantity < 1) {
                Swal.fire('Error', 'กรุณาระบุจำนวนขวด', 'error');
                return;
            }

            // Prepare data
            const formData = {
                lineUserId: userId,
                customerName,
                customerPhone,
                alcoholType,
                quantity,
                tableNumber: tableNumber || '-',
                notes: notes || '-',
                requestDate: new Date().toISOString()
            };

            // Show loading
            Swal.fire({
                title: 'กำลังส่งคำขอ...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // TODO: Call Google Apps Script backend
                console.log('Submitting deposit request:', formData);

                // Simulated API call
                await new Promise(resolve => setTimeout(resolve, 1500));

                // For actual implementation:
                // const response = await fetch(WEB_APP_URL, {
                //     method: 'POST',
                //     body: JSON.stringify({
                //         action: 'submitDepositRequest',
                //         data: formData
                //     })
                // });
                // const result = await response.json();

                Swal.fire({
                    icon: 'success',
                    title: 'ส่งคำขอสำเร็จ!',
                    html: `
                        <div class="text-left">
                            <p class="mb-2">ส่งคำขอฝากเหล้าเรียบร้อยแล้ว</p>
                            <p class="text-sm text-gray-600">พนักงานจะรับเข้าสู่ระบบและแจ้งให้คุณทราบ</p>
                        </div>
                    `,
                    confirmButtonText: 'ปิด',
                    confirmButtonColor: '#7c3aed'
                }).then(() => {
                    closeLiff();
                });

            } catch (error) {
                console.error('Submit error:', error);
                Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งคำขอ', 'error');
            }
        }

        function closeLiff() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }
    </script>
</body>
</html>
