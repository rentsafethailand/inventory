<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มขอเบิกเหล้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        [x-cloak] { display: none !important; }
        .deposit-card {
            @apply cursor-pointer transition-all;
        }
        .deposit-card:hover {
            @apply transform scale-105 shadow-xl;
        }
        .deposit-card.selected {
            @apply border-2 border-green-500 bg-green-50;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

    <div id="app" class="max-w-md mx-auto p-4">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-t-3xl p-6 -mx-4 -mt-4 mb-6">
            <div class="text-center">
                <i class="fas fa-hand-holding-heart text-4xl mb-3"></i>
                <h1 class="text-2xl font-bold">ฟอร์มขอเบิกเหล้า</h1>
                <p class="text-sm opacity-90 mt-1">เลือกรายการที่ต้องการเบิก</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-600">กำลังโหลดรายการฝาก...</p>
        </div>

        <!-- My Deposits List -->
        <div id="depositsList" style="display: none;">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-list text-green-600 mr-2"></i>รายการฝากของคุณ
                </h2>

                <!-- Empty State -->
                <div id="emptyState" style="display: none;" class="text-center py-8">
                    <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">ไม่มีรายการฝาก</p>
                    <p class="text-sm text-gray-400 mt-2">คุณยังไม่มีเหล้าที่ฝากไว้ในร้าน</p>
                </div>

                <!-- Deposits Container -->
                <div id="depositsContainer" class="space-y-3">
                    <!-- Deposits will be rendered here -->
                </div>
            </div>

            <!-- Withdrawal Form (Hidden until deposit selected) -->
            <div id="withdrawalForm" style="display: none;" class="bg-white rounded-2xl shadow-xl p-6 space-y-5">
                <h2 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-edit text-green-600 mr-2"></i>ข้อมูลการเบิก
                </h2>

                <!-- Selected Deposit Info -->
                <div id="selectedDepositInfo" class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Quantity to Withdraw -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-list-ol text-green-600 mr-2"></i>จำนวนที่ต้องการเบิก *
                    </label>
                    <input type="number"
                           id="withdrawalQty"
                           min="1"
                           value="1"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">
                    <p class="text-xs text-gray-500 mt-1">จำนวนขวดที่ต้องการเบิก</p>
                </div>

                <!-- Table Number -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-chair text-green-600 mr-2"></i>เลขโต๊ะ *
                    </label>
                    <input type="text"
                           id="tableNumber"
                           placeholder="กรอกเลขโต๊ะ"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-sticky-note text-green-600 mr-2"></i>หมายเหตุ
                    </label>
                    <textarea id="notes"
                              rows="3"
                              placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition resize-none"></textarea>
                </div>

                <!-- Submit Button -->
                <button onclick="submitWithdrawal()"
                        class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all transform hover:scale-105">
                    <i class="fas fa-check-circle mr-2"></i>ส่งคำขอเบิก
                </button>

                <!-- Back Button -->
                <button onclick="clearSelection()"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition">
                    <i class="fas fa-arrow-left mr-2"></i>เลือกรายการใหม่
                </button>
            </div>

            <!-- Close Button -->
            <button onclick="closeLiff()"
                    class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition">
                <i class="fas fa-times mr-2"></i>ปิด
            </button>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-sm text-gray-500">
            <p>Powered by <strong class="text-green-600">ระบบฝากเหล้า</strong></p>
        </div>
    </div>

    <script>
        let liffId = 'YOUR_LIFF_ID'; // TODO: Replace with actual LIFF ID
        let userId = null;
        let displayName = null;
        let myDeposits = [];
        let selectedDeposit = null;

        // Initialize LIFF
        window.onload = async function() {
            try {
                await liff.init({ liffId: liffId });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // Get user profile
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;

                console.log('LIFF initialized:', { userId, displayName });

                // Load user's deposits
                await loadMyDeposits();

            } catch (error) {
                console.error('LIFF init error:', error);
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อ LINE ได้', 'error');
            }
        };

        async function loadMyDeposits() {
            try {
                // TODO: Call Google Apps Script backend to get deposits by LINE User ID
                console.log('Loading deposits for user:', userId);

                // Simulated API call
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Simulated data
                myDeposits = [
                    // Example:
                    // {
                    //     id: 'DEP001',
                    //     depositCode: 'DEP-2024-001',
                    //     alcoholType: 'Whisky',
                    //     quantity: 2,
                    //     remainingQty: 2,
                    //     depositDate: '2024-01-15',
                    //     expiryDate: '2024-02-14',
                    //     storeName: 'สาขาทดสอบ'
                    // }
                ];

                // For actual implementation:
                // const response = await fetch(WEB_APP_URL + '?action=getMyDeposits&userId=' + userId);
                // myDeposits = await response.json();

                renderDeposits();

            } catch (error) {
                console.error('Load deposits error:', error);
                Swal.fire('Error', 'ไม่สามารถโหลดรายการฝากได้', 'error');
            }
        }

        function renderDeposits() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('depositsList').style.display = 'block';

            const container = document.getElementById('depositsContainer');
            const emptyState = document.getElementById('emptyState');

            if (myDeposits.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            container.innerHTML = myDeposits.map(deposit => `
                <div class="deposit-card bg-white border-2 border-gray-200 rounded-xl p-4 ${selectedDeposit?.id === deposit.id ? 'selected' : ''}"
                     onclick="selectDeposit('${deposit.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-800">${deposit.depositCode}</h3>
                            <p class="text-sm text-gray-600">${deposit.storeName}</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full">
                            คงเหลือ ${deposit.remainingQty}/${deposit.quantity} ขวด
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">ประเภท:</span>
                            <span class="font-semibold ml-1">${deposit.alcoholType}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">หมดอายุ:</span>
                            <span class="font-semibold ml-1">${formatDate(deposit.expiryDate)}</span>
                        </div>
                    </div>

                    ${selectedDeposit?.id === deposit.id ?
                        '<div class="mt-3 flex items-center text-green-600 text-sm font-semibold"><i class="fas fa-check-circle mr-2"></i>รายการที่เลือก</div>'
                        : ''}
                </div>
            `).join('');
        }

        function selectDeposit(depositId) {
            selectedDeposit = myDeposits.find(d => d.id === depositId);

            if (!selectedDeposit) return;

            // Update UI
            renderDeposits();

            // Show withdrawal form
            document.getElementById('withdrawalForm').style.display = 'block';

            // Set max quantity
            const qtyInput = document.getElementById('withdrawalQty');
            qtyInput.max = selectedDeposit.remainingQty;
            qtyInput.value = Math.min(1, selectedDeposit.remainingQty);

            // Populate selected deposit info
            document.getElementById('selectedDepositInfo').innerHTML = `
                <div class="flex items-start space-x-3">
                    <i class="fas fa-wine-bottle text-blue-600 text-2xl"></i>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${selectedDeposit.depositCode}</h4>
                        <p class="text-sm text-gray-600">${selectedDeposit.alcoholType}</p>
                        <p class="text-sm text-gray-600 mt-2">
                            <span class="font-semibold">คงเหลือ:</span>
                            <span class="text-green-600 font-bold">${selectedDeposit.remainingQty}</span>/${selectedDeposit.quantity} ขวด
                        </p>
                    </div>
                </div>
            `;

            // Scroll to form
            document.getElementById('withdrawalForm').scrollIntoView({ behavior: 'smooth' });
        }

        function clearSelection() {
            selectedDeposit = null;
            renderDeposits();
            document.getElementById('withdrawalForm').style.display = 'none';
            document.getElementById('tableNumber').value = '';
            document.getElementById('notes').value = '';
        }

        async function submitWithdrawal() {
            if (!selectedDeposit) {
                Swal.fire('Error', 'กรุณาเลือกรายการฝาก', 'error');
                return;
            }

            // Get form values
            const withdrawalQty = parseInt(document.getElementById('withdrawalQty').value);
            const tableNumber = document.getElementById('tableNumber').value.trim();
            const notes = document.getElementById('notes').value.trim();

            // Validation
            if (!withdrawalQty || withdrawalQty < 1) {
                Swal.fire('Error', 'กรุณาระบุจำนวนที่ต้องการเบิก', 'error');
                return;
            }

            if (withdrawalQty > selectedDeposit.remainingQty) {
                Swal.fire('Error', `จำนวนเกินที่มี (คงเหลือ ${selectedDeposit.remainingQty} ขวด)`, 'error');
                return;
            }

            if (!tableNumber) {
                Swal.fire('Error', 'กรุณาระบุเลขโต๊ะ', 'error');
                return;
            }

            // Prepare data
            const formData = {
                depositId: selectedDeposit.id,
                lineUserId: userId,
                requestedQty: withdrawalQty,
                tableNumber,
                notes: notes || '-',
                requestDate: new Date().toISOString()
            };

            // Show loading
            Swal.fire({
                title: 'กำลังส่งคำขอ...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // TODO: Call Google Apps Script backend
                console.log('Submitting withdrawal request:', formData);

                // Simulated API call
                await new Promise(resolve => setTimeout(resolve, 1500));

                // For actual implementation:
                // const response = await fetch(WEB_APP_URL, {
                //     method: 'POST',
                //     body: JSON.stringify({
                //         action: 'submitWithdrawalRequest',
                //         data: formData
                //     })
                // });
                // const result = await response.json();

                Swal.fire({
                    icon: 'success',
                    title: 'ส่งคำขอสำเร็จ!',
                    html: `
                        <div class="text-left">
                            <p class="mb-2">ส่งคำขอเบิกเรียบร้อยแล้ว</p>
                            <p class="text-sm text-gray-600">รหัสฝาก: <strong>${selectedDeposit.depositCode}</strong></p>
                            <p class="text-sm text-gray-600">จำนวน: <strong>${withdrawalQty} ขวด</strong></p>
                            <p class="text-sm text-gray-600 mt-2">กรุณารอพนักงานเตรียมเหล้าให้</p>
                        </div>
                    `,
                    confirmButtonText: 'ปิด',
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    closeLiff();
                });

            } catch (error) {
                console.error('Submit error:', error);
                Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งคำขอ', 'error');
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH');
        }

        function closeLiff() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }
    </script>
</body>
</html>
