<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการฝาก/เบิกเหล้า</title>

    <!-- Store ID from server -->
    <script>
        window.SERVER_STORE_ID = '<?= storeId ?>';
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Sarabun', sans-serif;
        }

        [x-cloak] {
            display: none !important;
        }

        body {
            font-family: 'Sarabun', sans-serif;
        }

        .tab-active {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white !important;
            border-radius: 0.5rem;
        }

        /* Badge styles with status colors */
        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .badge-new { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        .badge-pending { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .badge-withdrawal { background: linear-gradient(135deg, #10B981, #059669); }
        .badge-success { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }

        /* Login Modal Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
        }

        .login-card {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-card .icon-wrapper {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
        }

        .login-card h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #1F2937;
        }

        .login-card p {
            color: #6B7280;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #E5E7EB;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-alert {
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            color: #991B1B;
            padding: 0.875rem;
            border-radius: 0.5rem;
            margin-bottom: 1.25rem;
            text-align: left;
            font-size: 0.9rem;
        }

        .error-alert strong {
            font-weight: 700;
        }
    </style>
</head>

<body class="bg-gray-50" x-data="depositApp()" x-init="init()" x-cloak>

    <!-- Header -->
    <header class="bg-gradient-to-br from-blue-400 via-blue-500 to-blue-600 text-white shadow-xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <!-- Left: Logo & Store Name -->
                <div class="flex items-center space-x-3">
                    <div class="bg-white/20 p-2.5 rounded-xl backdrop-blur-sm">
                        <i class="fas fa-wine-glass-alt text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight">จัดการฝาก/เบิกเหล้า</h1>
                        <p class="text-sm opacity-90" x-text="currentStoreName">กำลังโหลด...</p>
                    </div>
                </div>

                <!-- Right: User Info (compact) -->
                <div x-show="isLoggedIn" class="flex items-center space-x-3">
                    <div class="hidden sm:flex items-center space-x-2 bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5">
                        <i class="fas fa-user-circle text-lg"></i>
                        <span class="text-sm font-medium" x-text="currentUser?.fullname || 'ผู้ใช้'"></span>
                        <span class="bg-white/20 px-2 py-0.5 rounded-full text-xs font-semibold"
                              x-text="getRoleLabel(currentUser?.role)"></span>
                    </div>
                    <button @click="logout()"
                            class="bg-red-500/90 hover:bg-red-600 px-3 py-1.5 rounded-lg text-sm font-medium transition-all hover:shadow-lg">
                        <i class="fas fa-sign-out-alt sm:mr-1"></i>
                        <span class="hidden sm:inline">ออก</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div x-show="isLoggedIn" class="bg-white shadow-sm sticky top-[88px] z-40 overflow-x-auto">
        <div class="max-w-7xl mx-auto px-2">
            <nav class="flex gap-2 py-3" id="tabsContainer">
                <template x-for="tab in visibleTabs" :key="tab.id">
                    <button @click="activeTab = tab.id"
                            :class="activeTab === tab.id ? 'tab-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2.5 text-sm font-medium relative transition-all rounded-lg whitespace-nowrap">
                        <span x-text="tab.label"></span>
                        <span x-show="tab.badge && tab.badge > 0"
                              :class="{
                                'badge-new': tab.id === 'new_requests',
                                'badge-pending': tab.id === 'pending_confirm',
                                'badge-withdrawal': tab.id === 'pending_withdrawal',
                                'badge-success': tab.id === 'deposited'
                              }"
                              class="badge"
                              x-text="tab.badge"></span>
                    </button>
                </template>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main x-show="isLoggedIn" class="max-w-7xl mx-auto p-4 pb-24">

        <!-- Tab: รายการใหม่ (Staff Only) -->
        <div x-show="activeTab === 'new_requests'" class="space-y-4">
            <!-- Header with Create Button -->
            <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 w-full sm:flex-1">
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-500 text-white p-2 rounded-lg">
                            <i class="fas fa-bell text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-blue-900">รายการใหม่จากลูกค้า</h3>
                            <p class="text-sm text-blue-700">คำขอฝากผ่าน LINE รอ Staff รับเข้าสู่ระบบ</p>
                        </div>
                    </div>
                </div>

                <!-- Create Walk-in Button -->
                <button @click="openWalkInModal()"
                        x-show="['staff', 'bar', 'manager', 'owner'].includes(currentUser?.role)"
                        class="w-full sm:w-auto bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center justify-center space-x-2">
                    <i class="fas fa-plus-circle text-lg"></i>
                    <span>สร้างรายการฝาก Walk-in</span>
                </button>
            </div>

            <!-- List of New Requests -->
            <template x-if="deposits.new_requests.length === 0">
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">ไม่มีรายการใหม่</p>
                </div>
            </template>

            <template x-for="item in deposits.new_requests" :key="item.id">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg" x-text="item.customerName"></h3>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-phone mr-1"></i>
                                <span x-text="item.customerPhone"></span>
                            </p>
                        </div>
                        <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full">
                            รายการใหม่
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div>
                            <span class="text-gray-600">ประเภทเหล้า:</span>
                            <span class="font-semibold ml-1" x-text="item.alcoholType"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">จำนวน:</span>
                            <span class="font-semibold ml-1" x-text="item.quantity + ' ขวด'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">โต๊ะ:</span>
                            <span class="font-semibold ml-1" x-text="item.tableNumber"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">เวลา:</span>
                            <span class="font-semibold ml-1" x-text="formatDateTime(item.requestDate)"></span>
                        </div>
                    </div>

                    <div x-show="item.notes" class="bg-gray-50 rounded p-2 mb-3 text-sm">
                        <span class="text-gray-600">หมายเหตุ:</span>
                        <span class="ml-1" x-text="item.notes"></span>
                    </div>

                    <div class="flex space-x-2">
                        <button @click="receiveDeposit(item.id)"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition">
                            <i class="fas fa-check mr-2"></i>รับเข้าระบบ
                        </button>
                        <button @click="viewDetails(item)"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Tab: รอคอนเฟิร์ม (Bar Only) -->
        <div x-show="activeTab === 'pending_confirm'" class="space-y-4">
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-clipboard-check text-orange-600 text-xl mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-orange-900">รอ Bar คอนเฟิร์ม</h3>
                        <p class="text-sm text-orange-700">อัปโหลดรูปขวดเหล้าและยืนยันการฝาก</p>
                    </div>
                </div>
            </div>

            <template x-if="deposits.pending_confirm.length === 0">
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">ไม่มีรายการรอคอนเฟิร์ม</p>
                </div>
            </template>

            <template x-for="item in deposits.pending_confirm" :key="item.id">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-orange-500">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg" x-text="item.customerName"></h3>
                            <p class="text-sm text-gray-600" x-text="'รหัสฝาก: ' + item.depositCode"></p>
                        </div>
                        <span class="bg-orange-100 text-orange-800 text-xs px-3 py-1 rounded-full">
                            รอคอนเฟิร์ม
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div>
                            <span class="text-gray-600">ประเภทเหล้า:</span>
                            <span class="font-semibold ml-1" x-text="item.alcoholType"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">จำนวน:</span>
                            <span class="font-semibold ml-1" x-text="item.quantity + ' ขวด'"></span>
                        </div>
                    </div>

                    <button @click="openConfirmModal(item)"
                        class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition">
                        <i class="fas fa-camera mr-2"></i>อัปโหลดรูปและยืนยัน
                    </button>
                </div>
            </template>
        </div>

        <!-- Tab: รอเบิก (Bar Only) -->
        <div x-show="activeTab === 'pending_withdrawal'" class="space-y-4">
            <!-- Header with Manual Withdrawal Button -->
            <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between">
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-4 w-full sm:flex-1">
                    <div class="flex items-start space-x-3">
                        <div class="bg-purple-500 text-white p-2 rounded-lg">
                            <i class="fas fa-hand-holding-heart text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-purple-900">คำขอเบิก</h3>
                            <p class="text-sm text-purple-700">ลูกค้าขอเบิกเหล้าที่ฝากไว้ผ่าน LINE</p>
                        </div>
                    </div>
                </div>

                <!-- Manual Withdrawal Button -->
                <button @click="openManualWithdrawalModal()"
                        x-show="['staff', 'bar', 'manager', 'owner'].includes(currentUser?.role)"
                        class="w-full sm:w-auto bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center justify-center space-x-2">
                    <i class="fas fa-box-open text-lg"></i>
                    <span>เบิกแบบ Manual</span>
                </button>
            </div>

            <template x-if="withdrawals.pending.length === 0">
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">ไม่มีคำขอเบิก</p>
                </div>
            </template>

            <template x-for="item in withdrawals.pending" :key="item.id">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg" x-text="item.customerName"></h3>
                            <p class="text-sm text-gray-600" x-text="'รหัสฝาก: ' + item.depositCode"></p>
                        </div>
                        <span class="bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded-full">
                            รอเบิก
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div>
                            <span class="text-gray-600">ประเภทเหล้า:</span>
                            <span class="font-semibold ml-1" x-text="item.alcoholType"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">ขอเบิก:</span>
                            <span class="font-semibold ml-1 text-purple-600" x-text="item.requestedQty + ' ขวด'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">คงเหลือ:</span>
                            <span class="font-semibold ml-1" x-text="item.remainingQty + ' ขวด'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">โต๊ะ:</span>
                            <span class="font-semibold ml-1" x-text="item.tableNumber"></span>
                        </div>
                    </div>

                    <button @click="openWithdrawalModal(item)"
                        class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition">
                        <i class="fas fa-check mr-2"></i>ยืนยันเบิก
                    </button>
                </div>
            </template>
        </div>

        <!-- Tab: ฝากสำเร็จ (Bar Only) -->
        <div x-show="activeTab === 'deposited'" class="space-y-4">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-check-circle text-green-600 text-xl mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-green-900">ฝากสำเร็จ</h3>
                        <p class="text-sm text-green-700">รายการที่ฝากอยู่ในร้าน</p>
                    </div>
                </div>
            </div>

            <!-- Search & Filter -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <input type="text" x-model="searchQuery" @input="filterDeposits()"
                    placeholder="ค้นหาชื่อ, เบอร์, รหัสฝาก..." class="w-full px-4 py-2 border rounded-lg">
            </div>

            <template x-if="filteredDeposits.length === 0">
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <i class="fas fa-search text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">ไม่พบรายการ</p>
                </div>
            </template>

            <template x-for="item in filteredDeposits" :key="item.id">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg" x-text="item.customerName"></h3>
                            <p class="text-sm text-gray-600" x-text="'รหัสฝาก: ' + item.depositCode"></p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full">
                            ในร้าน
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div>
                            <span class="text-gray-600">ประเภทเหล้า:</span>
                            <span class="font-semibold ml-1" x-text="item.alcoholType"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">จำนวน:</span>
                            <span class="font-semibold ml-1" x-text="item.quantity + ' ขวด'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">% คงเหลือ:</span>
                            <span class="font-semibold ml-1 text-green-600" x-text="(item.remainingPercent || 100) + '%'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">วันฝาก:</span>
                            <span class="font-semibold ml-1" x-text="formatDate(item.depositDate)"></span>
                        </div>
                        <div class="col-span-2">
                            <span class="text-gray-600">หมดอายุ:</span>
                            <span class="font-semibold ml-1" x-text="formatDate(item.expiryDate)"></span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-2">
                        <!-- Desktop: 2 rows -->
                        <div class="hidden md:block space-y-2">
                            <!-- Row 1: ดูรายละเอียด / ดูรูปภาพ / เบิกเหล้า -->
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="viewDetails(item)"
                                    class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-eye mr-1"></i>ดูรายละเอียด
                                </button>
                                <button @click="viewPhoto(item.photoUrl)"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-image mr-1"></i>ดูรูปภาพ
                                </button>
                                <button @click="openWithdrawForItem(item)"
                                    class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white py-2 px-3 rounded-lg transition text-sm font-semibold">
                                    <i class="fas fa-box-open mr-1"></i>เบิกเหล้า
                                </button>
                            </div>
                            <!-- Row 2: แสดง QR Code / พิมพ์ใบรับ / พิมพ์ป้ายขวด -->
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="showQRCode(item)"
                                    class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-qrcode mr-1"></i>แสดง QR Code
                                </button>
                                <button @click="printReceipt(item, 'customer')"
                                    class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-receipt mr-1"></i>พิมพ์ใบรับ
                                </button>
                                <button @click="printReceipt(item, 'bottle')"
                                    class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-tag mr-1"></i>พิมพ์ป้ายขวด
                                </button>
                            </div>
                        </div>

                        <!-- Mobile: 3 rows -->
                        <div class="md:hidden space-y-2">
                            <!-- Row 1: ดูรายละเอียด / ดูรูปภาพ -->
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="viewDetails(item)"
                                    class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-eye mr-1"></i>ดูรายละเอียด
                                </button>
                                <button @click="viewPhoto(item.photoUrl)"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-image mr-1"></i>ดูรูปภาพ
                                </button>
                            </div>
                            <!-- Row 2: เบิกเหล้า / แสดง QR Code -->
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="openWithdrawForItem(item)"
                                    class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white py-2 px-3 rounded-lg transition text-sm font-semibold">
                                    <i class="fas fa-box-open mr-1"></i>เบิกเหล้า
                                </button>
                                <button @click="showQRCode(item)"
                                    class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-qrcode mr-1"></i>แสดง QR Code
                                </button>
                            </div>
                            <!-- Row 3: พิมพ์ใบรับ / พิมพ์ป้ายขวด -->
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="printReceipt(item, 'customer')"
                                    class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-receipt mr-1"></i>พิมพ์ใบรับ
                                </button>
                                <button @click="printReceipt(item, 'bottle')"
                                    class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded-lg transition text-sm">
                                    <i class="fas fa-tag mr-1"></i>พิมพ์ป้ายขวด
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Tab: ประวัติ -->
        <div x-show="activeTab === 'history'" class="space-y-4">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-history text-gray-600 text-xl mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-gray-900">ประวัติทั้งหมด</h3>
                        <p class="text-sm text-gray-700">รายการที่เบิกแล้ว, หมดอายุ, โอนคลัง</p>
                    </div>
                </div>
            </div>

            <template x-if="deposits.history.length === 0">
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">ไม่มีประวัติ</p>
                </div>
            </template>

            <template x-for="item in deposits.history" :key="item.id">
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-gray-400">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg" x-text="item.customerName"></h3>
                            <p class="text-sm text-gray-600" x-text="'รหัสฝาก: ' + item.depositCode"></p>
                        </div>
                        <span class="bg-gray-200 text-gray-800 text-xs px-3 py-1 rounded-full"
                            x-text="getStatusLabel(item.status)">
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">ประเภทเหล้า:</span>
                            <span class="font-semibold ml-1" x-text="item.alcoholType"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">จำนวน:</span>
                            <span class="font-semibold ml-1" x-text="item.quantity + ' ขวด'"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>

    </main>

    <!-- Modal: Confirm Deposit (Bar) -->
    <div x-show="showConfirmModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
        @click.self="closeConfirmModal()">
        <div class="bg-white rounded-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto" @click.stop>
            <h2 class="text-xl font-bold mb-4">ยืนยันการฝาก</h2>

            <div class="mb-4" x-show="selectedDeposit">
                <p class="text-sm text-gray-600">รหัสฝาก: <span class="font-semibold"
                        x-text="selectedDeposit?.depositCode"></span></p>
            </div>

            <!-- Editable Fields -->
            <div class="space-y-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">ชื่อลูกค้า *</label>
                    <input type="text" x-model="confirmForm.customerName" placeholder="กรอกชื่อ"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">เบอร์โทร *</label>
                    <input type="tel" x-model="confirmForm.customerPhone" placeholder="0xx-xxx-xxxx"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">ชื่อเหล้า *</label>
                    <input type="text"
                           x-model="confirmForm.productName"
                           @input="onConfirmProductChange()"
                           list="confirmProductList"
                           placeholder="พิมพ์หรือเลือกชื่อเหล้า"
                           class="w-full px-3 py-2 border rounded-lg">
                    <datalist id="confirmProductList">
                        <template x-for="product in products" :key="product.name">
                            <option :value="product.name"></option>
                        </template>
                    </datalist>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">หมวดหมู่ *</label>
                    <select x-model="confirmForm.category" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">เลือกหมวดหมู่</option>
                        <template x-for="cat in categories" :key="cat">
                            <option :value="cat" x-text="cat"></option>
                        </template>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">จำนวนขวด *</label>
                        <input type="number" x-model="confirmForm.quantity" min="1" placeholder="จำนวน"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">% คงเหลือ</label>
                        <input type="number" x-model="confirmForm.remainingPercent" min="0" max="100"
                               step="0.1" placeholder="100"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">เบอร์โต๊ะ</label>
                    <input type="text" x-model="confirmForm.tableNumber" placeholder="เช่น A1, B2"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">หมายเหตุ</label>
                    <textarea x-model="confirmForm.notes" rows="2" placeholder="หมายเหตุเพิ่มเติม..."
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
            </div>

            <!-- Photo Section -->
            <div class="border-t pt-4">
                <!-- Show existing photo if available -->
                <div class="mb-4" x-show="selectedDeposit?.photoUrl && !uploadedPhotoPreview">
                    <label class="block text-sm font-medium mb-2">รูปที่ Staff ถ่ายไว้</label>
                    <img :src="selectedDeposit?.photoUrl" class="w-full h-48 object-cover rounded-lg border">
                    <p class="text-xs text-green-600 mt-1">✓ มีรูปแล้ว (ถ่ายใหม่ถ้าต้องการเปลี่ยน)</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        <span x-show="!selectedDeposit?.photoUrl">อัปโหลดรูปขวดเหล้า *</span>
                        <span x-show="selectedDeposit?.photoUrl">ถ่ายรูปใหม่ (ถ้าต้องการ)</span>
                    </label>
                    <input type="file" accept="image/*" @change="handlePhotoUpload($event)"
                        class="w-full px-3 py-2 border rounded-lg text-sm">
                    <p class="text-xs text-gray-500 mt-1">รูปถ่ายขวดเหล้าที่ฝากไว้</p>
                </div>

                <div class="mb-4" x-show="uploadedPhotoPreview">
                    <label class="block text-sm font-medium mb-2">รูปใหม่ที่จะใช้</label>
                    <img :src="uploadedPhotoPreview" class="w-full h-48 object-cover rounded-lg border">
                    <button @click="uploadedPhotoPreview = null; uploadedPhotoFile = null" type="button"
                        class="mt-2 text-red-500 text-sm hover:text-red-600">
                        <i class="fas fa-times mr-1"></i>ยกเลิกรูปใหม่
                    </button>
                </div>
            </div>

            <div class="flex space-x-2 mt-6">
                <button @click="closeConfirmModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition">
                    ยกเลิก
                </button>
                <button @click="confirmDeposit()"
                    :disabled="!confirmForm.customerName || !confirmForm.productName || (!uploadedPhotoFile && !selectedDeposit?.photoUrl)"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-check mr-1"></i>ยืนยันการฝาก
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Process Withdrawal (Bar) -->
    <div x-show="showWithdrawalModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
        @click.self="closeWithdrawalModal()">
        <div class="bg-white rounded-lg max-w-md w-full p-6" @click.stop>
            <h2 class="text-xl font-bold mb-4">ยืนยันการเบิก</h2>

            <div class="mb-4" x-show="selectedWithdrawal">
                <p class="text-sm text-gray-600">ลูกค้า: <span class="font-semibold"
                        x-text="selectedWithdrawal?.customerName"></span></p>
                <p class="text-sm text-gray-600">ขอเบิก: <span class="font-semibold text-purple-600"
                        x-text="selectedWithdrawal?.requestedQty + ' ขวด'"></span></p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">จำนวนที่เบิกจริง</label>
                <input type="number" x-model="actualWithdrawalQty" :max="selectedWithdrawal?.requestedQty" min="1"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">หมายเหตุ (ถ้ามี)</label>
                <textarea x-model="withdrawalNotes" rows="3" placeholder="เช่น เบิกไม่ครบเพราะ..."
                    class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>

            <div class="flex space-x-2">
                <button @click="closeWithdrawalModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition">
                    ยกเลิก
                </button>
                <button @click="processWithdrawal()"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition">
                    ยืนยันเบิก
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Manual Withdrawal (Bar) -->
    <div x-show="showManualWithdrawalModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
        @click.self="closeManualWithdrawalModal()">
        <div class="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto shadow-2xl" @click.stop>
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">เบิกแบบ Manual</h2>
                <button @click="closeManualWithdrawalModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Search Section -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>ค้นหาข้อมูลลูกค้า
                </label>
                <div class="flex gap-2">
                    <input type="text" x-model="manualWithdrawalForm.searchQuery"
                           @keyup.enter="searchDeposit()"
                           placeholder="รหัสฝาก / ชื่อ / เบอร์โทร"
                           class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <button @click="searchDeposit()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all shadow hover:shadow-lg">
                        <i class="fas fa-search mr-2"></i>ค้นหา
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>สามารถค้นหาด้วย รหัสฝาก, ชื่อลูกค้า หรือเบอร์โทรศัพท์
                </p>
            </div>

            <!-- Multiple Deposits List -->
            <div x-show="showDepositList && manualWithdrawalDeposits.length > 0" class="mb-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-800">
                                <i class="fas fa-list mr-2"></i>พบรายการฝาก <span x-text="manualWithdrawalDeposits.length"></span> รายการ
                            </p>
                            <p class="text-xs text-gray-600 mt-1">กรุณาเลือกรายการที่ต้องการเบิก หรือเบิกทั้งหมด</p>
                        </div>
                        <button @click="withdrawAllDeposits()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow hover:shadow-lg">
                            <i class="fas fa-box-open mr-1"></i>เบิกทั้งหมด
                        </button>
                    </div>
                </div>

                <!-- Deposit Cards -->
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <template x-for="deposit in manualWithdrawalDeposits" :key="deposit.id">
                        <div class="bg-white border-2 border-gray-200 hover:border-green-400 rounded-lg p-3 cursor-pointer transition-all hover:shadow-md"
                             @click="selectDeposit(deposit)">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-mono bg-gray-100 px-2 py-0.5 rounded" x-text="deposit.depositCode"></span>
                                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-0.5 rounded-full">
                                            ฝากอยู่
                                        </span>
                                    </div>
                                    <h4 class="font-bold text-gray-800" x-text="deposit.customerName"></h4>
                                    <p class="text-sm text-gray-600" x-text="deposit.customerPhone"></p>
                                    <div class="grid grid-cols-2 gap-2 mt-2 text-xs">
                                        <div>
                                            <span class="text-gray-500">เหล้า:</span>
                                            <span class="font-semibold text-gray-800" x-text="deposit.productName"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">โต๊ะ:</span>
                                            <span class="font-semibold text-gray-800" x-text="deposit.tableNumber || '-'"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="text-xs text-gray-500">คงเหลือ:</span>
                                        <span class="font-bold text-green-600" x-text="deposit.remainingQty + ' ขวด'"></span>
                                    </div>
                                </div>
                                <div class="text-green-600 text-2xl">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Deposit Info (After Search) -->
            <div x-show="manualWithdrawalDeposit && !showDepositList" class="bg-white border-2 border-green-200 rounded-lg p-4 mb-4">
                <!-- Back to List Button (if multiple results exist) -->
                <div x-show="manualWithdrawalDeposits.length > 1" class="mb-3">
                    <button @click="backToDepositList()"
                            class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                        <i class="fas fa-arrow-left"></i>
                        กลับไปดูรายการทั้งหมด (<span x-text="manualWithdrawalDeposits.length"></span> รายการ)
                    </button>
                </div>

                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <p class="text-xs text-gray-500 mb-1">รหัสฝาก: <span class="font-semibold text-gray-700" x-text="manualWithdrawalDeposit?.depositCode"></span></p>
                        <h3 class="font-bold text-lg text-gray-800" x-text="manualWithdrawalDeposit?.customerName"></h3>
                        <p class="text-sm text-gray-600" x-text="manualWithdrawalDeposit?.customerPhone"></p>
                    </div>
                    <span class="bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">
                        ฝากอยู่
                    </span>
                </div>

                <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-gray-600 text-xs mb-1">ชื่อเหล้า</p>
                        <p class="font-semibold text-gray-800" x-text="manualWithdrawalDeposit?.productName"></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-gray-600 text-xs mb-1">หมวดหมู่</p>
                        <p class="font-semibold text-gray-800" x-text="manualWithdrawalDeposit?.category"></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-gray-600 text-xs mb-1">โต๊ะ</p>
                        <p class="font-semibold text-gray-800" x-text="manualWithdrawalDeposit?.tableNumber || '-'"></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-gray-600 text-xs mb-1">จำนวนฝากทั้งหมด</p>
                        <p class="font-semibold text-gray-800" x-text="manualWithdrawalDeposit?.quantity + ' ขวด'"></p>
                    </div>
                </div>

                <!-- Remaining Qty Highlight -->
                <div class="bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-300 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-green-700 font-medium mb-1">จำนวนคงเหลือ</p>
                            <p class="font-bold text-green-600 text-2xl" x-text="manualWithdrawalDeposit?.remainingQty + ' ขวด'"></p>
                        </div>
                        <i class="fas fa-wine-bottle text-green-400 text-4xl"></i>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Form -->
            <div x-show="manualWithdrawalDeposit" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-box-open mr-1"></i>จำนวนที่ต้องการเบิก *
                    </label>
                    <input type="number" x-model="manualWithdrawalForm.quantity"
                           :max="manualWithdrawalDeposit?.remainingQty" min="1"
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">
                        สูงสุด <span x-text="manualWithdrawalDeposit?.remainingQty"></span> ขวด
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-sticky-note mr-1"></i>หมายเหตุ
                    </label>
                    <textarea x-model="manualWithdrawalForm.notes" rows="3"
                              placeholder="เพิ่มหมายเหตุ (ถ้ามี)..."
                              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                </div>
            </div>

            <!-- Role-based Info Banner -->
            <div x-show="manualWithdrawalDeposit" class="mb-4">
                <div x-show="currentUser?.role === 'staff'"
                     class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Staff:</strong> บันทึกคำขอเบิก จะส่งไปยังแถบ "รอเบิก" เพื่อให้ Bar อนุมัติ
                </div>
                <div x-show="['bar', 'manager', 'owner'].includes(currentUser?.role)"
                     class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800">
                    <i class="fas fa-check-circle mr-2"></i>
                    <strong>Bar:</strong> สามารถเบิกได้ทันที ระบบจะบันทึกเป็นเบิกสำเร็จ
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 mt-6">
                <button @click="closeManualWithdrawalModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-medium transition-all">
                    ยกเลิก
                </button>
                <button @click="submitManualWithdrawal()"
                        :disabled="!manualWithdrawalDeposit"
                        :class="{
                            'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700': currentUser?.role === 'staff',
                            'bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700': ['bar', 'manager', 'owner'].includes(currentUser?.role)
                        }"
                        class="flex-1 text-white py-3 rounded-lg font-semibold transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                    <i :class="currentUser?.role === 'staff' ? 'fas fa-paper-plane' : 'fas fa-check'" class="mr-2"></i>
                    <span x-text="currentUser?.role === 'staff' ? 'ส่งคำขอเบิก' : 'ยืนยันเบิก'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Walk-in Deposit (Staff) -->
    <div x-show="showWalkInModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
        @click.self="closeWalkInModal()">
        <div class="bg-white rounded-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto" @click.stop>
            <h2 class="text-xl font-bold mb-4">สร้างรายการฝาก (Walk-in)</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">ชื่อลูกค้า *</label>
                    <input type="text" x-model="walkInForm.customerName" placeholder="กรอกชื่อ"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">เบอร์โทร *</label>
                    <input type="tel" x-model="walkInForm.customerPhone" placeholder="0xx-xxx-xxxx"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 flex items-center justify-between">
                        <span>รายชื่อเหล้า *</span>
                        <button @click="loadProducts(true)" type="button"
                                class="text-blue-500 hover:text-blue-600 text-xs flex items-center"
                                :disabled="loadingProducts">
                            <i class="fas fa-sync-alt mr-1" :class="{ 'fa-spin': loadingProducts }"></i>
                            รีเฟรช
                        </button>
                    </label>
                    <select x-model="walkInForm.productName" @change="onProductChange()"
                            class="w-full px-3 py-2 border rounded-lg">
                        <option value="">เลือกรายชื่อเหล้า</option>
                        <template x-for="product in products" :key="product.name">
                            <option :value="product.name" x-text="product.name"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">หมวดหมู่ *</label>
                    <input type="text" x-model="walkInForm.category" readonly
                        class="w-full px-3 py-2 border rounded-lg bg-gray-100"
                        placeholder="เลือกเหล้าก่อน จะแสดงหมวดหมู่อัตโนมัติ">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">จำนวนขวด *</label>
                        <input type="number" x-model="walkInForm.quantity" min="1" placeholder="จำนวน"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">% คงเหลือ</label>
                        <input type="number" x-model="walkInForm.remainingPercent" min="0" max="100"
                               step="0.1" placeholder="100"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">โต๊ะ</label>
                    <input type="text" x-model="walkInForm.tableNumber" placeholder="เลขโต๊ะ"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">หมายเหตุ</label>
                    <textarea x-model="walkInForm.notes" rows="3" placeholder="หมายเหตุเพิ่มเติม..."
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>

                <!-- Photo Upload (Optional) -->
                <div>
                    <label class="block text-sm font-medium mb-2">รูปขวดเหล้า (ถ้ามี)</label>
                    <input type="file" accept="image/*" @change="handleWalkInPhotoUpload($event)"
                        class="w-full px-3 py-2 border rounded-lg text-sm">
                    <p class="text-xs text-gray-500 mt-1">ถ่ายรูปเลย หรือให้ Bar ถ่ายทีหลังก็ได้</p>
                </div>

                <!-- Photo Preview -->
                <div x-show="walkInPhotoPreview" class="mb-4">
                    <img :src="walkInPhotoPreview" class="w-full h-48 object-cover rounded-lg border">
                    <button @click="walkInPhotoPreview = null; walkInPhotoFile = null" type="button"
                        class="mt-2 text-red-500 text-sm hover:text-red-600">
                        <i class="fas fa-times mr-1"></i>ลบรูป
                    </button>
                </div>
            </div>

            <div class="flex space-x-2 mt-6">
                <button @click="closeWalkInModal()" type="button"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition">
                    ยกเลิก
                </button>
                <button @click="submitWalkIn()" type="button"
                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition">
                    <i class="fas fa-save mr-1"></i>บันทึก
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Show QR Code for Customer (No Printer) -->
    <div x-show="showQRModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto"
        @click.self="closeQRModal()">
        <div class="bg-white rounded-lg max-w-lg w-full p-8 text-center my-auto max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-green-600 mb-2">
                    <i class="fas fa-check-circle"></i> ฝากเหล้าสำเร็จ
                </h2>
                <p class="text-gray-600">ให้ลูกค้าสแกน QR Code ด้านล่าง</p>
            </div>

            <!-- Deposit Code -->
            <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-6 mb-6">
                <p class="text-sm text-gray-600 mb-2">รหัสฝาก</p>
                <p class="text-4xl font-bold text-purple-600 tracking-wider" x-text="selectedDepositForQR?.depositCode">
                </p>
            </div>

            <!-- Customer Info -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600">ชื่อลูกค้า:</span>
                        <p class="font-semibold" x-text="selectedDepositForQR?.customerName"></p>
                    </div>
                    <div>
                        <span class="text-gray-600">เบอร์โทร:</span>
                        <p class="font-semibold" x-text="selectedDepositForQR?.customerPhone"></p>
                    </div>
                    <div>
                        <span class="text-gray-600">ประเภทเหล้า:</span>
                        <p class="font-semibold" x-text="selectedDepositForQR?.alcoholType"></p>
                    </div>
                    <div>
                        <span class="text-gray-600">จำนวน:</span>
                        <p class="font-semibold" x-text="(selectedDepositForQR?.quantity || 0) + ' ขวด'"></p>
                    </div>
                </div>
            </div>

            <!-- QR Code -->
            <div class="mb-6">
                <div class="inline-block p-4 bg-white border-4 border-gray-300 rounded-xl">
                    <img :src="qrCodeImageUrl" alt="QR Code" class="w-64 h-64 mx-auto" x-show="qrCodeImageUrl">
                    <div x-show="!qrCodeImageUrl" class="w-64 h-64 flex items-center justify-center">
                        <p class="text-gray-400">ไม่มี QR Code</p>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>วิธีใช้งาน:</strong>
                </p>
                <ol class="text-sm text-blue-700 text-left ml-6 space-y-1 list-decimal">
                    <li>ให้ลูกค้าเปิด LINE แล้วสแกน QR Code</li>
                    <li>Add Friend LINE OA ของร้าน</li>
                    <li>ลูกค้าจะสามารถขอเบิกเหล้าผ่าน LINE ได้ทันที</li>
                </ol>
            </div>

            <!-- LINE ID -->
            <p class="text-sm text-gray-600 mb-6">
                หรือค้นหา LINE ID: <strong x-text="lineId"></strong>
            </p>

            <!-- Close Button -->
            <button @click="closeQRModal()"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg transition font-semibold">
                <i class="fas fa-times mr-2"></i>ปิด
            </button>
        </div>
    </div>

    <!-- Modal: Deposit Details -->
    <div x-show="showDetailsModal" x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
        @click.self="closeDetailsModal()">
        <div class="bg-white rounded-lg max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">รายละเอียดการฝาก</h2>
                <button @click="closeDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <template x-if="selectedDepositForDetails">
                <div class="space-y-4">
                    <!-- Deposit Code -->
                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 rounded-lg text-center">
                        <div class="text-sm opacity-90">รหัสการฝาก</div>
                        <div class="text-2xl font-bold mt-1" x-text="selectedDepositForDetails.depositCode"></div>
                    </div>

                    <!-- Customer Info -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-user mr-2 text-blue-500"></i>ข้อมูลลูกค้า
                        </h3>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">ชื่อ:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.customerName"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">เบอร์โทร:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.customerPhone"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">โต๊ะ:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.tableNumber || '-'"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">VIP:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.isVip ? 'ใช่' : 'ไม่'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-wine-bottle mr-2 text-orange-500"></i>ข้อมูลสินค้า
                        </h3>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="col-span-2">
                                <span class="text-gray-600">ชื่อเหล้า:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.alcoholType || selectedDepositForDetails.productName"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">หมวดหมู่:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.category || '-'"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">จำนวน:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.quantity + ' ขวด'"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">% คงเหลือ:</span>
                                <span class="font-semibold ml-2" x-text="(selectedDepositForDetails.remainingPercent || 100) + '%'"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">ปริมาณคงเหลือ:</span>
                                <span class="font-semibold ml-2" x-text="selectedDepositForDetails.remainingQty || '-'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Date Info with Progress Bar -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-calendar mr-2 text-green-500"></i>วันที่และอายุการฝาก
                        </h3>
                        <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                            <div>
                                <span class="text-gray-600">วันที่ฝาก:</span>
                                <span class="font-semibold ml-2" x-text="formatDateTime(selectedDepositForDetails.depositDate)"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">วันหมดอายุ:</span>
                                <span class="font-semibold ml-2" x-text="formatDate(selectedDepositForDetails.expiryDate)"></span>
                            </div>
                        </div>

                        <!-- Days Remaining with Progress Bar -->
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">เหลือเวลาอีก:</span>
                                <span class="text-sm font-bold"
                                      :class="{
                                          'text-green-600': getDaysRemaining(selectedDepositForDetails.expiryDate) > 14,
                                          'text-yellow-600': getDaysRemaining(selectedDepositForDetails.expiryDate) > 7 && getDaysRemaining(selectedDepositForDetails.expiryDate) <= 14,
                                          'text-red-600': getDaysRemaining(selectedDepositForDetails.expiryDate) <= 7
                                      }"
                                      x-text="getDaysRemaining(selectedDepositForDetails.expiryDate) + ' วัน'">
                                </span>
                            </div>
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-500"
                                     :class="{
                                         'bg-gradient-to-r from-green-400 to-green-600': getDaysRemaining(selectedDepositForDetails.expiryDate) > 14,
                                         'bg-gradient-to-r from-yellow-400 to-yellow-600': getDaysRemaining(selectedDepositForDetails.expiryDate) > 7 && getDaysRemaining(selectedDepositForDetails.expiryDate) <= 14,
                                         'bg-gradient-to-r from-red-400 to-red-600': getDaysRemaining(selectedDepositForDetails.expiryDate) <= 7
                                     }"
                                     :style="`width: ${getExpiryProgress(selectedDepositForDetails.expiryDate, selectedDepositForDetails.depositDate)}%`">
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>ฝาก</span>
                                <span>หมดอายุ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-purple-500"></i>สถานะ
                        </h3>
                        <div class="text-sm">
                            <span class="text-gray-600">สถานะปัจจุบัน:</span>
                            <span class="font-semibold ml-2">
                                <template x-if="selectedDepositForDetails.status === 'in_store'">
                                    <span class="text-green-600">ฝากอยู่ในร้าน</span>
                                </template>
                                <template x-if="selectedDepositForDetails.status === 'withdrawn'">
                                    <span class="text-blue-600">เบิกแล้ว</span>
                                </template>
                                <template x-if="selectedDepositForDetails.status === 'expired'">
                                    <span class="text-red-600">หมดอายุ</span>
                                </template>
                                <template x-if="selectedDepositForDetails.status === 'transferred'">
                                    <span class="text-orange-600">โอนคลังกลาง</span>
                                </template>
                            </span>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div x-show="selectedDepositForDetails.notes" class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <h3 class="font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-sticky-note mr-2 text-yellow-600"></i>หมายเหตุ
                        </h3>
                        <p class="text-sm text-gray-700" x-text="selectedDepositForDetails.notes"></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-2 pt-4 border-t">
                        <button @click="viewPhoto(selectedDepositForDetails.photoUrl)"
                                x-show="selectedDepositForDetails.photoUrl"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition">
                            <i class="fas fa-image mr-2"></i>ดูรูปภาพ
                        </button>
                        <button @click="closeDetailsModal()"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition">
                            <i class="fas fa-times mr-2"></i>ปิด
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Login Modal -->
    <template x-if="!isLoggedIn">
        <div class="login-container">
            <div class="login-card">
                <div class="icon-wrapper">
                    <i class="fas fa-lock fa-2x"></i>
                </div>
                <h2>กรุณาเข้าสู่ระบบ</h2>
                <p>เพื่อเข้าถึงระบบจัดการฝาก/เบิกเหล้า</p>

                <div x-show="authError" class="error-alert">
                    <strong>เกิดข้อผิดพลาด:</strong>
                    <span x-text="authError"></span>
                </div>

                <form @submit.prevent="login()">
                    <div class="form-group">
                        <label for="username">ชื่อผู้ใช้</label>
                        <input type="text" id="username" x-model="loginForm.username"
                               @input="authError = null" required>
                    </div>
                    <div class="form-group">
                        <label for="password">รหัสผ่าน</label>
                        <input type="password" id="password" x-model="loginForm.password"
                               @input="authError = null" required>
                    </div>
                    <button type="submit" class="btn-login" :disabled="loginForm.loading">
                        <span x-show="!loginForm.loading">
                            <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ
                        </span>
                        <span x-show="loginForm.loading">
                            <i class="fas fa-spinner fa-spin mr-2"></i>กำลังตรวจสอบ...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </template>

    <script>
    // Define depositApp globally so Alpine.js can access it
    window.depositApp = function () {
        return {
            // Authentication State
            isLoggedIn: false,
            showLoginModal: false,
            loginForm: {
                username: '',
                password: '',
                loading: false
            },
            authError: null,

            // State
            currentUser: null,
            currentStoreId: null,
            currentStoreName: 'กำลังโหลด...',
            activeTab: 'new_requests',
            visibleTabs: [],

            // Print Settings (from store config)
            printSettings: {
                receiptHeaderText: 'ใบรับฝากเหล้า', // Receipt header text
                receiptFooterLine1: 'กรุณาเก็บใบรับนี้ไว้เป็นหลักฐาน', // Footer line 1
                receiptFooterLine2: 'แสดงใบรับหรือรหัสเมื่อต้องการเบิก' // Footer line 2
            },

            // Data
            deposits: {
                new_requests: [],
                pending_confirm: [],
                deposited: [],
                history: []
            },
            withdrawals: {
                pending: []
            },

            // Search & Filter
            searchQuery: '',
            filteredDeposits: [],

            // Modals
            showConfirmModal: false,
            showWithdrawalModal: false,
            showManualWithdrawalModal: false,
            showWalkInModal: false,
            showQRModal: false,
            showDetailsModal: false,
            selectedDeposit: null,
            selectedWithdrawal: null,
            selectedDepositForQR: null,
            selectedDepositForDetails: null,
            qrCodeImageUrl: '',
            lineId: '',
            uploadedPhotoFile: null,
            uploadedPhotoPreview: null,
            actualWithdrawalQty: 1,
            withdrawalNotes: '',

            // Manual Withdrawal Form
            manualWithdrawalForm: {
                searchQuery: '',
                quantity: 1,
                notes: ''
            },
            manualWithdrawalDeposit: null,
            manualWithdrawalDeposits: [], // Array for multiple results
            showDepositList: false, // Flag to show deposit list

            // Walk-in Form
            walkInForm: {
                customerName: '',
                customerPhone: '',
                productName: '',
                category: '',
                quantity: 1,
                remainingPercent: null,
                tableNumber: '',
                notes: ''
            },
            walkInPhotoFile: null,

            // Confirm Form (for editing before confirmation)
            confirmForm: {
                customerName: '',
                customerPhone: '',
                productName: '',
                category: '',
                quantity: 1,
                remainingPercent: null,
                tableNumber: '',
                notes: ''
            },
            walkInPhotoPreview: null,

            // Products cache
            products: [],
            categories: [],
            loadingProducts: false,

            // Initialize
            async init() {
                try {
                    // Get store ID from server-side template
                    this.currentStoreId = window.SERVER_STORE_ID || null;

                    console.log('=== DEPOSIT INIT ===');
                    console.log('Store ID from server:', this.currentStoreId);

                    // Validate store ID
                    if (!this.currentStoreId) {
                        console.error('❌ Missing store ID');
                        Swal.fire({
                            icon: 'error',
                            title: 'ข้อผิดพลาด',
                            text: 'ไม่พบรหัสสาขา กรุณาเข้าผ่านหน้าหลัก',
                            confirmButtonText: 'ตกลง'
                        });
                        return;
                    }

                    // Get user session
                    const loggedIn = await this.getUserSession();

                    // Only load data if logged in
                    if (loggedIn) {
                        console.log('✅ User logged in:', this.currentUser?.username);
                        console.log('Store Name:', this.currentStoreName);

                        // Set visible tabs based on role
                        this.setVisibleTabs();

                        // Set default active tab
                        if (this.visibleTabs.length > 0) {
                            this.activeTab = this.visibleTabs[0].id;
                        }

                        // Load data
                        await this.loadAllData();
                    }
                } catch (error) {
                    console.error('❌ Init error:', error);
                    Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้', 'error');
                }
            },

            async getUserSession() {
                console.log('🔐 Checking user session...');
                const session = localStorage.getItem('depositSession');

                if (session) {
                    try {
                        const user = JSON.parse(session);
                        console.log('✅ Found session:', {
                            username: user.username,
                            role: user.role,
                            storesCount: user.stores?.length || 0
                        });

                        this.currentUser = user;
                        this.isLoggedIn = true;

                        // Find store name from stores array using currentStoreId
                        if (user.stores && user.stores.length > 0) {
                            console.log('📋 Available stores:', user.stores.map(s => ({ id: s.store_id, name: s.name })));
                            const currentStore = user.stores.find(s => s.store_id === this.currentStoreId);

                            if (currentStore) {
                                this.currentStoreName = currentStore.name;
                                console.log('✅ Store found:', currentStore.name);

                                // Load print text settings from store config
                                if (currentStore.receipt_header_text) {
                                    this.printSettings.receiptHeaderText = currentStore.receipt_header_text;
                                }
                                if (currentStore.receipt_footer_line1) {
                                    this.printSettings.receiptFooterLine1 = currentStore.receipt_footer_line1;
                                }
                                if (currentStore.receipt_footer_line2) {
                                    this.printSettings.receiptFooterLine2 = currentStore.receipt_footer_line2;
                                }
                                console.log('📄 Print settings loaded:', this.printSettings);
                            } else {
                                this.currentStoreName = 'ไม่พบสาขา';
                                console.warn('⚠️  Store not found in user stores list');
                            }
                        } else {
                            this.currentStoreName = 'สาขาทดสอบ';
                            console.warn('⚠️  No stores in user data');
                        }

                        return true;
                    } catch (error) {
                        console.error('❌ Error parsing session:', error);
                        localStorage.removeItem('depositSession');
                        this.isLoggedIn = false;
                        this.showLoginModal = true;
                        return false;
                    }
                } else {
                    console.log('❌ No session found');
                    this.isLoggedIn = false;
                    this.showLoginModal = true;
                    return false;
                }
            },

            setVisibleTabs() {
                const role = this.currentUser?.role;

                const allTabs = {
                    staff: [
                        { id: 'new_requests', label: 'รายการใหม่ (LINE)', badge: 0 },
                        { id: 'pending_confirm', label: 'รอบาร์ยืนยัน', badge: 0 }
                    ],
                    bar: [
                        { id: 'pending_confirm', label: 'รอยืนยัน', badge: 0 },
                        { id: 'pending_withdrawal', label: 'รอเบิก', badge: 0 },
                        { id: 'deposited', label: 'ฝากสำเร็จ', badge: 0 },
                        { id: 'history', label: 'ประวัติ', badge: 0 }
                    ],
                    manager: [
                        { id: 'new_requests', label: 'รายการใหม่ (LINE)', badge: 0 },
                        { id: 'pending_confirm', label: 'รอบาร์ยืนยัน', badge: 0 },
                        { id: 'pending_withdrawal', label: 'รอเบิก', badge: 0 },
                        { id: 'deposited', label: 'ฝากสำเร็จ', badge: 0 },
                        { id: 'history', label: 'ประวัติ', badge: 0 }
                    ]
                };

                this.visibleTabs = allTabs[role] || allTabs.manager;
            },

            async loadAllData() {
                console.log('📊 Loading deposit data for store:', this.currentStoreId);

                if (!this.currentStoreId) {
                    console.error('❌ Cannot load data: Store ID is null');
                    return;
                }

                try {
                    // Call backend to get deposit data
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .getDepositData(this.currentStoreId);
                    });

                    console.log('📥 Backend data response:', result);

                    // Check if result is valid
                    if (!result) {
                        console.warn('⚠️  Backend returned null/undefined');
                        throw new Error('ไม่ได้รับข้อมูลจาก server');
                    }

                    if (result.success) {
                        this.deposits = result.deposits || {
                            new_requests: [],
                            pending_confirm: [],
                            deposited: [],
                            history: []
                        };
                        this.withdrawals = result.withdrawals || { pending: [] };
                        this.filteredDeposits = this.deposits.deposited || [];
                        this.updateBadges();

                        console.log('✅ Data loaded:', {
                            new_requests: this.deposits.new_requests?.length || 0,
                            pending_confirm: this.deposits.pending_confirm?.length || 0,
                            deposited: this.deposits.deposited?.length || 0,
                            history: this.deposits.history?.length || 0,
                            withdrawals: this.withdrawals.pending?.length || 0
                        });
                    } else {
                        console.error('❌ Backend returned error:', result.message);
                        throw new Error(result.message || 'ไม่สามารถโหลดข้อมูลได้');
                    }
                } catch (error) {
                    console.error('❌ Error loading deposit data:', error);
                    // Initialize empty arrays on error
                    this.deposits.new_requests = [];
                    this.deposits.pending_confirm = [];
                    this.deposits.deposited = [];
                    this.deposits.history = [];
                    this.withdrawals.pending = [];
                    this.filteredDeposits = [];
                    this.updateBadges();
                }
            },

            updateBadges() {
                this.visibleTabs.forEach(tab => {
                    switch (tab.id) {
                        case 'new_requests':
                            tab.badge = this.deposits.new_requests.length;
                            break;
                        case 'pending_confirm':
                            tab.badge = this.deposits.pending_confirm.length;
                            break;
                        case 'pending_withdrawal':
                            tab.badge = this.withdrawals.pending.length;
                            break;
                    }
                });
            },

            filterDeposits() {
                if (!this.searchQuery) {
                    this.filteredDeposits = this.deposits.deposited;
                    return;
                }

                const query = this.searchQuery.toLowerCase();
                this.filteredDeposits = this.deposits.deposited.filter(item =>
                    item.customerName.toLowerCase().includes(query) ||
                    item.customerPhone.includes(query) ||
                    item.depositCode.toLowerCase().includes(query)
                );
            },

            async openConfirmModal(item) {
                this.selectedDeposit = item;
                this.uploadedPhotoFile = null;
                this.uploadedPhotoPreview = null;

                // Load products if not loaded
                if (this.products.length === 0) {
                    await this.loadProducts();
                }

                // Populate confirmForm with deposit data
                // Note: alcoholType is actually product_name from backend
                this.confirmForm = {
                    customerName: item.customerName || '',
                    customerPhone: item.customerPhone || '',
                    productName: item.alcoholType || item.productName || '',
                    category: item.category || '',
                    quantity: item.quantity || 1,
                    remainingPercent: item.remainingPercent || null,
                    tableNumber: item.tableNumber || '',
                    notes: item.notes || ''
                };

                this.showConfirmModal = true;
            },

            onConfirmProductChange() {
                // Auto-fill category when product is selected
                const selectedProduct = this.products.find(p => p.name === this.confirmForm.productName);
                if (selectedProduct) {
                    this.confirmForm.category = selectedProduct.category;
                }
            },

            closeConfirmModal() {
                this.showConfirmModal = false;
                this.selectedDeposit = null;
                this.uploadedPhotoFile = null;
                this.uploadedPhotoPreview = null;
            },

            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.uploadedPhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.uploadedPhotoPreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            async confirmDeposit() {
                // Validation
                if (!this.confirmForm.customerName || !this.confirmForm.productName) {
                    Swal.fire('Error', 'กรุณากรอกข้อมูลที่จำเป็น', 'error');
                    return;
                }

                // Photo required only if no existing photo
                if (!this.uploadedPhotoFile && !this.selectedDeposit?.photoUrl) {
                    Swal.fire('Error', 'กรุณาอัปโหลดรูปภาพ', 'error');
                    return;
                }

                try {
                    Swal.fire({
                        title: 'กำลังบันทึก...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const confirmData = {
                        depositId: this.selectedDeposit.id,
                        storeId: this.currentStoreId,
                        customerName: this.confirmForm.customerName,
                        customerPhone: this.confirmForm.customerPhone,
                        productName: this.confirmForm.productName,
                        category: this.confirmForm.category,
                        quantity: parseInt(this.confirmForm.quantity),
                        remainingPercent: this.confirmForm.remainingPercent ? parseFloat(this.confirmForm.remainingPercent) : null,
                        tableNumber: this.confirmForm.tableNumber,
                        notes: this.confirmForm.notes,
                        photoBase64: this.uploadedPhotoPreview || null, // New photo if uploaded
                        existingPhotoUrl: this.selectedDeposit.photoUrl || null // Keep existing if no new photo
                    };

                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .confirmDepositWithEdits(confirmData);
                    });

                    if (result.success) {
                        // Close modal first
                        this.closeConfirmModal();

                        // Reload data
                        await this.loadAllData();

                        // Show success with print options
                        const printResult = await Swal.fire({
                            icon: 'success',
                            title: 'ยืนยันการฝากสำเร็จ!',
                            html: `
                                <p class="mb-4">รหัสฝาก: <strong>${result.depositCode || this.selectedDeposit.depositCode}</strong></p>
                                <p class="text-sm text-gray-600 mb-3">คุณต้องการพิมพ์ใบเสร็จหรือป้ายแปะขวดหรือไม่?</p>
                            `,
                            showDenyButton: true,
                            showCancelButton: true,
                            confirmButtonText: '<i class="fas fa-receipt mr-2"></i>พิมพ์ใบรับ',
                            denyButtonText: '<i class="fas fa-tag mr-2"></i>พิมพ์ป้ายขวด',
                            cancelButtonText: 'ไม่พิมพ์',
                            confirmButtonColor: '#8b5cf6',
                            denyButtonColor: '#f97316'
                        });

                        // Get the confirmed deposit from the deposited list
                        const confirmedDeposit = this.deposits.deposited.find(d =>
                            d.depositCode === (result.depositCode || this.selectedDeposit.depositCode)
                        );

                        if (printResult.isConfirmed && confirmedDeposit) {
                            // Print customer receipt
                            this.printReceipt(confirmedDeposit, 'customer');
                        } else if (printResult.isDenied && confirmedDeposit) {
                            // Print bottle label
                            this.printReceipt(confirmedDeposit, 'bottle');
                        }
                    } else {
                        throw new Error(result.message || 'ไม่สามารถยืนยันการฝากได้');
                    }

                } catch (error) {
                    console.error('❌ Error confirming deposit:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message || 'ไม่สามารถยืนยันการฝากได้'
                    });
                }
            },

            openWithdrawalModal(item) {
                this.selectedWithdrawal = item;
                this.actualWithdrawalQty = item.requestedQty;
                this.withdrawalNotes = '';
                this.showWithdrawalModal = true;
            },

            closeWithdrawalModal() {
                this.showWithdrawalModal = false;
                this.selectedWithdrawal = null;
            },

            async processWithdrawal() {
                Swal.fire('สำเร็จ', 'เบิกเรียบร้อยแล้ว', 'success');
                this.closeWithdrawalModal();
                this.loadAllData();
            },

            openManualWithdrawalModal() {
                this.manualWithdrawalForm = {
                    searchQuery: '',
                    quantity: 1,
                    notes: ''
                };
                this.manualWithdrawalDeposit = null;
                this.manualWithdrawalDeposits = [];
                this.showDepositList = false;
                this.showManualWithdrawalModal = true;
            },

            closeManualWithdrawalModal() {
                this.showManualWithdrawalModal = false;
                this.manualWithdrawalForm = {
                    searchQuery: '',
                    quantity: 1,
                    notes: ''
                };
                this.manualWithdrawalDeposit = null;
                this.manualWithdrawalDeposits = [];
                this.showDepositList = false;
            },

            selectDeposit(deposit) {
                this.manualWithdrawalDeposit = deposit;
                this.manualWithdrawalForm.quantity = deposit.remainingQty || 1;
                this.showDepositList = false;
            },

            openWithdrawForItem(item) {
                // Convert item to deposit format for modal
                const deposit = {
                    id: item.id,
                    depositCode: item.depositCode,
                    customerName: item.customerName,
                    customerPhone: item.customerPhone,
                    productName: item.alcoholType,
                    category: item.category,
                    quantity: item.quantity,
                    remainingQty: item.remainingQty || item.quantity,
                    tableNumber: item.tableNumber,
                    depositDate: item.depositDate,
                    expiryDate: item.expiryDate
                };

                this.manualWithdrawalForm = {
                    searchQuery: '',
                    quantity: deposit.remainingQty || 1,
                    notes: ''
                };
                this.manualWithdrawalDeposit = deposit;
                this.manualWithdrawalDeposits = [deposit];
                this.showDepositList = false;
                this.showManualWithdrawalModal = true;
            },

            backToDepositList() {
                this.manualWithdrawalDeposit = null;
                this.showDepositList = true;
            },

            async withdrawAllDeposits() {
                if (!this.manualWithdrawalDeposits || this.manualWithdrawalDeposits.length === 0) {
                    Swal.fire('Error', 'ไม่มีรายการฝากที่ต้องการเบิก', 'error');
                    return;
                }

                const result = await Swal.fire({
                    title: 'ยืนยันการเบิกทั้งหมด?',
                    html: `คุณต้องการเบิกทั้งหมด ${this.manualWithdrawalDeposits.length} รายการใช่หรือไม่?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#6b7280'
                });

                if (!result.isConfirmed) return;

                try {
                    Swal.fire({
                        title: 'กำลังดำเนินการ...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    let successCount = 0;
                    let failCount = 0;
                    const errors = [];

                    for (const deposit of this.manualWithdrawalDeposits) {
                        try {
                            const withdrawalData = {
                                depositId: deposit.id,
                                storeId: this.currentStoreId,
                                quantity: deposit.remainingQty || 1,
                                notes: this.manualWithdrawalForm.notes || 'เบิกทั้งหมด',
                                requestedBy: this.currentUser.username,
                                role: this.currentUser.role
                            };

                            const withdrawResult = await new Promise((resolve, reject) => {
                                google.script.run
                                    .withSuccessHandler(resolve)
                                    .withFailureHandler(reject)
                                    .createManualWithdrawal(withdrawalData);
                            });

                            if (withdrawResult.success) {
                                successCount++;
                            } else {
                                failCount++;
                                errors.push(`${deposit.depositCode}: ${withdrawResult.message}`);
                            }
                        } catch (error) {
                            failCount++;
                            errors.push(`${deposit.depositCode}: ${error.message}`);
                        }
                    }

                    Swal.close();

                    if (failCount === 0) {
                        Swal.fire({
                            icon: 'success',
                            title: 'เบิกสำเร็จ',
                            html: `เบิกทั้งหมด ${successCount} รายการสำเร็จ`,
                            timer: 2000
                        });
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'ดำเนินการเสร็จสิ้น',
                            html: `สำเร็จ: ${successCount} รายการ<br>ล้มเหลว: ${failCount} รายการ<br><br>${errors.join('<br>')}`,
                        });
                    }

                    this.closeManualWithdrawalModal();
                    await this.loadAllData();

                } catch (error) {
                    console.error('Withdraw all error:', error);
                    Swal.fire('Error', 'ไม่สามารถดำเนินการได้', 'error');
                }
            },

            async searchDeposit() {
                if (!this.manualWithdrawalForm.searchQuery) {
                    Swal.fire('Error', 'กรุณากรอกข้อมูลที่ต้องการค้นหา', 'error');
                    return;
                }

                try {
                    Swal.fire({
                        title: 'กำลังค้นหา...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .searchDepositForWithdrawal(this.currentStoreId, this.manualWithdrawalForm.searchQuery);
                    });

                    Swal.close();

                    if (result.success && result.deposits && result.deposits.length > 0) {
                        if (result.deposits.length === 1) {
                            // Single result - show directly
                            this.manualWithdrawalDeposit = result.deposits[0];
                            this.manualWithdrawalForm.quantity = result.deposits[0].remainingQty || 1;
                            this.showDepositList = false;
                        } else {
                            // Multiple results - show list
                            this.manualWithdrawalDeposits = result.deposits;
                            this.showDepositList = true;
                            this.manualWithdrawalDeposit = null;
                        }
                    } else {
                        Swal.fire('ไม่พบข้อมูล', result.message || 'ไม่พบรหัสฝากนี้หรือเบิกหมดแล้ว', 'warning');
                        this.manualWithdrawalDeposit = null;
                        this.manualWithdrawalDeposits = [];
                        this.showDepositList = false;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    Swal.fire('Error', 'ไม่สามารถค้นหาข้อมูลได้', 'error');
                }
            },

            async submitManualWithdrawal() {
                if (!this.manualWithdrawalDeposit) {
                    Swal.fire('Error', 'กรุณาค้นหารหัสฝากก่อน', 'error');
                    return;
                }

                if (!this.manualWithdrawalForm.quantity || this.manualWithdrawalForm.quantity <= 0) {
                    Swal.fire('Error', 'กรุณากรอกจำนวนที่ต้องการเบิก', 'error');
                    return;
                }

                const isStaff = this.currentUser?.role === 'staff';
                const isBar = ['bar', 'manager', 'owner'].includes(this.currentUser?.role);

                try {
                    Swal.fire({
                        title: 'กำลังบันทึก...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const withdrawalData = {
                        depositId: this.manualWithdrawalDeposit.id,
                        storeId: this.currentStoreId,
                        quantity: parseInt(this.manualWithdrawalForm.quantity),
                        notes: this.manualWithdrawalForm.notes,
                        requestedBy: this.currentUser.username,
                        role: this.currentUser.role
                    };

                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .createManualWithdrawal(withdrawalData);
                    });

                    if (result.success) {
                        const message = isStaff
                            ? 'บันทึกคำขอเบิกสำเร็จ จะแสดงในแถบ "รอเบิก"'
                            : 'เบิกเรียบร้อยแล้ว';

                        Swal.fire({
                            icon: 'success',
                            title: 'สำเร็จ',
                            text: message,
                            timer: 2000
                        });
                        this.closeManualWithdrawalModal();
                        await this.loadAllData();
                    } else {
                        throw new Error(result.message || 'ไม่สามารถดำเนินการได้');
                    }
                } catch (error) {
                    console.error('Manual withdrawal error:', error);
                    Swal.fire('Error', error.message || 'ไม่สามารถดำเนินการได้', 'error');
                }
            },

            async loadProducts(forceRefresh = false) {
                const CACHE_KEY = 'productsCache';
                const CACHE_TIMESTAMP_KEY = 'productsCacheTimestamp';
                const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

                try {
                    // Check cache first
                    if (!forceRefresh) {
                        const cachedData = localStorage.getItem(CACHE_KEY);
                        const cacheTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);

                        if (cachedData && cacheTimestamp) {
                            const age = Date.now() - parseInt(cacheTimestamp);
                            if (age < CACHE_DURATION) {
                                const data = JSON.parse(cachedData);
                                this.products = data.products || [];
                                this.categories = data.categories || [];
                                return;
                            }
                        }
                    }

                    // Load from backend
                    this.loadingProducts = true;
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .getProductsForDeposit(this.currentStoreId);
                    });

                    if (result.success) {
                        this.products = result.products || [];
                        this.categories = result.categories || [];

                        // Save to cache
                        localStorage.setItem(CACHE_KEY, JSON.stringify({
                            products: this.products,
                            categories: this.categories
                        }));
                        localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                    }
                } catch (error) {
                    console.error('Load products error:', error);
                } finally {
                    this.loadingProducts = false;
                }
            },

            onProductChange() {
                // Auto-fill category when product is selected
                const selectedProduct = this.products.find(p => p.name === this.walkInForm.productName);
                if (selectedProduct) {
                    this.walkInForm.category = selectedProduct.category;
                }
            },

            handleWalkInPhotoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.walkInPhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.walkInPhotoPreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            async openWalkInModal() {
                // Load products if not loaded
                if (this.products.length === 0) {
                    await this.loadProducts();
                }

                this.walkInForm = {
                    customerName: '',
                    customerPhone: '',
                    productName: '',
                    category: '',
                    quantity: 1,
                    remainingPercent: null,
                    tableNumber: '',
                    notes: ''
                };
                this.walkInPhotoFile = null;
                this.walkInPhotoPreview = null;
                this.showWalkInModal = true;
            },

            closeWalkInModal() {
                this.showWalkInModal = false;
                this.walkInPhotoFile = null;
                this.walkInPhotoPreview = null;
            },

            async submitWalkIn() {
                // Validate required fields
                if (!this.walkInForm.customerName || !this.walkInForm.customerPhone ||
                    !this.walkInForm.productName || !this.walkInForm.category || !this.walkInForm.quantity) {
                    Swal.fire('Error', 'กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                    return;
                }

                // Show loading
                Swal.fire({
                    title: 'กำลังบันทึก...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    // Prepare data to send to backend
                    const depositData = {
                        storeId: this.currentStoreId,
                        customerName: this.walkInForm.customerName,
                        customerPhone: this.walkInForm.customerPhone,
                        customerLineId: null, // Walk-in ไม่มี LINE ID
                        productName: this.walkInForm.productName,
                        category: this.walkInForm.category,
                        quantity: parseInt(this.walkInForm.quantity),
                        remainingPercent: this.walkInForm.remainingPercent ? parseFloat(this.walkInForm.remainingPercent) : null,
                        tableNumber: this.walkInForm.tableNumber || '',
                        notes: this.walkInForm.notes || '',
                        receivedBy: this.currentUser.username,
                        source: 'walk-in',
                        photoBase64: this.walkInPhotoPreview || null // Send base64 photo data
                    };

                    console.log('📤 Sending walk-in deposit:', depositData);

                    // Call backend to create deposit
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .createWalkInDeposit(depositData);
                    });

                    console.log('📥 Backend response:', result);
                    console.log('📥 depositCode type:', typeof result.depositCode, result.depositCode);

                    if (result && result.success) {
                        this.closeWalkInModal();

                        // Extract depositCode (handle if it's an object)
                        const depositCode = typeof result.depositCode === 'string'
                            ? result.depositCode
                            : (result.depositCode?.toString() || 'N/A');

                        Swal.fire({
                            icon: 'success',
                            title: 'สำเร็จ',
                            text: `สร้างรายการฝากแล้ว (${depositCode}) รอ Bar ยืนยัน`,
                            timer: 2000,
                            showConfirmButton: false
                        });

                        // Reload data
                        await this.loadAllData();
                    } else {
                        throw new Error(result?.message || 'ไม่สามารถบันทึกข้อมูลได้');
                    }
                } catch (error) {
                    console.error('❌ Submit walk-in error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message || 'ไม่สามารถบันทึกข้อมูลได้'
                    });
                }
            },

            viewDetails(item) {
                console.log('View details:', item);
                this.selectedDepositForDetails = item;
                this.showDetailsModal = true;
            },

            closeDetailsModal() {
                this.showDetailsModal = false;
                this.selectedDepositForDetails = null;
            },

            viewPhoto(photoUrl) {
                if (photoUrl) {
                    window.open(photoUrl, '_blank');
                } else {
                    Swal.fire('Info', 'ไม่มีรูปภาพ', 'info');
                }
            },

            goBackToIndex() {
                window.close();
            },

            // Helpers
            getRoleLabel(role) {
                const labels = {
                    staff: 'พนักงาน',
                    bar: 'บาร์',
                    manager: 'ผู้จัดการ',
                    owner: 'เจ้าของ'
                };
                return labels[role] || role;
            },

            getStatusLabel(status) {
                const labels = {
                    withdrawn: 'เบิกแล้ว',
                    expired: 'หมดอายุ',
                    transferred: 'โอนคลังกลาง'
                };
                return labels[status] || status;
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('th-TH');
            },

            formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            },

            getDaysRemaining(expiryDateStr) {
                if (!expiryDateStr) return null;
                const today = new Date();
                const expiryDate = new Date(expiryDateStr);
                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            },

            getExpiryColor(daysRemaining) {
                if (daysRemaining === null) return 'gray';
                if (daysRemaining <= 7) return 'red';
                if (daysRemaining <= 14) return 'yellow';
                return 'green';
            },

            getExpiryProgress(expiryDateStr, depositDateStr) {
                if (!expiryDateStr || !depositDateStr) return 0;
                const depositDate = new Date(depositDateStr);
                const expiryDate = new Date(expiryDateStr);
                const today = new Date();

                const totalDays = Math.ceil((expiryDate - depositDate) / (1000 * 60 * 60 * 24));
                const remainingDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                const progress = Math.max(0, Math.min(100, (remainingDays / totalDays) * 100));

                return progress;
            },

            async printReceipt(item, receiptType = 'customer') {
                try {
                    console.log('Print receipt:', item.depositCode, receiptType);

                    // Show loading
                    Swal.fire({
                        title: 'กำลังสร้างใบพิมพ์...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // TODO: Call Google Apps Script to generate receipt
                    // google.script.run
                    //     .withSuccessHandler(response => {
                    //         if (response.success) {
                    //             Swal.close();
                    //             // Open print dialog or PDF
                    //             window.open(response.receiptUrl, '_blank');
                    //         } else {
                    //             Swal.fire('Error', response.message, 'error');
                    //         }
                    //     })
                    //     .withFailureHandler(err => {
                    //         Swal.fire('Error', err.message, 'error');
                    //     })
                    //     .generateDepositReceipt(item.id, receiptType);

                    // Simulated response
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'สร้างใบพิมพ์สำเร็จ',
                            html: receiptType === 'customer'
                                ? 'ใบเสร็จสำหรับลูกค้าพร้อมแล้ว<br><small>หน้าต่างพิมพ์จะเปิดขึ้นอัตโนมัติ</small>'
                                : 'ใบป้ายแปะขวดพร้อมแล้ว<br><small>หน้าต่างพิมพ์จะเปิดขึ้นอัตโนมัติ</small>',
                            showConfirmButton: false,
                            timer: 1500
                        });

                        // Open print preview directly
                        setTimeout(() => {
                            this.openPrintPreview(item, receiptType);
                        }, 500);
                    }, 1000);

                } catch (error) {
                    console.error('Print receipt error:', error);
                    Swal.fire('Error', 'ไม่สามารถพิมพ์ได้', 'error');
                }
            },

            openPrintPreview(item, receiptType) {
                // Create print window with receipt content
                const printWindow = window.open('', '_blank', 'width=400,height=600');

                const receiptHTML = receiptType === 'customer'
                    ? this.generateCustomerReceiptHTML(item)
                    : this.generateBottleLabelHTML(item);

                printWindow.document.write(receiptHTML);
                printWindow.document.close();

                // Auto print after load
                printWindow.onload = () => {
                    printWindow.print();
                };
            },

            generateCustomerReceiptHTML(item) {
                const headerText = this.printSettings.receiptHeaderText || 'ใบรับฝาก';
                const depositDate = new Date(item.depositDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });

                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>ใบรับฝาก - ${item.depositCode}</title>
                        <style>
                            @page {
                                size: 35mm 45mm;
                                margin: 0;
                            }
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                width: 35mm;
                                height: 45mm;
                                padding: 1.5mm;
                                font-family: 'Sarabun', Arial, sans-serif;
                                font-size: 6.5pt;
                                line-height: 1.2;
                            }
                            .header {
                                text-align: center;
                                font-size: 8pt;
                                font-weight: bold;
                                border-bottom: 0.3mm dashed #000;
                                padding-bottom: 1mm;
                                margin-bottom: 1mm;
                            }
                            .code {
                                text-align: center;
                                font-size: 10pt;
                                font-weight: bold;
                                letter-spacing: 0.3mm;
                                margin: 1mm 0;
                            }
                            .info {
                                font-size: 6.5pt;
                            }
                            .row {
                                display: flex;
                                justify-content: space-between;
                                margin: 0.3mm 0;
                            }
                            .row .label {
                                color: #333;
                                font-size: 6pt;
                            }
                            .row .value {
                                font-weight: bold;
                                text-align: right;
                                max-width: 55%;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                white-space: nowrap;
                                font-size: 6pt;
                            }
                            .dates {
                                display: flex;
                                justify-content: space-between;
                                font-size: 6pt;
                                border-top: 0.3mm dashed #000;
                                padding-top: 1mm;
                                margin-top: 1mm;
                            }
                            .date-item {
                                text-align: center;
                            }
                            .date-label {
                                color: #555;
                                font-size: 5.5pt;
                            }
                            .date-value {
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">${headerText}</div>
                        <div class="code">${item.depositCode}</div>
                        <div class="info">
                            <div class="row">
                                <span class="label">ชื่อ</span>
                                <span class="value">${item.customerName}</span>
                            </div>
                            <div class="row">
                                <span class="label">สินค้า</span>
                                <span class="value">${item.alcoholType}</span>
                            </div>
                            <div class="row">
                                <span class="label">จำนวน</span>
                                <span class="value">${item.quantity} ขวด</span>
                            </div>
                        </div>
                        <div class="dates">
                            <div class="date-item">
                                <div class="date-label">วันฝาก</div>
                                <div class="date-value">${depositDate}</div>
                            </div>
                            <div class="date-item">
                                <div class="date-label">หมดอายุ</div>
                                <div class="date-value">${expiryDate}</div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            },

            generateBottleLabelHTML(item) {
                const expiryDate = new Date(item.expiryDate).toLocaleDateString('th-TH', {
                    year: '2-digit',
                    month: '2-digit',
                    day: '2-digit'
                });
                const quantity = item.quantity || 1;

                // Generate multiple labels based on quantity
                let labelsHTML = '';
                for (let i = 0; i < quantity; i++) {
                    labelsHTML += `
                        <div class="label-page">
                            <div class="code">${item.depositCode}</div>
                            <div class="product">${item.alcoholType}</div>
                            <div class="bottle-num">${i + 1}/${quantity}</div>
                            <div class="expiry-box">EXP: ${expiryDate}</div>
                        </div>`;
                }

                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>ป้ายแปะขวด - ${item.depositCode}</title>
                        <style>
                            @page {
                                size: 35mm 45mm;
                                margin: 0;
                            }
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                font-family: 'Sarabun', Arial, sans-serif;
                            }
                            .label-page {
                                width: 35mm;
                                height: 45mm;
                                padding: 1.5mm;
                                page-break-after: always;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                align-items: center;
                            }
                            .label-page:last-child {
                                page-break-after: auto;
                            }
                            .code {
                                font-size: 11pt;
                                font-weight: bold;
                                letter-spacing: 0.3mm;
                                margin-bottom: 2mm;
                            }
                            .product {
                                font-size: 7pt;
                                font-weight: bold;
                                text-align: center;
                                margin-bottom: 2mm;
                                max-width: 100%;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                white-space: nowrap;
                            }
                            .bottle-num {
                                font-size: 9pt;
                                font-weight: bold;
                                color: #333;
                                margin-bottom: 2mm;
                            }
                            .expiry-box {
                                background: #000;
                                color: #fff;
                                padding: 1mm 3mm;
                                border-radius: 1mm;
                                font-size: 7pt;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        ${labelsHTML}
                    </body>
                    </html>
                `;
            },

            async showQRCode(item) {
                this.selectedDepositForQR = item;
                this.qrCodeImageUrl = 'https://via.placeholder.com/256';
                this.lineId = '@example';
                this.showQRModal = true;
            },

            closeQRModal() {
                this.showQRModal = false;
                this.selectedDepositForQR = null;
                this.qrCodeImageUrl = '';
                this.lineId = '';
            },

            // Authentication functions
            async login() {
                console.log('🔑 Login attempt:', this.loginForm.username);
                this.loginForm.loading = true;
                this.authError = null;

                try {
                    // Call Google Apps Script backend for authentication
                    console.log('📡 Calling backend doLogin...');
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .doLogin(this.loginForm.username, this.loginForm.password);
                    });

                    console.log('📥 Backend response:', {
                        success: result.success,
                        username: result.user?.username,
                        role: result.user?.role,
                        storesCount: result.user?.stores?.length
                    });

                    this.loginForm.loading = false;

                    if (result.success) {
                        this.currentUser = result.user;
                        this.isLoggedIn = true;
                        this.showLoginModal = false;

                        console.log('👤 User data:', {
                            username: result.user.username,
                            role: result.user.role,
                            stores: result.user.stores?.map(s => ({ id: s.store_id, name: s.name }))
                        });

                        // Find store name from stores array using currentStoreId
                        if (result.user.stores && result.user.stores.length > 0) {
                            const currentStore = result.user.stores.find(s => s.store_id === this.currentStoreId);

                            if (currentStore) {
                                this.currentStoreName = currentStore.name;
                                console.log('✅ Login successful - Store:', currentStore.name);
                            } else {
                                this.currentStoreName = 'ไม่พบสาขา';
                                console.warn('⚠️  Store ID not found in user stores:', this.currentStoreId);
                            }
                        } else {
                            this.currentStoreName = 'สาขาทดสอบ';
                            console.warn('⚠️  No stores in backend response');
                        }

                        // Save to localStorage
                        localStorage.setItem('depositSession', JSON.stringify(result.user));
                        console.log('💾 Session saved to localStorage');

                        // Continue initialization
                        this.setVisibleTabs();
                        if (this.visibleTabs.length > 0) {
                            this.activeTab = this.visibleTabs[0].id;
                        }
                        await this.loadAllData();
                    } else {
                        console.error('❌ Login failed:', result.message);
                        this.authError = result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                    }
                } catch (error) {
                    this.loginForm.loading = false;
                    this.authError = error.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
                    console.error('❌ Login error:', error);
                }
            },

            logout() {
                localStorage.removeItem('depositSession');
                this.isLoggedIn = false;
                this.currentUser = null;
                this.showLoginModal = true;
                this.authError = null;
                this.loginForm.username = '';
                this.loginForm.password = '';

                // Clear data
                this.deposits = {
                    new_requests: [],
                    pending_confirm: [],
                    deposited: [],
                    history: []
                };
                this.withdrawals = { pending: [] };
            }
        };
    }
    </script>
</body>

</html>