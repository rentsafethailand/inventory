<!DOCTYPE html>
<html lang="th" x-data="{ isDarkMode: localStorage.getItem('isDarkMode') === 'true' }" :class="{ 'dark': isDarkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ชี้แจงและกระทบยอดผลต่างสต๊อก</title>
    
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');

        /* CSS Variables for Theming */
        :root {
            --light-bg: #F9FAFB;
            --light-card-bg: #FFFFFF;
            --light-border: #E5E7EB;
            --light-text-primary: #1F2937;
            --light-text-secondary: #6B7280;
            --light-icon-bg: #E0F2FE;
            
            --dark-bg: #111827;
            --dark-card-bg: #1F2937;
            --dark-border: #374151;
            --dark-text-primary: #F9FAFB;
            --dark-text-secondary: #9CA3AF;
            --dark-icon-bg: #1E3A8A;

            --accent-blue: #3B82F6;
            --accent-yellow: #F59E0B;
            --accent-red: #EF4444;
            --accent-green: #10B981;
            --accent-gray: #6B7280;
        }

        /* Base styles */
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Light Mode */
        body {
            background-color: var(--light-bg);
            color: var(--light-text-primary);
        }

        /* Dark Mode */
        .dark body {
            background-color: var(--dark-bg);
            color: var(--dark-text-primary);
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        main {
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Adds space between section cards */
            margin-top: 1.5rem;
        }

        [x-cloak] { display: none !important; }

        /* Header */
        .page-header {
            text-align: center;
        }
        .page-header .icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            background-color: var(--light-icon-bg);
            color: var(--accent-blue);
            transition: background-color 0.3s;
        }
        .dark .page-header .icon-wrapper { background-color: var(--dark-icon-bg); }
        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }


        .info-badge { 
            display: inline-block; 
            margin-top: 0.5rem; 
            padding: 0.5rem 1rem; 
            border-radius: 9999px; 
            border: 1px solid var(--accent-blue); 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }
        .dark .info-badge { 
            border-color: var(--accent-blue); 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08));
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        .info-badge p { 
            margin: 0; 
            font-size: 0.95rem; 
            font-weight: 600;
            color: var(--accent-blue); 
        }
        .dark .info-badge p { 
            color: #60A5FA; 
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 9999px;
            background-color: var(--light-card-bg);
            border: 1px solid var(--light-border);
            color: var(--light-text-secondary);
        }
        .dark .theme-toggle {
            background-color: var(--dark-card-bg);
            border-color: var(--dark-border);
            color: var(--dark-text-secondary);
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .summary-grid { grid-template-columns: repeat(5, 1fr); }
        }

        .summary-card {
            padding: 1rem;
            text-align: center;
            border-radius: 0.75rem;
            background-color: var(--light-card-bg);
            border: 1px solid var(--light-border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark .summary-card {
            background-color: var(--dark-card-bg);
            border-color: var(--dark-border);
        }
        .summary-card .value { font-size: 1.75rem; font-weight: 700; line-height: 1; }
        .summary-card .label { font-size: 0.8rem; margin-top: 0.25rem; color: var(--light-text-secondary); }
        .dark .summary-card .label { color: var(--dark-text-secondary); }
        
        /* Section Card */
        .section-card {
            background-color: var(--light-card-bg);
            border: 1px solid var(--light-border);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark .section-card {
            background-color: var(--dark-card-bg);
            border-color: var(--dark-border);
        }
        .section-card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--light-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .dark .section-card-header { border-color: var(--dark-border); }
        .section-card-header h2 {
            font-size: 1.125rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-card-content { padding: 1rem; }
        .section-card-content[style*="display: none;"] {
             padding: 0;
        }
        
        /* Item Card Layout */
        .item-list { display: flex; flex-direction: column; gap: 1rem; }
        .item-card { border: 1px solid var(--light-border); border-radius: 0.5rem; padding: 0.75rem; }
        .dark .item-card { border-color: var(--dark-border); }
        
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .item-info .name { font-weight: 500; }
        .item-info .code { font-size: 0.8rem; color: var(--light-text-secondary); }
        .dark .item-info .code { color: var(--dark-text-secondary); }

        /* --- START: EDIT --- */
        .item-diff {
            text-align: right;
            flex-shrink: 0;
            padding-left: 1rem;
            font-size: 0.8rem;
            color: var(--light-text-secondary);
        }
        .dark .item-diff { color: var(--dark-text-secondary); }
        .item-diff .diff-row {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            min-width: 120px;
        }
        .item-diff .diff-row-total {
            font-weight: 700;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            padding-top: 0.25rem;
            border-top: 1px solid var(--light-border);
        }
        .dark .item-diff .diff-row-total { border-color: var(--dark-border); }
        .pos-value { color: var(--accent-green) !important; }
        .neg-value { color: var(--accent-red) !important; }
        .zero-value { color: var(--light-text-primary); }
        .dark .zero-value { color: var(--dark-text-primary); }
        /* --- END: EDIT --- */

        /* Textarea and Input */
        textarea, input[type="number"] {
            width: 100%; padding: 0.5rem; border-radius: 0.375rem;
            font-family: 'Sarabun', sans-serif; font-size: 0.9rem; box-sizing: border-box;
            background-color: var(--light-bg); border: 1px solid var(--light-border); color: var(--light-text-primary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .dark textarea, .dark input[type="number"] {
            background-color: var(--dark-bg); border-color: var(--dark-border); color: var(--dark-text-primary);
        }
        textarea:disabled { cursor: not-allowed; opacity: 0.7; }
        
        .rejected-reason {
            font-size: 0.8rem; padding: 0.5rem; margin-top: 0.5rem; border-radius: 0.25rem;
            background-color: rgba(239, 68, 68, 0.1); color: #DC2626; border-left: 3px solid var(--accent-red);
        }
        .dark .rejected-reason { background-color: rgba(239, 68, 68, 0.2); color: #F87171; }
        
        .bulk-reason-toggle {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.9rem; cursor: pointer; color: var(--light-text-secondary);
        }
        .dark .bulk-reason-toggle { color: var(--dark-text-secondary); }

        /* Submit Button */
        .btn-submit {
            width: 100%; padding: 0.75rem 1rem; font-size: 1.125rem;
            font-weight: 700; border: none; border-radius: 0.5rem;
            cursor: pointer; transition: all 0.2s; display: flex;
            align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1.5rem;
            background-color: var(--accent-blue); color: white;
        }
        .btn-submit:hover { background-color: #2563EB; }
        .btn-submit:disabled { background-color: #93C5FD; cursor: not-allowed; }


        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            z-index: 9999;
        }
        .dark .loading-overlay {
            background-color: rgba(17, 24, 39, 0.95);
        }
        .loading-spinner {
            font-size: 3rem;
            color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--light-text-primary);
        }
        .dark .loading-text {
            color: var(--dark-text-primary);
        }




        /* Login form */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 80vh; }
        .login-card { 
            background-color: var(--light-card-bg); 
            border: 1px solid var(--light-border); 
            border-radius: 0.75rem; 
            padding: 2rem; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
        }
        .dark .login-card { background-color: var(--dark-card-bg); border-color: var(--dark-border); }
        .login-card h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .login-card p { color: var(--light-text-secondary); margin-bottom: 1.5rem; }
        .dark .login-card p { color: var(--dark-text-secondary); }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 0.25rem; }
        .form-group input { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid var(--light-border); 
            border-radius: 0.5rem; 
            box-sizing: border-box; 
        }
        .dark .form-group input { 
            background-color: var(--dark-bg); 
            border-color: var(--dark-border); 
            color: var(--dark-text-primary); 
        }
        .btn { 
            padding: 0.75rem 1.5rem; 
            font-size: 1rem; 
            font-weight: 700; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-primary:hover { background-color: #2563EB; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-full { width: 100%; }

        /* Profile dropdown */
        .profile-container { position: absolute; top: 1rem; right: 4rem; }
        .profile-button { cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .profile-icon { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            background-color: var(--light-icon-bg); 
            color: var(--accent-blue); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .dark .profile-icon { background-color: var(--dark-icon-bg); }
        .profile-dropdown { 
            position: absolute; 
            right: 0; 
            top: 100%; 
            margin-top: 0.5rem; 
            background-color: var(--light-card-bg); 
            border: 1px solid var(--light-border); 
            border-radius: 0.5rem; 
            min-width: 180px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            z-index: 10; 
        }
        .dark .profile-dropdown { background-color: var(--dark-card-bg); border-color: var(--dark-border); }
        .dropdown-item { 
            display: block; 
            width: 100%; 
            text-align: left; 
            padding: 0.75rem 1rem; 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 0.9rem; 
        }
        .dropdown-item:hover { background-color: var(--light-bg); }
        .dark .dropdown-item:hover { background-color: var(--dark-bg); }
        .dropdown-divider { border-top: 1px solid var(--light-border); }
        .dark .dropdown-divider { border-color: var(--dark-border); }
   

    
    </style>
</head>
<body>
    <div x-data="explanationApp()" x-init="init()" data-store-id="<?= storeId ?>" data-date="<?= date ?>" class="main-container" x-cloak>
        
        <div x-show="loading" class="loading-overlay">
    <i class="fa-solid fa-spinner loading-spinner"></i>
    <p class="loading-text">กำลังโหลดข้อมูล...</p>
</div>
        <div x-show="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
            <p class="font-bold">เกิดข้อผิดพลาด</p>
            <p x-text="error"></p>
        </div>

      <template x-if="!isLoggedIn && !loading">
    <div class="login-container">
        <div class="login-card">
            <div class="icon-wrapper" style="margin: 0 auto 1rem;"><i class="fa-solid fa-lock fa-xl"></i></div>
            <h2>กรุณาเข้าสู่ระบบ</h2>
            <p>เพื่อเข้าถึงหน้าชี้แจงและกระทบยอด</p>
            <div x-show="authError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 text-sm text-left" role="alert">
                <strong class="font-bold">เกิดข้อผิดพลาด:</strong>
                <span class="block sm:inline" x-text="authError"></span>
            </div>
            <form @submit.prevent="login()">
                <div class="form-group">
                    <label for="username">ชื่อผู้ใช้</label>
                    <input type="text" id="username" x-model="loginForm.username" @input="authError = null" required>
                </div>
                <div class="form-group">
                    <label for="password">รหัสผ่าน</label>
                    <input type="password" id="password" x-model="loginForm.password" @input="authError = null" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full" :disabled="loginForm.loading">
                    <span x-show="!loginForm.loading">เข้าสู่ระบบ</span>
                    <span x-show="loginForm.loading"><i class="fa-solid fa-spinner fa-spin"></i> กำลังตรวจสอบ...</span>
                </button>
            </form>
        </div>
    </div>
</template>

<template x-if="isLoggedIn && !loading && !error">
    <div>
               <button @click="isDarkMode = !isDarkMode; localStorage.setItem('isDarkMode', isDarkMode)" class="theme-toggle">
    <i :class="isDarkMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon'"></i>
</button>

<div x-data="{ open: false }" @click.away="open = false" class="profile-container">
    <div @click="open = !open" class="profile-button">
        <span class="text-sm font-medium" x-text="user.username"></span>
        <div class="profile-icon"><i class="fa-solid fa-user"></i></div>
    </div>
    <div x-show="open" x-transition class="profile-dropdown">
        <button @click="changePassword()" class="dropdown-item"><i class="fa-solid fa-key" style="width: 20px;"></i> เปลี่ยนรหัสผ่าน</button>
        <div class="dropdown-divider"></div>
        <button @click="logout()" class="dropdown-item" style="color: var(--accent-red);"><i class="fa-solid fa-right-from-bracket" style="width: 20px;"></i> ออกจากระบบ</button>
    </div>
</div>

                <header class="page-header">
                    <div class="icon-wrapper"><i class="fa-solid fa-file-signature fa-xl"></i></div>
                    <h1>ชี้แจงและกระทบยอด</h1>
                    <div class="info-badge">
                        <p x-text="`สาขา: ${storeName} | วันที่: ${formattedDate}`"></p>
                    </div>
                </header>

                <main>
                    <section class="summary-grid">
                        <div class="summary-card"><div class="value" style="color: var(--accent-blue);" x-text="summary.pendingCount"></div><div class="label">ยังไม่ได้นับ</div></div>
                        <div class="summary-card"><div class="value" style="color: var(--accent-yellow);" x-text="summary.pendingExplanation"></div><div class="label">รอชี้แจง</div></div>
                        <div class="summary-card"><div class="value" style="color: var(--accent-red);" x-text="summary.rejected"></div><div class="label">ปฏิเสธ</div></div>
                        <div class="summary-card"><div class="value" style="color: var(--accent-gray);" x-text="summary.pendingApproval"></div><div class="label">รออนุมัติ</div></div>
                        <div class="summary-card"><div class="value" style="color: var(--accent-green);" x-text="summary.approved"></div><div class="label">อนุมัติแล้ว</div></div>
                    </section>

                    <section x-show="pendingCountItems.length > 0" x-data="{ isOpen: true }" class="section-card">
                        <div class="section-card-header" @click="isOpen = !isOpen">
                            <h2><i class="fa-solid fa-clipboard-question" style="color: var(--accent-blue);"></i> รายการที่ยังไม่ได้นับ</h2>
                            <i class="fa-solid text-sm" :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                        <div x-show="isOpen" x-transition class="section-card-content">
                            <div class="item-list">
                                <template x-for="item in pendingCountItems" :key="item.comp_id">
                                    <div class="item-card">
                                        <div class="item-info">
                                            <div class="name" x-text="item.product_name"></div>
                                            <div class="code" x-text="item.product_code"></div>
                                        </div>
                                        <div class="mt-2">
                                            <label class="label block mb-1">จำนวนที่นับได้จริง</label>
                                            <input type="number" step="0.01" x-model.number="item.new_count" placeholder="กรอกจำนวนที่นับได้">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </section>
                    
                    <section x-show="pendingExplanationItemsForDisplay.length > 0" x-data="{ isOpen: true, useBulkReason: false, bulkReasonText: '' }" class="section-card">
                        <div class="section-card-header" @click="isOpen = !isOpen">
                            <h2><i class="fa-solid fa-pen-to-square" style="color: var(--accent-yellow);"></i> รายการที่รอชี้แจง</h2>
                             <i class="fa-solid text-sm" :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                        <div x-show="isOpen" x-transition class="section-card-content">
                             <div class="border-b pb-4 mb-4" :class="{ 'dark:border-gray-700': isDarkMode, 'border-gray-200': !isDarkMode }">
                                <label @click.stop class="bulk-reason-toggle">
                                    <input type="checkbox" x-model="useBulkReason">
                                    <span>ใช้เหตุผลรวม</span>
                                </label>
                                <div x-show="useBulkReason" x-transition class="mt-2">
                                    <textarea x-model="bulkReasonText" @blur="applyBulkReason(bulkReasonText)" rows="3" placeholder="พิมพ์เหตุผลรวมที่นี่ แล้วคลิกที่ว่าง..."></textarea>
                                </div>
                            </div>
                            <div class="item-list">
                                <template x-for="item in pendingExplanationItemsForDisplay" :key="item.comp_id">
                                    <div class="item-card">
                                        <div class="item-header">
                                            <div class="item-info">
                                                <div class="name" x-text="item.product_name"></div>
                                                <div class="code" x-text="item.product_code"></div>
                                            </div>
                                            <div class="item-diff">
                                                <div class="diff-row">
                                                    <span>POS:</span>
                                                    <span x-text="item.pos_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row">
                                                    <span>นับได้:</span>
                                                    <span x-text="item.manual_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row diff-row-total" :class="{
                                                    'pos-value': item.difference > 0,
                                                    'neg-value': item.difference < 0,
                                                    'zero-value': item.difference == 0
                                                }">
                                                    <span>ผลต่าง:</span>
                                                    <span x-text="(item.difference > 0 ? '+' : '') + item.difference.toFixed(2)"></span>
                                                </div>
                                            </div>
                                            </div>
                                        <div class="mt-2">
                                            <textarea x-model="item.explanation" @input="updateSummary()" rows="2" placeholder="ระบุเหตุผล..."></textarea>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </section>
                    
                    <section x-show="rejectedItems.length > 0" x-data="{ isOpen: true }" class="section-card">
                        <div class="section-card-header" @click="isOpen = !isOpen">
                            <h2><i class="fa-solid fa-circle-xmark" style="color: var(--accent-red);"></i> รายการที่ถูกปฏิเสธ</h2>
                            <i class="fa-solid text-sm" :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                        <div x-show="isOpen" x-transition class="section-card-content">
                            <div class="item-list">
                                <template x-for="item in rejectedItems" :key="item.comp_id">
                                    <div class="item-card">
                                        <div class="item-header">
                                            <div class="item-info">
                                                <div class="name" x-text="item.product_name"></div>
                                                <div class="code" x-text="item.product_code"></div>
                                            </div>
                                            <div class="item-diff">
                                                <div class="diff-row">
                                                    <span>POS:</span>
                                                    <span x-text="item.pos_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row">
                                                    <span>นับได้:</span>
                                                    <span x-text="item.manual_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row diff-row-total" :class="{
                                                    'pos-value': item.difference > 0,
                                                    'neg-value': item.difference < 0,
                                                    'zero-value': item.difference == 0
                                                }">
                                                    <span>ผลต่าง:</span>
                                                    <span x-text="(item.difference > 0 ? '+' : '') + item.difference.toFixed(2)"></span>
                                                </div>
                                            </div>
                                            </div>
                                        <div class="rejected-reason" x-text="`เหตุผลที่ถูกปฏิเสธ: ${item.owner_notes || 'ไม่มี'}`"></div>
                                        <div class="mt-2">
                                            <textarea x-model="item.explanation" rows="2" placeholder="แก้ไขเหตุผล..."></textarea>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </section>
                    
                    <section x-show="pendingApprovalItems.length > 0" x-data="{ isOpen: false }" class="section-card">
                        <div class="section-card-header" @click="isOpen = !isOpen">
                            <h2><i class="fa-solid fa-hourglass-half" style="color: var(--accent-gray);"></i> รายการที่รออนุมัติ</h2>
                            <i class="fa-solid text-sm" :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                        <div x-show="isOpen" x-transition class="section-card-content">
                           <div class="item-list">
                                <template x-for="item in pendingApprovalItems" :key="item.comp_id">
                                    <div class="item-card">
                                        <div class="item-header">
                                            <div class="item-info">
                                                <div class="name" x-text="item.product_name"></div>
                                                <div class="code" x-text="item.product_code"></div>
                                            </div>
                                            <div class="item-diff">
                                                <div class="diff-row">
                                                    <span>POS:</span>
                                                    <span x-text="item.pos_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row">
                                                    <span>นับได้:</span>
                                                    <span x-text="item.manual_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row diff-row-total" :class="{
                                                    'pos-value': item.difference > 0,
                                                    'neg-value': item.difference < 0,
                                                    'zero-value': item.difference == 0
                                                }">
                                                    <span>ผลต่าง:</span>
                                                    <span x-text="(item.difference > 0 ? '+' : '') + item.difference.toFixed(2)"></span>
                                                </div>
                                            </div>
                                            </div>
                                        <div class="mt-2">
                                            <textarea x-model="item.explanation" rows="2" disabled></textarea>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </section>

                    <section x-show="approvedItems.length > 0" x-data="{ isOpen: false }" class="section-card">
                        <div class="section-card-header" @click="isOpen = !isOpen">
                            <h2><i class="fa-solid fa-check-circle" style="color: var(--accent-green);"></i> รายการที่อนุมัติแล้ว</h2>
                             <i class="fa-solid text-sm" :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </div>
                        <div x-show="isOpen" x-transition class="section-card-content">
                            <div class="item-list">
                                <template x-for="item in approvedItems" :key="item.comp_id">
                                     <div class="item-card">
                                        <div class="item-header">
                                            <div class="item-info">
                                                <div class="name" x-text="item.product_name"></div>
                                                <div class="code" x-text="item.product_code"></div>
                                            </div>
                                            <div class="item-diff">
                                                <div class="diff-row">
                                                    <span>POS:</span>
                                                    <span x-text="item.pos_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row">
                                                    <span>นับได้:</span>
                                                    <span x-text="item.manual_quantity.toFixed(2)"></span>
                                                </div>
                                                <div class="diff-row diff-row-total" :class="{
                                                    'pos-value': item.difference > 0,
                                                    'neg-value': item.difference < 0,
                                                    'zero-value': item.difference == 0
                                                }">
                                                    <span>ผลต่าง:</span>
                                                    <span x-text="(item.difference > 0 ? '+' : '') + item.difference.toFixed(2)"></span>
                                                </div>
                                            </div>
                                            </div>
                                        <div class="mt-2">
                                            <textarea x-model="item.explanation" rows="2" disabled></textarea>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </section>

                    <div x-show="items.length > 0 && (pendingCountItems.length > 0 || pendingExplanationItemsForDisplay.length > 0 || rejectedItems.length > 0)">
                        <button @click="submitData()" class="btn-submit" :disabled="submitting">
                            <i x-show="submitting" class="fa-solid fa-spinner fa-spin"></i>
                            <span x-text="submitting ? 'กำลังบันทึก...' : 'ส่งข้อมูล'"></span>
                        </button>
                    </div>
                </main>
            </div>
        </template>
    </div>

<script>
    function explanationApp() {
        return {
            loading: true,
            isLoggedIn: false,
isAuthorized: false,
user: null,
authError: null,
loginForm: {
    username: '',
    password: '',
    loading: false
},
            submitting: false,
            error: null,
            storeId: null,
            sheetId: null,
            storeName: '',
            date: null,
            formattedDate: '',
            items: [],
            pendingExplanationItemsForDisplay: [],
            
            summary: {
                pendingCount: 0,
                pendingExplanation: 0,
                pendingApproval: 0,
                approved: 0,
                rejected: 0,
            },

            get pendingCountItems() { return this.items.filter(i => i.status === 'pending_count'); },
            get rejectedItems() { return this.items.filter(i => i.status === 'discrepancy' && i.approval_status === 'rejected'); },
            get pendingExplanationItems() { return this.items.filter(i => i.status === 'discrepancy' && !i.explanation && !i.approval_status); },
            get pendingApprovalItems() { return this.items.filter(i => i.status === 'discrepancy' && i.explanation && i.approval_status === 'pending'); },
            get approvedItems() { return this.items.filter(i => i.status === 'discrepancy' && i.approval_status === 'approved'); },
            
init() {
    this.storeId = this.$el.dataset.storeId;
    this.date = this.$el.dataset.date;
    
    if (!this.storeId || !this.date) {
        this.error = 'ข้อมูลไม่ครบถ้วน (ไม่พบรหัสสาขาหรือวันที่)';
        this.loading = false;
        return;
    }

    const session = localStorage.getItem('stockCountSession');
    if (session) {
        this.user = JSON.parse(session);
        this.isLoggedIn = true;
        this.authorizeAndFetch();
    } else {
        this.loading = false;
    }
},

authorizeAndFetch() {
    const authorizedStore = this.user.stores.find(s => s.store_id === this.storeId);
    
    if (authorizedStore) {
        this.isAuthorized = true;
        this.sheetId = authorizedStore.sheet_id;
        this.storeName = authorizedStore.name;
        this.fetchData();
    } else {
        this.isAuthorized = false;
        this.loading = false;
        this.authError = 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลของสาขานี้ กรุณาติดต่อผู้ดูแลระบบ';
        localStorage.removeItem('stockCountSession');
        this.isLoggedIn = false;
    }
},



fetchData() {
    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                const items = response.data.items.map(d => ({ ...d, new_count: null }));
                this.items = items;
                this.pendingExplanationItemsForDisplay = items.filter(i => i.status === 'discrepancy' && !i.explanation && !i.approval_status);
                this.updateSummary();
                const dateParts = this.date.split('-');
                this.formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            } else {
                this.error = response.message;
            }
            this.loading = false;
        })
        .withFailureHandler(err => {
            this.error = 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์';
            this.loading = false;
        })
        .getExplanationData(this.storeId, this.date);
},






login() {
    this.loginForm.loading = true;
    this.authError = null;
    google.script.run
        .withSuccessHandler(result => {
            this.loginForm.loading = false;
            if (result.success) {
                this.user = result.user;
                this.isLoggedIn = true;
                localStorage.setItem('stockCountSession', JSON.stringify(result.user));
                this.authorizeAndFetch();
            } else {
                this.authError = result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            }
        })
        .withFailureHandler(error => {
            this.loginForm.loading = false;
            this.authError = error.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
        })
        .doLogin(this.loginForm.username, this.loginForm.password);
},

logout() {
    localStorage.removeItem('stockCountSession');
    this.isLoggedIn = false;
    this.user = null;
    this.isAuthorized = false;
    this.authError = null;
    this.loginForm.username = '';
    this.loginForm.password = '';
},

changePassword() {
    Swal.fire({
        title: 'เปลี่ยนรหัสผ่าน',
        html: `
            <div style="text-align: left;">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">รหัสผ่านใหม่</label>
                    <input type="password" id="newPassword" class="swal2-input" style="width: 100%; margin: 0;" placeholder="กรอกรหัสผ่านใหม่">
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">ยืนยันรหัสผ่านใหม่</label>
                    <input type="password" id="confirmPassword" class="swal2-input" style="width: 100%; margin: 0;" placeholder="กรอกรหัสผ่านอีกครั้ง">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'เปลี่ยนรหัสผ่าน',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#3B82F6',
        cancelButtonColor: '#6B7280',
        focusConfirm: false,
        preConfirm: () => {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                Swal.showValidationMessage('กรุณากรอกรหัสผ่านให้ครบ');
                return false;
            }
            
            if (newPassword.length < 6) {
                Swal.showValidationMessage('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return false;
            }
            
            if (newPassword !== confirmPassword) {
                Swal.showValidationMessage('รหัสผ่านไม่ตรงกัน');
                return false;
            }
            
            return { newPassword };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'กำลังเปลี่ยนรหัสผ่าน...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        Swal.fire({
                            title: 'สำเร็จ!',
                            text: 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว',
                            icon: 'success',
                            confirmButtonColor: '#10B981'
                        });
                    } else {
                        Swal.fire({
                            title: 'ผิดพลาด',
                            text: response.message,
                            icon: 'error'
                        });
                    }
                })
                .withFailureHandler(error => {
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message,
                        icon: 'error'
                    });
                })
                .changePassword(this.user.username, result.value.newPassword);
        }
    });
},
            
            updateSummary() {
                this.summary.pendingCount = this.pendingCountItems.length;
                this.summary.rejected = this.rejectedItems.length;
                this.summary.pendingExplanation = this.pendingExplanationItems.length;
                this.summary.pendingApproval = this.pendingApprovalItems.length;
                this.summary.approved = this.approvedItems.length;
            },
            
            // **FIX**: This function now overwrites existing reasons, allowing it to be used multiple times.
            applyBulkReason(reasonText) {
                this.pendingExplanationItemsForDisplay.forEach(item => {
                    item.explanation = reasonText;
                });
                this.updateSummary();
            },

            submitData() {
                let explanationsToSubmit = [];
                let countsToSubmit = [];
                let hasMissingData = false;
                let hasUnexplainedDiscrepancy = false;
                
                const itemsToProcess = [...this.pendingCountItems, ...this.rejectedItems, ...this.pendingExplanationItemsForDisplay];
                const processedCompIds = new Set();

                itemsToProcess.forEach(item => {
                    if (processedCompIds.has(item.comp_id)) return;
                    
                    if (item.status === 'discrepancy') {
                        if (item.explanation && item.explanation.trim() !== '') {
                            explanationsToSubmit.push({ compId: item.comp_id, explanation: item.explanation.trim() });
                        } else { hasUnexplainedDiscrepancy = true; }
                    } else if (item.status === 'pending_count') {
                        if (item.new_count !== null && item.new_count !== '' && !isNaN(item.new_count)) {
                            countsToSubmit.push({ compId: item.comp_id, quantity: item.new_count });
                        } else { hasMissingData = true; }
                    }
                    processedCompIds.add(item.comp_id);
                });

                if (hasMissingData) { Swal.fire({ icon: 'warning', title: 'ข้อมูลไม่ครบถ้วน', text: 'กรุณากรอก "จำนวนที่นับได้จริง" ให้ครบทุกรายการ' }); return; }
                if (hasUnexplainedDiscrepancy) { Swal.fire({ icon: 'warning', title: 'ข้อมูลไม่ครบถ้วน', text: 'กรุณาใส่ "เหตุผล" ให้ครบทุกรายการที่สามารถแก้ไขได้' }); return; }
                if (explanationsToSubmit.length === 0 && countsToSubmit.length === 0) { Swal.fire({ icon: 'info', title: 'ไม่มีข้อมูลใหม่ให้บันทึก', text: 'คุณยังไม่ได้กรอกข้อมูลใดๆ เพิ่มเติม' }); return; }

                this.submitting = true;
                const payload = { explanations: explanationsToSubmit, counts: countsToSubmit };

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            Swal.fire({ icon: 'success', title: 'สำเร็จ!', text: 'บันทึกข้อมูลเรียบร้อยแล้ว', timer: 2000, showConfirmButton: false })
                            .then(() => { google.script.host.close(); });
                        } else { Swal.fire('เกิดข้อผิดพลาด', response.message, 'error'); }
                        this.submitting = false;
                    })
                    .withFailureHandler(err => {
                        Swal.fire('เกิดข้อผิดพลาดร้ายแรง', err.message, 'error');
                        this.submitting = false;
                    })
                    .submitExplanationsAndCounts(this.sheetId, payload, 'Staff via Explanation Page');
            }
        }
    }
</script>
</body>
</html>